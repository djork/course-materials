<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Part 2 – Machine Learning with R | CEC01 - A hands-on introduction to applied artificial intelligence in toxicology (CAAIT)</title>
  <meta name="description" content="Part 2 – Machine Learning with R | CEC01 - A hands-on introduction to applied artificial intelligence in toxicology (CAAIT)" />
  <meta name="generator" content="bookdown 0.33 and GitBook 2.6.7" />

  <meta property="og:title" content="Part 2 – Machine Learning with R | CEC01 - A hands-on introduction to applied artificial intelligence in toxicology (CAAIT)" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Part 2 – Machine Learning with R | CEC01 - A hands-on introduction to applied artificial intelligence in toxicology (CAAIT)" />
  
  
  

<meta name="author" content="Marc A.T. Teunis, PhD" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="part-1-introduction-to-r-and-rstudio.html"/>
<link rel="next" href="part-2-machine-learning-with-r-1.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.27/datatables.js"></script>
<link href="libs/dt-core-1.12.1/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.12.1/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.12.1/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo"><a href="./"></a> <h4 class=".paddingtitel ">CAAIT</h2></li>
<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#disclaimer-on-this-work"><i class="fa fa-check"></i>Disclaimer on this work</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#caait"><i class="fa fa-check"></i>CAAIT</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#programme-of-this-workshop"><i class="fa fa-check"></i>Programme of this workshop</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#course-material"><i class="fa fa-check"></i>Course material</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#r-and-rstudio"><i class="fa fa-check"></i>R and RStudio</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#resources-and-bookdown"><i class="fa fa-check"></i>Resources and Bookdown</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#learning-objectives"><i class="fa fa-check"></i>Learning objectives</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#attribution"><i class="fa fa-check"></i>Attribution</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html"><i class="fa fa-check"></i>Part 1 – Introduction to R and RStudio</a>
<ul>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#contents-day-1"><i class="fa fa-check"></i>Contents day 1</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#starting-to-work-within-a-project"><i class="fa fa-check"></i>Starting to work within a project</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#data-types-and-structures-in-r"><i class="fa fa-check"></i>Data types and structures in R</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#indexing"><i class="fa fa-check"></i>Indexing</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#missing-values"><i class="fa fa-check"></i>Missing values</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#secondstart"><i class="fa fa-check"></i>More complicated data</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#lists"><i class="fa fa-check"></i>Lists</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#dataframes"><i class="fa fa-check"></i>Dataframes</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#tibbles"><i class="fa fa-check"></i>Tibbles</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#factors"><i class="fa fa-check"></i>Factors</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#using-functions-drc"><i class="fa fa-check"></i>using functions: drc</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#scripts-and-rmarkdown"><i class="fa fa-check"></i>scripts and Rmarkdown</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#rmarkdown"><i class="fa fa-check"></i>Rmarkdown</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#yaml-header"><i class="fa fa-check"></i>YAML header</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#code-chunks"><i class="fa fa-check"></i>Code chunks</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#output-control"><i class="fa fa-check"></i>Output control</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#plain-text-formatting"><i class="fa fa-check"></i>Plain text formatting</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#here-package"><i class="fa fa-check"></i>Here package</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#creating-a-new-rmarkdown-file"><i class="fa fa-check"></i>Creating a new RMarkdown file</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html"><i class="fa fa-check"></i>Part 2 – Machine Learning with R</a>
<ul>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#learning-objectives-1"><i class="fa fa-check"></i>Learning objectives</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#machine-learning"><i class="fa fa-check"></i>Machine Learning</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#learning-more-tame"><i class="fa fa-check"></i>Learning more; TAME</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#tidymodels"><i class="fa fa-check"></i>Tidymodels</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#packages"><i class="fa fa-check"></i>Packages</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#data"><i class="fa fa-check"></i>Data</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#qsar-data"><i class="fa fa-check"></i>QSAR data</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#getting-started-with-tidymodels"><i class="fa fa-check"></i>Getting started with <code>{tidymodels}</code></a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#recipe"><i class="fa fa-check"></i>Create recipe and roles</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#features"><i class="fa fa-check"></i>Create features</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#fit-workflow"><i class="fa fa-check"></i>Fit a model with a recipe</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#predict-workflow"><i class="fa fa-check"></i>Use a trained workflow to predict</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#feature-importance"><i class="fa fa-check"></i>Feature importance</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#case-study-qsar-data"><i class="fa fa-check"></i>Case study; QSAR data</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#sparsity"><i class="fa fa-check"></i>Sparsity</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#unsupervised-machine-learning"><i class="fa fa-check"></i>Unsupervised machine learning</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#principal-component-analysis"><i class="fa fa-check"></i>Principal Component Analysis</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#t-sne"><i class="fa fa-check"></i>t-SNE</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#k-means-clustering"><i class="fa fa-check"></i>K-means clustering</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#xgboost"><i class="fa fa-check"></i>XGBoost</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#tuning-our-model"><i class="fa fa-check"></i>Tuning our model</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#model-tuning"><i class="fa fa-check"></i>Model tuning</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#read-results-from-disk"><i class="fa fa-check"></i>Read results from disk</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#bigger-grid"><i class="fa fa-check"></i>Bigger grid</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html"><i class="fa fa-check"></i>Part 2 – Machine Learning with R</a>
<ul>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#learning-objectives-2"><i class="fa fa-check"></i>Learning objectives</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#machine-learning-1"><i class="fa fa-check"></i>Machine Learning</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#learning-more-tame-1"><i class="fa fa-check"></i>Learning more; TAME</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#tidymodels-1"><i class="fa fa-check"></i>Tidymodels</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#packages-1"><i class="fa fa-check"></i>Packages</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#data-1"><i class="fa fa-check"></i>Data</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#qsar-data-1"><i class="fa fa-check"></i>QSAR data</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#getting-started-with-tidymodels-1"><i class="fa fa-check"></i>Getting started with <code>{tidymodels}</code></a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#recipe"><i class="fa fa-check"></i>Create recipe and roles</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#features"><i class="fa fa-check"></i>Create features</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#fit-workflow"><i class="fa fa-check"></i>Fit a model with a recipe</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#predict-workflow"><i class="fa fa-check"></i>Use a trained workflow to predict</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#feature-importance-1"><i class="fa fa-check"></i>Feature importance</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#case-study-qsar-data-1"><i class="fa fa-check"></i>Case study; QSAR data</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#sparsity-1"><i class="fa fa-check"></i>Sparsity</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#unsupervised-machine-learning-1"><i class="fa fa-check"></i>Unsupervised machine learning</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#principal-component-analysis-1"><i class="fa fa-check"></i>Principal Component Analysis</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#t-sne-1"><i class="fa fa-check"></i>t-SNE</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#k-means-clustering-1"><i class="fa fa-check"></i>K-means clustering</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#xgboost-1"><i class="fa fa-check"></i>XGBoost</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#tuning-our-model-1"><i class="fa fa-check"></i>Tuning our model</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#model-tuning-1"><i class="fa fa-check"></i>Model tuning</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#read-results-from-disk-1"><i class="fa fa-check"></i>Read results from disk</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r-1.html"><a href="part-2-machine-learning-with-r-1.html#bigger-grid-1"><i class="fa fa-check"></i>Bigger grid</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/ontox-hu/aira" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">CEC01 - A hands-on introduction to applied artificial intelligence in toxicology (CAAIT)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="part-2-machine-learning-with-r" class="section level1">
<h1>Part 2 – Machine Learning with R</h1>
<p><img src="images/tidymodels.svg" width="50%" style="display: block; margin: auto;" /></p>
<div id="learning-objectives-1" class="section level2">
<h2>Learning objectives</h2>
<p>After this lesson:</p>
<ul>
<li>You will be able to explore data suited for training a machine learning algorithm</li>
<li>Perform a number of unsupervised exploratory analysis (PCA, t-SNE, k-Means)</li>
<li>Build a predictive toxicity model, based on chemical fingerprints</li>
<li>Build a model to predict the partition coefficient (LogP), based on fingerprints</li>
<li>Enrich your data using an external data source (Tox21 dataset)</li>
<li>(Perform a biological read across, based on compound similarity)</li>
</ul>
</div>
<div id="machine-learning" class="section level2">
<h2>Machine Learning</h2>
<p>The term machine learning refers to a field of computational science and applications, where methods are used and developed that can ‘learn’ from data to solve specific tasks. In classicial machine learning these tasks are mostly related to classification. Machine Learning, of short ML, is considered a subfield of Artificial Intelligence and is considered as methods (or models / algorithms) that are trained on (sample) data to to make predictions or or decisions, without explicitly being programmed to do so. The following figure tries to convey the difference between classical problem solving using a rule based approach and modern ML.
For a gently introduction see <a href="https://en.wikipedia.org/wiki/Machine_learning">this wiki page</a></p>
</div>
<div id="learning-more-tame" class="section level2">
<h2>Learning more; TAME</h2>
<p>If after this course you would like to learn more about applying ML in Toxicology, the <a href="https://github.com/UNCSRP/Data-Analysis-Training-Modules">The TAME Toolkit</a> for Introductory Data Science, Chemical-Biological Analyses, Predictive Modeling, and Database Mining for Environmental Health Research is a good place to start learning. Some of the examples in this lesson were taken from <a href="https://uncsrp.github.io/Data-Analysis-Training-Modules/machine-learning-and-predictive-modeling.html#machine-learning-and-predictive-modeling">chapter 2.2 of the TAME Bookdown project</a></p>
<p><a href="https://doi.org/10.3389/ftox.2022.893924">Reference:</a> Roell, K., Koval, L. E., Boyles, R., Patlewicz, G., Ring, C., Rider, C. V., Ward-Caviness, C., Reif, D. M., Jaspers, I., Fry, R. C., &amp; Rager, J. E. (2022). Development of the InTelligence And Machine LEarning (TAME) Toolkit for Introductory Data Science, Chemical-Biological Analyses, Predictive Modeling, and Database Mining for Environmental Health Research. Frontiers in toxicology, 4, 893924. <a href="https://doi.org/10.3389/ftox.2022.893924" class="uri">https://doi.org/10.3389/ftox.2022.893924</a></p>
</div>
<div id="tidymodels" class="section level2">
<h2>Tidymodels</h2>
<p>The Tidymodels framework is an extension of the <code>{tidyverse}</code> suite. It is especially focused towards providing a generalized way to define, run and optimize models in R. To get started we will walk you though the ‘getting started’ part of the <a href="https://www.tidymodels.org/start/">Tidymodels documentation</a></p>
<p>To learn more on Tidymodels, there is a very elaborate <a href="https://www.tmwr.org">bookdown project</a></p>
</div>
<div id="packages" class="section level2">
<h2>Packages</h2>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="part-2-machine-learning-with-r.html#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code></pre></div>
<pre><code>## ── Attaching packages ────────────────────────────────────── tidymodels 1.0.0 ──</code></pre>
<pre><code>## ✔ broom        1.0.4          ✔ recipes      1.0.6     
## ✔ dials        1.1.0          ✔ rsample      1.1.1     
## ✔ dplyr        1.1.1.9000     ✔ tibble       3.2.1     
## ✔ ggplot2      3.4.1          ✔ tidyr        1.3.0     
## ✔ infer        1.0.4          ✔ tune         1.0.1     
## ✔ modeldata    1.1.0          ✔ workflows    1.1.3     
## ✔ parsnip      1.0.4          ✔ workflowsets 1.0.0     
## ✔ purrr        1.0.1          ✔ yardstick    1.1.0</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
## ✖ purrr::discard() masks scales::discard()
## ✖ dplyr::filter()  masks stats::filter()
## ✖ dplyr::lag()     masks stats::lag()
## ✖ recipes::step()  masks stats::step()
## • Dig deeper into tidy modeling with R at https://www.tmwr.org</code></pre>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="part-2-machine-learning-with-r.html#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<pre><code>## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
## ✔ forcats   1.0.0          ✔ readr     2.1.4.9000
## ✔ lubridate 1.9.2          ✔ stringr   1.5.0.9000</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ readr::col_factor() masks scales::col_factor()
## ✖ purrr::discard()    masks scales::discard()
## ✖ dplyr::filter()     masks stats::filter()
## ✖ stringr::fixed()    masks recipes::fixed()
## ✖ dplyr::lag()        masks stats::lag()
## ✖ readr::spec()       masks yardstick::spec()
## ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="part-2-machine-learning-with-r.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom.mixed) <span class="co"># for converting bayesian models to tidy tibbles</span></span>
<span id="cb206-2"><a href="part-2-machine-learning-with-r.html#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dotwhisker)  <span class="co">#</span></span></code></pre></div>
</div>
<div id="data" class="section level2">
<h2>Data</h2>
<p>For this lesson we will use a number of different datasets. Because we need datasets that include somewhat larger volumes of data, we also download data on the fly.</p>
<p>Let’s get the datasets</p>
<div id="sea-urchins" class="section level3">
<h3>Sea Urchins</h3>
<p>A dataset build into the <code>{tidymodels}</code> documentation for illustrative purposes. See <a href="https://www.tidymodels.org/start/models/">original resource:</a></p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="part-2-machine-learning-with-r.html#cb207-1" aria-hidden="true" tabindex="-1"></a>urchins <span class="ot">&lt;-</span></span>
<span id="cb207-2"><a href="part-2-machine-learning-with-r.html#cb207-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data were assembled for a tutorial </span></span>
<span id="cb207-3"><a href="part-2-machine-learning-with-r.html#cb207-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># at https://www.flutterbys.com.au/stats/tut/tut7.5a.html</span></span>
<span id="cb207-4"><a href="part-2-machine-learning-with-r.html#cb207-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(<span class="st">&quot;https://tidymodels.org/start/models/urchins.csv&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb207-5"><a href="part-2-machine-learning-with-r.html#cb207-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Change the names to be a little more verbose</span></span>
<span id="cb207-6"><a href="part-2-machine-learning-with-r.html#cb207-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;food_regime&quot;</span>, <span class="st">&quot;initial_volume&quot;</span>, <span class="st">&quot;width&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb207-7"><a href="part-2-machine-learning-with-r.html#cb207-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Factors are very helpful for modeling, so we convert one column</span></span>
<span id="cb207-8"><a href="part-2-machine-learning-with-r.html#cb207-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">food_regime =</span> <span class="fu">factor</span>(food_regime, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Initial&quot;</span>, <span class="st">&quot;Low&quot;</span>, <span class="st">&quot;High&quot;</span>)))</span></code></pre></div>
<pre><code>## Rows: 72 Columns: 3
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr (1): TREAT
## dbl (2): IV, SUTW
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="part-2-machine-learning-with-r.html#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Rows: 72 Columns: 3</span></span>
<span id="cb209-2"><a href="part-2-machine-learning-with-r.html#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ── Column specification ──────────────────────────────────────────────</span></span>
<span id="cb209-3"><a href="part-2-machine-learning-with-r.html#cb209-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Delimiter: &quot;,&quot;</span></span>
<span id="cb209-4"><a href="part-2-machine-learning-with-r.html#cb209-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; chr (1): TREAT</span></span>
<span id="cb209-5"><a href="part-2-machine-learning-with-r.html#cb209-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; dbl (2): IV, SUTW</span></span>
<span id="cb209-6"><a href="part-2-machine-learning-with-r.html#cb209-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb209-7"><a href="part-2-machine-learning-with-r.html#cb209-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ℹ Use `spec()` to retrieve the full column specification for this data.</span></span>
<span id="cb209-8"><a href="part-2-machine-learning-with-r.html#cb209-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</span></span></code></pre></div>
</div>
<div id="chemical_lists_pfas-statins-from-the-epa" class="section level3">
<h3>Chemical_Lists_PFAS-Statins from the EPA</h3>
<p>This datset was curated and povided in the TAME project mentioned above
It can be directly downloaded from Github</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="part-2-machine-learning-with-r.html#cb210-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">&quot;https://raw.githubusercontent.com/UNCSRP/Data-Analysis-Training-Modules/main/Chapter%202/2.2%20ML%20Predictive%20Modeling/Module2_2_Chemical_Lists_PFAS-Statins.csv&quot;</span></span>
<span id="cb210-2"><a href="part-2-machine-learning-with-r.html#cb210-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-3"><a href="part-2-machine-learning-with-r.html#cb210-3" aria-hidden="true" tabindex="-1"></a>data_tame <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb210-4"><a href="part-2-machine-learning-with-r.html#cb210-4" aria-hidden="true" tabindex="-1"></a>    url, </span>
<span id="cb210-5"><a href="part-2-machine-learning-with-r.html#cb210-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">locale =</span> readr<span class="sc">::</span><span class="fu">locale</span>(<span class="at">encoding =</span><span class="st">&quot;UTF-8&quot;</span>)</span>
<span id="cb210-6"><a href="part-2-machine-learning-with-r.html#cb210-6" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<pre><code>## Rows: 144 Columns: 14
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr  (4): List, Substance Name, CASRN, DTXSID
## dbl (10): Molecular Weight, OPERA, Boiling Point, OPERA, Henry&#39;s Law Constan...
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div id="tox21-end-chembl-using-the-biobricks.ai-bricks" class="section level3">
<h3>Tox21 end Chembl, using the <a href="https://biobricks.ai/">biobricks.ai bricks</a></h3>
<p>Biobricks.ai is developed by researcher Dr. Tom Luechtefeld as a ‘data-as-dependency’ approach. By integrating large public databases into so-called bricks, the database data can be accessed through a standardized api and downloaded to a local machine or Virtual Machine. The bricks are version controlled, so this enables a reproducible workflow.
We will not use this data in this lesson, but it will get you started in finding and downloading data for your own modelling purposes. To get started on Biobricks, the code below will get you the ‘tox21’ brick.</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="part-2-machine-learning-with-r.html#cb212-1" aria-hidden="true" tabindex="-1"></a>biobricks<span class="sc">::</span><span class="fu">local_bblib</span>()</span>
<span id="cb212-2"><a href="part-2-machine-learning-with-r.html#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="fu">initialize</span>()</span>
<span id="cb212-3"><a href="part-2-machine-learning-with-r.html#cb212-3" aria-hidden="true" tabindex="-1"></a><span class="fu">brick_install</span>(<span class="st">&quot;tox21&quot;</span>)</span>
<span id="cb212-4"><a href="part-2-machine-learning-with-r.html#cb212-4" aria-hidden="true" tabindex="-1"></a><span class="fu">brick_pull</span>(<span class="st">&quot;tox21&quot;</span>) <span class="co"># OR build it with brick_repro(&quot;HGNC&quot;)</span></span>
<span id="cb212-5"><a href="part-2-machine-learning-with-r.html#cb212-5" aria-hidden="true" tabindex="-1"></a>tbls <span class="ot">&lt;-</span> <span class="fu">brick_load_arrow</span>(<span class="st">&quot;tox21&quot;</span>)</span>
<span id="cb212-6"><a href="part-2-machine-learning-with-r.html#cb212-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tbls) <span class="co"># &quot;hgnc_complete_set.parquet&quot;</span></span>
<span id="cb212-7"><a href="part-2-machine-learning-with-r.html#cb212-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-8"><a href="part-2-machine-learning-with-r.html#cb212-8" aria-hidden="true" tabindex="-1"></a><span class="do">## look at one table</span></span>
<span id="cb212-9"><a href="part-2-machine-learning-with-r.html#cb212-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-10"><a href="part-2-machine-learning-with-r.html#cb212-10" aria-hidden="true" tabindex="-1"></a>tox21_tbls  <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">imap_dfr</span>(tbls,<span class="sc">~</span> <span class="fu">tibble</span>(<span class="at">tbl=</span>.y,<span class="at">rows=</span><span class="fu">nrow</span>(.x))) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(rows))</span>
<span id="cb212-11"><a href="part-2-machine-learning-with-r.html#cb212-11" aria-hidden="true" tabindex="-1"></a>tox21_names <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">imap_dfr</span>(tbls,<span class="sc">~</span> <span class="fu">tibble</span>(<span class="at">tbl=</span>.y,<span class="at">name=</span><span class="fu">names</span>(.x)))</span>
<span id="cb212-12"><a href="part-2-machine-learning-with-r.html#cb212-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-13"><a href="part-2-machine-learning-with-r.html#cb212-13" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> tox21_names <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">&quot;ID$&quot;</span>,name))</span>
<span id="cb212-14"><a href="part-2-machine-learning-with-r.html#cb212-14" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> ids <span class="sc">|&gt;</span> <span class="fu">split</span>(ids<span class="sc">$</span>name) <span class="sc">|&gt;</span> <span class="fu">discard</span>(<span class="sc">~</span><span class="fu">nrow</span>(.)<span class="sc">&lt;</span><span class="dv">2</span>) </span>
<span id="cb212-15"><a href="part-2-machine-learning-with-r.html#cb212-15" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ids)</span>
<span id="cb212-16"><a href="part-2-machine-learning-with-r.html#cb212-16" aria-hidden="true" tabindex="-1"></a>tox21_names </span>
<span id="cb212-17"><a href="part-2-machine-learning-with-r.html#cb212-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-18"><a href="part-2-machine-learning-with-r.html#cb212-18" aria-hidden="true" tabindex="-1"></a><span class="do">## look at one table</span></span>
<span id="cb212-19"><a href="part-2-machine-learning-with-r.html#cb212-19" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> tbls<span class="sc">$</span><span class="st">`</span><span class="at">tox21-ache-p3.aggregrated.parquet</span><span class="st">`</span> <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">collect</span>()</span>
<span id="cb212-20"><a href="part-2-machine-learning-with-r.html#cb212-20" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb212-21"><a href="part-2-machine-learning-with-r.html#cb212-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-22"><a href="part-2-machine-learning-with-r.html#cb212-22" aria-hidden="true" tabindex="-1"></a>data_all <span class="ot">&lt;-</span> </span>
<span id="cb212-23"><a href="part-2-machine-learning-with-r.html#cb212-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(</span>
<span id="cb212-24"><a href="part-2-machine-learning-with-r.html#cb212-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">.x =</span> tbls,</span>
<span id="cb212-25"><a href="part-2-machine-learning-with-r.html#cb212-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> dplyr<span class="sc">::</span>collect</span>
<span id="cb212-26"><a href="part-2-machine-learning-with-r.html#cb212-26" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
</div>
<div id="qsar-data" class="section level2">
<h2>QSAR data</h2>
<p>An example dataset that contains classical chemical fingerprints.
<a href="https://archive.ics.uci.edu/ml/datasets/QSAR+oral+toxicity">From the UCL repository</a></p>
<p>Metadata:
Attribute Information:</p>
<p>1024 binary molecular fingerprints and 1 experimental class:
1-1024) binary molecular fingerprint
1025) experimental class: positive (very toxic) and negative (not very toxic)</p>
<p>Relevant Papers:</p>
<p><a href="https://doi.org/10.1002/minf.201800124">D. Ballabio, F. Grisoni, V. Consonni, R. Todeschini (2019), Integrated QSAR models to predict acute oral systemic toxicity, Molecular Informatics, 38, 180012; doi: 10.1002/minf.201800124</a></p>
<p>Files <code>ID.txt</code>,<code>class.csv</code> and <code>X.csv</code> in folder <code>./data/lesson5/qsar</code> were obtained from the author of the paper above via personal communication. Orinal sources files (Matlab scripts and matrix files can be downloaded from the paper’s DOI as supplemental data). They are included here for reproducibility reasons in <code>./data/lesson5/qsar/oral_toxicity_data.rar</code></p>
<p>The code below downloads the data to a the <code>./data</code> folder and unzips the file in a temporary folder. We read the file into R from that temp file.</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="part-2-machine-learning-with-r.html#cb213-1" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb213-2"><a href="part-2-machine-learning-with-r.html#cb213-2" aria-hidden="true" tabindex="-1"></a>  base_folder,</span>
<span id="cb213-3"><a href="part-2-machine-learning-with-r.html#cb213-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;data&quot;</span>,</span>
<span id="cb213-4"><a href="part-2-machine-learning-with-r.html#cb213-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;qsar_oral_toxicity.zip&quot;</span></span>
<span id="cb213-5"><a href="part-2-machine-learning-with-r.html#cb213-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb213-6"><a href="part-2-machine-learning-with-r.html#cb213-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-7"><a href="part-2-machine-learning-with-r.html#cb213-7" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="at">url =</span> <span class="st">&quot;https://archive.ics.uci.edu/ml/machine-learning-databases/00508/qsar_oral_toxicity.zip&quot;</span>, <span class="at">destfile =</span> path)</span>
<span id="cb213-8"><a href="part-2-machine-learning-with-r.html#cb213-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-9"><a href="part-2-machine-learning-with-r.html#cb213-9" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(<span class="at">zipfile =</span> path, <span class="at">exdir =</span> here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb213-10"><a href="part-2-machine-learning-with-r.html#cb213-10" aria-hidden="true" tabindex="-1"></a>  base_folder, <span class="st">&quot;data&quot;</span>)</span>
<span id="cb213-11"><a href="part-2-machine-learning-with-r.html#cb213-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="getting-started-with-tidymodels" class="section level2">
<h2>Getting started with <code>{tidymodels}</code></h2>
<p>The fragment below was reproduced from <a href="https://www.tidymodels.org/start/models/">the <code>tidymodels</code> documentation</a></p>
<div id="build-our-first-model-with-tidymodels" class="section level3">
<h3>Build our first model with Tidymodels</h3>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="part-2-machine-learning-with-r.html#cb214-1" aria-hidden="true" tabindex="-1"></a>urchins</span></code></pre></div>
<pre><code>## # A tibble: 72 × 3
##    food_regime initial_volume width
##    &lt;fct&gt;                &lt;dbl&gt; &lt;dbl&gt;
##  1 Initial                3.5 0.01 
##  2 Initial                5   0.02 
##  3 Initial                8   0.061
##  4 Initial               10   0.051
##  5 Initial               13   0.041
##  6 Initial               13   0.061
##  7 Initial               15   0.041
##  8 Initial               15   0.071
##  9 Initial               16   0.092
## 10 Initial               17   0.051
## # ℹ 62 more rows</code></pre>
<p>Plotting the data
As a first step in modeling, it’s always a good idea to plot the data:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="part-2-machine-learning-with-r.html#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(urchins,</span>
<span id="cb216-2"><a href="part-2-machine-learning-with-r.html#cb216-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> initial_volume, </span>
<span id="cb216-3"><a href="part-2-machine-learning-with-r.html#cb216-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> width, </span>
<span id="cb216-4"><a href="part-2-machine-learning-with-r.html#cb216-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">group =</span> food_regime, </span>
<span id="cb216-5"><a href="part-2-machine-learning-with-r.html#cb216-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">col =</span> food_regime)) <span class="sc">+</span> </span>
<span id="cb216-6"><a href="part-2-machine-learning-with-r.html#cb216-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb216-7"><a href="part-2-machine-learning-with-r.html#cb216-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> lm, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb216-8"><a href="part-2-machine-learning-with-r.html#cb216-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>, <span class="at">end =</span> .<span class="dv">7</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="part-2-machine-learning-with-r.html#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `geom_smooth()` using formula &#39;y ~ x&#39;</span></span></code></pre></div>
<p>A standard two-way analysis of variance (ANOVA) model makes sense for this dataset because we have both a continuous predictor and a categorical predictor. Since the slopes appear to be different for at least two of the feeding regimes, let’s build a model that allows for two-way interactions. Specifying an R formula with our variables in this way:</p>
<p><span class="math inline">\(width \sim initial\_volume * food\_regime\)</span>, where the <span class="math inline">\(\sim\)</span> means ‘is dependent on’.</p>
<p>The <code>{parsnip}</code> package allows to specify models like this in consistent way. Here we will use the <code>lin_reg()</code> engine of <code>{parnsip}</code> to define the model engine, the type of regression and the model definition as showed in the formula above.</p>
<p>If we put this together we can define the linear regression model (using the ‘ordinal least squares’ engine) as:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="part-2-machine-learning-with-r.html#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="fu">linear_reg</span>() <span class="sc">|&gt;</span></span>
<span id="cb219-2"><a href="part-2-machine-learning-with-r.html#cb219-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;lm&quot;</span>)</span></code></pre></div>
<pre><code>## Linear Regression Model Specification (regression)
## 
## Computational engine: lm</code></pre>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="part-2-machine-learning-with-r.html#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="do">## because &quot;lm&quot; is the default engine this is the same as</span></span>
<span id="cb221-2"><a href="part-2-machine-learning-with-r.html#cb221-2" aria-hidden="true" tabindex="-1"></a><span class="fu">linear_reg</span>()</span></code></pre></div>
<pre><code>## Linear Regression Model Specification (regression)
## 
## Computational engine: lm</code></pre>
<p>We can choose a different computational ‘engine’ as</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="part-2-machine-learning-with-r.html#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="fu">linear_reg</span>() <span class="sc">|&gt;</span></span>
<span id="cb223-2"><a href="part-2-machine-learning-with-r.html#cb223-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;keras&quot;</span>)</span></code></pre></div>
<pre><code>## Linear Regression Model Specification (regression)
## 
## Computational engine: keras</code></pre>
<p>The <a href="https://parsnip.tidymodels.org/reference/linear_reg.html">documentation page</a> for <code>linear_reg()</code> lists all the possible engines. We’ll save our model object using the default engine as lm_mod.</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="part-2-machine-learning-with-r.html#cb225-1" aria-hidden="true" tabindex="-1"></a>lm_mod <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>()</span></code></pre></div>
<p>From here, the model can be estimated or trained using the fit() function:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="part-2-machine-learning-with-r.html#cb226-1" aria-hidden="true" tabindex="-1"></a>lm_fit <span class="ot">&lt;-</span> </span>
<span id="cb226-2"><a href="part-2-machine-learning-with-r.html#cb226-2" aria-hidden="true" tabindex="-1"></a>  lm_mod <span class="sc">%&gt;%</span> </span>
<span id="cb226-3"><a href="part-2-machine-learning-with-r.html#cb226-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(width <span class="sc">~</span> initial_volume <span class="sc">*</span> food_regime, <span class="at">data =</span> urchins)</span>
<span id="cb226-4"><a href="part-2-machine-learning-with-r.html#cb226-4" aria-hidden="true" tabindex="-1"></a>lm_fit</span></code></pre></div>
<pre><code>## parsnip model object
## 
## 
## Call:
## stats::lm(formula = width ~ initial_volume * food_regime, data = data)
## 
## Coefficients:
##                    (Intercept)                  initial_volume  
##                      0.0331216                       0.0015546  
##                 food_regimeLow                 food_regimeHigh  
##                      0.0197824                       0.0214111  
##  initial_volume:food_regimeLow  initial_volume:food_regimeHigh  
##                     -0.0012594                       0.0005254</code></pre>
<p>We can get the model summary using the <code>summary()</code> function, but a more tidy output will be achieved if we use the <code>tidy()</code> function.</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="part-2-machine-learning-with-r.html#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(lm_fit)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 5
##   term                            estimate std.error statistic  p.value
##   &lt;chr&gt;                              &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)                     0.0331    0.00962      3.44  0.00100 
## 2 initial_volume                  0.00155   0.000398     3.91  0.000222
## 3 food_regimeLow                  0.0198    0.0130       1.52  0.133   
## 4 food_regimeHigh                 0.0214    0.0145       1.47  0.145   
## 5 initial_volume:food_regimeLow  -0.00126   0.000510    -2.47  0.0162  
## 6 initial_volume:food_regimeHigh  0.000525  0.000702     0.748 0.457</code></pre>
<p>If you like to see a visual representation of the model results, which can be handy to e.g. compare models.</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="part-2-machine-learning-with-r.html#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(lm_fit) <span class="sc">%&gt;%</span> </span>
<span id="cb230-2"><a href="part-2-machine-learning-with-r.html#cb230-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dwplot</span>(<span class="at">dot_args =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>),</span>
<span id="cb230-3"><a href="part-2-machine-learning-with-r.html#cb230-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">whisker_args =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>),</span>
<span id="cb230-4"><a href="part-2-machine-learning-with-r.html#cb230-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">vline =</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="st">&quot;grey50&quot;</span>, <span class="at">linetype =</span> <span class="dv">2</span>))</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>This fitted object lm_fit has the lm model output built-in, which you can access with lm_fit$fit, but there are some benefits to using the fitted parsnip model object when it comes to predicting.</p>
<p>Suppose that, for a publication, it would be particularly interesting to make a plot of the mean body size for urchins that started the experiment with an initial volume of 20ml. To create such a graph, we start with some new example data that we will make predictions for, to show in our graph:</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="part-2-machine-learning-with-r.html#cb231-1" aria-hidden="true" tabindex="-1"></a>new_points <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">initial_volume =</span> <span class="dv">20</span>, </span>
<span id="cb231-2"><a href="part-2-machine-learning-with-r.html#cb231-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">food_regime =</span> <span class="fu">c</span>(<span class="st">&quot;Initial&quot;</span>, <span class="st">&quot;Low&quot;</span>, <span class="st">&quot;High&quot;</span>))</span>
<span id="cb231-3"><a href="part-2-machine-learning-with-r.html#cb231-3" aria-hidden="true" tabindex="-1"></a>new_points</span></code></pre></div>
<pre><code>##   initial_volume food_regime
## 1             20     Initial
## 2             20         Low
## 3             20        High</code></pre>
<p>To get our predicted results, we can use the predict() function to find the mean values at 20ml.</p>
<p>It is also important to communicate the variability, so we also need to find the predicted confidence intervals. If we had used <code>lm()</code> to fit the model directly, a few minutes of reading the documentation page for <code>predict.lm()</code> would explain how to do this. However, if we decide to use a different model to estimate urchin size, it is likely that a completely different syntax would be required.</p>
<p>This is the strength of <code>{tidymodels}</code>. It provides a single interface and modelling syntax, to build many different types of models. With <code>{tidymodels}</code>, the types of predicted values are standardized so that we can use the same syntax to get these values.</p>
<p>First, let’s generate the mean body width values:</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="part-2-machine-learning-with-r.html#cb233-1" aria-hidden="true" tabindex="-1"></a>mean_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm_fit, <span class="at">new_data =</span> new_points)</span>
<span id="cb233-2"><a href="part-2-machine-learning-with-r.html#cb233-2" aria-hidden="true" tabindex="-1"></a>mean_pred</span></code></pre></div>
<pre><code>## # A tibble: 3 × 1
##    .pred
##    &lt;dbl&gt;
## 1 0.0642
## 2 0.0588
## 3 0.0961</code></pre>
<p>When making predictions, the tidymodels convention is to always produce a tibble of results with standardized column names. This makes it easy to combine the original data and the predictions in a usable format:</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="part-2-machine-learning-with-r.html#cb235-1" aria-hidden="true" tabindex="-1"></a>conf_int_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm_fit, </span>
<span id="cb235-2"><a href="part-2-machine-learning-with-r.html#cb235-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">new_data =</span> new_points, </span>
<span id="cb235-3"><a href="part-2-machine-learning-with-r.html#cb235-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type =</span> <span class="st">&quot;conf_int&quot;</span>)</span>
<span id="cb235-4"><a href="part-2-machine-learning-with-r.html#cb235-4" aria-hidden="true" tabindex="-1"></a>conf_int_pred</span></code></pre></div>
<pre><code>## # A tibble: 3 × 2
##   .pred_lower .pred_upper
##         &lt;dbl&gt;       &lt;dbl&gt;
## 1      0.0555      0.0729
## 2      0.0499      0.0678
## 3      0.0870      0.105</code></pre>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="part-2-machine-learning-with-r.html#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now combine: </span></span>
<span id="cb237-2"><a href="part-2-machine-learning-with-r.html#cb237-2" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> </span>
<span id="cb237-3"><a href="part-2-machine-learning-with-r.html#cb237-3" aria-hidden="true" tabindex="-1"></a>  new_points <span class="sc">%&gt;%</span> </span>
<span id="cb237-4"><a href="part-2-machine-learning-with-r.html#cb237-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(mean_pred) <span class="sc">%&gt;%</span> </span>
<span id="cb237-5"><a href="part-2-machine-learning-with-r.html#cb237-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(conf_int_pred)</span>
<span id="cb237-6"><a href="part-2-machine-learning-with-r.html#cb237-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-7"><a href="part-2-machine-learning-with-r.html#cb237-7" aria-hidden="true" tabindex="-1"></a><span class="co"># and plot:</span></span>
<span id="cb237-8"><a href="part-2-machine-learning-with-r.html#cb237-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> food_regime)) <span class="sc">+</span> </span>
<span id="cb237-9"><a href="part-2-machine-learning-with-r.html#cb237-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> .pred)) <span class="sc">+</span> </span>
<span id="cb237-10"><a href="part-2-machine-learning-with-r.html#cb237-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .pred_lower, </span>
<span id="cb237-11"><a href="part-2-machine-learning-with-r.html#cb237-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax =</span> .pred_upper),</span>
<span id="cb237-12"><a href="part-2-machine-learning-with-r.html#cb237-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> .<span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb237-13"><a href="part-2-machine-learning-with-r.html#cb237-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;urchin size&quot;</span>) <span class="sc">+</span></span>
<span id="cb237-14"><a href="part-2-machine-learning-with-r.html#cb237-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Ordinal least squares linear regression&quot;</span>) <span class="ot">-&gt;</span> p_lm</span>
<span id="cb237-15"><a href="part-2-machine-learning-with-r.html#cb237-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-16"><a href="part-2-machine-learning-with-r.html#cb237-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-17"><a href="part-2-machine-learning-with-r.html#cb237-17" aria-hidden="true" tabindex="-1"></a>p_lm</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>Of course, we will demo how we can choose a different modelling engine. As said, we do not need to change the syntax, when we use <code>{tidymodels}</code>.</p>
<p>The <a href="https://github.com/stan-dev/rstanarm">documentation</a> on the <code>{rstanarm}</code> package shows us that the <code>stan_glm()</code> function can be used to estimate this model, and that the function arguments that need to be specified are called prior and prior_intercept. If we were to use <code>stan_glm()</code>, we would need to change our syntax to model the <code>urchin</code> data with this <code>{rstanarm}</code> engine. It turns out that <code>linear_reg()</code> has a stan engine. Since these prior distribution arguments are specific to the Stan software, they are passed as arguments to parsnip::set_engine(). If we want to use this engine, we need to install the <code>{rstanarm}</code> package, in order for tidymodels to be able to use the engine under the hood</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="part-2-machine-learning-with-r.html#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;rstanarm&quot;)</span></span>
<span id="cb238-2"><a href="part-2-machine-learning-with-r.html#cb238-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span></code></pre></div>
<pre><code>## Loading required package: Rcpp</code></pre>
<pre><code>## 
## Attaching package: &#39;Rcpp&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:rsample&#39;:
## 
##     populate</code></pre>
<pre><code>## This is rstanarm version 2.21.4</code></pre>
<pre><code>## - See https://mc-stan.org/rstanarm/articles/priors for changes to default priors!</code></pre>
<pre><code>## - Default priors may change, so it&#39;s safest to specify priors, even if equivalent to the defaults.</code></pre>
<pre><code>## - For execution on a local, multicore CPU with excess RAM we recommend calling</code></pre>
<pre><code>##   options(mc.cores = parallel::detectCores())</code></pre>
<p>After that, the same exact fit() call is used:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="part-2-machine-learning-with-r.html#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set the prior distribution</span></span>
<span id="cb247-2"><a href="part-2-machine-learning-with-r.html#cb247-2" aria-hidden="true" tabindex="-1"></a>prior_dist <span class="ot">&lt;-</span> rstanarm<span class="sc">::</span><span class="fu">student_t</span>(<span class="at">df =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>Now we can fir our model, using a Bayesian modelling engine.</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="part-2-machine-learning-with-r.html#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb248-2"><a href="part-2-machine-learning-with-r.html#cb248-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-3"><a href="part-2-machine-learning-with-r.html#cb248-3" aria-hidden="true" tabindex="-1"></a><span class="co"># make the parsnip model</span></span>
<span id="cb248-4"><a href="part-2-machine-learning-with-r.html#cb248-4" aria-hidden="true" tabindex="-1"></a>bayes_mod <span class="ot">&lt;-</span>   </span>
<span id="cb248-5"><a href="part-2-machine-learning-with-r.html#cb248-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb248-6"><a href="part-2-machine-learning-with-r.html#cb248-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;stan&quot;</span>, </span>
<span id="cb248-7"><a href="part-2-machine-learning-with-r.html#cb248-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">prior_intercept =</span> prior_dist, </span>
<span id="cb248-8"><a href="part-2-machine-learning-with-r.html#cb248-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">prior =</span> prior_dist) </span>
<span id="cb248-9"><a href="part-2-machine-learning-with-r.html#cb248-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-10"><a href="part-2-machine-learning-with-r.html#cb248-10" aria-hidden="true" tabindex="-1"></a><span class="co"># train the model</span></span>
<span id="cb248-11"><a href="part-2-machine-learning-with-r.html#cb248-11" aria-hidden="true" tabindex="-1"></a>bayes_fit <span class="ot">&lt;-</span> </span>
<span id="cb248-12"><a href="part-2-machine-learning-with-r.html#cb248-12" aria-hidden="true" tabindex="-1"></a>  bayes_mod <span class="sc">%&gt;%</span> </span>
<span id="cb248-13"><a href="part-2-machine-learning-with-r.html#cb248-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(width <span class="sc">~</span> initial_volume <span class="sc">*</span> food_regime, <span class="at">data =</span> urchins)</span>
<span id="cb248-14"><a href="part-2-machine-learning-with-r.html#cb248-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-15"><a href="part-2-machine-learning-with-r.html#cb248-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bayes_fit, <span class="at">digits =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## parsnip model object
## 
## stan_glm
##  family:       gaussian [identity]
##  formula:      width ~ initial_volume * food_regime
##  observations: 72
##  predictors:   6
## ------
##                                Median   MAD_SD  
## (Intercept)                     0.03336  0.01003
## initial_volume                  0.00156  0.00040
## food_regimeLow                  0.01963  0.01308
## food_regimeHigh                 0.02120  0.01421
## initial_volume:food_regimeLow  -0.00126  0.00051
## initial_volume:food_regimeHigh  0.00054  0.00070
## 
## Auxiliary parameter(s):
##       Median  MAD_SD 
## sigma 0.02129 0.00188
## 
## ------
## * For help interpreting the printed output see ?print.stanreg
## * For info on the priors used see ?prior_summary.stanreg</code></pre>
<p>This kind of Bayesian analysis (like many models) involves randomly generated numbers in its fitting procedure. We can use set.seed() to ensure that the same (pseudo-)random numbers are generated each time we run this code. The number 123 isn’t special or related to our data; it is just a “seed” used to choose random numbers.</p>
<p>To update the parameter table, the tidy() method is once again used:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="part-2-machine-learning-with-r.html#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(bayes_fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 5
##   term                            estimate std.error  conf.low conf.high
##   &lt;chr&gt;                              &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept)                     0.0334    0.0100    0.0179    0.0493  
## 2 initial_volume                  0.00156   0.000404  0.000876  0.00219 
## 3 food_regimeLow                  0.0196    0.0131   -0.00271   0.0414  
## 4 food_regimeHigh                 0.0212    0.0142   -0.00289   0.0455  
## 5 initial_volume:food_regimeLow  -0.00126   0.000515 -0.00213  -0.000364
## 6 initial_volume:food_regimeHigh  0.000541  0.000696 -0.000669  0.00174</code></pre>
<p>A goal of the tidymodels packages is that the interfaces to common tasks are standardized (as seen in the tidy() results above). The same is true for getting predictions; we can use the same code even though the underlying packages use very different syntax:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="part-2-machine-learning-with-r.html#cb252-1" aria-hidden="true" tabindex="-1"></a>bayes_plot_data <span class="ot">&lt;-</span> </span>
<span id="cb252-2"><a href="part-2-machine-learning-with-r.html#cb252-2" aria-hidden="true" tabindex="-1"></a>  new_points <span class="sc">%&gt;%</span> </span>
<span id="cb252-3"><a href="part-2-machine-learning-with-r.html#cb252-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(bayes_fit, <span class="at">new_data =</span> new_points)) <span class="sc">%&gt;%</span> </span>
<span id="cb252-4"><a href="part-2-machine-learning-with-r.html#cb252-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(bayes_fit, <span class="at">new_data =</span> new_points, <span class="at">type =</span> <span class="st">&quot;conf_int&quot;</span>))</span>
<span id="cb252-5"><a href="part-2-machine-learning-with-r.html#cb252-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-6"><a href="part-2-machine-learning-with-r.html#cb252-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bayes_plot_data, <span class="fu">aes</span>(<span class="at">x =</span> food_regime)) <span class="sc">+</span> </span>
<span id="cb252-7"><a href="part-2-machine-learning-with-r.html#cb252-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> .pred)) <span class="sc">+</span> </span>
<span id="cb252-8"><a href="part-2-machine-learning-with-r.html#cb252-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .pred_lower, <span class="at">ymax =</span> .pred_upper), <span class="at">width =</span> .<span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb252-9"><a href="part-2-machine-learning-with-r.html#cb252-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;urchin size&quot;</span>) <span class="sc">+</span> </span>
<span id="cb252-10"><a href="part-2-machine-learning-with-r.html#cb252-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Bayesian model with t(1) prior distribution&quot;</span>) <span class="ot">-&gt;</span> p_bayes</span>
<span id="cb252-11"><a href="part-2-machine-learning-with-r.html#cb252-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-12"><a href="part-2-machine-learning-with-r.html#cb252-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-13"><a href="part-2-machine-learning-with-r.html#cb252-13" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(p_lm, p_bayes)</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>The parsnip package can work with many model types, engines, and arguments. Check out tidymodels.org/find/parsnip to see what is available.</p>
</div>
<div id="preprocssing-the-data-for-modelling-using-recipes" class="section level3">
<h3>Preprocssing the data for modelling using <code>{recipes}</code></h3>
<p>Recipes are built as a series of preprocessing steps, such as:</p>
<ul>
<li>converting qualitative predictors to indicator variables (also known as dummy variables)</li>
<li>transforming data to be on a different scale (e.g., taking the logarithm of a variable)</li>
<li>transforming whole groups of predictors together</li>
<li>extracting key features from raw variables (e.g., getting the day of the week out of a date variable)</li>
</ul>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="part-2-machine-learning-with-r.html#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels) <span class="do">## for the recipes package, along with the rest of tidymodels</span></span>
<span id="cb253-2"><a href="part-2-machine-learning-with-r.html#cb253-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-3"><a href="part-2-machine-learning-with-r.html#cb253-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Helper packages</span></span>
<span id="cb253-4"><a href="part-2-machine-learning-with-r.html#cb253-4" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(c(&quot;nycflights13&quot;, &quot;skimr&quot;))</span></span>
<span id="cb253-5"><a href="part-2-machine-learning-with-r.html#cb253-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nycflights13)    <span class="do">## for flight data</span></span>
<span id="cb253-6"><a href="part-2-machine-learning-with-r.html#cb253-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)      <span class="do">## for variable summaries</span></span>
<span id="cb253-7"><a href="part-2-machine-learning-with-r.html#cb253-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<p>Let’s use the nycflights13 data to predict whether a plane arrives more than 30 minutes late. This data set contains information on 325,819 flights departing near New York City in 2013. Let’s start by loading the data and making a few changes to the variables:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="part-2-machine-learning-with-r.html#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb254-2"><a href="part-2-machine-learning-with-r.html#cb254-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-3"><a href="part-2-machine-learning-with-r.html#cb254-3" aria-hidden="true" tabindex="-1"></a>flight_data <span class="ot">&lt;-</span> </span>
<span id="cb254-4"><a href="part-2-machine-learning-with-r.html#cb254-4" aria-hidden="true" tabindex="-1"></a>  flights <span class="sc">|&gt;</span></span>
<span id="cb254-5"><a href="part-2-machine-learning-with-r.html#cb254-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb254-6"><a href="part-2-machine-learning-with-r.html#cb254-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the arrival delay to a factor</span></span>
<span id="cb254-7"><a href="part-2-machine-learning-with-r.html#cb254-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">arr_delay =</span> <span class="fu">ifelse</span>(arr_delay <span class="sc">&gt;=</span> <span class="dv">30</span>, <span class="st">&quot;late&quot;</span>, <span class="st">&quot;on_time&quot;</span>),</span>
<span id="cb254-8"><a href="part-2-machine-learning-with-r.html#cb254-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">arr_delay =</span> <span class="fu">factor</span>(arr_delay),</span>
<span id="cb254-9"><a href="part-2-machine-learning-with-r.html#cb254-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We will use the date (not date-time) in the recipe below</span></span>
<span id="cb254-10"><a href="part-2-machine-learning-with-r.html#cb254-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> lubridate<span class="sc">::</span><span class="fu">as_date</span>(time_hour)</span>
<span id="cb254-11"><a href="part-2-machine-learning-with-r.html#cb254-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb254-12"><a href="part-2-machine-learning-with-r.html#cb254-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Include the weather data</span></span>
<span id="cb254-13"><a href="part-2-machine-learning-with-r.html#cb254-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(weather, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;time_hour&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb254-14"><a href="part-2-machine-learning-with-r.html#cb254-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Only retain the specific columns we will use</span></span>
<span id="cb254-15"><a href="part-2-machine-learning-with-r.html#cb254-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(dep_time, flight, origin, dest, air_time, distance, </span>
<span id="cb254-16"><a href="part-2-machine-learning-with-r.html#cb254-16" aria-hidden="true" tabindex="-1"></a>         carrier, date, arr_delay, time_hour) <span class="sc">%&gt;%</span> </span>
<span id="cb254-17"><a href="part-2-machine-learning-with-r.html#cb254-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Exclude missing data</span></span>
<span id="cb254-18"><a href="part-2-machine-learning-with-r.html#cb254-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">|&gt;</span></span>
<span id="cb254-19"><a href="part-2-machine-learning-with-r.html#cb254-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For creating models, it is better to have qualitative columns</span></span>
<span id="cb254-20"><a href="part-2-machine-learning-with-r.html#cb254-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># encoded as factors (instead of character strings)</span></span>
<span id="cb254-21"><a href="part-2-machine-learning-with-r.html#cb254-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.character, as.factor) <span class="sc">|&gt;</span> <span class="do">## it is custom to move the &#39;class&#39; column to the first position, as the dependent variable</span></span>
<span id="cb254-22"><a href="part-2-machine-learning-with-r.html#cb254-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(arr_delay, <span class="dv">1</span>)</span></code></pre></div>
<p>We can see that about 16% of the flights in this data set arrived more than 30 minutes late.</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="part-2-machine-learning-with-r.html#cb255-1" aria-hidden="true" tabindex="-1"></a>flight_data <span class="sc">|&gt;</span> </span>
<span id="cb255-2"><a href="part-2-machine-learning-with-r.html#cb255-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(arr_delay) <span class="sc">|&gt;</span></span>
<span id="cb255-3"><a href="part-2-machine-learning-with-r.html#cb255-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>() <span class="ot">-&gt;</span> counts</span>
<span id="cb255-4"><a href="part-2-machine-learning-with-r.html#cb255-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-5"><a href="part-2-machine-learning-with-r.html#cb255-5" aria-hidden="true" tabindex="-1"></a>counts<span class="sc">$</span>n[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">sum</span>(counts<span class="sc">$</span>n) <span class="sc">*</span><span class="dv">100</span></span></code></pre></div>
<pre><code>## [1] 16.12552</code></pre>
<p>Before we start building up our recipe, let’s take a quick look at a few specific variables that will be important for both preprocessing and modeling.</p>
<p>First, notice that the variable we created called arr_delay is a factor variable; it is important that our outcome variable for training a logistic regression model is a factor.</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="part-2-machine-learning-with-r.html#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(flight_data)</span></code></pre></div>
<pre><code>## Rows: 325,819
## Columns: 10
## $ arr_delay &lt;fct&gt; on_time, on_time, late, on_time, on_time, on_time, on_time, …
## $ dep_time  &lt;int&gt; 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 558, 558, …
## $ flight    &lt;int&gt; 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301, 49, 71…
## $ origin    &lt;fct&gt; EWR, LGA, JFK, JFK, LGA, EWR, EWR, LGA, JFK, LGA, JFK, JFK, …
## $ dest      &lt;fct&gt; IAH, IAH, MIA, BQN, ATL, ORD, FLL, IAD, MCO, ORD, PBI, TPA, …
## $ air_time  &lt;dbl&gt; 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149, 158, 3…
## $ distance  &lt;dbl&gt; 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 733, 1028,…
## $ carrier   &lt;fct&gt; UA, UA, AA, B6, DL, UA, B6, EV, B6, AA, B6, B6, UA, UA, AA, …
## $ date      &lt;date&gt; 2013-01-01, 2013-01-01, 2013-01-01, 2013-01-01, 2013-01-01,…
## $ time_hour &lt;dttm&gt; 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-01 05:00:…</code></pre>
<p>If we want to explore the data further, we can use the <code>skim()</code> function</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="part-2-machine-learning-with-r.html#cb259-1" aria-hidden="true" tabindex="-1"></a>flight_data <span class="sc">%&gt;%</span> </span>
<span id="cb259-2"><a href="part-2-machine-learning-with-r.html#cb259-2" aria-hidden="true" tabindex="-1"></a>  skimr<span class="sc">::</span><span class="fu">skim</span>(dest, carrier) <span class="sc">|&gt;</span> DT<span class="sc">::</span><span class="fu">datatable</span>()</span></code></pre></div>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-9eceb20dc2a931752ae4" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9eceb20dc2a931752ae4">{"x":{"filter":"none","vertical":false,"data":[["1","2"],["factor","factor"],["dest","carrier"],[0,0],[1,1],[false,false],[104,16],["ATL: 16771, ORD: 16507, LAX: 15942, BOS: 14948","UA: 57489, B6: 53715, EV: 50868, DL: 47465"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>skim_type<\/th>\n      <th>skim_variable<\/th>\n      <th>n_missing<\/th>\n      <th>complete_rate<\/th>\n      <th>factor.ordered<\/th>\n      <th>factor.n_unique<\/th>\n      <th>factor.top_counts<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
<p>These two variables are what we call zero variance variables. They contain information on the rows in the form of ids for the destionation and the carrier. We can use these types of variables to identify problems later.</p>
<p>To get started, let’s split this single dataset into two: a training set and a testing set. We’ll keep most of the rows in the original dataset (subset chosen randomly) in the training set. The training data will be used to fit the model, and the testing set will be used to measure model performance.</p>
<p>To do this, we can use the <code>{rsample}</code> package to create an object that contains the information on how to split the data, and then two more <code>{rsample}</code> functions to create data frames for the training and testing sets:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="part-2-machine-learning-with-r.html#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb260-2"><a href="part-2-machine-learning-with-r.html#cb260-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix the random numbers by setting the seed </span></span>
<span id="cb260-3"><a href="part-2-machine-learning-with-r.html#cb260-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This enables the analysis to be reproducible when random numbers are used </span></span>
<span id="cb260-4"><a href="part-2-machine-learning-with-r.html#cb260-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">222</span>)</span>
<span id="cb260-5"><a href="part-2-machine-learning-with-r.html#cb260-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Put 3/4 of the data into the training set </span></span>
<span id="cb260-6"><a href="part-2-machine-learning-with-r.html#cb260-6" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(flight_data, <span class="at">prop =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb260-7"><a href="part-2-machine-learning-with-r.html#cb260-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-8"><a href="part-2-machine-learning-with-r.html#cb260-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frames for the two sets:</span></span>
<span id="cb260-9"><a href="part-2-machine-learning-with-r.html#cb260-9" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb260-10"><a href="part-2-machine-learning-with-r.html#cb260-10" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span></code></pre></div>
</div>
</div>
<div id="recipe" class="section level2">
<h2>Create recipe and roles</h2>
<p>To get started, let’s create a recipe for a simple logistic regression model. Before training the model, we can use a recipe to create a few new predictors and conduct some preprocessing required by the model.</p>
<p>Let’s initiate a new recipe:</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="part-2-machine-learning-with-r.html#cb261-1" aria-hidden="true" tabindex="-1"></a>flights_rec <span class="ot">&lt;-</span> </span>
<span id="cb261-2"><a href="part-2-machine-learning-with-r.html#cb261-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(arr_delay <span class="sc">~</span> ., <span class="at">data =</span> train_data) </span></code></pre></div>
<p>The <a href="https://recipes.tidymodels.org/reference/recipe.html"><code>recipe()</code> function</a> as we used it here has two arguments:</p>
<ul>
<li><p>A <strong>formula</strong>. Any variable on the left-hand side of the tilde (<code>~</code>) is considered the model outcome (here, <code>arr_delay</code>). On the right-hand side of the tilde are the predictors. Variables may be listed by name, or you can use the dot (<code>.</code>) to indicate all other variables as predictors.</p></li>
<li><p>The <strong>data</strong>. A recipe is associated with the data set used to create the model. This will typically be the <em>training</em> set, so <code>data = train_data</code> here.</p></li>
</ul>
<p>Now we can add <a href="https://recipes.tidymodels.org/reference/roles.html">roles</a> to this recipe. We can use the <a href="https://recipes.tidymodels.org/reference/roles.html"><code>update_role()</code> function</a> to let recipes know that <code>flight</code> and <code>time_hour</code> are variables with a custom role that we called <code>"ID"</code> (a role can have any character value). Whereas our formula included all variables in the training set other than <code>arr_delay</code> as predictors, this tells the recipe to keep these two variables but not use them as either outcomes or predictors.
This is particularly useful in a reproducible workflow, because we do not need to mutate the data itself to select the predictors. Furthermore, there is no need to copy the dataset as another variable in our R environment.</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="part-2-machine-learning-with-r.html#cb262-1" aria-hidden="true" tabindex="-1"></a>flights_rec <span class="ot">&lt;-</span> </span>
<span id="cb262-2"><a href="part-2-machine-learning-with-r.html#cb262-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(arr_delay <span class="sc">~</span> ., <span class="at">data =</span> train_data) <span class="sc">%&gt;%</span> </span>
<span id="cb262-3"><a href="part-2-machine-learning-with-r.html#cb262-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(flight, time_hour, <span class="at">new_role =</span> <span class="st">&quot;ID&quot;</span>) </span></code></pre></div>
<p>This step of adding roles to a recipe is optional; the purpose of using it here is that those two variables can be retained in the data but not included in the model. This can be convenient when, after the model is fit, we want to investigate some poorly predicted value. These ID columns will be available and can be used to try to understand what went wrong.</p>
<p>To get the current set of variables and roles, use the <code>summary()</code> function:</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="part-2-machine-learning-with-r.html#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(flights_rec)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
##    variable  type      role      source  
##    &lt;chr&gt;     &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
##  1 dep_time  &lt;chr [2]&gt; predictor original
##  2 flight    &lt;chr [2]&gt; ID        original
##  3 origin    &lt;chr [3]&gt; predictor original
##  4 dest      &lt;chr [3]&gt; predictor original
##  5 air_time  &lt;chr [2]&gt; predictor original
##  6 distance  &lt;chr [2]&gt; predictor original
##  7 carrier   &lt;chr [3]&gt; predictor original
##  8 date      &lt;chr [1]&gt; predictor original
##  9 time_hour &lt;chr [1]&gt; ID        original
## 10 arr_delay &lt;chr [3]&gt; outcome   original</code></pre>
</div>
<div id="features" class="section level2">
<h2>Create features</h2>
<p>Now we can start adding steps onto our recipe using the pipe operator. Perhaps it is reasonable for the date of the flight to have an effect on the likelihood of a late arrival. How should the date be encoded into the model? The <code>date</code> column has an R <code>date</code> object so including that column “as is” will mean that the model will convert it to a numeric format equal to the number of days after a reference date:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="part-2-machine-learning-with-r.html#cb265-1" aria-hidden="true" tabindex="-1"></a>flight_data <span class="sc">%&gt;%</span> </span>
<span id="cb265-2"><a href="part-2-machine-learning-with-r.html#cb265-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(date) <span class="sc">%&gt;%</span> </span>
<span id="cb265-3"><a href="part-2-machine-learning-with-r.html#cb265-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">numeric_date =</span> <span class="fu">as.numeric</span>(date)) </span></code></pre></div>
<pre><code>## # A tibble: 364 × 2
##   date       numeric_date
##   &lt;date&gt;            &lt;dbl&gt;
## 1 2013-01-01        15706
## 2 2013-01-02        15707
## 3 2013-01-03        15708
## 4 2013-01-04        15709
## 5 2013-01-05        15710
## # ℹ 359 more rows</code></pre>
<p>It’s possible that the numeric date variable is a good option for modeling; perhaps the model would benefit from a linear trend between the log-odds of a late arrival and the numeric date variable. However, it might be better to add model terms <em>derived</em> from the date that have a better potential to be important to the model. For example, we could derive the following meaningful features from the single <code>date</code> variable:</p>
<ul>
<li>the day of the week,</li>
<li>the month, and</li>
<li>whether or not the date corresponds to a holiday.</li>
</ul>
<p>Let’s do all three of these by adding steps to our recipe:</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="part-2-machine-learning-with-r.html#cb267-1" aria-hidden="true" tabindex="-1"></a>flights_rec <span class="ot">&lt;-</span> </span>
<span id="cb267-2"><a href="part-2-machine-learning-with-r.html#cb267-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(arr_delay <span class="sc">~</span> ., <span class="at">data =</span> train_data) <span class="sc">%&gt;%</span> </span>
<span id="cb267-3"><a href="part-2-machine-learning-with-r.html#cb267-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(flight, time_hour, <span class="at">new_role =</span> <span class="st">&quot;ID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb267-4"><a href="part-2-machine-learning-with-r.html#cb267-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_date</span>(date, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&quot;dow&quot;</span>, <span class="st">&quot;month&quot;</span>)) <span class="sc">%&gt;%</span>               </span>
<span id="cb267-5"><a href="part-2-machine-learning-with-r.html#cb267-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_holiday</span>(date, </span>
<span id="cb267-6"><a href="part-2-machine-learning-with-r.html#cb267-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">holidays =</span> timeDate<span class="sc">::</span><span class="fu">listHolidays</span>(<span class="st">&quot;US&quot;</span>), </span>
<span id="cb267-7"><a href="part-2-machine-learning-with-r.html#cb267-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">keep_original_cols =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>What do each of these steps do?</p>
<ul>
<li><p>With <a href="https://recipes.tidymodels.org/reference/step_date.html"><code>step_date()</code></a>, we created two new factor columns with the appropriate day of the week and the month.</p></li>
<li><p>With <a href="https://recipes.tidymodels.org/reference/step_holiday.html"><code>step_holiday()</code></a>, we created a binary variable indicating whether the current date is a holiday or not. The argument value of <code>timeDate::listHolidays("US")</code> uses the <a href="https://cran.r-project.org/web/packages/timeDate/index.html">timeDate package</a> to list the 18 standard US holidays.</p></li>
<li><p>With <code>keep_original_cols = FALSE</code>, we remove the original <code>date</code> variable since we no longer want it in the model. Many recipe steps that create new variables have this argument.</p></li>
</ul>
<p>Next, we’ll turn our attention to the variable types of our predictors. Because we plan to train a logistic regression model, we know that predictors will ultimately need to be numeric, as opposed to nominal data like strings and factor variables. In other words, there may be a difference in how we store our data (in factors inside a data frame), and how the underlying equations require them (a purely numeric matrix).</p>
<p>For factors like <code>dest</code> and <code>origin</code>, <a href="https://bookdown.org/max/FES/creating-dummy-variables-for-unordered-categories.html">standard practice</a> is to convert them into <em>dummy</em> or <em>indicator</em> variables to make them numeric. These are binary values for each level of the factor. For example, our <code>origin</code> variable has values of <code>"EWR"</code>, <code>"JFK"</code>, and <code>"LGA"</code>. The standard dummy variable encoding, shown below, will create <em>two</em> numeric columns of the data that are 1 when the originating airport is <code>"JFK"</code> or <code>"LGA"</code> and zero otherwise, respectively.</p>
<pre><code>## 
## Attaching package: &#39;kableExtra&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     group_rows</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
origin
</th>
<th style="text-align:right;">
origin_JFK
</th>
<th style="text-align:right;">
origin_LGA
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
JFK
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
EWR
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
LGA
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<p>But, unlike the standard model formula methods in R, a recipe <strong>does not</strong> automatically create these dummy variables for you; you’ll need to tell your recipe to add this step. This is for two reasons. First, many models do not require <a href="https://bookdown.org/max/FES/categorical-trees.html">numeric predictors</a>, so dummy variables may not always be preferred. Second, recipes can also be used for purposes outside of modeling, where non-dummy versions of the variables may work better. For example, you may want to make a table or a plot with a variable as a single factor. For those reasons, you need to explicitly tell recipes to create dummy variables using <code>step_dummy()</code>.</p>
<p>Apply the example above to the whole dataset:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="part-2-machine-learning-with-r.html#cb270-1" aria-hidden="true" tabindex="-1"></a>flights_rec <span class="ot">&lt;-</span> </span>
<span id="cb270-2"><a href="part-2-machine-learning-with-r.html#cb270-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(arr_delay <span class="sc">~</span> ., <span class="at">data =</span> train_data) <span class="sc">%&gt;%</span> </span>
<span id="cb270-3"><a href="part-2-machine-learning-with-r.html#cb270-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(flight, time_hour, <span class="at">new_role =</span> <span class="st">&quot;ID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb270-4"><a href="part-2-machine-learning-with-r.html#cb270-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_date</span>(date, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&quot;dow&quot;</span>, <span class="st">&quot;month&quot;</span>)) <span class="sc">%&gt;%</span>               </span>
<span id="cb270-5"><a href="part-2-machine-learning-with-r.html#cb270-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_holiday</span>(date, </span>
<span id="cb270-6"><a href="part-2-machine-learning-with-r.html#cb270-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">holidays =</span> timeDate<span class="sc">::</span><span class="fu">listHolidays</span>(<span class="st">&quot;US&quot;</span>), </span>
<span id="cb270-7"><a href="part-2-machine-learning-with-r.html#cb270-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">keep_original_cols =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb270-8"><a href="part-2-machine-learning-with-r.html#cb270-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span></code></pre></div>
<p>Here, we did something different than before: instead of applying a step to an individual variable, we used <a href="https://recipes.tidymodels.org/reference/selections.html">selectors</a> to apply this recipe step to several variables at once, <code>all_nominal_predictors()</code>. The <a href="https://recipes.tidymodels.org/reference/selections.html">selector functions</a> can be combined to select intersections of variables.</p>
<p>At this stage in the recipe, this step selects the <code>origin</code>, <code>dest</code>, and <code>carrier</code> variables. It also includes two new variables, <code>date_dow</code> and <code>date_month</code>, that were created by the earlier <code>step_date()</code>.</p>
<p>More generally, the recipe selectors mean that you don’t always have to apply steps to individual variables one at a time. Since a recipe knows the <em>variable type</em> and <em>role</em> of each column, they can also be selected (or dropped) using this information.</p>
<p>We need one final step to add to our recipe. Since <code>carrier</code> and <code>dest</code> have some infrequently occurring factor values, it is possible that dummy variables might be created for values that don’t exist in the training set. For example, there is one destination that is only in the test set:</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="part-2-machine-learning-with-r.html#cb271-1" aria-hidden="true" tabindex="-1"></a>test_data <span class="sc">%&gt;%</span> </span>
<span id="cb271-2"><a href="part-2-machine-learning-with-r.html#cb271-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(dest) <span class="sc">%&gt;%</span> </span>
<span id="cb271-3"><a href="part-2-machine-learning-with-r.html#cb271-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(train_data)</span></code></pre></div>
<pre><code>## Joining with `by = join_by(dest)`</code></pre>
<pre><code>## # A tibble: 1 × 1
##   dest 
##   &lt;fct&gt;
## 1 LEX</code></pre>
<p>When the recipe is applied to the training set, a column is made for LEX because the factor levels come from <code>flight_data</code> (not the training set), but this column will contain all zeros. This is a “zero-variance predictor” that has no information within the column. While some R functions will not produce an error for such predictors, it usually causes warnings and other issues. <code>step_zv()</code> will remove columns from the data when the training set data have a single value, so it is added to the recipe <em>after</em> <code>step_dummy()</code>:</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="part-2-machine-learning-with-r.html#cb274-1" aria-hidden="true" tabindex="-1"></a>flights_rec <span class="ot">&lt;-</span> </span>
<span id="cb274-2"><a href="part-2-machine-learning-with-r.html#cb274-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(arr_delay <span class="sc">~</span> ., <span class="at">data =</span> train_data) <span class="sc">%&gt;%</span> </span>
<span id="cb274-3"><a href="part-2-machine-learning-with-r.html#cb274-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(flight, time_hour, <span class="at">new_role =</span> <span class="st">&quot;ID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb274-4"><a href="part-2-machine-learning-with-r.html#cb274-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_date</span>(date, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&quot;dow&quot;</span>, <span class="st">&quot;month&quot;</span>)) <span class="sc">%&gt;%</span>               </span>
<span id="cb274-5"><a href="part-2-machine-learning-with-r.html#cb274-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_holiday</span>(date, </span>
<span id="cb274-6"><a href="part-2-machine-learning-with-r.html#cb274-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">holidays =</span> timeDate<span class="sc">::</span><span class="fu">listHolidays</span>(<span class="st">&quot;US&quot;</span>), </span>
<span id="cb274-7"><a href="part-2-machine-learning-with-r.html#cb274-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">keep_original_cols =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb274-8"><a href="part-2-machine-learning-with-r.html#cb274-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb274-9"><a href="part-2-machine-learning-with-r.html#cb274-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>())</span></code></pre></div>
<p>Now we’ve created a <em>specification</em> of what should be done with the data. How do we use the recipe we made?</p>
</div>
<div id="fit-workflow" class="section level2">
<h2>Fit a model with a recipe</h2>
<p>Let’s use logistic regression to model the flight data. As we saw in <a href="/start/models/"><em>Build a Model</em></a>, we start by <a href="/start/models/#build-model">building a model specification</a> using the parsnip package:</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="part-2-machine-learning-with-r.html#cb275-1" aria-hidden="true" tabindex="-1"></a>lr_mod <span class="ot">&lt;-</span> </span>
<span id="cb275-2"><a href="part-2-machine-learning-with-r.html#cb275-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb275-3"><a href="part-2-machine-learning-with-r.html#cb275-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>)</span></code></pre></div>
<p>We will want to use our recipe across several steps as we train and test our model. We will:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Process the recipe using the training set</strong>: This involves any estimation or calculations based on the training set. For our recipe, the training set will be used to determine which predictors should be converted to dummy variables and which predictors will have zero-variance in the training set, and should be slated for removal.</p></li>
<li><p><strong>Apply the recipe to the training set</strong>: We create the final predictor set on the training set.</p></li>
<li><p><strong>Apply the recipe to the test set</strong>: We create the final predictor set on the test set. Nothing is recomputed and no information from the test set is used here; the dummy variable and zero-variance results from the training set are applied to the test set.</p></li>
</ol>
<p>To simplify this process, we can use a <em>model workflow</em>, which pairs a model and recipe together. This is a straightforward approach because different recipes are often needed for different models, so when a model and recipe are bundled, it becomes easier to train and test <em>workflows</em>. We’ll use the <a href="https://workflows.tidymodels.org/">workflows package</a> from tidymodels to bundle our parsnip model (<code>lr_mod</code>) with our recipe (<code>flights_rec</code>).</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="part-2-machine-learning-with-r.html#cb276-1" aria-hidden="true" tabindex="-1"></a>flights_wflow <span class="ot">&lt;-</span> </span>
<span id="cb276-2"><a href="part-2-machine-learning-with-r.html#cb276-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb276-3"><a href="part-2-machine-learning-with-r.html#cb276-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lr_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb276-4"><a href="part-2-machine-learning-with-r.html#cb276-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(flights_rec)</span>
<span id="cb276-5"><a href="part-2-machine-learning-with-r.html#cb276-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-6"><a href="part-2-machine-learning-with-r.html#cb276-6" aria-hidden="true" tabindex="-1"></a>flights_wflow</span></code></pre></div>
<pre><code>## ══ Workflow ════════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: logistic_reg()
## 
## ── Preprocessor ────────────────────────────────────────────────────────────────
## 4 Recipe Steps
## 
## • step_date()
## • step_holiday()
## • step_dummy()
## • step_zv()
## 
## ── Model ───────────────────────────────────────────────────────────────────────
## Logistic Regression Model Specification (classification)
## 
## Computational engine: glm</code></pre>
<p>Now, there is a single function that can be used to prepare the recipe and train the model from the resulting predictors: <code>fit()</code></p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="part-2-machine-learning-with-r.html#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="do">## this step is the actual fitting and can take a </span></span>
<span id="cb278-2"><a href="part-2-machine-learning-with-r.html#cb278-2" aria-hidden="true" tabindex="-1"></a>flights_fit <span class="ot">&lt;-</span> </span>
<span id="cb278-3"><a href="part-2-machine-learning-with-r.html#cb278-3" aria-hidden="true" tabindex="-1"></a>  flights_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb278-4"><a href="part-2-machine-learning-with-r.html#cb278-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> train_data)</span></code></pre></div>
<p>This object has the finalized recipe and fitted model objects inside. You may want to extract the model or recipe objects from the workflow. To do this, you can use the helper functions <code>extract_fit_parsnip()</code> and <code>extract_recipe()</code>. For example, here we pull the fitted model object then use the <code>broom::tidy()</code> function to get a tidy tibble of model coefficients:</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="part-2-machine-learning-with-r.html#cb279-1" aria-hidden="true" tabindex="-1"></a>flights_fit <span class="sc">%&gt;%</span> </span>
<span id="cb279-2"><a href="part-2-machine-learning-with-r.html#cb279-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb279-3"><a href="part-2-machine-learning-with-r.html#cb279-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>()</span></code></pre></div>
<pre><code>## # A tibble: 158 × 5
##   term                estimate std.error statistic  p.value
##   &lt;chr&gt;                  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)          7.26    2.73           2.66 7.75e- 3
## 2 dep_time            -0.00166 0.0000141   -118.   0       
## 3 air_time            -0.0440  0.000563     -78.2  0       
## 4 distance             0.00508 0.00150        3.38 7.13e- 4
## 5 date_USChristmasDay  1.35    0.178          7.59 3.32e-14
## # ℹ 153 more rows</code></pre>
</div>
<div id="predict-workflow" class="section level2">
<h2>Use a trained workflow to predict</h2>
<p>Our goal was to predict whether a plane arrives more than 30 minutes late. We have just:</p>
<ol style="list-style-type: decimal">
<li>Built the model (<code>lr_mod</code>),</li>
<li>Created a preprocessing recipe (<code>flights_rec</code>),</li>
<li>Bundled the model and recipe (<code>flights_wflow</code>), and</li>
<li>Trained our workflow using a single call to <code>fit()</code>.</li>
</ol>
<p>The next step is to use the trained workflow (<code>flights_fit</code>) to predict with the unseen test data, which we will do with a single call to <code>predict()</code>. The <code>predict()</code> method applies the recipe to the new data, then passes them to the fitted model.</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="part-2-machine-learning-with-r.html#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(flights_fit, test_data)</span></code></pre></div>
<pre><code>## # A tibble: 81,455 × 1
##   .pred_class
##   &lt;fct&gt;      
## 1 on_time    
## 2 on_time    
## 3 on_time    
## 4 on_time    
## 5 on_time    
## # ℹ 81,450 more rows</code></pre>
<p>Because our outcome variable here is a factor, the output from <code>predict()</code> returns the predicted class: <code>late</code> versus <code>on_time</code>. But, let’s say we want the predicted class probabilities for each flight instead. To return those, we can specify <code>type = "prob"</code> when we use <code>predict()</code> or use <code>augment()</code> with the model plus test data to save them together:</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="part-2-machine-learning-with-r.html#cb283-1" aria-hidden="true" tabindex="-1"></a>flights_aug <span class="ot">&lt;-</span> </span>
<span id="cb283-2"><a href="part-2-machine-learning-with-r.html#cb283-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>(flights_fit, test_data)</span>
<span id="cb283-3"><a href="part-2-machine-learning-with-r.html#cb283-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-4"><a href="part-2-machine-learning-with-r.html#cb283-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The data look like: </span></span>
<span id="cb283-5"><a href="part-2-machine-learning-with-r.html#cb283-5" aria-hidden="true" tabindex="-1"></a>flights_aug <span class="sc">%&gt;%</span></span>
<span id="cb283-6"><a href="part-2-machine-learning-with-r.html#cb283-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(arr_delay, time_hour, flight, .pred_class, .pred_on_time)</span></code></pre></div>
<pre><code>## # A tibble: 81,455 × 5
##   arr_delay time_hour           flight .pred_class .pred_on_time
##   &lt;fct&gt;     &lt;dttm&gt;               &lt;int&gt; &lt;fct&gt;               &lt;dbl&gt;
## 1 on_time   2013-01-01 05:00:00   1545 on_time             0.945
## 2 on_time   2013-01-01 05:00:00   1714 on_time             0.949
## 3 on_time   2013-01-01 06:00:00    507 on_time             0.964
## 4 on_time   2013-01-01 06:00:00   5708 on_time             0.961
## 5 on_time   2013-01-01 06:00:00     71 on_time             0.962
## # ℹ 81,450 more rows</code></pre>
<p>Now that we have a tibble with our predicted class probabilities, how will we evaluate the performance of our workflow? We can see from these first few rows that our model predicted these 5 on time flights correctly because the values of <code>.pred_on_time</code> are <em>p</em> &gt; .50. But we also know that we have 81,455 rows total to predict. We would like to calculate a metric that tells how well our model predicted late arrivals, compared to the true status of our outcome variable, <code>arr_delay</code>.</p>
<p>Let’s use the area under the <a href="https://bookdown.org/max/FES/measuring-performance.html#class-metrics">ROC curve</a> as our metric, computed using <code>roc_curve()</code> and <code>roc_auc()</code> from the <a href="https://yardstick.tidymodels.org/">yardstick package</a>.</p>
<p>To generate a ROC curve, we need the predicted class probabilities for <code>late</code> and <code>on_time</code>, which we just calculated in the code chunk above. We can create the ROC curve with these values, using <code>roc_curve()</code> and then piping to the <code>autoplot()</code> method:</p>
<div class="sourceCode" id="cb285"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb285-1"><a href="part-2-machine-learning-with-r.html#cb285-1" aria-hidden="true" tabindex="-1"></a>flights_aug <span class="sc">%&gt;%</span> </span>
<span id="cb285-2"><a href="part-2-machine-learning-with-r.html#cb285-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> arr_delay, .pred_late) <span class="sc">%&gt;%</span> </span>
<span id="cb285-3"><a href="part-2-machine-learning-with-r.html#cb285-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<pre><code>## Warning: Returning more (or less) than 1 row per `summarise()` group was deprecated in
## dplyr 1.1.0.
## ℹ Please use `reframe()` instead.
## ℹ When switching from `summarise()` to `reframe()`, remember that `reframe()`
##   always returns an ungrouped data frame and adjust accordingly.
## ℹ The deprecated feature was likely used in the yardstick package.
##   Please report the issue at &lt;https://github.com/tidymodels/yardstick/issues&gt;.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
## generated.</code></pre>
<p><img src="002_tidymodels_old_files/figure-html/roc-plot-1.png" width="672" /></p>
<p>Similarly, <code>roc_auc()</code> estimates the area under the curve:</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb287-1"><a href="part-2-machine-learning-with-r.html#cb287-1" aria-hidden="true" tabindex="-1"></a>flights_aug <span class="sc">%&gt;%</span> </span>
<span id="cb287-2"><a href="part-2-machine-learning-with-r.html#cb287-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_auc</span>(<span class="at">truth =</span> arr_delay, .pred_late)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 roc_auc binary         0.764</code></pre>
<p>Not too bad! We leave it to the reader to test out this workflow <a href="https://workflows.tidymodels.org/reference/add_formula.html"><em>without</em></a> this recipe. You can use <code>workflows::add_formula(arr_delay ~ .)</code> instead of <code>add_recipe()</code> (remember to remove the identification variables first!), and see whether our recipe improved our model’s ability to predict late arrivals.</p>
<div id="exercise-getting-started-with-the-tame-dataset-2" class="section level5 unnumbered question">
<h5>Exercise; Getting started with the TAME dataset 2</h5>
<p>The TAME learning module contains an example dataset from the EPA containing molecular descriptors of pfas and statins. The data was already downloaded above and should be visible in your Global env. as <code>data_tame</code>. If not, look up the code chunk above an rerun it.</p>
<p>In this exercise, we are going to build a predictive model to try and answer the following question:</p>
<p>“Can we differentiate between the <code>PFAS</code> and <code>statin</code> chemical classes, when considering just the raw physicochemical property variables.</p>
<p>The assignment is to build a predictive model, using the Tidymodel framework that was demonstrated in the previous section. In order to achieve this you need at least to consider the following steps</p>
<ol style="list-style-type: decimal">
<li>Inpect the data, using the tools/functions you learned during the previous section of this lesson and the course (e.g. <code>head()</code>, <code>skim::skimr()</code>, <code>colnames()</code>, etc.)</li>
<li>Check the datatypes of the variables</li>
<li>Create some exploratory graphs</li>
<li>Identify the type of modelling approach (engine?) you would like to use</li>
<li>Identify the roles for each variable in the dataset</li>
<li>Are there any variables that need to be ‘<code>feature engineered</code>’?</li>
<li>Build a <code>tame_mod</code> R object that contains the model definition (formula)</li>
<li>Split the data in to a <code>data_tame_train</code> and a <code>data_tame_test</code> fold</li>
<li>Define a recipe (<code>tame_rec</code>) that includes all the steps you would like to perform as pre-processing. Think about the ‘zero-variance’ variables here</li>
<li>Build a workflow that combines the model (<code>tame_mod</code>) and recipe (<code>tame_rec</code>)</li>
<li>Fit the model using the workflow and the training data</li>
<li>Check the model performance using the fitted model and the test data</li>
</ol>
<p><strong>TIPS</strong></p>
<ol style="list-style-type: decimal">
<li>Think about what type of classification problem we are dealing with here: regression, logistic regression, binary classification, is the outcome numeric or a factor?</li>
<li>Check if there are any missing values, as part of your exploratory analysis</li>
<li>Also check the distributions of the variables, do we perhaps need to scale and/or center the variables, before fitting the model? If so why, or if not - why not?</li>
<li>Remember <code>janitor::clean_names()</code> to tidy the variable names, this makes the variables complient to R convention</li>
<li>Maybe rename the <code>List</code> variable to something more meaningful?</li>
</ol>
</div>
<details>
<summary>
Click for the answer
</summary>
<p>Exercise Answer:</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb289-1"><a href="part-2-machine-learning-with-r.html#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Inspect the data</span></span>
<span id="cb289-2"><a href="part-2-machine-learning-with-r.html#cb289-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(data_tame)</span></code></pre></div>
<pre><code>## [1] 144  14</code></pre>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb291-1"><a href="part-2-machine-learning-with-r.html#cb291-1" aria-hidden="true" tabindex="-1"></a>data_tame[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## # A tibble: 4 × 5
##   List  `Substance Name`                         CASRN DTXSID `Molecular Weight`
##   &lt;chr&gt; &lt;chr&gt;                                    &lt;chr&gt; &lt;chr&gt;               &lt;dbl&gt;
## 1 PFAS  Perfluoro-2-(trifluoromethyl)propanesul… 9376… DTXSI…               300.
## 2 PFAS  Potassium perfluoroheptanesulfonate      6027… DTXSI…               488.
## 3 PFAS  Bis(2-hydroxyethyl)ammonium perfluorohe… 7022… DTXSI…               555.
## 4 PFAS  Potassium perfluoro-p-ethylcyclohexanes… 335-… DTXSI…               500.</code></pre>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="part-2-machine-learning-with-r.html#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb293-2"><a href="part-2-machine-learning-with-r.html#cb293-2" aria-hidden="true" tabindex="-1"></a>data_tame</span></code></pre></div>
<pre><code>## # A tibble: 144 × 14
##    List  `Substance Name` CASRN DTXSID `Molecular Weight` `OPERA, Boiling Point`
##    &lt;chr&gt; &lt;chr&gt;            &lt;chr&gt; &lt;chr&gt;               &lt;dbl&gt;                  &lt;dbl&gt;
##  1 PFAS  Perfluoro-2-(tr… 9376… DTXSI…               300.                   213.
##  2 PFAS  Potassium perfl… 6027… DTXSI…               488.                   223.
##  3 PFAS  Bis(2-hydroxyet… 7022… DTXSI…               555.                   223.
##  4 PFAS  Potassium perfl… 335-… DTXSI…               500.                   221.
##  5 PFAS  1,1,2,2,3,3,4,4… 647-… DTXSI…               484.                   207.
##  6 PFAS  Perfluorononane… 6825… DTXSI…               550.                   224.
##  7 PFAS  Ammonium perflu… 6825… DTXSI…               367.                   225.
##  8 PFAS  Ammonium perflu… 6825… DTXSI…               467.                   223.
##  9 PFAS  Sodium nonafluo… 6045… DTXSI…               322.                   211.
## 10 PFAS  2H-Perfluoropro… 357-… DTXSI…               232.                   202.
## # ℹ 134 more rows
## # ℹ 8 more variables: `OPERA, Henry&#39;s Law Constant` &lt;dbl&gt;,
## #   `OPERA, Melting Point` &lt;dbl&gt;,
## #   `OPERA, Negative Log of Acid Dissociation Constant` &lt;dbl&gt;,
## #   `OPERA, Octanol-Air Partition Coefficient` &lt;dbl&gt;,
## #   `OPERA, Octanol-Water Distribution Coefficient` &lt;dbl&gt;,
## #   `OPERA, Octanol-Water Partition Coefficient` &lt;dbl&gt;, …</code></pre>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="part-2-machine-learning-with-r.html#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(data_tame<span class="sc">$</span>List)</span></code></pre></div>
<pre><code>## [1] &quot;PFAS&quot;    &quot;Statins&quot;</code></pre>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb297-1"><a href="part-2-machine-learning-with-r.html#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_tame)</span></code></pre></div>
<pre><code>##  [1] &quot;List&quot;                                             
##  [2] &quot;Substance Name&quot;                                   
##  [3] &quot;CASRN&quot;                                            
##  [4] &quot;DTXSID&quot;                                           
##  [5] &quot;Molecular Weight&quot;                                 
##  [6] &quot;OPERA, Boiling Point&quot;                             
##  [7] &quot;OPERA, Henry&#39;s Law Constant&quot;                      
##  [8] &quot;OPERA, Melting Point&quot;                             
##  [9] &quot;OPERA, Negative Log of Acid Dissociation Constant&quot;
## [10] &quot;OPERA, Octanol-Air Partition Coefficient&quot;         
## [11] &quot;OPERA, Octanol-Water Distribution Coefficient&quot;    
## [12] &quot;OPERA, Octanol-Water Partition Coefficient&quot;       
## [13] &quot;OPERA, Vapor Pressure&quot;                            
## [14] &quot;OPERA, Water Solubility&quot;</code></pre>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="part-2-machine-learning-with-r.html#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="do">## exploratory graphs</span></span>
<span id="cb299-2"><a href="part-2-machine-learning-with-r.html#cb299-2" aria-hidden="true" tabindex="-1"></a>data_tame_tidy <span class="ot">&lt;-</span> data_tame <span class="sc">|&gt;</span></span>
<span id="cb299-3"><a href="part-2-machine-learning-with-r.html#cb299-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">class =</span> List) <span class="sc">|&gt;</span></span>
<span id="cb299-4"><a href="part-2-machine-learning-with-r.html#cb299-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">as_factor</span>(class)) <span class="sc">|&gt;</span></span>
<span id="cb299-5"><a href="part-2-machine-learning-with-r.html#cb299-5" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb299-6"><a href="part-2-machine-learning-with-r.html#cb299-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data_tame_tidy)</span></code></pre></div>
<pre><code>##  [1] &quot;class&quot;                                           
##  [2] &quot;substance_name&quot;                                  
##  [3] &quot;casrn&quot;                                           
##  [4] &quot;dtxsid&quot;                                          
##  [5] &quot;molecular_weight&quot;                                
##  [6] &quot;opera_boiling_point&quot;                             
##  [7] &quot;opera_henrys_law_constant&quot;                       
##  [8] &quot;opera_melting_point&quot;                             
##  [9] &quot;opera_negative_log_of_acid_dissociation_constant&quot;
## [10] &quot;opera_octanol_air_partition_coefficient&quot;         
## [11] &quot;opera_octanol_water_distribution_coefficient&quot;    
## [12] &quot;opera_octanol_water_partition_coefficient&quot;       
## [13] &quot;opera_vapor_pressure&quot;                            
## [14] &quot;opera_water_solubility&quot;</code></pre>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="part-2-machine-learning-with-r.html#cb301-1" aria-hidden="true" tabindex="-1"></a>data_tame_tidy <span class="sc">|&gt;</span></span>
<span id="cb301-2"><a href="part-2-machine-learning-with-r.html#cb301-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> molecular_weight, <span class="at">y =</span> opera_octanol_water_distribution_coefficient)) <span class="sc">+</span></span>
<span id="cb301-3"><a href="part-2-machine-learning-with-r.html#cb301-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> class))</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="part-2-machine-learning-with-r.html#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="do">## let&#39;s do another</span></span>
<span id="cb302-2"><a href="part-2-machine-learning-with-r.html#cb302-2" aria-hidden="true" tabindex="-1"></a>data_tame_tidy <span class="sc">|&gt;</span></span>
<span id="cb302-3"><a href="part-2-machine-learning-with-r.html#cb302-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> opera_water_solubility , <span class="at">y =</span> opera_negative_log_of_acid_dissociation_constant)) <span class="sc">+</span></span>
<span id="cb302-4"><a href="part-2-machine-learning-with-r.html#cb302-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> class))</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-32-2.png" width="672" /></p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="part-2-machine-learning-with-r.html#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="do">## What can you conclude from these two example graphs?</span></span>
<span id="cb303-2"><a href="part-2-machine-learning-with-r.html#cb303-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-3"><a href="part-2-machine-learning-with-r.html#cb303-3" aria-hidden="true" tabindex="-1"></a><span class="do">## missing values</span></span>
<span id="cb303-4"><a href="part-2-machine-learning-with-r.html#cb303-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_tame_tidy))</span></code></pre></div>
<pre><code>## [1] 47</code></pre>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="part-2-machine-learning-with-r.html#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;naniar&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:skimr&#39;:
## 
##     n_complete</code></pre>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="part-2-machine-learning-with-r.html#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vis_miss</span>(data_tame_tidy)</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-32-3.png" width="672" /></p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="part-2-machine-learning-with-r.html#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="do">## missingnes seems to be in the dtxsid colum</span></span>
<span id="cb309-2"><a href="part-2-machine-learning-with-r.html#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="do">## check</span></span>
<span id="cb309-3"><a href="part-2-machine-learning-with-r.html#cb309-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_tame_tidy<span class="sc">$</span>dtxsid))</span></code></pre></div>
<pre><code>## [1] 47</code></pre>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="part-2-machine-learning-with-r.html#cb311-1" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt; 47, so not a problem, this variable is an ID, not a predictor. For random forest, we cannot have missing values in predictor variables</span></span></code></pre></div>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="part-2-machine-learning-with-r.html#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define the engine and model type</span></span>
<span id="cb312-2"><a href="part-2-machine-learning-with-r.html#cb312-2" aria-hidden="true" tabindex="-1"></a><span class="do">## this problem seems fit for a regression tree approach, e.g. random forest. See: https://parsnip.tidymodels.org/reference/rand_forest.html</span></span>
<span id="cb312-3"><a href="part-2-machine-learning-with-r.html#cb312-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-4"><a href="part-2-machine-learning-with-r.html#cb312-4" aria-hidden="true" tabindex="-1"></a>tame_mod <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>() <span class="sc">|&gt;</span></span>
<span id="cb312-5"><a href="part-2-machine-learning-with-r.html#cb312-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;ranger&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb312-6"><a href="part-2-machine-learning-with-r.html#cb312-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)<span class="co"># default engine</span></span>
<span id="cb312-7"><a href="part-2-machine-learning-with-r.html#cb312-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-8"><a href="part-2-machine-learning-with-r.html#cb312-8" aria-hidden="true" tabindex="-1"></a>tame_mod</span></code></pre></div>
<pre><code>## Random Forest Model Specification (classification)
## 
## Computational engine: ranger</code></pre>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="part-2-machine-learning-with-r.html#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="do">## data split</span></span>
<span id="cb314-2"><a href="part-2-machine-learning-with-r.html#cb314-2" aria-hidden="true" tabindex="-1"></a>data_tame_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_tame_tidy, <span class="at">prop =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb314-3"><a href="part-2-machine-learning-with-r.html#cb314-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-4"><a href="part-2-machine-learning-with-r.html#cb314-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frames for the two sets:</span></span>
<span id="cb314-5"><a href="part-2-machine-learning-with-r.html#cb314-5" aria-hidden="true" tabindex="-1"></a>data_tame_train <span class="ot">&lt;-</span> <span class="fu">training</span>(data_tame_split)</span>
<span id="cb314-6"><a href="part-2-machine-learning-with-r.html#cb314-6" aria-hidden="true" tabindex="-1"></a>data_tame_test  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_tame_split)</span></code></pre></div>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="part-2-machine-learning-with-r.html#cb315-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data_tame_tidy)</span></code></pre></div>
<pre><code>##  [1] &quot;class&quot;                                           
##  [2] &quot;substance_name&quot;                                  
##  [3] &quot;casrn&quot;                                           
##  [4] &quot;dtxsid&quot;                                          
##  [5] &quot;molecular_weight&quot;                                
##  [6] &quot;opera_boiling_point&quot;                             
##  [7] &quot;opera_henrys_law_constant&quot;                       
##  [8] &quot;opera_melting_point&quot;                             
##  [9] &quot;opera_negative_log_of_acid_dissociation_constant&quot;
## [10] &quot;opera_octanol_air_partition_coefficient&quot;         
## [11] &quot;opera_octanol_water_distribution_coefficient&quot;    
## [12] &quot;opera_octanol_water_partition_coefficient&quot;       
## [13] &quot;opera_vapor_pressure&quot;                            
## [14] &quot;opera_water_solubility&quot;</code></pre>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="part-2-machine-learning-with-r.html#cb317-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define the recipe</span></span>
<span id="cb317-2"><a href="part-2-machine-learning-with-r.html#cb317-2" aria-hidden="true" tabindex="-1"></a>tame_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(class <span class="sc">~</span> ., <span class="at">data =</span> data_tame_train) <span class="sc">|&gt;</span> </span>
<span id="cb317-3"><a href="part-2-machine-learning-with-r.html#cb317-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(substance_name, casrn, dtxsid, <span class="at">new_role =</span> <span class="st">&quot;ID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb317-4"><a href="part-2-machine-learning-with-r.html#cb317-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb317-5"><a href="part-2-machine-learning-with-r.html#cb317-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb317-6"><a href="part-2-machine-learning-with-r.html#cb317-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb317-7"><a href="part-2-machine-learning-with-r.html#cb317-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-8"><a href="part-2-machine-learning-with-r.html#cb317-8" aria-hidden="true" tabindex="-1"></a><span class="do">## let&#39;s look at the distribution of values accross the predictors</span></span>
<span id="cb317-9"><a href="part-2-machine-learning-with-r.html#cb317-9" aria-hidden="true" tabindex="-1"></a><span class="fu">map_lgl</span>(</span>
<span id="cb317-10"><a href="part-2-machine-learning-with-r.html#cb317-10" aria-hidden="true" tabindex="-1"></a>  data_tame_tidy,</span>
<span id="cb317-11"><a href="part-2-machine-learning-with-r.html#cb317-11" aria-hidden="true" tabindex="-1"></a>  is.numeric</span>
<span id="cb317-12"><a href="part-2-machine-learning-with-r.html#cb317-12" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> ind</span>
<span id="cb317-13"><a href="part-2-machine-learning-with-r.html#cb317-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-14"><a href="part-2-machine-learning-with-r.html#cb317-14" aria-hidden="true" tabindex="-1"></a><span class="fu">map_df</span>(</span>
<span id="cb317-15"><a href="part-2-machine-learning-with-r.html#cb317-15" aria-hidden="true" tabindex="-1"></a>  data_tame_tidy[,ind],</span>
<span id="cb317-16"><a href="part-2-machine-learning-with-r.html#cb317-16" aria-hidden="true" tabindex="-1"></a>  min</span>
<span id="cb317-17"><a href="part-2-machine-learning-with-r.html#cb317-17" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> mins</span>
<span id="cb317-18"><a href="part-2-machine-learning-with-r.html#cb317-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-19"><a href="part-2-machine-learning-with-r.html#cb317-19" aria-hidden="true" tabindex="-1"></a>mins<span class="sc">$</span>type <span class="ot">=</span> <span class="st">&quot;min&quot;</span></span>
<span id="cb317-20"><a href="part-2-machine-learning-with-r.html#cb317-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-21"><a href="part-2-machine-learning-with-r.html#cb317-21" aria-hidden="true" tabindex="-1"></a><span class="fu">map_df</span>(</span>
<span id="cb317-22"><a href="part-2-machine-learning-with-r.html#cb317-22" aria-hidden="true" tabindex="-1"></a>  data_tame_tidy[,ind],</span>
<span id="cb317-23"><a href="part-2-machine-learning-with-r.html#cb317-23" aria-hidden="true" tabindex="-1"></a>  max</span>
<span id="cb317-24"><a href="part-2-machine-learning-with-r.html#cb317-24" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> maxes</span>
<span id="cb317-25"><a href="part-2-machine-learning-with-r.html#cb317-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-26"><a href="part-2-machine-learning-with-r.html#cb317-26" aria-hidden="true" tabindex="-1"></a>maxes<span class="sc">$</span>type <span class="ot">=</span> <span class="st">&quot;max&quot;</span></span>
<span id="cb317-27"><a href="part-2-machine-learning-with-r.html#cb317-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-28"><a href="part-2-machine-learning-with-r.html#cb317-28" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(mins, maxes) <span class="sc">|&gt;</span></span>
<span id="cb317-29"><a href="part-2-machine-learning-with-r.html#cb317-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">names_to =</span> <span class="st">&quot;vars&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;values&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb317-30"><a href="part-2-machine-learning-with-r.html#cb317-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb317-31"><a href="part-2-machine-learning-with-r.html#cb317-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">reorder</span>(<span class="fu">as_factor</span>(vars), values), </span>
<span id="cb317-32"><a href="part-2-machine-learning-with-r.html#cb317-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> values)) <span class="sc">+</span></span>
<span id="cb317-33"><a href="part-2-machine-learning-with-r.html#cb317-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> type), <span class="at">position =</span> <span class="st">&quot;jitter&quot;</span>) <span class="sc">+</span></span>
<span id="cb317-34"><a href="part-2-machine-learning-with-r.html#cb317-34" aria-hidden="true" tabindex="-1"></a>  toolboxr<span class="sc">::</span><span class="fu">rotate_axis_labels</span>(<span class="st">&quot;x&quot;</span>, <span class="dv">90</span>)</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-35-1.png" width="672" /></p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="part-2-machine-learning-with-r.html#cb318-1" aria-hidden="true" tabindex="-1"></a><span class="do">## now we do the same for the normalized and centered data, we will use the function `preProcess()` from the {caret} package, which was developed by Max Kuhn (co/lead-developer for {tidymodels})</span></span>
<span id="cb318-2"><a href="part-2-machine-learning-with-r.html#cb318-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span></code></pre></div>
<pre><code>## Loading required package: lattice</code></pre>
<pre><code>## 
## Attaching package: &#39;caret&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:rstanarm&#39;:
## 
##     compare_models, R2</code></pre>
<pre><code>## The following objects are masked from &#39;package:yardstick&#39;:
## 
##     precision, recall, sensitivity, specificity</code></pre>
<pre><code>## The following object is masked from &#39;package:purrr&#39;:
## 
##     lift</code></pre>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb324-1"><a href="part-2-machine-learning-with-r.html#cb324-1" aria-hidden="true" tabindex="-1"></a>preProcValues <span class="ot">&lt;-</span> <span class="fu">preProcess</span>(data_tame, <span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>))</span>
<span id="cb324-2"><a href="part-2-machine-learning-with-r.html#cb324-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-3"><a href="part-2-machine-learning-with-r.html#cb324-3" aria-hidden="true" tabindex="-1"></a>data_tame_transformed <span class="ot">&lt;-</span> <span class="fu">predict</span>(preProcValues, data_tame)</span>
<span id="cb324-4"><a href="part-2-machine-learning-with-r.html#cb324-4" aria-hidden="true" tabindex="-1"></a>data_tame_transformed</span></code></pre></div>
<pre><code>## # A tibble: 144 × 14
##    List  `Substance Name` CASRN DTXSID `Molecular Weight` `OPERA, Boiling Point`
##    &lt;chr&gt; &lt;chr&gt;            &lt;chr&gt; &lt;chr&gt;               &lt;dbl&gt;                  &lt;dbl&gt;
##  1 PFAS  Perfluoro-2-(tr… 9376… DTXSI…            -1.03                   -0.626
##  2 PFAS  Potassium perfl… 6027… DTXSI…             0.118                  -0.515
##  3 PFAS  Bis(2-hydroxyet… 7022… DTXSI…             0.526                  -0.515
##  4 PFAS  Potassium perfl… 335-… DTXSI…             0.191                  -0.543
##  5 PFAS  1,1,2,2,3,3,4,4… 647-… DTXSI…             0.0931                 -0.694
##  6 PFAS  Perfluorononane… 6825… DTXSI…             0.495                  -0.504
##  7 PFAS  Ammonium perflu… 6825… DTXSI…            -0.619                  -0.494
##  8 PFAS  Ammonium perflu… 6825… DTXSI…            -0.0103                 -0.515
##  9 PFAS  Sodium nonafluo… 6045… DTXSI…            -0.893                  -0.650
## 10 PFAS  2H-Perfluoropro… 357-… DTXSI…            -1.44                   -0.752
## # ℹ 134 more rows
## # ℹ 8 more variables: `OPERA, Henry&#39;s Law Constant` &lt;dbl&gt;,
## #   `OPERA, Melting Point` &lt;dbl&gt;,
## #   `OPERA, Negative Log of Acid Dissociation Constant` &lt;dbl&gt;,
## #   `OPERA, Octanol-Air Partition Coefficient` &lt;dbl&gt;,
## #   `OPERA, Octanol-Water Distribution Coefficient` &lt;dbl&gt;,
## #   `OPERA, Octanol-Water Partition Coefficient` &lt;dbl&gt;, …</code></pre>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="part-2-machine-learning-with-r.html#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="do">## let&#39;s put the code above in a function that we can recycle for later use</span></span>
<span id="cb326-2"><a href="part-2-machine-learning-with-r.html#cb326-2" aria-hidden="true" tabindex="-1"></a>plot_min_max <span class="ot">&lt;-</span> <span class="cf">function</span>(df, ...) { <span class="do">## ... ellipsis, additional arguments to pivot_longer(), column index or tidy-eval column names (unquoted)</span></span>
<span id="cb326-3"><a href="part-2-machine-learning-with-r.html#cb326-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_lgl</span>(df,</span>
<span id="cb326-4"><a href="part-2-machine-learning-with-r.html#cb326-4" aria-hidden="true" tabindex="-1"></a>          is.numeric) <span class="ot">-&gt;</span> ind</span>
<span id="cb326-5"><a href="part-2-machine-learning-with-r.html#cb326-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb326-6"><a href="part-2-machine-learning-with-r.html#cb326-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(df[, ind],</span>
<span id="cb326-7"><a href="part-2-machine-learning-with-r.html#cb326-7" aria-hidden="true" tabindex="-1"></a>         min) <span class="ot">-&gt;</span> mins</span>
<span id="cb326-8"><a href="part-2-machine-learning-with-r.html#cb326-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb326-9"><a href="part-2-machine-learning-with-r.html#cb326-9" aria-hidden="true" tabindex="-1"></a>  mins<span class="sc">$</span>type <span class="ot">=</span> <span class="st">&quot;min&quot;</span></span>
<span id="cb326-10"><a href="part-2-machine-learning-with-r.html#cb326-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb326-11"><a href="part-2-machine-learning-with-r.html#cb326-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(df[, ind],</span>
<span id="cb326-12"><a href="part-2-machine-learning-with-r.html#cb326-12" aria-hidden="true" tabindex="-1"></a>         max) <span class="ot">-&gt;</span> maxes</span>
<span id="cb326-13"><a href="part-2-machine-learning-with-r.html#cb326-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb326-14"><a href="part-2-machine-learning-with-r.html#cb326-14" aria-hidden="true" tabindex="-1"></a>  maxes<span class="sc">$</span>type <span class="ot">=</span> <span class="st">&quot;max&quot;</span></span>
<span id="cb326-15"><a href="part-2-machine-learning-with-r.html#cb326-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb326-16"><a href="part-2-machine-learning-with-r.html#cb326-16" aria-hidden="true" tabindex="-1"></a>  title <span class="ot">&lt;-</span> <span class="fu">deparse</span>(<span class="fu">substitute</span>(df)) </span>
<span id="cb326-17"><a href="part-2-machine-learning-with-r.html#cb326-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb326-18"><a href="part-2-machine-learning-with-r.html#cb326-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(mins, maxes) <span class="sc">|&gt;</span></span>
<span id="cb326-19"><a href="part-2-machine-learning-with-r.html#cb326-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(..., <span class="at">names_to =</span> <span class="st">&quot;vars&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;values&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb326-20"><a href="part-2-machine-learning-with-r.html#cb326-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(<span class="fu">as_factor</span>(vars), values),</span>
<span id="cb326-21"><a href="part-2-machine-learning-with-r.html#cb326-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">y =</span> values)) <span class="sc">+</span></span>
<span id="cb326-22"><a href="part-2-machine-learning-with-r.html#cb326-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> type), <span class="at">position =</span> <span class="st">&quot;jitter&quot;</span>) <span class="sc">+</span></span>
<span id="cb326-23"><a href="part-2-machine-learning-with-r.html#cb326-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(title) <span class="sc">+</span></span>
<span id="cb326-24"><a href="part-2-machine-learning-with-r.html#cb326-24" aria-hidden="true" tabindex="-1"></a>    toolboxr<span class="sc">::</span><span class="fu">rotate_axis_labels</span>(<span class="st">&quot;x&quot;</span>, <span class="dv">90</span>) <span class="ot">-&gt;</span> p</span>
<span id="cb326-25"><a href="part-2-machine-learning-with-r.html#cb326-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb326-26"><a href="part-2-machine-learning-with-r.html#cb326-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb326-27"><a href="part-2-machine-learning-with-r.html#cb326-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-28"><a href="part-2-machine-learning-with-r.html#cb326-28" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_min_max</span>(<span class="at">df =</span> data_tame_transformed, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="ot">-&gt;</span> tame_plot_transformed </span>
<span id="cb326-29"><a href="part-2-machine-learning-with-r.html#cb326-29" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_min_max</span>(<span class="at">df =</span> data_tame, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="ot">-&gt;</span> tame_plot</span>
<span id="cb326-30"><a href="part-2-machine-learning-with-r.html#cb326-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-31"><a href="part-2-machine-learning-with-r.html#cb326-31" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb326-32"><a href="part-2-machine-learning-with-r.html#cb326-32" aria-hidden="true" tabindex="-1"></a>  tame_plot,</span>
<span id="cb326-33"><a href="part-2-machine-learning-with-r.html#cb326-33" aria-hidden="true" tabindex="-1"></a>  tame_plot_transformed</span>
<span id="cb326-34"><a href="part-2-machine-learning-with-r.html#cb326-34" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-35-2.png" width="672" /></p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="part-2-machine-learning-with-r.html#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="do">## In terms of feature engineering, there seems to be no need to do this upfront. We could get the SMILES for each compound from a database, and calculate fingerprints. In a later part of this lesson we will revisit this option.</span></span></code></pre></div>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb328-1"><a href="part-2-machine-learning-with-r.html#cb328-1" aria-hidden="true" tabindex="-1"></a>tame_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb328-2"><a href="part-2-machine-learning-with-r.html#cb328-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tame_mod) <span class="sc">|&gt;</span></span>
<span id="cb328-3"><a href="part-2-machine-learning-with-r.html#cb328-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(tame_rec)</span></code></pre></div>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="part-2-machine-learning-with-r.html#cb329-1" aria-hidden="true" tabindex="-1"></a><span class="do">## fitting the model</span></span>
<span id="cb329-2"><a href="part-2-machine-learning-with-r.html#cb329-2" aria-hidden="true" tabindex="-1"></a>tame_fit <span class="ot">&lt;-</span> tame_workflow <span class="sc">|&gt;</span></span>
<span id="cb329-3"><a href="part-2-machine-learning-with-r.html#cb329-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> data_tame_train)</span>
<span id="cb329-4"><a href="part-2-machine-learning-with-r.html#cb329-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-5"><a href="part-2-machine-learning-with-r.html#cb329-5" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(tame_fit, data_tame_test)</span></code></pre></div>
<pre><code>## # A tibble: 36 × 1
##    .pred_class
##    &lt;fct&gt;      
##  1 PFAS       
##  2 PFAS       
##  3 PFAS       
##  4 PFAS       
##  5 PFAS       
##  6 PFAS       
##  7 PFAS       
##  8 PFAS       
##  9 PFAS       
## 10 PFAS       
## # ℹ 26 more rows</code></pre>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb331-1"><a href="part-2-machine-learning-with-r.html#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(tame_fit, data_tame_test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 36 × 2
##    .pred_PFAS .pred_Statins
##         &lt;dbl&gt;         &lt;dbl&gt;
##  1      1          0       
##  2      1          0       
##  3      0.999      0.001   
##  4      0.994      0.00608 
##  5      1          0       
##  6      0.999      0.001   
##  7      1          0       
##  8      0.999      0.000857
##  9      1          0       
## 10      1          0       
## # ℹ 26 more rows</code></pre>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb333-1"><a href="part-2-machine-learning-with-r.html#cb333-1" aria-hidden="true" tabindex="-1"></a><span class="do">## augment</span></span>
<span id="cb333-2"><a href="part-2-machine-learning-with-r.html#cb333-2" aria-hidden="true" tabindex="-1"></a>tame_aug <span class="ot">&lt;-</span> </span>
<span id="cb333-3"><a href="part-2-machine-learning-with-r.html#cb333-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>(tame_fit, data_tame_test, .pred_PFAS, .pred_Statins)</span>
<span id="cb333-4"><a href="part-2-machine-learning-with-r.html#cb333-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-5"><a href="part-2-machine-learning-with-r.html#cb333-5" aria-hidden="true" tabindex="-1"></a><span class="do">## The data look like: </span></span>
<span id="cb333-6"><a href="part-2-machine-learning-with-r.html#cb333-6" aria-hidden="true" tabindex="-1"></a>tame_aug <span class="sc">%&gt;%</span></span>
<span id="cb333-7"><a href="part-2-machine-learning-with-r.html#cb333-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(class, .pred_class, .pred_PFAS, .pred_Statins)</span></code></pre></div>
<pre><code>## # A tibble: 36 × 4
##    class .pred_class .pred_PFAS .pred_Statins
##    &lt;fct&gt; &lt;fct&gt;            &lt;dbl&gt;         &lt;dbl&gt;
##  1 PFAS  PFAS             1          0       
##  2 PFAS  PFAS             1          0       
##  3 PFAS  PFAS             0.999      0.001   
##  4 PFAS  PFAS             0.994      0.00608 
##  5 PFAS  PFAS             1          0       
##  6 PFAS  PFAS             0.999      0.001   
##  7 PFAS  PFAS             1          0       
##  8 PFAS  PFAS             0.999      0.000857
##  9 PFAS  PFAS             1          0       
## 10 PFAS  PFAS             1          0       
## # ℹ 26 more rows</code></pre>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb335-1"><a href="part-2-machine-learning-with-r.html#cb335-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Confusion table</span></span>
<span id="cb335-2"><a href="part-2-machine-learning-with-r.html#cb335-2" aria-hidden="true" tabindex="-1"></a> tame_aug <span class="sc">%&gt;%</span></span>
<span id="cb335-3"><a href="part-2-machine-learning-with-r.html#cb335-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> class, <span class="at">estimate =</span> .pred_class)</span></code></pre></div>
<pre><code>##           Truth
## Prediction PFAS Statins
##    PFAS      21       1
##    Statins    0      14</code></pre>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb337-1"><a href="part-2-machine-learning-with-r.html#cb337-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Accuracy</span></span>
<span id="cb337-2"><a href="part-2-machine-learning-with-r.html#cb337-2" aria-hidden="true" tabindex="-1"></a> <span class="co"># Model preformace metrics</span></span>
<span id="cb337-3"><a href="part-2-machine-learning-with-r.html#cb337-3" aria-hidden="true" tabindex="-1"></a>class_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(accuracy)</span>
<span id="cb337-4"><a href="part-2-machine-learning-with-r.html#cb337-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb337-5"><a href="part-2-machine-learning-with-r.html#cb337-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Get preformance metrics</span></span>
<span id="cb337-6"><a href="part-2-machine-learning-with-r.html#cb337-6" aria-hidden="true" tabindex="-1"></a>tame_aug <span class="sc">%&gt;%</span></span>
<span id="cb337-7"><a href="part-2-machine-learning-with-r.html#cb337-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">class_metrics</span>(<span class="at">truth =</span> class, <span class="at">estimate =</span> .pred_class)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.972</code></pre>
</details>
</div>
<div id="feature-importance" class="section level2">
<h2>Feature importance</h2>
<p>When we use a tree based approach we can also get an idea on which features are most important in the determining the class to which an observation belongs. We will need a different model “deand engine”rpart” to get to the feature importance and the derived decision tree.</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb339-1"><a href="part-2-machine-learning-with-r.html#cb339-1" aria-hidden="true" tabindex="-1"></a>tame_importance_mod <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>() <span class="sc">|&gt;</span></span>
<span id="cb339-2"><a href="part-2-machine-learning-with-r.html#cb339-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;rpart&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb339-3"><a href="part-2-machine-learning-with-r.html#cb339-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)<span class="co"># default engine</span></span>
<span id="cb339-4"><a href="part-2-machine-learning-with-r.html#cb339-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-5"><a href="part-2-machine-learning-with-r.html#cb339-5" aria-hidden="true" tabindex="-1"></a>tame_rpart_wf <span class="ot">&lt;-</span> tame_workflow <span class="sc">|&gt;</span></span>
<span id="cb339-6"><a href="part-2-machine-learning-with-r.html#cb339-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(tame_importance_mod)</span>
<span id="cb339-7"><a href="part-2-machine-learning-with-r.html#cb339-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-8"><a href="part-2-machine-learning-with-r.html#cb339-8" aria-hidden="true" tabindex="-1"></a><span class="do">## new fit using the updated workflow</span></span>
<span id="cb339-9"><a href="part-2-machine-learning-with-r.html#cb339-9" aria-hidden="true" tabindex="-1"></a>tame_importance_fit <span class="ot">&lt;-</span> tame_rpart_wf <span class="sc">|&gt;</span></span>
<span id="cb339-10"><a href="part-2-machine-learning-with-r.html#cb339-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> data_tame_train)</span>
<span id="cb339-11"><a href="part-2-machine-learning-with-r.html#cb339-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-12"><a href="part-2-machine-learning-with-r.html#cb339-12" aria-hidden="true" tabindex="-1"></a><span class="do">## decision tree</span></span>
<span id="cb339-13"><a href="part-2-machine-learning-with-r.html#cb339-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span></code></pre></div>
<pre><code>## Loading required package: rpart</code></pre>
<pre><code>## 
## Attaching package: &#39;rpart&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dials&#39;:
## 
##     prune</code></pre>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="part-2-machine-learning-with-r.html#cb343-1" aria-hidden="true" tabindex="-1"></a>tame_importance_fit <span class="sc">%&gt;%</span></span>
<span id="cb343-2"><a href="part-2-machine-learning-with-r.html#cb343-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>() <span class="sc">%&gt;%</span></span>
<span id="cb343-3"><a href="part-2-machine-learning-with-r.html#cb343-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart.plot</span>(<span class="at">roundint =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
</div>
<div id="case-study-qsar-data" class="section level2">
<h2>Case study; QSAR data</h2>
<p>To look at a more realistic case example, that is not so clear cut as the previous (educational) exercise. Let’s look at a dataset containing data suitable for Quantitative Structure Activity Relationships (QSAR).
We downloaded the data in a code chunk above as “qsar_oral_toxicity.csv”. The data should be available in a temporary directory on your machine. To see the contents of this directory type</p>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb344-1"><a href="part-2-machine-learning-with-r.html#cb344-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(here<span class="sc">::</span><span class="fu">here</span>(base_folder, <span class="st">&quot;data&quot;</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">pattern =</span> <span class="st">&quot;.csv&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;/Users/marcteunis/Documents/workspaces/course-materials/track-a/machine-learning-with-r/data/qsar_oral_toxicity.csv&quot;</code></pre>
<div id="exercise-2" class="section level5 unnumbered question">
<h5>Exercise 2</h5>
<ol style="list-style-type: decimal">
<li>Inspect the file <code>qsar_oral_toxicity.csv</code>, using the <code>head</code> command in the terminal, or on Windows: open the file with Notepad. Are there headers in this file?</li>
<li>Read the file into R, using the <code>read_csv()</code> funtion</li>
<li>Rename the columns with a string from “f1” to “f1025”</li>
<li>Reorder the classification column (“f1025”) to be the first column, and rename this column to <code>class</code></li>
<li>Look at the dataset</li>
<li>Tally the classification column, how many observations of each class do we have? Does this correspond with the meta data on UCL? Do you see a potential problem?</li>
<li>Isolate the classification column in a new R object</li>
<li>Remove the row with classifications (“f1025”) from the data and store the resulting new dataframe as a matrix, using the <code>as.matrix()</code> function.</li>
</ol>
</div>
<details>
<summary>
Click for the answer
</summary>
<p>Reading the data into R. This file has no headers. The last column in the data contains the labels.</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="part-2-machine-learning-with-r.html#cb346-1" aria-hidden="true" tabindex="-1"></a>data_qsar <span class="ot">&lt;-</span> <span class="fu">read_csv2</span>(</span>
<span id="cb346-2"><a href="part-2-machine-learning-with-r.html#cb346-2" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb346-3"><a href="part-2-machine-learning-with-r.html#cb346-3" aria-hidden="true" tabindex="-1"></a>    base_folder, </span>
<span id="cb346-4"><a href="part-2-machine-learning-with-r.html#cb346-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb346-5"><a href="part-2-machine-learning-with-r.html#cb346-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;qsar_oral_toxicity.csv&quot;</span>),</span>
<span id="cb346-6"><a href="part-2-machine-learning-with-r.html#cb346-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## ℹ Using &quot;&#39;,&#39;&quot; as decimal and &quot;&#39;.&#39;&quot; as grouping mark. Use `read_delim()` for more control.</code></pre>
<pre><code>## Rows: 8992 Columns: 1025
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;;&quot;
## chr    (1): X1025
## dbl (1024): X1, X2, X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15...
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb349-1"><a href="part-2-machine-learning-with-r.html#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="co"># answer</span></span>
<span id="cb349-2"><a href="part-2-machine-learning-with-r.html#cb349-2" aria-hidden="true" tabindex="-1"></a>names_new <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;f&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">1025</span>)</span>
<span id="cb349-3"><a href="part-2-machine-learning-with-r.html#cb349-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data_qsar) <span class="ot">&lt;-</span> names_new</span>
<span id="cb349-4"><a href="part-2-machine-learning-with-r.html#cb349-4" aria-hidden="true" tabindex="-1"></a>data_qsar <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb349-5"><a href="part-2-machine-learning-with-r.html#cb349-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(f1025, <span class="at">.before =</span> f1) <span class="sc">|&gt;</span></span>
<span id="cb349-6"><a href="part-2-machine-learning-with-r.html#cb349-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">class =</span> f1025)</span>
<span id="cb349-7"><a href="part-2-machine-learning-with-r.html#cb349-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-8"><a href="part-2-machine-learning-with-r.html#cb349-8" aria-hidden="true" tabindex="-1"></a>data_qsar <span class="sc">|&gt;</span> </span>
<span id="cb349-9"><a href="part-2-machine-learning-with-r.html#cb349-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(class) <span class="sc">|&gt;</span></span>
<span id="cb349-10"><a href="part-2-machine-learning-with-r.html#cb349-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   class        n
##   &lt;chr&gt;    &lt;int&gt;
## 1 negative  8251
## 2 positive   741</code></pre>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb351-1"><a href="part-2-machine-learning-with-r.html#cb351-1" aria-hidden="true" tabindex="-1"></a>classes <span class="ot">&lt;-</span> data_qsar<span class="sc">$</span>class</span>
<span id="cb351-2"><a href="part-2-machine-learning-with-r.html#cb351-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-3"><a href="part-2-machine-learning-with-r.html#cb351-3" aria-hidden="true" tabindex="-1"></a><span class="co">#data_qsar_all_numm &lt;- data_qsar |&gt;</span></span>
<span id="cb351-4"><a href="part-2-machine-learning-with-r.html#cb351-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  select(-class)</span></span>
<span id="cb351-5"><a href="part-2-machine-learning-with-r.html#cb351-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-6"><a href="part-2-machine-learning-with-r.html#cb351-6" aria-hidden="true" tabindex="-1"></a><span class="do">## look at the data</span></span>
<span id="cb351-7"><a href="part-2-machine-learning-with-r.html#cb351-7" aria-hidden="true" tabindex="-1"></a>data_qsar</span></code></pre></div>
<pre><code>## # A tibble: 8,992 × 1,025
##    class    f1    f2    f3    f4    f5    f6    f7    f8    f9   f10   f11   f12
##    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 nega…     0     0     0     0     0     0     0     0     0     0     1     0
##  2 nega…     0     0     1     0     0     0     0     0     0     0     1     0
##  3 nega…     0     0     0     0     0     0     0     0     0     0     1     0
##  4 nega…     0     0     0     0     0     0     0     1     0     0     1     0
##  5 nega…     0     0     0     0     0     0     0     0     0     0     0     0
##  6 nega…     1     0     0     0     0     0     1     0     0     0     0     0
##  7 nega…     0     0     0     0     0     0     0     0     0     0     1     0
##  8 posi…     0     0     1     0     0     0     0     0     0     0     0     0
##  9 nega…     0     0     0     0     0     0     0     0     0     0     0     0
## 10 nega…     0     0     0     0     0     0     0     0     0     0     0     0
## # ℹ 8,982 more rows
## # ℹ 1,012 more variables: f13 &lt;dbl&gt;, f14 &lt;dbl&gt;, f15 &lt;dbl&gt;, f16 &lt;dbl&gt;,
## #   f17 &lt;dbl&gt;, f18 &lt;dbl&gt;, f19 &lt;dbl&gt;, f20 &lt;dbl&gt;, f21 &lt;dbl&gt;, f22 &lt;dbl&gt;,
## #   f23 &lt;dbl&gt;, f24 &lt;dbl&gt;, f25 &lt;dbl&gt;, f26 &lt;dbl&gt;, f27 &lt;dbl&gt;, f28 &lt;dbl&gt;,
## #   f29 &lt;dbl&gt;, f30 &lt;dbl&gt;, f31 &lt;dbl&gt;, f32 &lt;dbl&gt;, f33 &lt;dbl&gt;, f34 &lt;dbl&gt;,
## #   f35 &lt;dbl&gt;, f36 &lt;dbl&gt;, f37 &lt;dbl&gt;, f38 &lt;dbl&gt;, f39 &lt;dbl&gt;, f40 &lt;dbl&gt;,
## #   f41 &lt;dbl&gt;, f42 &lt;dbl&gt;, f43 &lt;dbl&gt;, f44 &lt;dbl&gt;, f45 &lt;dbl&gt;, f46 &lt;dbl&gt;, …</code></pre>
</details>
<div class="question">
<div id="exercise-exploratory-data-analysis-2" class="section level5 unnumbered">
<h5>Exercise Exploratory Data Analysis 2</h5>
<ul>
<li>Use visualizations and transformations to explore your data in a systematic way</li>
<li>A task that statisticians call exploratory data analysis, or EDA for short.</li>
</ul>
</div>
<div id="eda-is-an-iterative-cycle-you" class="section level2">
<h2>EDA is an iterative cycle; you:</h2>
<ol style="list-style-type: decimal">
<li>Generate questions about your data.</li>
<li>Search for answers by visualising, transforming, and modelling your data.</li>
<li>Use what you learn to refine your questions and/or generate new questions.</li>
</ol>
<p><strong>You do not need to know statistics for EDA, but it helps if you do!</strong></p>
</div>
<div id="eda-is-not-a-formal-process-with-a-strict-set-of-rules" class="section level2">
<h2>EDA is not a formal process with a strict set of rules</h2>
<ul>
<li>EDA is a state of mind.</li>
<li>Should feel free to investigate every idea that occurs to you.</li>
<li>Some of these ideas will pan out, and some will be dead ends.</li>
<li>As your exploration continues, you will zoom in on a few particularly productive areas that you’ll eventually write up and communicate to others.</li>
</ul>
</div>
<div id="eda-steps" class="section level2">
<h2>EDA Steps</h2>
<p>To do data analysis, you’ll need to deploy all the tools of EDA: visualisation, transformation, and modelling.</p>
<p>When perfoming EDA consider</p>
<ol style="list-style-type: decimal">
<li>What question(s) are you trying to solve (or prove wrong)?</li>
<li>Which information do you need and can you come up with a plan to answer the question(s)</li>
<li>What kind of data do you have and how do you treat different types?</li>
<li>What’s missing from the data and how do you deal with it?</li>
<li>Where are the outliers and why should you care about them?</li>
<li>How can you add, change or remove features to get more out of your data?</li>
<li>Do you need additional data from other sources to relate to the dataset under scrutany?</li>
<li>Are underlying statitical assumptions met / how is data distribution looking?</li>
<li>What (exploratory) models apply or fit well to the data?</li>
<li>What is the undelying (experimental) design?</li>
<li>Is there multi-colinearity?</li>
</ol>
</div>
<div id="definitions" class="section level2">
<h2>Definitions</h2>
<ul>
<li>A <strong>variable</strong> is a quantity, quality, or property that you can measure.</li>
<li>A <strong>value</strong> is the state of a variable when you measure it. The value of a variable may change from measurement to measurement.</li>
<li>An <strong>observation</strong> is a set of measurements made under similar conditions. An observation will contain several values, each associated with a different variable. I’ll sometimes refer to an observation as a data point.</li>
<li>Tables: <strong>Tabular data</strong> is a set of values, each associated with a variable and an observation.</li>
<li>Tabular data is <em>tidy</em> if each value is placed in its own “cell”, each variable in its own column, and each observation in its own row.</li>
<li>In real-life, most data isn’t tidy, as we’ve seen in <strong>tidy data</strong>.</li>
</ul>
</div>
<div id="variation" class="section level2">
<h2>Variation</h2>
<p><strong>Variation</strong> is the tendency of the values of a variable to change from measurement to measurement.</p>
<ul>
<li><p>Categorical variables can also vary if you measure across different subjects (e.g. the eye colors of different people), or different times (e.g. the energy levels of an electron at different moments).</p></li>
<li><p>Every variable has its own pattern of variation, which can reveal interesting information. The best way to understand that pattern is to visualise the distribution of the variable’s values.</p></li>
</ul>
<div id="categorical-variables" class="section level3">
<h3>Categorical variables</h3>
<ul>
<li>A variable is <strong>categorical</strong> if it can only take one of a small set of values.<br />
</li>
<li>In R, categorical variables are usually saved as factors or character vectors.</li>
<li>To examine the distribution of a categorical variable, use a bar chart:</li>
</ul>
</div>
</div>
<div id="missing-values-1" class="section level2">
<h2>Missing values</h2>
<p>In a dataset such as this, I do not expect to encouter any missing values. The fingerprints are calculated from molecules, so it would not make sense to have missing values somewhere. But just to be sure, we can get the sum of missing values like this:</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb353-1"><a href="part-2-machine-learning-with-r.html#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_qsar))</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>One less thing to worry about.</p>
</div>
<div id="distributions" class="section level2">
<h2>Distributions</h2>
<p>Here we have a distribution of either value <code>0</code> or <code>1</code> in the data. Let’s check if on average the amount of <code>1</code>s is the same for positive and negative compounds. We will convert the dataframe to a long format to do more easy calculations and plotting with <code>{ggplot2}</code></p>
<p>Calculate first how many times a certain feature is present in the data.</p>
<details>
<summary>
Click for the answer
</summary>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="part-2-machine-learning-with-r.html#cb355-1" aria-hidden="true" tabindex="-1"></a>data_qsar_mtx <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb355-2"><a href="part-2-machine-learning-with-r.html#cb355-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb355-3"><a href="part-2-machine-learning-with-r.html#cb355-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb355-4"><a href="part-2-machine-learning-with-r.html#cb355-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-5"><a href="part-2-machine-learning-with-r.html#cb355-5" aria-hidden="true" tabindex="-1"></a>features <span class="ot">&lt;-</span> <span class="fu">colSums</span>(data_qsar_mtx) <span class="sc">|&gt;</span> </span>
<span id="cb355-6"><a href="part-2-machine-learning-with-r.html#cb355-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>()</span>
<span id="cb355-7"><a href="part-2-machine-learning-with-r.html#cb355-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-8"><a href="part-2-machine-learning-with-r.html#cb355-8" aria-hidden="true" tabindex="-1"></a>features <span class="sc">|&gt;</span></span>
<span id="cb355-9"><a href="part-2-machine-learning-with-r.html#cb355-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb355-10"><a href="part-2-machine-learning-with-r.html#cb355-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-44-1.png" width="672" /></p>
<p>So there are many featurs that are represented in the data at low frequencies and very few features that are respresented in the data very often.</p>
</details>
How do these distributions look if we split for negative and positive compounds
<details>
<summary>
Click for the answer
</summary>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="part-2-machine-learning-with-r.html#cb357-1" aria-hidden="true" tabindex="-1"></a>features_negative <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb357-2"><a href="part-2-machine-learning-with-r.html#cb357-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(class <span class="sc">==</span> <span class="st">&quot;negative&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb357-3"><a href="part-2-machine-learning-with-r.html#cb357-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb357-4"><a href="part-2-machine-learning-with-r.html#cb357-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span></span>
<span id="cb357-5"><a href="part-2-machine-learning-with-r.html#cb357-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colSums</span>() <span class="sc">|&gt;</span></span>
<span id="cb357-6"><a href="part-2-machine-learning-with-r.html#cb357-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb357-7"><a href="part-2-machine-learning-with-r.html#cb357-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">distro =</span> <span class="st">&quot;negative&quot;</span>)</span>
<span id="cb357-8"><a href="part-2-machine-learning-with-r.html#cb357-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-9"><a href="part-2-machine-learning-with-r.html#cb357-9" aria-hidden="true" tabindex="-1"></a>features_positive <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb357-10"><a href="part-2-machine-learning-with-r.html#cb357-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(class <span class="sc">==</span> <span class="st">&quot;positive&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb357-11"><a href="part-2-machine-learning-with-r.html#cb357-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb357-12"><a href="part-2-machine-learning-with-r.html#cb357-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span></span>
<span id="cb357-13"><a href="part-2-machine-learning-with-r.html#cb357-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colSums</span>() <span class="sc">|&gt;</span></span>
<span id="cb357-14"><a href="part-2-machine-learning-with-r.html#cb357-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb357-15"><a href="part-2-machine-learning-with-r.html#cb357-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">distro =</span> <span class="st">&quot;positive&quot;</span>)</span>
<span id="cb357-16"><a href="part-2-machine-learning-with-r.html#cb357-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-17"><a href="part-2-machine-learning-with-r.html#cb357-17" aria-hidden="true" tabindex="-1"></a>features_neg_pos <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb357-18"><a href="part-2-machine-learning-with-r.html#cb357-18" aria-hidden="true" tabindex="-1"></a>  features_negative,</span>
<span id="cb357-19"><a href="part-2-machine-learning-with-r.html#cb357-19" aria-hidden="true" tabindex="-1"></a>  features_positive</span>
<span id="cb357-20"><a href="part-2-machine-learning-with-r.html#cb357-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb357-21"><a href="part-2-machine-learning-with-r.html#cb357-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-22"><a href="part-2-machine-learning-with-r.html#cb357-22" aria-hidden="true" tabindex="-1"></a>features_neg_pos <span class="sc">|&gt;</span></span>
<span id="cb357-23"><a href="part-2-machine-learning-with-r.html#cb357-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb357-24"><a href="part-2-machine-learning-with-r.html#cb357-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_freqpoly</span>(<span class="fu">aes</span>(<span class="at">colour =</span> distro), <span class="at">alpha =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<img src="002_tidymodels_old_files/figure-html/unnamed-chunk-45-1.png" width="672" />
</details>
</div>
</div>
<div id="exercise-2-1" class="section level5 unnumbered question">
<h5>Exercise 2</h5>
<p>Are there differences in total amount of features between positive and negative compounds?</p>
<p>Be aware, that we have more negtives then positives in our data. Can you think of a way to normalize for this?</p>
<p><strong>TIPS</strong></p>
<ul>
<li>Create a frequency distribution of all features and group by compound class (negatives/positives)</li>
<li>Remember that <code>{ggplot2}</code> works best with long dataframe format</li>
<li>The <code>{ggplot2}</code> geom for frequency distribution is <code>geom_freqpoly()</code></li>
</ul>
</div>
<details>
<summary>
Click for the answer
</summary>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="part-2-machine-learning-with-r.html#cb359-1" aria-hidden="true" tabindex="-1"></a>data_qsar <span class="sc">|&gt;</span></span>
<span id="cb359-2"><a href="part-2-machine-learning-with-r.html#cb359-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(class) <span class="sc">|&gt;</span></span>
<span id="cb359-3"><a href="part-2-machine-learning-with-r.html#cb359-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>() <span class="ot">-&gt;</span> tally_compounds</span>
<span id="cb359-4"><a href="part-2-machine-learning-with-r.html#cb359-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-5"><a href="part-2-machine-learning-with-r.html#cb359-5" aria-hidden="true" tabindex="-1"></a>features_row_neg <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb359-6"><a href="part-2-machine-learning-with-r.html#cb359-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(class <span class="sc">==</span> <span class="st">&quot;negative&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb359-7"><a href="part-2-machine-learning-with-r.html#cb359-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb359-8"><a href="part-2-machine-learning-with-r.html#cb359-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span></span>
<span id="cb359-9"><a href="part-2-machine-learning-with-r.html#cb359-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowSums</span>() <span class="sc">|&gt;</span></span>
<span id="cb359-10"><a href="part-2-machine-learning-with-r.html#cb359-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb359-11"><a href="part-2-machine-learning-with-r.html#cb359-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">distro =</span> <span class="st">&quot;negative&quot;</span>)</span>
<span id="cb359-12"><a href="part-2-machine-learning-with-r.html#cb359-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-13"><a href="part-2-machine-learning-with-r.html#cb359-13" aria-hidden="true" tabindex="-1"></a>features_row_pos <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb359-14"><a href="part-2-machine-learning-with-r.html#cb359-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(class <span class="sc">==</span> <span class="st">&quot;positive&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb359-15"><a href="part-2-machine-learning-with-r.html#cb359-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb359-16"><a href="part-2-machine-learning-with-r.html#cb359-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span></span>
<span id="cb359-17"><a href="part-2-machine-learning-with-r.html#cb359-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowSums</span>() <span class="sc">|&gt;</span></span>
<span id="cb359-18"><a href="part-2-machine-learning-with-r.html#cb359-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb359-19"><a href="part-2-machine-learning-with-r.html#cb359-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">distro =</span> <span class="st">&quot;positive&quot;</span>)</span>
<span id="cb359-20"><a href="part-2-machine-learning-with-r.html#cb359-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-21"><a href="part-2-machine-learning-with-r.html#cb359-21" aria-hidden="true" tabindex="-1"></a>features_row_neg_pos <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb359-22"><a href="part-2-machine-learning-with-r.html#cb359-22" aria-hidden="true" tabindex="-1"></a>  features_row_neg,</span>
<span id="cb359-23"><a href="part-2-machine-learning-with-r.html#cb359-23" aria-hidden="true" tabindex="-1"></a>  features_row_pos</span>
<span id="cb359-24"><a href="part-2-machine-learning-with-r.html#cb359-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb359-25"><a href="part-2-machine-learning-with-r.html#cb359-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-26"><a href="part-2-machine-learning-with-r.html#cb359-26" aria-hidden="true" tabindex="-1"></a>features_row_neg_pos <span class="sc">|&gt;</span></span>
<span id="cb359-27"><a href="part-2-machine-learning-with-r.html#cb359-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb359-28"><a href="part-2-machine-learning-with-r.html#cb359-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_freqpoly</span>(<span class="fu">aes</span>(<span class="at">colour =</span> distro), <span class="at">alpha =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-46-1.png" width="672" /></p>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="part-2-machine-learning-with-r.html#cb361-1" aria-hidden="true" tabindex="-1"></a>features_row_neg_pos <span class="sc">|&gt;</span></span>
<span id="cb361-2"><a href="part-2-machine-learning-with-r.html#cb361-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(distro) <span class="sc">|&gt;</span></span>
<span id="cb361-3"><a href="part-2-machine-learning-with-r.html#cb361-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_feat =</span> <span class="fu">mean</span>(value))</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   distro   mean_feat
##   &lt;chr&gt;        &lt;dbl&gt;
## 1 negative      95.6
## 2 positive      91.4</code></pre>
<p>On average, there is not much difference in number of features per compound, if we compare negatives and positives</p>
</details>
</div>
<div id="sparsity" class="section level2">
<h2>Sparsity</h2>
<p>As we saw upon first inspection of the data, the fingerprints contain only 2 values: a <code>1</code> and a <code>0</code>. One of the disadvantages of describing molecules on the basis of fingerprints is that the resulting matrix is <em>sparse</em>. This means that there is a relatively low amount of information content (many zeros and a few ones) in the data. Let’s calculate how sparse the matrix is. We will write a function that we can recycle.</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="part-2-machine-learning-with-r.html#cb363-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> data_qsar</span>
<span id="cb363-2"><a href="part-2-machine-learning-with-r.html#cb363-2" aria-hidden="true" tabindex="-1"></a>only_numeric <span class="ot">&lt;-</span> <span class="fu">select_if</span>(df, is.numeric)</span>
<span id="cb363-3"><a href="part-2-machine-learning-with-r.html#cb363-3" aria-hidden="true" tabindex="-1"></a>number_numeric_cells <span class="ot">&lt;-</span> (<span class="fu">nrow</span>(df) <span class="sc">*</span> <span class="fu">ncol</span>(df))</span>
<span id="cb363-4"><a href="part-2-machine-learning-with-r.html#cb363-4" aria-hidden="true" tabindex="-1"></a>number_zeros <span class="ot">&lt;-</span> <span class="fu">sum</span>(df <span class="sc">==</span> <span class="dv">0</span>) </span>
<span id="cb363-5"><a href="part-2-machine-learning-with-r.html#cb363-5" aria-hidden="true" tabindex="-1"></a>number_ones <span class="ot">&lt;-</span> <span class="fu">sum</span>(df <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb363-6"><a href="part-2-machine-learning-with-r.html#cb363-6" aria-hidden="true" tabindex="-1"></a>sparsity <span class="ot">=</span> (number_ones <span class="sc">/</span> number_zeros)<span class="sc">*</span><span class="dv">100</span></span>
<span id="cb363-7"><a href="part-2-machine-learning-with-r.html#cb363-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-8"><a href="part-2-machine-learning-with-r.html#cb363-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Let&#39;s put this together in a function, we write a test to check for input</span></span>
<span id="cb363-9"><a href="part-2-machine-learning-with-r.html#cb363-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-10"><a href="part-2-machine-learning-with-r.html#cb363-10" aria-hidden="true" tabindex="-1"></a>get_sparsity_perc <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb363-11"><a href="part-2-machine-learning-with-r.html#cb363-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb363-12"><a href="part-2-machine-learning-with-r.html#cb363-12" aria-hidden="true" tabindex="-1"></a>  only_numeric <span class="ot">&lt;-</span> <span class="fu">select_if</span>(df, is.numeric)</span>
<span id="cb363-13"><a href="part-2-machine-learning-with-r.html#cb363-13" aria-hidden="true" tabindex="-1"></a>  only_numeric_mtx <span class="ot">&lt;-</span> only_numeric <span class="sc">|&gt;</span> <span class="fu">as.matrix</span>()</span>
<span id="cb363-14"><a href="part-2-machine-learning-with-r.html#cb363-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb363-15"><a href="part-2-machine-learning-with-r.html#cb363-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">## check if values of matrix are either 0 or 1</span></span>
<span id="cb363-16"><a href="part-2-machine-learning-with-r.html#cb363-16" aria-hidden="true" tabindex="-1"></a>  <span class="do">## %in% is functional for `match`</span></span>
<span id="cb363-17"><a href="part-2-machine-learning-with-r.html#cb363-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb363-18"><a href="part-2-machine-learning-with-r.html#cb363-18" aria-hidden="true" tabindex="-1"></a>      only_numeric_mtx <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb363-19"><a href="part-2-machine-learning-with-r.html#cb363-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all</span>() <span class="sc">==</span> <span class="cn">FALSE</span>){</span>
<span id="cb363-20"><a href="part-2-machine-learning-with-r.html#cb363-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Please check if input values are either ones               and/or zeros&quot;</span>)</span>
<span id="cb363-21"><a href="part-2-machine-learning-with-r.html#cb363-21" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb363-22"><a href="part-2-machine-learning-with-r.html#cb363-22" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb363-23"><a href="part-2-machine-learning-with-r.html#cb363-23" aria-hidden="true" tabindex="-1"></a>  number_numeric_cells <span class="ot">&lt;-</span> (<span class="fu">nrow</span>(df) <span class="sc">*</span> <span class="fu">ncol</span>(df))</span>
<span id="cb363-24"><a href="part-2-machine-learning-with-r.html#cb363-24" aria-hidden="true" tabindex="-1"></a>  number_zeros <span class="ot">&lt;-</span> <span class="fu">sum</span>(df <span class="sc">==</span> <span class="dv">0</span>) </span>
<span id="cb363-25"><a href="part-2-machine-learning-with-r.html#cb363-25" aria-hidden="true" tabindex="-1"></a>  number_ones <span class="ot">&lt;-</span> <span class="fu">sum</span>(df <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb363-26"><a href="part-2-machine-learning-with-r.html#cb363-26" aria-hidden="true" tabindex="-1"></a>  sparsity <span class="ot">=</span> (number_ones <span class="sc">/</span> number_zeros)<span class="sc">*</span><span class="dv">100</span></span>
<span id="cb363-27"><a href="part-2-machine-learning-with-r.html#cb363-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sparsity)</span>
<span id="cb363-28"><a href="part-2-machine-learning-with-r.html#cb363-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-29"><a href="part-2-machine-learning-with-r.html#cb363-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb363-30"><a href="part-2-machine-learning-with-r.html#cb363-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb363-31"><a href="part-2-machine-learning-with-r.html#cb363-31" aria-hidden="true" tabindex="-1"></a><span class="do">## test function</span></span>
<span id="cb363-32"><a href="part-2-machine-learning-with-r.html#cb363-32" aria-hidden="true" tabindex="-1"></a><span class="fu">get_sparsity_perc</span>(<span class="at">df =</span> data_qsar)</span>
<span id="cb363-33"><a href="part-2-machine-learning-with-r.html#cb363-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-34"><a href="part-2-machine-learning-with-r.html#cb363-34" aria-hidden="true" tabindex="-1"></a><span class="do">## check our test</span></span>
<span id="cb363-35"><a href="part-2-machine-learning-with-r.html#cb363-35" aria-hidden="true" tabindex="-1"></a>data_qsar_with_mutation <span class="ot">&lt;-</span> data_qsar</span>
<span id="cb363-36"><a href="part-2-machine-learning-with-r.html#cb363-36" aria-hidden="true" tabindex="-1"></a>data_qsar_with_mutation[<span class="dv">333</span>,<span class="dv">445</span>] <span class="ot">&lt;-</span> <span class="fl">9.887</span></span>
<span id="cb363-37"><a href="part-2-machine-learning-with-r.html#cb363-37" aria-hidden="true" tabindex="-1"></a><span class="fu">get_sparsity_perc</span>(data_qsar_with_mutation)</span>
<span id="cb363-38"><a href="part-2-machine-learning-with-r.html#cb363-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-39"><a href="part-2-machine-learning-with-r.html#cb363-39" aria-hidden="true" tabindex="-1"></a><span class="do">## getting unique values</span></span>
<span id="cb363-40"><a href="part-2-machine-learning-with-r.html#cb363-40" aria-hidden="true" tabindex="-1"></a><span class="fu">select_if</span>(data_qsar, is.numeric) <span class="sc">|&gt;</span></span>
<span id="cb363-41"><a href="part-2-machine-learning-with-r.html#cb363-41" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(unique) <span class="sc">|&gt;</span></span>
<span id="cb363-42"><a href="part-2-machine-learning-with-r.html#cb363-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span> </span>
<span id="cb363-43"><a href="part-2-machine-learning-with-r.html#cb363-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flatten</span>() <span class="sc">|&gt;</span> </span>
<span id="cb363-44"><a href="part-2-machine-learning-with-r.html#cb363-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb363-45"><a href="part-2-machine-learning-with-r.html#cb363-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-46"><a href="part-2-machine-learning-with-r.html#cb363-46" aria-hidden="true" tabindex="-1"></a><span class="fu">select_if</span>(data_qsar_with_mutation, is.numeric) <span class="sc">|&gt;</span></span>
<span id="cb363-47"><a href="part-2-machine-learning-with-r.html#cb363-47" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(unique) <span class="sc">|&gt;</span>  <span class="fu">unique</span>() <span class="sc">|&gt;</span> </span>
<span id="cb363-48"><a href="part-2-machine-learning-with-r.html#cb363-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flatten</span>() <span class="sc">|&gt;</span> </span>
<span id="cb363-49"><a href="part-2-machine-learning-with-r.html#cb363-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span></code></pre></div>
<div id="heatmap" class="section level3">
<h3>Heatmap</h3>
<p>Let’s look at the fingerprints and see how they differ between negatives and positives. Maybe we can learn something there. Because we have many features and observations, we will take a random sample, to reduce computation time.</p>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb364-1"><a href="part-2-machine-learning-with-r.html#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb364-2"><a href="part-2-machine-learning-with-r.html#cb364-2" aria-hidden="true" tabindex="-1"></a>data_qsar_sample <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb364-3"><a href="part-2-machine-learning-with-r.html#cb364-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data_qsar)) <span class="sc">|&gt;</span></span>
<span id="cb364-4"><a href="part-2-machine-learning-with-r.html#cb364-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_frac</span>(<span class="fl">0.005</span>)</span>
<span id="cb364-5"><a href="part-2-machine-learning-with-r.html#cb364-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-6"><a href="part-2-machine-learning-with-r.html#cb364-6" aria-hidden="true" tabindex="-1"></a>data_qsar_mtx_sample <span class="ot">&lt;-</span> data_qsar_sample <span class="sc">|&gt;</span></span>
<span id="cb364-7"><a href="part-2-machine-learning-with-r.html#cb364-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb364-8"><a href="part-2-machine-learning-with-r.html#cb364-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() </span>
<span id="cb364-9"><a href="part-2-machine-learning-with-r.html#cb364-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-10"><a href="part-2-machine-learning-with-r.html#cb364-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_qsar_mtx_sample) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb364-11"><a href="part-2-machine-learning-with-r.html#cb364-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;c&quot;</span>, </span>
<span id="cb364-12"><a href="part-2-machine-learning-with-r.html#cb364-12" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(data_qsar_mtx_sample)</span>
<span id="cb364-13"><a href="part-2-machine-learning-with-r.html#cb364-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb364-14"><a href="part-2-machine-learning-with-r.html#cb364-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-15"><a href="part-2-machine-learning-with-r.html#cb364-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-16"><a href="part-2-machine-learning-with-r.html#cb364-16" aria-hidden="true" tabindex="-1"></a>data_qsar_sample <span class="sc">|&gt;</span> </span>
<span id="cb364-17"><a href="part-2-machine-learning-with-r.html#cb364-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> f1<span class="sc">:</span>f1024, <span class="at">values_to =</span> <span class="st">&quot;score&quot;</span>, <span class="at">names_to =</span> <span class="st">&quot;feature&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb364-18"><a href="part-2-machine-learning-with-r.html#cb364-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb364-19"><a href="part-2-machine-learning-with-r.html#cb364-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">reorder</span>(<span class="fu">as_factor</span>(feature), score), </span>
<span id="cb364-20"><a href="part-2-machine-learning-with-r.html#cb364-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">as_factor</span>(score))) <span class="sc">+</span></span>
<span id="cb364-21"><a href="part-2-machine-learning-with-r.html#cb364-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">as_factor</span>(score))) <span class="sc">+</span> <span class="fu">facet_wrap</span>(class<span class="sc">~</span>row_id) <span class="sc">+</span></span>
<span id="cb364-22"><a href="part-2-machine-learning-with-r.html#cb364-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb364-23"><a href="part-2-machine-learning-with-r.html#cb364-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb364-24"><a href="part-2-machine-learning-with-r.html#cb364-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb364-25"><a href="part-2-machine-learning-with-r.html#cb364-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb364-26"><a href="part-2-machine-learning-with-r.html#cb364-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb364-27"><a href="part-2-machine-learning-with-r.html#cb364-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">4</span>))</span>
<span id="cb364-28"><a href="part-2-machine-learning-with-r.html#cb364-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb364-29"><a href="part-2-machine-learning-with-r.html#cb364-29" aria-hidden="true" tabindex="-1"></a><span class="do">## to save the graph in a readible size and format</span></span>
<span id="cb364-30"><a href="part-2-machine-learning-with-r.html#cb364-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave(&quot;test.png&quot;, height = 20, width = 20, units = &quot;cm&quot;, dpi = 300)</span></span>
<span id="cb364-31"><a href="part-2-machine-learning-with-r.html#cb364-31" aria-hidden="true" tabindex="-1"></a><span class="do">## or if you want to have a vectorgraph</span></span>
<span id="cb364-32"><a href="part-2-machine-learning-with-r.html#cb364-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave(&quot;test.png&quot;, height = 20, width = 20, units = &quot;cm&quot;, dpi = 300)</span></span></code></pre></div>
</div>
</div>
<div id="unsupervised-machine-learning" class="section level2">
<h2>Unsupervised machine learning</h2>
<p>Before we plan to do any kind of classification task on our data, it is good to consider doing an exploratory data analysis to learn more about our data.
Here we use a principal component analysis and a k-means clustering to learn some patterns.</p>
</div>
<div id="principal-component-analysis" class="section level2">
<h2>Principal Component Analysis</h2>
<p>For code see: <a href="https://cmdlinetips.com/2020/06/pca-with-tidymodels-in-r/" class="uri">https://cmdlinetips.com/2020/06/pca-with-tidymodels-in-r/</a></p>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb365-1"><a href="part-2-machine-learning-with-r.html#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb365-2"><a href="part-2-machine-learning-with-r.html#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb365-3"><a href="part-2-machine-learning-with-r.html#cb365-3" aria-hidden="true" tabindex="-1"></a><span class="co">#library(gapminder)</span></span>
<span id="cb365-4"><a href="part-2-machine-learning-with-r.html#cb365-4" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>(<span class="dv">16</span>))</span></code></pre></div>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb366-1"><a href="part-2-machine-learning-with-r.html#cb366-1" aria-hidden="true" tabindex="-1"></a>pca_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_qsar)</span>
<span id="cb366-2"><a href="part-2-machine-learning-with-r.html#cb366-2" aria-hidden="true" tabindex="-1"></a>pca_trans <span class="ot">&lt;-</span> pca_recipe <span class="sc">%&gt;%</span></span>
<span id="cb366-3"><a href="part-2-machine-learning-with-r.html#cb366-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># center the data</span></span>
<span id="cb366-4"><a href="part-2-machine-learning-with-r.html#cb366-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb366-5"><a href="part-2-machine-learning-with-r.html#cb366-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># center the data</span></span>
<span id="cb366-6"><a href="part-2-machine-learning-with-r.html#cb366-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb366-7"><a href="part-2-machine-learning-with-r.html#cb366-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pca on all numeric variables</span></span>
<span id="cb366-8"><a href="part-2-machine-learning-with-r.html#cb366-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">all_numeric</span>())</span>
<span id="cb366-9"><a href="part-2-machine-learning-with-r.html#cb366-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-10"><a href="part-2-machine-learning-with-r.html#cb366-10" aria-hidden="true" tabindex="-1"></a>pca_estimates <span class="ot">&lt;-</span> <span class="fu">prep</span>(pca_trans) <span class="do">## this step takes a bit longer to calculate</span></span>
<span id="cb366-11"><a href="part-2-machine-learning-with-r.html#cb366-11" aria-hidden="true" tabindex="-1"></a>pca_estimates<span class="sc">$</span>var_info</span>
<span id="cb366-12"><a href="part-2-machine-learning-with-r.html#cb366-12" aria-hidden="true" tabindex="-1"></a>sdev <span class="ot">&lt;-</span> pca_estimates<span class="sc">$</span>steps[[<span class="dv">3</span>]]<span class="sc">$</span>res<span class="sc">$</span>sdev</span>
<span id="cb366-13"><a href="part-2-machine-learning-with-r.html#cb366-13" aria-hidden="true" tabindex="-1"></a>percent_variation <span class="ot">&lt;-</span> sdev<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="fu">sum</span>(sdev<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb366-14"><a href="part-2-machine-learning-with-r.html#cb366-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-15"><a href="part-2-machine-learning-with-r.html#cb366-15" aria-hidden="true" tabindex="-1"></a>var_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">PC=</span><span class="fu">paste0</span>(<span class="st">&quot;PC&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sdev)),</span>
<span id="cb366-16"><a href="part-2-machine-learning-with-r.html#cb366-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">var_explained=</span>percent_variation,</span>
<span id="cb366-17"><a href="part-2-machine-learning-with-r.html#cb366-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb366-18"><a href="part-2-machine-learning-with-r.html#cb366-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-19"><a href="part-2-machine-learning-with-r.html#cb366-19" aria-hidden="true" tabindex="-1"></a>var_df <span class="sc">%&gt;%</span></span>
<span id="cb366-20"><a href="part-2-machine-learning-with-r.html#cb366-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PC =</span> <span class="fu">fct_inorder</span>(PC)) <span class="sc">%&gt;%</span></span>
<span id="cb366-21"><a href="part-2-machine-learning-with-r.html#cb366-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>PC,<span class="at">y=</span>var_explained))<span class="sc">+</span><span class="fu">geom_col</span>()</span>
<span id="cb366-22"><a href="part-2-machine-learning-with-r.html#cb366-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-23"><a href="part-2-machine-learning-with-r.html#cb366-23" aria-hidden="true" tabindex="-1"></a><span class="fu">juice</span>(pca_estimates) </span>
<span id="cb366-24"><a href="part-2-machine-learning-with-r.html#cb366-24" aria-hidden="true" tabindex="-1"></a><span class="fu">juice</span>(pca_estimates) <span class="sc">%&gt;%</span></span>
<span id="cb366-25"><a href="part-2-machine-learning-with-r.html#cb366-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(PC1, PC2)) <span class="sc">+</span></span>
<span id="cb366-26"><a href="part-2-machine-learning-with-r.html#cb366-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> class), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb366-27"><a href="part-2-machine-learning-with-r.html#cb366-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;PCA from tidymodels&quot;</span>)</span></code></pre></div>
</div>
<div id="t-sne" class="section level2">
<h2>t-SNE</h2>
<p>T-SNE or <a href="https://en.wikipedia.org/wiki/T-distributed_stochastic_neighbor_embedding">t-distributed stochastic neighbor embedding</a> is way to visualize high dimensional data. It is especially used in many of the omics areas. For illustrative puposes, we here show how to run such a model on our QSAR data.</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb367-1"><a href="part-2-machine-learning-with-r.html#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;embed&quot;)</span></span>
<span id="cb367-2"><a href="part-2-machine-learning-with-r.html#cb367-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(embed)</span>
<span id="cb367-3"><a href="part-2-machine-learning-with-r.html#cb367-3" aria-hidden="true" tabindex="-1"></a>pca_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_qsar)</span>
<span id="cb367-4"><a href="part-2-machine-learning-with-r.html#cb367-4" aria-hidden="true" tabindex="-1"></a>pca_trans <span class="ot">&lt;-</span> pca_recipe <span class="sc">%&gt;%</span></span>
<span id="cb367-5"><a href="part-2-machine-learning-with-r.html#cb367-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># center the data</span></span>
<span id="cb367-6"><a href="part-2-machine-learning-with-r.html#cb367-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb367-7"><a href="part-2-machine-learning-with-r.html#cb367-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># center the data</span></span>
<span id="cb367-8"><a href="part-2-machine-learning-with-r.html#cb367-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb367-9"><a href="part-2-machine-learning-with-r.html#cb367-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pca on all numeric variables</span></span>
<span id="cb367-10"><a href="part-2-machine-learning-with-r.html#cb367-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_umap</span>(<span class="fu">all_numeric</span>())</span>
<span id="cb367-11"><a href="part-2-machine-learning-with-r.html#cb367-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb367-12"><a href="part-2-machine-learning-with-r.html#cb367-12" aria-hidden="true" tabindex="-1"></a>pca_estimates <span class="ot">&lt;-</span> <span class="fu">prep</span>(pca_trans) <span class="do">## this step takes a bit longer to calculate</span></span>
<span id="cb367-13"><a href="part-2-machine-learning-with-r.html#cb367-13" aria-hidden="true" tabindex="-1"></a>pca_estimates<span class="sc">$</span>var_info</span></code></pre></div>
<pre><code>## # A tibble: 1,025 × 4
##    variable type      role      source  
##    &lt;chr&gt;    &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
##  1 class    &lt;chr [3]&gt; predictor original
##  2 f1       &lt;chr [2]&gt; predictor original
##  3 f2       &lt;chr [2]&gt; predictor original
##  4 f3       &lt;chr [2]&gt; predictor original
##  5 f4       &lt;chr [2]&gt; predictor original
##  6 f5       &lt;chr [2]&gt; predictor original
##  7 f6       &lt;chr [2]&gt; predictor original
##  8 f7       &lt;chr [2]&gt; predictor original
##  9 f8       &lt;chr [2]&gt; predictor original
## 10 f9       &lt;chr [2]&gt; predictor original
## # ℹ 1,015 more rows</code></pre>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb369-1"><a href="part-2-machine-learning-with-r.html#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="fu">juice</span>(pca_estimates) </span></code></pre></div>
<pre><code>## # A tibble: 8,992 × 3
##    class     UMAP1 UMAP2
##    &lt;fct&gt;     &lt;dbl&gt; &lt;dbl&gt;
##  1 negative  0.347 -3.39
##  2 negative  0.280 -3.18
##  3 negative  0.242 -3.15
##  4 negative  0.230 -3.18
##  5 negative  1.84  -1.51
##  6 negative  0.416 -2.68
##  7 negative  2.43  -3.08
##  8 positive -5.07   4.52
##  9 negative -4.98   4.41
## 10 negative -3.87   5.63
## # ℹ 8,982 more rows</code></pre>
<div class="sourceCode" id="cb371"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb371-1"><a href="part-2-machine-learning-with-r.html#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="fu">juice</span>(pca_estimates) <span class="sc">%&gt;%</span></span>
<span id="cb371-2"><a href="part-2-machine-learning-with-r.html#cb371-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(UMAP1, UMAP2)) <span class="sc">+</span></span>
<span id="cb371-3"><a href="part-2-machine-learning-with-r.html#cb371-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> class), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb371-4"><a href="part-2-machine-learning-with-r.html#cb371-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;UMAP (t-SNE) from tidymodels&quot;</span>)</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-51-1.png" width="672" /></p>
</div>
<div id="k-means-clustering" class="section level2">
<h2>K-means clustering</h2>
<p>To show you that we do not need to stick to the Tidymodels framework (but I would recommend it), here we use a dedicated workflow for K-means clustering. An equivalent Tidymodels approach can be found <a href="https://www.tidymodels.org/learn/statistics/k-means/">here</a></p>
<p><a href="https://uc-r.github.io/kmeans_clustering" class="uri">https://uc-r.github.io/kmeans_clustering</a></p>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="part-2-machine-learning-with-r.html#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)  <span class="co"># data manipulation</span></span>
<span id="cb372-2"><a href="part-2-machine-learning-with-r.html#cb372-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cluster)    <span class="co"># clustering algorithms</span></span>
<span id="cb372-3"><a href="part-2-machine-learning-with-r.html#cb372-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span>
<span id="cb372-4"><a href="part-2-machine-learning-with-r.html#cb372-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-5"><a href="part-2-machine-learning-with-r.html#cb372-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb372-6"><a href="part-2-machine-learning-with-r.html#cb372-6" aria-hidden="true" tabindex="-1"></a>data_qsar_k <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb372-7"><a href="part-2-machine-learning-with-r.html#cb372-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_frac</span>(<span class="fl">0.1</span>) <span class="sc">|&gt;</span></span>
<span id="cb372-8"><a href="part-2-machine-learning-with-r.html#cb372-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb372-9"><a href="part-2-machine-learning-with-r.html#cb372-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-10"><a href="part-2-machine-learning-with-r.html#cb372-10" aria-hidden="true" tabindex="-1"></a>row_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data_qsar_k)), data_qsar_k<span class="sc">$</span>class, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb372-11"><a href="part-2-machine-learning-with-r.html#cb372-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-12"><a href="part-2-machine-learning-with-r.html#cb372-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(data_qsar_k) <span class="ot">&lt;-</span> row_names</span>
<span id="cb372-13"><a href="part-2-machine-learning-with-r.html#cb372-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-14"><a href="part-2-machine-learning-with-r.html#cb372-14" aria-hidden="true" tabindex="-1"></a>data_qsar_k <span class="ot">&lt;-</span> data_qsar_k <span class="sc">|&gt;</span></span>
<span id="cb372-15"><a href="part-2-machine-learning-with-r.html#cb372-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class)</span>
<span id="cb372-16"><a href="part-2-machine-learning-with-r.html#cb372-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-17"><a href="part-2-machine-learning-with-r.html#cb372-17" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">scale</span>(data_qsar_k) </span>
<span id="cb372-18"><a href="part-2-machine-learning-with-r.html#cb372-18" aria-hidden="true" tabindex="-1"></a>df</span>
<span id="cb372-19"><a href="part-2-machine-learning-with-r.html#cb372-19" aria-hidden="true" tabindex="-1"></a>distance <span class="ot">&lt;-</span> <span class="fu">get_dist</span>(df)</span>
<span id="cb372-20"><a href="part-2-machine-learning-with-r.html#cb372-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-21"><a href="part-2-machine-learning-with-r.html#cb372-21" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(df))</span>
<span id="cb372-22"><a href="part-2-machine-learning-with-r.html#cb372-22" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_qsar_sample))</span>
<span id="cb372-23"><a href="part-2-machine-learning-with-r.html#cb372-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-24"><a href="part-2-machine-learning-with-r.html#cb372-24" aria-hidden="true" tabindex="-1"></a><span class="do">## takes a long time to compute</span></span>
<span id="cb372-25"><a href="part-2-machine-learning-with-r.html#cb372-25" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_dist</span>(</span>
<span id="cb372-26"><a href="part-2-machine-learning-with-r.html#cb372-26" aria-hidden="true" tabindex="-1"></a>  distance, </span>
<span id="cb372-27"><a href="part-2-machine-learning-with-r.html#cb372-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">gradient =</span> <span class="fu">list</span>(</span>
<span id="cb372-28"><a href="part-2-machine-learning-with-r.html#cb372-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">&quot;#00AFBB&quot;</span>, </span>
<span id="cb372-29"><a href="part-2-machine-learning-with-r.html#cb372-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">mid =</span> <span class="st">&quot;white&quot;</span>, </span>
<span id="cb372-30"><a href="part-2-machine-learning-with-r.html#cb372-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">high =</span> <span class="st">&quot;#FC4E07&quot;</span></span>
<span id="cb372-31"><a href="part-2-machine-learning-with-r.html#cb372-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb372-32"><a href="part-2-machine-learning-with-r.html#cb372-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb372-33"><a href="part-2-machine-learning-with-r.html#cb372-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-34"><a href="part-2-machine-learning-with-r.html#cb372-34" aria-hidden="true" tabindex="-1"></a>k2 <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(df, <span class="at">centers =</span> <span class="dv">2</span>)</span>
<span id="cb372-35"><a href="part-2-machine-learning-with-r.html#cb372-35" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_cluster</span>(k2, <span class="at">data =</span> df)</span>
<span id="cb372-36"><a href="part-2-machine-learning-with-r.html#cb372-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-37"><a href="part-2-machine-learning-with-r.html#cb372-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-38"><a href="part-2-machine-learning-with-r.html#cb372-38" aria-hidden="true" tabindex="-1"></a><span class="do">## Multiple clusters</span></span>
<span id="cb372-39"><a href="part-2-machine-learning-with-r.html#cb372-39" aria-hidden="true" tabindex="-1"></a>k3 <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(df, <span class="at">centers =</span> <span class="dv">3</span>, <span class="at">nstart =</span> <span class="dv">25</span>)</span>
<span id="cb372-40"><a href="part-2-machine-learning-with-r.html#cb372-40" aria-hidden="true" tabindex="-1"></a>k4 <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(df, <span class="at">centers =</span> <span class="dv">4</span>, <span class="at">nstart =</span> <span class="dv">25</span>)</span>
<span id="cb372-41"><a href="part-2-machine-learning-with-r.html#cb372-41" aria-hidden="true" tabindex="-1"></a>k5 <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(df, <span class="at">centers =</span> <span class="dv">5</span>, <span class="at">nstart =</span> <span class="dv">25</span>)</span>
<span id="cb372-42"><a href="part-2-machine-learning-with-r.html#cb372-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-43"><a href="part-2-machine-learning-with-r.html#cb372-43" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">fviz_cluster</span>(k2, <span class="at">geom =</span> <span class="st">&quot;point&quot;</span>, <span class="at">data =</span> df) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;k = 2&quot;</span>)</span>
<span id="cb372-44"><a href="part-2-machine-learning-with-r.html#cb372-44" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">fviz_cluster</span>(k3, <span class="at">geom =</span> <span class="st">&quot;point&quot;</span>,  <span class="at">data =</span> df) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;k = 3&quot;</span>)</span>
<span id="cb372-45"><a href="part-2-machine-learning-with-r.html#cb372-45" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">fviz_cluster</span>(k4, <span class="at">geom =</span> <span class="st">&quot;point&quot;</span>,  <span class="at">data =</span> df) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;k = 4&quot;</span>)</span>
<span id="cb372-46"><a href="part-2-machine-learning-with-r.html#cb372-46" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">fviz_cluster</span>(k5, <span class="at">geom =</span> <span class="st">&quot;point&quot;</span>,  <span class="at">data =</span> df) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;k = 5&quot;</span>)</span>
<span id="cb372-47"><a href="part-2-machine-learning-with-r.html#cb372-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-48"><a href="part-2-machine-learning-with-r.html#cb372-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb372-49"><a href="part-2-machine-learning-with-r.html#cb372-49" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, p3, p4, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb372-50"><a href="part-2-machine-learning-with-r.html#cb372-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-51"><a href="part-2-machine-learning-with-r.html#cb372-51" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb372-52"><a href="part-2-machine-learning-with-r.html#cb372-52" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_nbclust</span>(df, kmeans, <span class="at">method =</span> <span class="st">&quot;wss&quot;</span>)</span>
<span id="cb372-53"><a href="part-2-machine-learning-with-r.html#cb372-53" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_nbclust</span>(df, kmeans, <span class="at">method =</span> <span class="st">&quot;silhouette&quot;</span>)</span>
<span id="cb372-54"><a href="part-2-machine-learning-with-r.html#cb372-54" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span></code></pre></div>
<div id="exercise-building-an-xgboost-model-on-the-qsar-data-2" class="section level5 unnumbered question">
<h5>Exercise Building an XGBoost model on the QSAR data 2</h5>
<p>A much used machine learning algorithm is a regression tree as we saw before. A variant that is often used to boost accuracy is the <a href="https://parsnip.tidymodels.org/reference/details_boost_tree_xgboost.html">XGBoost model</a>. In this Exercise we invite you to build such a model and run some predictions and diagnostics on your model. You can follow the steps from the previous demo, where we used the TAME <code>PFAS/Statins</code> dataset to build a Random Forest model.</p>
<p>These are the steps you need to take</p>
<ol style="list-style-type: decimal">
<li>Build the appropriate model - <a href="https://parsnip.tidymodels.org/reference/details_boost_tree_xgboost.html">XGBoost</a></li>
<li>Choose the right mode and engine</li>
<li>Build a suitable recipe</li>
<li>Generate a random split of the data for a train and a test portion - maybe think about stratification here</li>
<li>Build a workflow, including the model and the recipe</li>
<li>Fit our model on the training data</li>
<li>Test our model on the test dataset</li>
<li>Evaluate the model by assessing some performance metrics (accuracy, confusion table)</li>
</ol>
</div>
<details>
<summary>
Click for the answer
</summary>
<p>Beause we have class imbalance (more negatives then positives) we use a stratification approach</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb373-1"><a href="part-2-machine-learning-with-r.html#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="do">## prepare data splits</span></span>
<span id="cb373-2"><a href="part-2-machine-learning-with-r.html#cb373-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb373-3"><a href="part-2-machine-learning-with-r.html#cb373-3" aria-hidden="true" tabindex="-1"></a>qsar_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(<span class="at">data =</span> data_qsar, </span>
<span id="cb373-4"><a href="part-2-machine-learning-with-r.html#cb373-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">prop =</span> <span class="fl">0.80</span>, </span>
<span id="cb373-5"><a href="part-2-machine-learning-with-r.html#cb373-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">strata =</span> class)</span>
<span id="cb373-6"><a href="part-2-machine-learning-with-r.html#cb373-6" aria-hidden="true" tabindex="-1"></a>qsar_train <span class="ot">&lt;-</span> <span class="fu">training</span>(qsar_split)</span>
<span id="cb373-7"><a href="part-2-machine-learning-with-r.html#cb373-7" aria-hidden="true" tabindex="-1"></a>qsar_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(qsar_split)</span></code></pre></div>
<p>Let’s look at the tally
<a href="https://r4ds.github.io/bookclub-tmwr/class-imbalance.html" class="uri">https://r4ds.github.io/bookclub-tmwr/class-imbalance.html</a></p>
<div class="sourceCode" id="cb374"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb374-1"><a href="part-2-machine-learning-with-r.html#cb374-1" aria-hidden="true" tabindex="-1"></a>qsar_test <span class="sc">|&gt;</span></span>
<span id="cb374-2"><a href="part-2-machine-learning-with-r.html#cb374-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(class) <span class="sc">|&gt;</span></span>
<span id="cb374-3"><a href="part-2-machine-learning-with-r.html#cb374-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   class        n
##   &lt;chr&gt;    &lt;int&gt;
## 1 negative  1665
## 2 positive   134</code></pre>
<div class="sourceCode" id="cb376"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb376-1"><a href="part-2-machine-learning-with-r.html#cb376-1" aria-hidden="true" tabindex="-1"></a>qsar_train <span class="sc">|&gt;</span></span>
<span id="cb376-2"><a href="part-2-machine-learning-with-r.html#cb376-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(class) <span class="sc">|&gt;</span></span>
<span id="cb376-3"><a href="part-2-machine-learning-with-r.html#cb376-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   class        n
##   &lt;chr&gt;    &lt;int&gt;
## 1 negative  6586
## 2 positive   607</code></pre>
</div>
<div id="xgboost" class="section level2">
<h2>XGBoost</h2>
<p>See: <a href="https://parsnip.tidymodels.org/reference/details_boost_tree_xgboost.html" class="uri">https://parsnip.tidymodels.org/reference/details_boost_tree_xgboost.html</a></p>
<div class="sourceCode" id="cb378"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb378-1"><a href="part-2-machine-learning-with-r.html#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="do">## prepare model recipe</span></span>
<span id="cb378-2"><a href="part-2-machine-learning-with-r.html#cb378-2" aria-hidden="true" tabindex="-1"></a>xgb_mod <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">mtry =</span> <span class="dv">50</span>, <span class="at">trees =</span> <span class="dv">500</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb378-3"><a href="part-2-machine-learning-with-r.html#cb378-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb378-4"><a href="part-2-machine-learning-with-r.html#cb378-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)</span>
<span id="cb378-5"><a href="part-2-machine-learning-with-r.html#cb378-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-6"><a href="part-2-machine-learning-with-r.html#cb378-6" aria-hidden="true" tabindex="-1"></a>xgb_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(class <span class="sc">~</span> ., <span class="at">data =</span> qsar_train) <span class="sc">|&gt;</span></span>
<span id="cb378-7"><a href="part-2-machine-learning-with-r.html#cb378-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb378-8"><a href="part-2-machine-learning-with-r.html#cb378-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb378-9"><a href="part-2-machine-learning-with-r.html#cb378-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb378-10"><a href="part-2-machine-learning-with-r.html#cb378-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-11"><a href="part-2-machine-learning-with-r.html#cb378-11" aria-hidden="true" tabindex="-1"></a>xgb_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb378-12"><a href="part-2-machine-learning-with-r.html#cb378-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(xgb_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb378-13"><a href="part-2-machine-learning-with-r.html#cb378-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(xgb_rec)</span>
<span id="cb378-14"><a href="part-2-machine-learning-with-r.html#cb378-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-15"><a href="part-2-machine-learning-with-r.html#cb378-15" aria-hidden="true" tabindex="-1"></a><span class="co">#prep &lt;- prep(rf_rec)</span></span>
<span id="cb378-16"><a href="part-2-machine-learning-with-r.html#cb378-16" aria-hidden="true" tabindex="-1"></a><span class="co">#juiced &lt;- juice(prep)</span></span>
<span id="cb378-17"><a href="part-2-machine-learning-with-r.html#cb378-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-18"><a href="part-2-machine-learning-with-r.html#cb378-18" aria-hidden="true" tabindex="-1"></a>data_qsar <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb378-19"><a href="part-2-machine-learning-with-r.html#cb378-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">as_factor</span>(class))</span>
<span id="cb378-20"><a href="part-2-machine-learning-with-r.html#cb378-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-21"><a href="part-2-machine-learning-with-r.html#cb378-21" aria-hidden="true" tabindex="-1"></a>qsar_test <span class="ot">&lt;-</span> qsar_test <span class="sc">|&gt;</span></span>
<span id="cb378-22"><a href="part-2-machine-learning-with-r.html#cb378-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">as_factor</span>(class))</span>
<span id="cb378-23"><a href="part-2-machine-learning-with-r.html#cb378-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-24"><a href="part-2-machine-learning-with-r.html#cb378-24" aria-hidden="true" tabindex="-1"></a>qsar_train <span class="ot">&lt;-</span> qsar_train <span class="sc">|&gt;</span></span>
<span id="cb378-25"><a href="part-2-machine-learning-with-r.html#cb378-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">as_factor</span>(class))</span>
<span id="cb378-26"><a href="part-2-machine-learning-with-r.html#cb378-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-27"><a href="part-2-machine-learning-with-r.html#cb378-27" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb378-28"><a href="part-2-machine-learning-with-r.html#cb378-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-29"><a href="part-2-machine-learning-with-r.html#cb378-29" aria-hidden="true" tabindex="-1"></a><span class="do">## fit model</span></span>
<span id="cb378-30"><a href="part-2-machine-learning-with-r.html#cb378-30" aria-hidden="true" tabindex="-1"></a>xgb_fit <span class="ot">&lt;-</span> xgb_wf <span class="sc">%&gt;%</span> </span>
<span id="cb378-31"><a href="part-2-machine-learning-with-r.html#cb378-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> qsar_train)</span>
<span id="cb378-32"><a href="part-2-machine-learning-with-r.html#cb378-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-33"><a href="part-2-machine-learning-with-r.html#cb378-33" aria-hidden="true" tabindex="-1"></a><span class="do">## see model metrics</span></span>
<span id="cb378-34"><a href="part-2-machine-learning-with-r.html#cb378-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-35"><a href="part-2-machine-learning-with-r.html#cb378-35" aria-hidden="true" tabindex="-1"></a>xgb_fit <span class="sc">%&gt;%</span> <span class="fu">extract_fit_parsnip</span>()</span></code></pre></div>
<pre><code>## parsnip model object
## 
## ##### xgb.Booster
## raw: 863.8 Kb 
## call:
##   xgboost::xgb.train(params = list(eta = 0.3, max_depth = 6, gamma = 0, 
##     colsample_bytree = 1, colsample_bynode = 0.048828125, min_child_weight = 1, 
##     subsample = 1), data = x$data, nrounds = 500, watchlist = x$watchlist, 
##     verbose = 0, nthread = 1, objective = &quot;binary:logistic&quot;)
## params (as set within xgb.train):
##   eta = &quot;0.3&quot;, max_depth = &quot;6&quot;, gamma = &quot;0&quot;, colsample_bytree = &quot;1&quot;, colsample_bynode = &quot;0.048828125&quot;, min_child_weight = &quot;1&quot;, subsample = &quot;1&quot;, nthread = &quot;1&quot;, objective = &quot;binary:logistic&quot;, validate_parameters = &quot;TRUE&quot;
## xgb.attributes:
##   niter
## callbacks:
##   cb.evaluation.log()
## # of features: 1024 
## niter: 500
## nfeatures : 1024 
## evaluation_log:
##     iter training_logloss
##        1       0.50282655
##        2       0.39467603
## ---                      
##      499       0.02022062
##      500       0.02018738</code></pre>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb380-1"><a href="part-2-machine-learning-with-r.html#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(xgb_fit, qsar_test)</span></code></pre></div>
<pre><code>## # A tibble: 1,799 × 1
##    .pred_class
##    &lt;fct&gt;      
##  1 negative   
##  2 negative   
##  3 negative   
##  4 negative   
##  5 negative   
##  6 positive   
##  7 negative   
##  8 negative   
##  9 negative   
## 10 negative   
## # ℹ 1,789 more rows</code></pre>
<div class="sourceCode" id="cb382"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb382-1"><a href="part-2-machine-learning-with-r.html#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model eval</span></span>
<span id="cb382-2"><a href="part-2-machine-learning-with-r.html#cb382-2" aria-hidden="true" tabindex="-1"></a>xgb_fit <span class="sc">%&gt;%</span> </span>
<span id="cb382-3"><a href="part-2-machine-learning-with-r.html#cb382-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>( <span class="at">new_data =</span> qsar_test) <span class="sc">%&gt;%</span> </span>
<span id="cb382-4"><a href="part-2-machine-learning-with-r.html#cb382-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(qsar_test[<span class="st">&quot;class&quot;</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb382-5"><a href="part-2-machine-learning-with-r.html#cb382-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(<span class="at">truth=</span> <span class="fu">as.factor</span>(class), .pred_class) </span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.957</code></pre>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb384-1"><a href="part-2-machine-learning-with-r.html#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="do">## confusion matrix</span></span>
<span id="cb384-2"><a href="part-2-machine-learning-with-r.html#cb384-2" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">confusionMatrix</span>(</span>
<span id="cb384-3"><a href="part-2-machine-learning-with-r.html#cb384-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.factor</span>(qsar_test<span class="sc">$</span>class), </span>
<span id="cb384-4"><a href="part-2-machine-learning-with-r.html#cb384-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(xgb_fit, <span class="at">new_data =</span> qsar_test)<span class="sc">$</span>.pred_class)</span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##           Reference
## Prediction negative positive
##   negative     1646       19
##   positive       59       75
##                                           
##                Accuracy : 0.9566          
##                  95% CI : (0.9462, 0.9656)
##     No Information Rate : 0.9477          
##     P-Value [Acc &gt; NIR] : 0.04729         
##                                           
##                   Kappa : 0.6355          
##                                           
##  Mcnemar&#39;s Test P-Value : 1.006e-05       
##                                           
##             Sensitivity : 0.9654          
##             Specificity : 0.7979          
##          Pos Pred Value : 0.9886          
##          Neg Pred Value : 0.5597          
##              Prevalence : 0.9477          
##          Detection Rate : 0.9150          
##    Detection Prevalence : 0.9255          
##       Balanced Accuracy : 0.8816          
##                                           
##        &#39;Positive&#39; Class : negative        
## </code></pre>
<div class="sourceCode" id="cb386"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb386-1"><a href="part-2-machine-learning-with-r.html#cb386-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(</span>
<span id="cb386-2"><a href="part-2-machine-learning-with-r.html#cb386-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(xgb_fit, qsar_test),</span>
<span id="cb386-3"><a href="part-2-machine-learning-with-r.html#cb386-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(xgb_fit, qsar_test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>),</span>
<span id="cb386-4"><a href="part-2-machine-learning-with-r.html#cb386-4" aria-hidden="true" tabindex="-1"></a>    qsar_test[,<span class="dv">1</span>]</span>
<span id="cb386-5"><a href="part-2-machine-learning-with-r.html#cb386-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> predictions</span>
<span id="cb386-6"><a href="part-2-machine-learning-with-r.html#cb386-6" aria-hidden="true" tabindex="-1"></a>predictions</span></code></pre></div>
<pre><code>## # A tibble: 1,799 × 4
##    .pred_class .pred_negative .pred_positive class   
##    &lt;fct&gt;                &lt;dbl&gt;          &lt;dbl&gt; &lt;fct&gt;   
##  1 negative             0.999      0.00131   negative
##  2 negative             1.00       0.000378  negative
##  3 negative             0.976      0.0241    negative
##  4 negative             0.983      0.0173    negative
##  5 negative             0.999      0.000697  negative
##  6 positive             0.489      0.511     positive
##  7 negative             0.999      0.00142   negative
##  8 negative             0.622      0.378     negative
##  9 negative             0.937      0.0634    negative
## 10 negative             1.00       0.0000561 negative
## # ℹ 1,789 more rows</code></pre>
</details>
</div>
<div id="tuning-our-model" class="section level2">
<h2>Tuning our model</h2>
<p>Above we arbitrarily chose trees = 200 and mtry = 50. These arguments is called hyperparameters. We can more structurally tune our model when we do a grid search for the optimal hyperparameters that yield the best accuracy of our model.</p>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb388-1"><a href="part-2-machine-learning-with-r.html#cb388-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)  <span class="co"># for the tune package, along with the rest of tidymodels</span></span>
<span id="cb388-2"><a href="part-2-machine-learning-with-r.html#cb388-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-3"><a href="part-2-machine-learning-with-r.html#cb388-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper packages</span></span>
<span id="cb388-4"><a href="part-2-machine-learning-with-r.html#cb388-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)  <span class="co"># for visualizing a decision tree</span></span>
<span id="cb388-5"><a href="part-2-machine-learning-with-r.html#cb388-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)         <span class="co"># for variable importance plots</span></span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;vip&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:utils&#39;:
## 
##     vi</code></pre>
</details>
</div>
<div id="model-tuning" class="section level2">
<h2>Model tuning</h2>
<p>Model tuning, means that we will try to find the optimal value for the so-called hyperparameters of the model. These parameters are the paramters that define some setting of the model. For the Random Forest model we saw earlier, we chose an arbitrary value for instance for the <code>mtry</code> and <code>trees</code> hyperparameters. During the model tuning process, we run muliple models with varying values for the hyperparameters. Each time we evaluate the model to check the performance. The result from this tuning will hopefully yield the best setting for our hyperparameters. Finally, we can run the model one last time with these optimized setting to get the maximum performance. Because model tuning is expensive in terms of computing power, I have run the computation on a Virtual Machine in the Cloud. A machine with 30 cores and 472 Gb RAM memory. A big computer, much bigger than your laptop. The results of these expensive calculations were saved to disk. They can be found online <a href="**ADD%20LINK**">here</a>.
To tune the hyperparameters of our XGBoost model we can update (create a new) model using a grid search. This is structural way of defining different values for our hyperparameters. We stick to the <a href="https://www.tidymodels.org/start/tuning/">Tidymodels tuning workflow here</a>.</p>
<p>In stead of defining a value for the hyperparameters, we use the <code>tune()</code> function to act as a placeholder for the actual values from the tune grid:</p>
<div class="sourceCode" id="cb391"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb391-1"><a href="part-2-machine-learning-with-r.html#cb391-1" aria-hidden="true" tabindex="-1"></a>xgb_mod_tune <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb391-2"><a href="part-2-machine-learning-with-r.html#cb391-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>(), </span>
<span id="cb391-3"><a href="part-2-machine-learning-with-r.html#cb391-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb391-4"><a href="part-2-machine-learning-with-r.html#cb391-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb391-5"><a href="part-2-machine-learning-with-r.html#cb391-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb391-6"><a href="part-2-machine-learning-with-r.html#cb391-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)</span></code></pre></div>
<p>In order to get a structured collection of possible combinations of our hyperperparameters, we can use the <code>grid_regular()</code> function.</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb392-1"><a href="part-2-machine-learning-with-r.html#cb392-1" aria-hidden="true" tabindex="-1"></a>tree_grid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(</span>
<span id="cb392-2"><a href="part-2-machine-learning-with-r.html#cb392-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trees</span>(),</span>
<span id="cb392-3"><a href="part-2-machine-learning-with-r.html#cb392-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tree_depth</span>(),</span>
<span id="cb392-4"><a href="part-2-machine-learning-with-r.html#cb392-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(<span class="fu">mtry</span>(), <span class="fu">select</span>(data_qsar , <span class="sc">-</span>class)),</span>
<span id="cb392-5"><a href="part-2-machine-learning-with-r.html#cb392-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>Armed with this grid we need to create multiple folds of our data to run the models.</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb393-1"><a href="part-2-machine-learning-with-r.html#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234</span>)</span>
<span id="cb393-2"><a href="part-2-machine-learning-with-r.html#cb393-2" aria-hidden="true" tabindex="-1"></a>cell_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(qsar_train, <span class="at">v =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>We tune our parameters according the grid, over the data-folds we created. This step takes a long time to compute. I ran this on 30 core VM, with 472 Gb RAM. A very large machine, in comparison to a standards laptop, almost 4x more compute power. On that machine it took about 2 hours for the code below to finish. That is why I stored the results on disk, so that you do not need to run this. For safety reasons, I out-commented the code, so that you do not accidentally run it.</p>
<div class="sourceCode" id="cb394"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb394-1"><a href="part-2-machine-learning-with-r.html#cb394-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(345)</span></span>
<span id="cb394-2"><a href="part-2-machine-learning-with-r.html#cb394-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-3"><a href="part-2-machine-learning-with-r.html#cb394-3" aria-hidden="true" tabindex="-1"></a><span class="co"># tree_grid &lt;- grid_regular(</span></span>
<span id="cb394-4"><a href="part-2-machine-learning-with-r.html#cb394-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   trees(),</span></span>
<span id="cb394-5"><a href="part-2-machine-learning-with-r.html#cb394-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   tree_depth(),</span></span>
<span id="cb394-6"><a href="part-2-machine-learning-with-r.html#cb394-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   finalize(mtry(), select(data_qsar , -class)),</span></span>
<span id="cb394-7"><a href="part-2-machine-learning-with-r.html#cb394-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   levels = 3)</span></span>
<span id="cb394-8"><a href="part-2-machine-learning-with-r.html#cb394-8" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb394-9"><a href="part-2-machine-learning-with-r.html#cb394-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb394-10"><a href="part-2-machine-learning-with-r.html#cb394-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(234)</span></span>
<span id="cb394-11"><a href="part-2-machine-learning-with-r.html#cb394-11" aria-hidden="true" tabindex="-1"></a><span class="co"># cell_folds &lt;- vfold_cv(qsar_train, v = 3)</span></span>
<span id="cb394-12"><a href="part-2-machine-learning-with-r.html#cb394-12" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb394-13"><a href="part-2-machine-learning-with-r.html#cb394-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-14"><a href="part-2-machine-learning-with-r.html#cb394-14" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_wf_tune &lt;- workflow() %&gt;%</span></span>
<span id="cb394-15"><a href="part-2-machine-learning-with-r.html#cb394-15" aria-hidden="true" tabindex="-1"></a><span class="co">#  add_model(xgb_mod_tune) %&gt;%</span></span>
<span id="cb394-16"><a href="part-2-machine-learning-with-r.html#cb394-16" aria-hidden="true" tabindex="-1"></a><span class="co">#  add_formula(class ~ .)</span></span>
<span id="cb394-17"><a href="part-2-machine-learning-with-r.html#cb394-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-18"><a href="part-2-machine-learning-with-r.html#cb394-18" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_res &lt;- </span></span>
<span id="cb394-19"><a href="part-2-machine-learning-with-r.html#cb394-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  xgb_wf_tune %&gt;% </span></span>
<span id="cb394-20"><a href="part-2-machine-learning-with-r.html#cb394-20" aria-hidden="true" tabindex="-1"></a><span class="co">#  tune_grid(</span></span>
<span id="cb394-21"><a href="part-2-machine-learning-with-r.html#cb394-21" aria-hidden="true" tabindex="-1"></a><span class="co">#    resamples = cell_folds,</span></span>
<span id="cb394-22"><a href="part-2-machine-learning-with-r.html#cb394-22" aria-hidden="true" tabindex="-1"></a><span class="co">#    grid = tree_grid, control = control_grid(verbose = TRUE))</span></span>
<span id="cb394-23"><a href="part-2-machine-learning-with-r.html#cb394-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb394-24"><a href="part-2-machine-learning-with-r.html#cb394-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-25"><a href="part-2-machine-learning-with-r.html#cb394-25" aria-hidden="true" tabindex="-1"></a><span class="co">#xgb_res</span></span>
<span id="cb394-26"><a href="part-2-machine-learning-with-r.html#cb394-26" aria-hidden="true" tabindex="-1"></a><span class="co">#write_rds(xgb_res, here::here(base_folder, &quot;data&quot;, &quot;xgb_res.rds&quot;))</span></span></code></pre></div>
</div>
<div id="read-results-from-disk" class="section level2">
<h2>Read results from disk</h2>
<div class="sourceCode" id="cb395"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb395-1"><a href="part-2-machine-learning-with-r.html#cb395-1" aria-hidden="true" tabindex="-1"></a>xgb_res <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_rds</span>(here<span class="sc">::</span><span class="fu">here</span>(base_folder, <span class="st">&quot;data&quot;</span>, <span class="st">&quot;xgb_res.rds&quot;</span>))</span>
<span id="cb395-2"><a href="part-2-machine-learning-with-r.html#cb395-2" aria-hidden="true" tabindex="-1"></a>xgb_res</span></code></pre></div>
<pre><code>## # Tuning results
## # 3-fold cross-validation 
## # A tibble: 3 × 4
##   splits              id    .metrics          .notes          
##   &lt;list&gt;              &lt;chr&gt; &lt;list&gt;            &lt;list&gt;          
## 1 &lt;split [4795/2398]&gt; Fold1 &lt;tibble [54 × 7]&gt; &lt;tibble [0 × 3]&gt;
## 2 &lt;split [4795/2398]&gt; Fold2 &lt;tibble [54 × 7]&gt; &lt;tibble [0 × 3]&gt;
## 3 &lt;split [4796/2397]&gt; Fold3 &lt;tibble [54 × 7]&gt; &lt;tibble [0 × 3]&gt;</code></pre>
<div class="sourceCode" id="cb397"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb397-1"><a href="part-2-machine-learning-with-r.html#cb397-1" aria-hidden="true" tabindex="-1"></a>hyper_p <span class="ot">&lt;-</span> xgb_res <span class="sc">|&gt;</span></span>
<span id="cb397-2"><a href="part-2-machine-learning-with-r.html#cb397-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span>
<span id="cb397-3"><a href="part-2-machine-learning-with-r.html#cb397-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-4"><a href="part-2-machine-learning-with-r.html#cb397-4" aria-hidden="true" tabindex="-1"></a>xgb_res <span class="sc">%&gt;%</span></span>
<span id="cb397-5"><a href="part-2-machine-learning-with-r.html#cb397-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb397-6"><a href="part-2-machine-learning-with-r.html#cb397-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="fu">factor</span>(tree_depth)) <span class="sc">%&gt;%</span></span>
<span id="cb397-7"><a href="part-2-machine-learning-with-r.html#cb397-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(trees, mean, <span class="at">color =</span> tree_depth)) <span class="sc">+</span></span>
<span id="cb397-8"><a href="part-2-machine-learning-with-r.html#cb397-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  geom_line(size = 1.5, alpha = 0.6) +</span></span>
<span id="cb397-9"><a href="part-2-machine-learning-with-r.html#cb397-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb397-10"><a href="part-2-machine-learning-with-r.html#cb397-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb397-11"><a href="part-2-machine-learning-with-r.html#cb397-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>()) <span class="sc">+</span></span>
<span id="cb397-12"><a href="part-2-machine-learning-with-r.html#cb397-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>, <span class="at">begin =</span> .<span class="dv">9</span>, <span class="at">end =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb397-13"><a href="part-2-machine-learning-with-r.html#cb397-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>mtry)</span></code></pre></div>
<p><img src="002_tidymodels_old_files/figure-html/unnamed-chunk-61-1.png" width="672" /></p>
<div class="sourceCode" id="cb398"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb398-1"><a href="part-2-machine-learning-with-r.html#cb398-1" aria-hidden="true" tabindex="-1"></a>xgb_res <span class="sc">%&gt;%</span></span>
<span id="cb398-2"><a href="part-2-machine-learning-with-r.html#cb398-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_best</span>(<span class="st">&quot;accuracy&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 5 × 9
##    mtry trees tree_depth .metric  .estimator  mean     n  std_err .config       
##   &lt;int&gt; &lt;int&gt;      &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;         
## 1  1024  1000         15 accuracy binary     0.932     3 0.00125  Preprocessor1…
## 2  1024  2000         15 accuracy binary     0.932     3 0.000551 Preprocessor1…
## 3  1024  2000          8 accuracy binary     0.932     3 0.000825 Preprocessor1…
## 4   512  1000          8 accuracy binary     0.932     3 0.000492 Preprocessor1…
## 5   512  1000         15 accuracy binary     0.932     3 0.000771 Preprocessor1…</code></pre>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb400-1"><a href="part-2-machine-learning-with-r.html#cb400-1" aria-hidden="true" tabindex="-1"></a>best_boost <span class="ot">&lt;-</span> xgb_res <span class="sc">%&gt;%</span></span>
<span id="cb400-2"><a href="part-2-machine-learning-with-r.html#cb400-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_best</span>(<span class="st">&quot;accuracy&quot;</span>)</span>
<span id="cb400-3"><a href="part-2-machine-learning-with-r.html#cb400-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-4"><a href="part-2-machine-learning-with-r.html#cb400-4" aria-hidden="true" tabindex="-1"></a>final_wf <span class="ot">&lt;-</span> </span>
<span id="cb400-5"><a href="part-2-machine-learning-with-r.html#cb400-5" aria-hidden="true" tabindex="-1"></a>  xgb_wf <span class="sc">%&gt;%</span> </span>
<span id="cb400-6"><a href="part-2-machine-learning-with-r.html#cb400-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_boost)</span>
<span id="cb400-7"><a href="part-2-machine-learning-with-r.html#cb400-7" aria-hidden="true" tabindex="-1"></a>final_wf</span></code></pre></div>
<pre><code>## ══ Workflow ════════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: boost_tree()
## 
## ── Preprocessor ────────────────────────────────────────────────────────────────
## 3 Recipe Steps
## 
## • step_center()
## • step_scale()
## • step_zv()
## 
## ── Model ───────────────────────────────────────────────────────────────────────
## Boosted Tree Model Specification (classification)
## 
## Main Arguments:
##   mtry = 50
##   trees = 500
## 
## Computational engine: xgboost</code></pre>
<div class="sourceCode" id="cb402"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb402-1"><a href="part-2-machine-learning-with-r.html#cb402-1" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> </span>
<span id="cb402-2"><a href="part-2-machine-learning-with-r.html#cb402-2" aria-hidden="true" tabindex="-1"></a>  final_wf <span class="sc">%&gt;%</span></span>
<span id="cb402-3"><a href="part-2-machine-learning-with-r.html#cb402-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(qsar_split) </span>
<span id="cb402-4"><a href="part-2-machine-learning-with-r.html#cb402-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-5"><a href="part-2-machine-learning-with-r.html#cb402-5" aria-hidden="true" tabindex="-1"></a>final_fit<span class="sc">$</span>.metrics</span></code></pre></div>
<pre><code>## [[1]]
## # A tibble: 2 × 4
##   .metric  .estimator .estimate .config             
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
## 1 accuracy binary         0.960 Preprocessor1_Model1
## 2 roc_auc  binary         0.902 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb404"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb404-1"><a href="part-2-machine-learning-with-r.html#cb404-1" aria-hidden="true" tabindex="-1"></a>final_fit<span class="sc">$</span>.predictions</span></code></pre></div>
<pre><code>## [[1]]
## # A tibble: 1,799 × 6
##    .pred_negative .pred_positive  .row .pred_class class    .config             
##             &lt;dbl&gt;          &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;       &lt;fct&gt;    &lt;chr&gt;               
##  1          1.00       0.000378      6 negative    negative Preprocessor1_Model1
##  2          1.00       0.000252     19 negative    negative Preprocessor1_Model1
##  3          0.997      0.00272      23 negative    negative Preprocessor1_Model1
##  4          0.991      0.00851      24 negative    negative Preprocessor1_Model1
##  5          0.998      0.00153      34 negative    negative Preprocessor1_Model1
##  6          0.451      0.549        37 positive    positive Preprocessor1_Model1
##  7          0.999      0.000511     38 negative    negative Preprocessor1_Model1
##  8          0.589      0.411        40 negative    negative Preprocessor1_Model1
##  9          0.956      0.0437       42 negative    negative Preprocessor1_Model1
## 10          1.00       0.0000170    43 negative    negative Preprocessor1_Model1
## # ℹ 1,789 more rows</code></pre>
<div class="sourceCode" id="cb406"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb406-1"><a href="part-2-machine-learning-with-r.html#cb406-1" aria-hidden="true" tabindex="-1"></a>final_fit<span class="sc">$</span>.predictions[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb406-2"><a href="part-2-machine-learning-with-r.html#cb406-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(<span class="at">truth=</span> <span class="fu">as.factor</span>(class), .pred_class) </span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.960</code></pre>
<div class="sourceCode" id="cb408"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb408-1"><a href="part-2-machine-learning-with-r.html#cb408-1" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">confusionMatrix</span>(</span>
<span id="cb408-2"><a href="part-2-machine-learning-with-r.html#cb408-2" aria-hidden="true" tabindex="-1"></a>  final_fit<span class="sc">$</span>.predictions[[<span class="dv">1</span>]]<span class="sc">$</span>.pred_class, final_fit<span class="sc">$</span>.predictions[[<span class="dv">1</span>]]<span class="sc">$</span>class )</span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##           Reference
## Prediction negative positive
##   negative     1649       56
##   positive       16       78
##                                           
##                Accuracy : 0.96            
##                  95% CI : (0.9499, 0.9686)
##     No Information Rate : 0.9255          
##     P-Value [Acc &gt; NIR] : 9.833e-10       
##                                           
##                   Kappa : 0.6635          
##                                           
##  Mcnemar&#39;s Test P-Value : 4.303e-06       
##                                           
##             Sensitivity : 0.9904          
##             Specificity : 0.5821          
##          Pos Pred Value : 0.9672          
##          Neg Pred Value : 0.8298          
##              Prevalence : 0.9255          
##          Detection Rate : 0.9166          
##    Detection Prevalence : 0.9477          
##       Balanced Accuracy : 0.7862          
##                                           
##        &#39;Positive&#39; Class : negative        
## </code></pre>
</div>
<div id="bigger-grid" class="section level2">
<h2>Bigger grid</h2>
<p><a href="https://cran.r-project.org/web/packages/doFuture/vignettes/doFuture.html" class="uri">https://cran.r-project.org/web/packages/doFuture/vignettes/doFuture.html</a></p>
<div class="sourceCode" id="cb410"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb410-1"><a href="part-2-machine-learning-with-r.html#cb410-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # ## we can optimize the big grid tuning using a different engine</span></span>
<span id="cb410-2"><a href="part-2-machine-learning-with-r.html#cb410-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  xgb_l_tune &lt;- boost_tree(</span></span>
<span id="cb410-3"><a href="part-2-machine-learning-with-r.html#cb410-3" aria-hidden="true" tabindex="-1"></a><span class="co">#    trees = tune(),</span></span>
<span id="cb410-4"><a href="part-2-machine-learning-with-r.html#cb410-4" aria-hidden="true" tabindex="-1"></a><span class="co">#    mtry = tune(),</span></span>
<span id="cb410-5"><a href="part-2-machine-learning-with-r.html#cb410-5" aria-hidden="true" tabindex="-1"></a><span class="co">#    tree_depth = tune()) %&gt;% </span></span>
<span id="cb410-6"><a href="part-2-machine-learning-with-r.html#cb410-6" aria-hidden="true" tabindex="-1"></a><span class="co">#    set_engine(&quot;xgboost&quot;) |&gt;</span></span>
<span id="cb410-7"><a href="part-2-machine-learning-with-r.html#cb410-7" aria-hidden="true" tabindex="-1"></a><span class="co">#    set_mode(&quot;classification&quot;)</span></span>
<span id="cb410-8"><a href="part-2-machine-learning-with-r.html#cb410-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # </span></span>
<span id="cb410-9"><a href="part-2-machine-learning-with-r.html#cb410-9" aria-hidden="true" tabindex="-1"></a><span class="co"># # tree_grid &lt;- grid_regular(</span></span>
<span id="cb410-10"><a href="part-2-machine-learning-with-r.html#cb410-10" aria-hidden="true" tabindex="-1"></a><span class="co"># #   trees(),</span></span>
<span id="cb410-11"><a href="part-2-machine-learning-with-r.html#cb410-11" aria-hidden="true" tabindex="-1"></a><span class="co"># #   tree_depth(),</span></span>
<span id="cb410-12"><a href="part-2-machine-learning-with-r.html#cb410-12" aria-hidden="true" tabindex="-1"></a><span class="co"># #   finalize(mtry(), select(data_qsar , -class)),</span></span>
<span id="cb410-13"><a href="part-2-machine-learning-with-r.html#cb410-13" aria-hidden="true" tabindex="-1"></a><span class="co"># #   levels = 10)</span></span>
<span id="cb410-14"><a href="part-2-machine-learning-with-r.html#cb410-14" aria-hidden="true" tabindex="-1"></a><span class="co"># # </span></span>
<span id="cb410-15"><a href="part-2-machine-learning-with-r.html#cb410-15" aria-hidden="true" tabindex="-1"></a><span class="co"># # </span></span>
<span id="cb410-16"><a href="part-2-machine-learning-with-r.html#cb410-16" aria-hidden="true" tabindex="-1"></a><span class="co"># # set.seed(234)</span></span>
<span id="cb410-17"><a href="part-2-machine-learning-with-r.html#cb410-17" aria-hidden="true" tabindex="-1"></a><span class="co"># # cell_folds &lt;- vfold_cv(qsar_train, v = 10)</span></span>
<span id="cb410-18"><a href="part-2-machine-learning-with-r.html#cb410-18" aria-hidden="true" tabindex="-1"></a><span class="co"># # </span></span>
<span id="cb410-19"><a href="part-2-machine-learning-with-r.html#cb410-19" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-20"><a href="part-2-machine-learning-with-r.html#cb410-20" aria-hidden="true" tabindex="-1"></a><span class="co"># # </span></span>
<span id="cb410-21"><a href="part-2-machine-learning-with-r.html#cb410-21" aria-hidden="true" tabindex="-1"></a><span class="co"># # set.seed(345)</span></span>
<span id="cb410-22"><a href="part-2-machine-learning-with-r.html#cb410-22" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-23"><a href="part-2-machine-learning-with-r.html#cb410-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ## read results from disk</span></span>
<span id="cb410-24"><a href="part-2-machine-learning-with-r.html#cb410-24" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_l_res &lt;- readr::read_rds(&quot;xgb_l_res.rds&quot;)</span></span>
<span id="cb410-25"><a href="part-2-machine-learning-with-r.html#cb410-25" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-26"><a href="part-2-machine-learning-with-r.html#cb410-26" aria-hidden="true" tabindex="-1"></a><span class="co">#  xgb_wf_l_tune &lt;- workflow() %&gt;%</span></span>
<span id="cb410-27"><a href="part-2-machine-learning-with-r.html#cb410-27" aria-hidden="true" tabindex="-1"></a><span class="co">#    add_model(xgb_l_tune) %&gt;%</span></span>
<span id="cb410-28"><a href="part-2-machine-learning-with-r.html#cb410-28" aria-hidden="true" tabindex="-1"></a><span class="co">#    add_formula(class ~ .)</span></span>
<span id="cb410-29"><a href="part-2-machine-learning-with-r.html#cb410-29" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-30"><a href="part-2-machine-learning-with-r.html#cb410-30" aria-hidden="true" tabindex="-1"></a><span class="co"># #xgb_l_res &lt;- </span></span>
<span id="cb410-31"><a href="part-2-machine-learning-with-r.html#cb410-31" aria-hidden="true" tabindex="-1"></a><span class="co"># #  xgb_wf_l_tune %&gt;% </span></span>
<span id="cb410-32"><a href="part-2-machine-learning-with-r.html#cb410-32" aria-hidden="true" tabindex="-1"></a><span class="co"># #  tune_grid(</span></span>
<span id="cb410-33"><a href="part-2-machine-learning-with-r.html#cb410-33" aria-hidden="true" tabindex="-1"></a><span class="co"># #    resamples = cell_folds,</span></span>
<span id="cb410-34"><a href="part-2-machine-learning-with-r.html#cb410-34" aria-hidden="true" tabindex="-1"></a><span class="co"># #    grid = tree_grid, control = control_grid(verbose = TRUE))</span></span>
<span id="cb410-35"><a href="part-2-machine-learning-with-r.html#cb410-35" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb410-36"><a href="part-2-machine-learning-with-r.html#cb410-36" aria-hidden="true" tabindex="-1"></a><span class="co"># #xgb_l_res</span></span>
<span id="cb410-37"><a href="part-2-machine-learning-with-r.html#cb410-37" aria-hidden="true" tabindex="-1"></a><span class="co"># #readr::write_rds(xgb_l_res, &quot;xgb_l_res.rds&quot;)</span></span>
<span id="cb410-38"><a href="part-2-machine-learning-with-r.html#cb410-38" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-39"><a href="part-2-machine-learning-with-r.html#cb410-39" aria-hidden="true" tabindex="-1"></a><span class="co"># hyper_p &lt;- xgb_l_res |&gt;</span></span>
<span id="cb410-40"><a href="part-2-machine-learning-with-r.html#cb410-40" aria-hidden="true" tabindex="-1"></a><span class="co">#   collect_metrics()</span></span>
<span id="cb410-41"><a href="part-2-machine-learning-with-r.html#cb410-41" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-42"><a href="part-2-machine-learning-with-r.html#cb410-42" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_l_res %&gt;%</span></span>
<span id="cb410-43"><a href="part-2-machine-learning-with-r.html#cb410-43" aria-hidden="true" tabindex="-1"></a><span class="co">#   collect_metrics() %&gt;%</span></span>
<span id="cb410-44"><a href="part-2-machine-learning-with-r.html#cb410-44" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(tree_depth = factor(tree_depth)) %&gt;%</span></span>
<span id="cb410-45"><a href="part-2-machine-learning-with-r.html#cb410-45" aria-hidden="true" tabindex="-1"></a><span class="co">#   ggplot(aes(trees, mean, color = tree_depth)) +</span></span>
<span id="cb410-46"><a href="part-2-machine-learning-with-r.html#cb410-46" aria-hidden="true" tabindex="-1"></a><span class="co"># #  geom_line(size = 1.5, alpha = 0.6) +</span></span>
<span id="cb410-47"><a href="part-2-machine-learning-with-r.html#cb410-47" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_point(size = 2) +</span></span>
<span id="cb410-48"><a href="part-2-machine-learning-with-r.html#cb410-48" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap(~ .metric, scales = &quot;free&quot;, nrow = 2) +</span></span>
<span id="cb410-49"><a href="part-2-machine-learning-with-r.html#cb410-49" aria-hidden="true" tabindex="-1"></a><span class="co">#   scale_x_log10(labels = scales::label_number()) +</span></span>
<span id="cb410-50"><a href="part-2-machine-learning-with-r.html#cb410-50" aria-hidden="true" tabindex="-1"></a><span class="co">#   scale_color_viridis_d(option = &quot;plasma&quot;, begin = .9, end = 0) +</span></span>
<span id="cb410-51"><a href="part-2-machine-learning-with-r.html#cb410-51" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap(~mtry)</span></span>
<span id="cb410-52"><a href="part-2-machine-learning-with-r.html#cb410-52" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-53"><a href="part-2-machine-learning-with-r.html#cb410-53" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_l_res %&gt;%</span></span>
<span id="cb410-54"><a href="part-2-machine-learning-with-r.html#cb410-54" aria-hidden="true" tabindex="-1"></a><span class="co">#   show_best(&quot;accuracy&quot;)</span></span>
<span id="cb410-55"><a href="part-2-machine-learning-with-r.html#cb410-55" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-56"><a href="part-2-machine-learning-with-r.html#cb410-56" aria-hidden="true" tabindex="-1"></a><span class="co"># best_boost &lt;- xgb_l_res %&gt;%</span></span>
<span id="cb410-57"><a href="part-2-machine-learning-with-r.html#cb410-57" aria-hidden="true" tabindex="-1"></a><span class="co">#   select_best(&quot;accuracy&quot;)</span></span>
<span id="cb410-58"><a href="part-2-machine-learning-with-r.html#cb410-58" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-59"><a href="part-2-machine-learning-with-r.html#cb410-59" aria-hidden="true" tabindex="-1"></a><span class="co"># final_wf &lt;- </span></span>
<span id="cb410-60"><a href="part-2-machine-learning-with-r.html#cb410-60" aria-hidden="true" tabindex="-1"></a><span class="co">#   xgb_wf %&gt;% </span></span>
<span id="cb410-61"><a href="part-2-machine-learning-with-r.html#cb410-61" aria-hidden="true" tabindex="-1"></a><span class="co">#   finalize_workflow(best_boost)</span></span>
<span id="cb410-62"><a href="part-2-machine-learning-with-r.html#cb410-62" aria-hidden="true" tabindex="-1"></a><span class="co"># final_wf</span></span>
<span id="cb410-63"><a href="part-2-machine-learning-with-r.html#cb410-63" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-64"><a href="part-2-machine-learning-with-r.html#cb410-64" aria-hidden="true" tabindex="-1"></a><span class="co"># final_fit &lt;- </span></span>
<span id="cb410-65"><a href="part-2-machine-learning-with-r.html#cb410-65" aria-hidden="true" tabindex="-1"></a><span class="co">#   final_wf %&gt;%</span></span>
<span id="cb410-66"><a href="part-2-machine-learning-with-r.html#cb410-66" aria-hidden="true" tabindex="-1"></a><span class="co">#   last_fit(qsar_split) </span></span>
<span id="cb410-67"><a href="part-2-machine-learning-with-r.html#cb410-67" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-68"><a href="part-2-machine-learning-with-r.html#cb410-68" aria-hidden="true" tabindex="-1"></a><span class="co"># final_fit$.metrics</span></span>
<span id="cb410-69"><a href="part-2-machine-learning-with-r.html#cb410-69" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-70"><a href="part-2-machine-learning-with-r.html#cb410-70" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_fit %&gt;% extract_fit_parsnip()</span></span>
<span id="cb410-71"><a href="part-2-machine-learning-with-r.html#cb410-71" aria-hidden="true" tabindex="-1"></a><span class="co"># #predict(final_fit, qsar_test)</span></span>
<span id="cb410-72"><a href="part-2-machine-learning-with-r.html#cb410-72" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-73"><a href="part-2-machine-learning-with-r.html#cb410-73" aria-hidden="true" tabindex="-1"></a><span class="co"># final_fit$.predictions</span></span>
<span id="cb410-74"><a href="part-2-machine-learning-with-r.html#cb410-74" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-75"><a href="part-2-machine-learning-with-r.html#cb410-75" aria-hidden="true" tabindex="-1"></a><span class="co"># final_fit$.predictions[[1]] %&gt;% </span></span>
<span id="cb410-76"><a href="part-2-machine-learning-with-r.html#cb410-76" aria-hidden="true" tabindex="-1"></a><span class="co">#   accuracy(truth= as.factor(class), .pred_class) </span></span>
<span id="cb410-77"><a href="part-2-machine-learning-with-r.html#cb410-77" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb410-78"><a href="part-2-machine-learning-with-r.html#cb410-78" aria-hidden="true" tabindex="-1"></a><span class="co"># caret::confusionMatrix(</span></span>
<span id="cb410-79"><a href="part-2-machine-learning-with-r.html#cb410-79" aria-hidden="true" tabindex="-1"></a><span class="co">#   final_fit$.predictions[[1]]$.pred_class, final_fit$.predictions[[1]]$class )</span></span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="part-1-introduction-to-r-and-rstudio.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="part-2-machine-learning-with-r-1.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
