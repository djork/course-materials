<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Part 2 – Machine Learning with R | CEC01 - A hands-on introduction to applied artificial intelligence in toxicology (CAAIT)</title>
  <meta name="description" content="Part 2 – Machine Learning with R | CEC01 - A hands-on introduction to applied artificial intelligence in toxicology (CAAIT)" />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Part 2 – Machine Learning with R | CEC01 - A hands-on introduction to applied artificial intelligence in toxicology (CAAIT)" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Part 2 – Machine Learning with R | CEC01 - A hands-on introduction to applied artificial intelligence in toxicology (CAAIT)" />
  
  
  

<meta name="author" content="Marc A.T. Teunis, PhD" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="part-1-introduction-to-r-and-rstudio.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />










<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo"><a href="./"></a> <h4 class=".paddingtitel ">CAAIT</h2></li>
<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#disclaimer-on-this-work"><i class="fa fa-check"></i>Disclaimer on this work</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#continuing-education-course-on-applied-artifical-intelligence-caait"><i class="fa fa-check"></i>Continuing Education Course on Applied Artifical Intelligence (CAAIT)</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#programme-of-this-workshop"><i class="fa fa-check"></i>Programme of this workshop</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#course-material"><i class="fa fa-check"></i>Course material</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#r-and-rstudio"><i class="fa fa-check"></i>R and RStudio</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#resources-and-bookdown"><i class="fa fa-check"></i>Resources and Bookdown</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#learning-objectives"><i class="fa fa-check"></i>Learning objectives</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#attribution"><i class="fa fa-check"></i>Attribution</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html"><i class="fa fa-check"></i>Part 1 – Introduction to R and RStudio</a>
<ul>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#contents-day-1"><i class="fa fa-check"></i>Contents day 1</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#starting-to-work-within-a-project"><i class="fa fa-check"></i>Starting to work within a project</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#data-types-and-structures-in-r"><i class="fa fa-check"></i>Data types and structures in R</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#indexing"><i class="fa fa-check"></i>Indexing</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#missing-values"><i class="fa fa-check"></i>Missing values</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#secondstart"><i class="fa fa-check"></i>More complicated data</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#lists"><i class="fa fa-check"></i>Lists</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#dataframes"><i class="fa fa-check"></i>Dataframes</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#tibbles"><i class="fa fa-check"></i>Tibbles</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#factors"><i class="fa fa-check"></i>Factors</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#using-functions-drc"><i class="fa fa-check"></i>using functions: drc</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#scripts-and-rmarkdown"><i class="fa fa-check"></i>scripts and Rmarkdown</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#rmarkdown"><i class="fa fa-check"></i>Rmarkdown</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#yaml-header"><i class="fa fa-check"></i>YAML header</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#code-chunks"><i class="fa fa-check"></i>Code chunks</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#output-control"><i class="fa fa-check"></i>Output control</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#plain-text-formatting"><i class="fa fa-check"></i>Plain text formatting</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#here-package"><i class="fa fa-check"></i>Here package</a></li>
<li class="chapter" data-level="" data-path="part-1-introduction-to-r-and-rstudio.html"><a href="part-1-introduction-to-r-and-rstudio.html#creating-a-new-rmarkdown-file"><i class="fa fa-check"></i>Creating a new RMarkdown file</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html"><i class="fa fa-check"></i>Part 2 – Machine Learning with R</a>
<ul>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#learning-objectives-1"><i class="fa fa-check"></i>Learning objectives</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#machine-learning"><i class="fa fa-check"></i>Machine Learning</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#tame"><i class="fa fa-check"></i>TAME</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#tidymodels"><i class="fa fa-check"></i>Tidymodels</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#packages"><i class="fa fa-check"></i>Packages</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#datasets"><i class="fa fa-check"></i>Datasets</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#tidymodels-overview"><i class="fa fa-check"></i>Tidymodels overview</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#getting-started-with-tidymodels"><i class="fa fa-check"></i>Getting started with <code>{tidymodels}</code></a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#running-a-different-model-type-random-forest"><i class="fa fa-check"></i>Running a different model type, Random Forest</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#final-fit"><i class="fa fa-check"></i>Final fit</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#feature-importance"><i class="fa fa-check"></i>Feature importance</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#case-study-qsar-data"><i class="fa fa-check"></i>Case study; QSAR data</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#sparsity"><i class="fa fa-check"></i>Sparsity</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#unsupervised-machine-learning"><i class="fa fa-check"></i>Unsupervised machine learning</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#principal-component-analysis"><i class="fa fa-check"></i>Principal Component Analysis</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#t-sne"><i class="fa fa-check"></i>t-SNE</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#k-means-clustering"><i class="fa fa-check"></i>K-means clustering</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#xgboost"><i class="fa fa-check"></i>XGBoost</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#tuning-our-model"><i class="fa fa-check"></i>Tuning our model</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#model-tuning"><i class="fa fa-check"></i>Model tuning</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#read-results-from-disk"><i class="fa fa-check"></i>Read results from disk</a></li>
<li class="chapter" data-level="" data-path="part-2-machine-learning-with-r.html"><a href="part-2-machine-learning-with-r.html#bigger-grid"><i class="fa fa-check"></i>Bigger grid</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/ontox-hu/aira" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">CEC01 - A hands-on introduction to applied artificial intelligence in toxicology (CAAIT)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="part-2-machine-learning-with-r" class="section level1">
<h1>Part 2 – Machine Learning with R</h1>
<p><img src="images/tidymodels.svg" width="50%" style="display: block; margin: auto;" /></p>
<div id="learning-objectives-1" class="section level2">
<h2>Learning objectives</h2>
<p>After this activity:</p>
<ul>
<li>You will be familiar with the core utilities and general workflow for developing a (machine learning) model using the <code>{idymodels}</code> framework in R</li>
<li>You will be able to explore data suited for training a machine learning algorithm</li>
<li>Perform a number of unsupervised exploratory analysis (PCA, t-SNE, k-Means)</li>
<li>Build a predictive toxicity model, based on physioco-chemical attributes of chemicals</li>
<li>Build a model to predict the partition coefficient (LogP), based on fingerprints</li>
</ul>
</div>
<div id="machine-learning" class="section level2">
<h2>Machine Learning</h2>
<p>The term machine learning refers to a field of computational science and applications, where methods are used and developed that can ‘learn’ from data to solve specific tasks. In classicial machine learning these tasks are mostly related to classification. Machine Learning, of short ML, is considered a subfield of Artificial Intelligence and is considered as methods (or models / algorithms) that are trained on (sample) data to to make predictions or or decisions, without explicitly being programmed to do so. The following figure tries to convey the difference between classical problem solving using a rule based approach and modern ML.
For a gentle introduction see <a href="https://en.wikipedia.org/wiki/Machine_learning">this wiki page</a></p>
</div>
<div id="tame" class="section level2">
<h2>TAME</h2>
<p>If after this workshop you would like to learn more about applying ML in Toxicology, the <a href="https://github.com/UNCSRP/Data-Analysis-Training-Modules">The TAME Toolkit</a> for Introductory Data Science, Chemical-Biological Analyses, Predictive Modeling, and Database Mining for Environmental Health Research is a good place to start learning. Some of the examples in this lesson were taken from <a href="https://uncsrp.github.io/Data-Analysis-Training-Modules/machine-learning-and-predictive-modeling.html#machine-learning-and-predictive-modeling">chapter 2.2 of the TAME Bookdown project</a></p>
<p><a href="https://doi.org/10.3389/ftox.2022.893924">Reference:</a> Roell, K., Koval, L. E., Boyles, R., Patlewicz, G., Ring, C., Rider, C. V., Ward-Caviness, C., Reif, D. M., Jaspers, I., Fry, R. C., &amp; Rager, J. E. (2022). Development of the InTelligence And Machine LEarning (TAME) Toolkit for Introductory Data Science, Chemical-Biological Analyses, Predictive Modeling, and Database Mining for Environmental Health Research. Frontiers in toxicology, 4, 893924. <a href="https://doi.org/10.3389/ftox.2022.893924" class="uri">https://doi.org/10.3389/ftox.2022.893924</a></p>
</div>
<div id="tidymodels" class="section level2">
<h2>Tidymodels</h2>
<p>The Tidymodels framework is an extension of the <code>{tidyverse}</code> suite. It is especially focused towards providing a generalized way to define, run and optimize models in R. To get started we will walk you through a customized example, relevant for toxicological compound classification. To learn more see [Tidymodels documentation](<a href="https://www.tidymodels.org/start/" class="uri">https://www.tidymodels.org/start/</a>. To learn even more about Tidymodels, there is also a very elaborate <a href="https://www.tmwr.org">bookdown project</a></p>
</div>
<div id="packages" class="section level2">
<h2>Packages</h2>
<p>Here we load all the packages that we need for this demo.</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="part-2-machine-learning-with-r.html#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code></pre></div>
<pre><code>## ── Attaching packages ────────────────────────────────────── tidymodels 1.1.0 ──</code></pre>
<pre><code>## ✔ broom        1.0.4     ✔ recipes      1.0.6
## ✔ dials        1.2.0     ✔ rsample      1.1.1
## ✔ dplyr        1.1.2     ✔ tibble       3.2.1
## ✔ ggplot2      3.4.2     ✔ tidyr        1.3.0
## ✔ infer        1.0.4     ✔ tune         1.1.1
## ✔ modeldata    1.1.0     ✔ workflows    1.1.3
## ✔ parsnip      1.1.0     ✔ workflowsets 1.0.1
## ✔ purrr        1.0.1     ✔ yardstick    1.2.0</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
## ✖ purrr::discard() masks scales::discard()
## ✖ dplyr::filter()  masks stats::filter()
## ✖ dplyr::lag()     masks stats::lag()
## ✖ recipes::step()  masks stats::step()
## • Dig deeper into tidy modeling with R at https://www.tmwr.org</code></pre>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="part-2-machine-learning-with-r.html#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<pre><code>## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
## ✔ forcats   1.0.0          ✔ readr     2.1.4.9000
## ✔ lubridate 1.9.2          ✔ stringr   1.5.0.9000</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ readr::col_factor() masks scales::col_factor()
## ✖ purrr::discard()    masks scales::discard()
## ✖ dplyr::filter()     masks stats::filter()
## ✖ stringr::fixed()    masks recipes::fixed()
## ✖ dplyr::lag()        masks stats::lag()
## ✖ readr::spec()       masks yardstick::spec()
## ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="part-2-machine-learning-with-r.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom.mixed)</span>
<span id="cb206-2"><a href="part-2-machine-learning-with-r.html#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dotwhisker)  </span>
<span id="cb206-3"><a href="part-2-machine-learning-with-r.html#cb206-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(QSARdata)</span>
<span id="cb206-4"><a href="part-2-machine-learning-with-r.html#cb206-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bundle)</span>
<span id="cb206-5"><a href="part-2-machine-learning-with-r.html#cb206-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doMC)</span></code></pre></div>
<pre><code>## Loading required package: foreach
## 
## Attaching package: &#39;foreach&#39;
## 
## The following objects are masked from &#39;package:purrr&#39;:
## 
##     accumulate, when
## 
## Loading required package: iterators
## Loading required package: parallel</code></pre>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="part-2-machine-learning-with-r.html#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(finetune)</span>
<span id="cb208-2"><a href="part-2-machine-learning-with-r.html#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tune)</span></code></pre></div>
</div>
<div id="datasets" class="section level2">
<h2>Datasets</h2>
<p>For this lesson we will use a number of different datasets. Because we need datasets that include somewhat larger volumes of data, we also download data on the fly.</p>
<p>Let’s get the datasets in our R-session</p>
<div id="mutagen" class="section level3">
<h3>Mutagen</h3>
<p>A dataset from <a href="https://github.com/simonpcouch/mutagen">Github</a>.</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="part-2-machine-learning-with-r.html#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(</span>
<span id="cb209-2"><a href="part-2-machine-learning-with-r.html#cb209-2" aria-hidden="true" tabindex="-1"></a> here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb209-3"><a href="part-2-machine-learning-with-r.html#cb209-3" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;data-raw&quot;</span>,</span>
<span id="cb209-4"><a href="part-2-machine-learning-with-r.html#cb209-4" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;mutagen_tbl.Rda&quot;</span></span>
<span id="cb209-5"><a href="part-2-machine-learning-with-r.html#cb209-5" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb209-6"><a href="part-2-machine-learning-with-r.html#cb209-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="a-dataset-on-statins-and-pfas-from-the-epa" class="section level3">
<h3>A dataset on statins and PFAS from the EPA</h3>
<p>This dataset was curated and provided in the TAME project mentioned above. It can be directly downloaded from Github.</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="part-2-machine-learning-with-r.html#cb210-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">&quot;https://raw.githubusercontent.com/UNCSRP/Data-Analysis-Training-Modules/main/Chapter%202/2.2%20ML%20Predictive%20Modeling/Module2_2_Chemical_Lists_PFAS-Statins.csv&quot;</span></span>
<span id="cb210-2"><a href="part-2-machine-learning-with-r.html#cb210-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-3"><a href="part-2-machine-learning-with-r.html#cb210-3" aria-hidden="true" tabindex="-1"></a>data_tame <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb210-4"><a href="part-2-machine-learning-with-r.html#cb210-4" aria-hidden="true" tabindex="-1"></a>    url, </span>
<span id="cb210-5"><a href="part-2-machine-learning-with-r.html#cb210-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">locale =</span> readr<span class="sc">::</span><span class="fu">locale</span>(<span class="at">encoding =</span><span class="st">&quot;UTF-8&quot;</span>)</span>
<span id="cb210-6"><a href="part-2-machine-learning-with-r.html#cb210-6" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<pre><code>## Rows: 144 Columns: 14
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr  (4): List, Substance Name, CASRN, DTXSID
## dbl (10): Molecular Weight, OPERA, Boiling Point, OPERA, Henry&#39;s Law Constan...
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div id="qsar-data" class="section level3">
<h3>QSAR data</h3>
<p>An example dataset that contains classical chemical fingerprints.
<a href="https://archive.ics.uci.edu/ml/datasets/QSAR+oral+toxicity">From the UCL repository</a></p>
<p>Metadata:
Attribute Information:</p>
<p>1024 binary molecular fingerprints and 1 experimental class:
1-1024) binary molecular fingerprint
1025) experimental class: positive (very toxic) and negative (not very toxic)</p>
<p>Data source:
<a href="https://doi.org/10.1002/minf.201800124">D. Ballabio, F. Grisoni, V. Consonni, R. Todeschini (2019), Integrated QSAR models to predict acute oral systemic toxicity, Molecular Informatics, 38, 180012; doi: 10.1002/minf.201800124</a></p>
<p>Files <code>ID.txt</code>,<code>class.csv</code> and <code>X.csv</code> in folder <code>./data-raw/</code> were obtained from the author of the paper above via personal communication. Original sources files (Matlab scripts and matrix files can be downloaded from the paper’s DOI as supplemental data). They are included here for reproducibility reasons in <code>./data/lesson5/qsar/oral_toxicity_data.rar</code></p>
<p>The code below downloads the data to a the <code>./data-raw</code> folder and unzips the file in a temporary folder. We read the file into R from that temp file.</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="part-2-machine-learning-with-r.html#cb212-1" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb212-2"><a href="part-2-machine-learning-with-r.html#cb212-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;data-raw&quot;</span>,</span>
<span id="cb212-3"><a href="part-2-machine-learning-with-r.html#cb212-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;qsar_oral_toxicity.zip&quot;</span></span>
<span id="cb212-4"><a href="part-2-machine-learning-with-r.html#cb212-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb212-5"><a href="part-2-machine-learning-with-r.html#cb212-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-6"><a href="part-2-machine-learning-with-r.html#cb212-6" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="at">url =</span> <span class="st">&quot;https://archive.ics.uci.edu/ml/machine-learning-databases/00508/qsar_oral_toxicity.zip&quot;</span>, <span class="at">destfile =</span> path)</span>
<span id="cb212-7"><a href="part-2-machine-learning-with-r.html#cb212-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-8"><a href="part-2-machine-learning-with-r.html#cb212-8" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(<span class="at">zipfile =</span> path, <span class="at">exdir =</span> here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb212-9"><a href="part-2-machine-learning-with-r.html#cb212-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;data-raw&quot;</span>)</span>
<span id="cb212-10"><a href="part-2-machine-learning-with-r.html#cb212-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div id="tidymodels-overview" class="section level2">
<h2>Tidymodels overview</h2>
<div id="tidymodels-core-packages" class="section level3">
<h3>Tidymodels core packages</h3>
<p><a href="https://www.tidymodels.org/packages/">The core Tidymodels collection of packages consists of</a></p>
<ul>
<li><code>{rsample}</code> - for splitting and resampling data</li>
<li><code>{parsnip}</code> - provides an unified interface for different models</li>
<li><code>{recipes}</code> - for pre-processing data</li>
<li><code>{workflows}</code> - for putting the recipe and the model together</li>
<li><code>{tune}</code> - for tuning the hyperparameters<br />
</li>
<li><code>{yardstick}</code> - for model evaluation and validation</li>
</ul>
<p>The tidymodels packages allow you to specify, run, fine tune and evaluate models in a consistent way. They provide a workflow for defining and updating modelling approaches and take away the effort of accomodating syntactical differences between different model implementations, so that you can focus on the stuff that is really important.</p>
<p>From my experience, the overall workflow is a little hard to get your head around initially, but putting in the effort to really understand it, pays off in the long run. Certainly, I am finding myself less busy with diving into the specific documentation of a model engine, but focussing more on the actual modelling part of the job!</p>
<p>The steps we need to walk though are:</p>
<ol style="list-style-type: decimal">
<li>Generate a training and a testing partition of the data. This can be done in several ways: Splitting into a single test and training set or genrating multiple so-called <code>folds</code>, that contain multiple (random) splits. It is crucial to understand the data before splitting. For example, you need to be able to provide answer to the question whrther the ‘thing’ you are trying to predict is present equally in the data, or that (e.g. in a binary classification, there are many more instances of one class, compared to the other)</li>
<li>Define a <code>{recipe}</code> for which variables and which dataset we would like to use for modelling. The recipe also holds so called <code>steps</code> that include any preprocessing we would need for the model we would like to fit. Different models have diffenrent requirements for preprocessing. See: for an overview <a href="https://www.tmwr.org/pre-proc-table.html">the Tidymodels Bookdown</a></li>
<li>A model <code>specification</code>, that contains the details on which model to run and which values to set for the hyperparameters of a model. Hyperparameters can be viewed as the dials with which you tune the model. They regulate e.g. overfitting or number of interactions. Tuning a models is an important aspect of modelling and can be done in several ways. A very structured way to find the most optimal hyperparameters is <code>grid tuning</code>. The <code>{tune}</code> package is facilitating this in the tidymodels suite.<br />
</li>
<li>Definition of the model <code>metrics</code> that will help decide how well the fit of the model is for the data</li>
<li>A <code>workflow</code> where the recipe and the model specification come together. This is the ‘wedding planner’ of the tidymodels. It can be considered as the plan for the model (without actually running the model)</li>
<li>A model <code>fit</code>. This is the step where actually run out model, or models, and <em>fit</em> the model to our data. From the fit we can extract the metrics, predictions, statistics and other valuable information that tells us how the model to the data.</li>
<li>Model performance: Getting the model performance metrics such as <code>specificiy</code>, <code>selectivity</code> and overall performance as <code>accuracy</code>, can be obtained from the <code>fit</code> object. To evaluate the model, we need to expose the model to our test dataset, or datasets if we use folds.<br />
</li>
<li>When we use tuning, we rerun the steps of model training and evaluation multiple times to find the most optimal value for the hyperperameters. We then evaluate the best model and arrive at our final model.</li>
<li>You can extend this workflow to running more then one model type. This is what we will do in this hands-on workshop.</li>
</ol>
<p>Here is a visual that may help in understanding the role and nature of the steps, and the different tidymodels packages, in the modelling process.</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="part-2-machine-learning-with-r.html#cb213-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(</span>
<span id="cb213-2"><a href="part-2-machine-learning-with-r.html#cb213-2" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb213-3"><a href="part-2-machine-learning-with-r.html#cb213-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;images&quot;</span>,</span>
<span id="cb213-4"><a href="part-2-machine-learning-with-r.html#cb213-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;tidymodels-pkgs.png&quot;</span></span>
<span id="cb213-5"><a href="part-2-machine-learning-with-r.html#cb213-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb213-6"><a href="part-2-machine-learning-with-r.html#cb213-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="images/tidymodels-pkgs.png" width="655" /></p>
</div>
</div>
<div id="getting-started-with-tidymodels" class="section level2">
<h2>Getting started with <code>{tidymodels}</code></h2>
<p>If we put the complete <code>{tidymodels}</code> workflow together we can define all the models and run them on our <code>mutagen</code> data. Here we will focus on just one model to see all the step described above in sequence
The complete code for running all the models shown in the plot above can be found in the mutagen repo: <a href="https://raw.githubusercontent.com/simonpcouch/mutagen/main/source/fit.R" class="uri">https://raw.githubusercontent.com/simonpcouch/mutagen/main/source/fit.R</a></p>
<p>See also: <a href="https://www.tidymodels.org/start/"><code>{tidymodels}</code> getting started documentation</a></p>
<div id="build-our-first-model-with-tidymodels" class="section level3">
<h3>Build our first model with Tidymodels</h3>
<p>Let’s train our first model, using tidymodels on the <code>mutagen_tbl</code> data. We will do some clean up of the ciolumn names first. As a convention, I like to put everything in lowercase. This saves brainpower by not having to ever worry about capitals. Same thing for <code>snake_case</code>. I like that best for readability and consistency.</p>
<p>The code for modelling the <code>mutagen</code> data was adapted from <a href="https://github.com/simonpcouch/mutagen" class="uri">https://github.com/simonpcouch/mutagen</a>.</p>
</div>
<div id="clean-names-mutagen-data" class="section level3">
<h3>Clean names mutagen data</h3>
<p>the <code>clean_names()</code> from the <code>{janitor}</code> package is very handy.</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="part-2-machine-learning-with-r.html#cb214-1" aria-hidden="true" tabindex="-1"></a>mutagen_tbl <span class="ot">&lt;-</span> mutagen_tbl <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb214-2"><a href="part-2-machine-learning-with-r.html#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="do">## add sample_id for later use (add_role() in recipe)</span></span>
<span id="cb214-3"><a href="part-2-machine-learning-with-r.html#cb214-3" aria-hidden="true" tabindex="-1"></a>mutagen_tbl <span class="ot">&lt;-</span> mutagen_tbl <span class="sc">|&gt;</span></span>
<span id="cb214-4"><a href="part-2-machine-learning-with-r.html#cb214-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mutagen_tbl)) <span class="sc">|&gt;</span></span>
<span id="cb214-5"><a href="part-2-machine-learning-with-r.html#cb214-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(sample_id)</span></code></pre></div>
</div>
<div id="load-processed-modelling-results" class="section level3">
<h3>Load processed modelling results</h3>
<p>The <code>mutagen</code> data was already fitted with a number of models. The Github repo contains the fitting results, which we load here.</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="part-2-machine-learning-with-r.html#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(</span>
<span id="cb215-2"><a href="part-2-machine-learning-with-r.html#cb215-2" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb215-3"><a href="part-2-machine-learning-with-r.html#cb215-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb215-4"><a href="part-2-machine-learning-with-r.html#cb215-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mutagen&quot;</span>,</span>
<span id="cb215-5"><a href="part-2-machine-learning-with-r.html#cb215-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb215-6"><a href="part-2-machine-learning-with-r.html#cb215-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;metrics_wf_set.Rda&quot;</span>))</span>
<span id="cb215-7"><a href="part-2-machine-learning-with-r.html#cb215-7" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb215-8"><a href="part-2-machine-learning-with-r.html#cb215-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb215-9"><a href="part-2-machine-learning-with-r.html#cb215-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mutagen&quot;</span>,</span>
<span id="cb215-10"><a href="part-2-machine-learning-with-r.html#cb215-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb215-11"><a href="part-2-machine-learning-with-r.html#cb215-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;metrics_xgb.Rda&quot;</span>))</span>
<span id="cb215-12"><a href="part-2-machine-learning-with-r.html#cb215-12" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb215-13"><a href="part-2-machine-learning-with-r.html#cb215-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb215-14"><a href="part-2-machine-learning-with-r.html#cb215-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mutagen&quot;</span>,</span>
<span id="cb215-15"><a href="part-2-machine-learning-with-r.html#cb215-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb215-16"><a href="part-2-machine-learning-with-r.html#cb215-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;xgb_final_fit.Rda&quot;</span>))</span>
<span id="cb215-17"><a href="part-2-machine-learning-with-r.html#cb215-17" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb215-18"><a href="part-2-machine-learning-with-r.html#cb215-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb215-19"><a href="part-2-machine-learning-with-r.html#cb215-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mutagen&quot;</span>,</span>
<span id="cb215-20"><a href="part-2-machine-learning-with-r.html#cb215-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb215-21"><a href="part-2-machine-learning-with-r.html#cb215-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;final_fit.Rda&quot;</span>))</span></code></pre></div>
</div>
<div id="plotting-the-data" class="section level3">
<h3>Plotting the data</h3>
<p>As a first step in modeling, it’s always a good idea to plot the data.
Here we plot two important determining attributes for chemicals: the <code>Molecular Weight</code> and the <code>Partition Coefficient</code></p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="part-2-machine-learning-with-r.html#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mutagen_tbl) <span class="sc">+</span></span>
<span id="cb216-2"><a href="part-2-machine-learning-with-r.html#cb216-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> mw, <span class="at">y =</span> mlogp, <span class="at">color =</span> outcome) <span class="sc">+</span></span>
<span id="cb216-3"><a href="part-2-machine-learning-with-r.html#cb216-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb216-4"><a href="part-2-machine-learning-with-r.html#cb216-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Mol. Weight&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Partition Coefficient&quot;</span>) <span class="sc">+</span></span>
<span id="cb216-5"><a href="part-2-machine-learning-with-r.html#cb216-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb216-6"><a href="part-2-machine-learning-with-r.html#cb216-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;#ba0600&quot;</span>, <span class="st">&quot;#71b075&quot;</span>))</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>You could repeat this visualization step with using different sets of variables. Then you will probably learn that no two variables can easily split the data into mutagens and non-mutagens. In order to build a predictive model that can predict the class of a compound (mutagen or non-mutagen), we need a more advanced method. Below we will build a logistic regression prediction model to illustrate all the steps in the tidymodels workflow. We choose logistic regression here as the model that does not have the lowest performance of all the models tested, and it is the more simpler model of the ones that have a good performance. Depending on the nature and intended use of the prediction model, it may not always be feasible to choose the most complex and lesser explainable model. The following section shows the performance results of six different models that were run on the <code>mutagen</code> data.</p>
</div>
<div id="evaluating-multiple-models" class="section level3">
<h3>Evaluating multiple models</h3>
<p>The previously run modelling results (model performance) experiments with the <code>mutagen</code> dataset can be visualized, using the dataframe containing the model metrics. Which model is best? Which is worst?</p>
<p><img src="002_tidymodels_files/figure-html/plot_mutagen_models_results-1.png" alt="A ggplot2 faceted boxplot, where different model types are on the x-axis and the out-of-sample ROC AUCs associated with those models are on the y-axis. The shown metrics values range from 0 to around 0.9. The x-axis is roughly sorted by descending ROC AUC, where the left-most model, XGBoost Boosted Tree, tends to have the best performance. Other models proposed were, from left to right, Bagged Decision Tree, Support Vector Machine, Logistic Regression, Bagged MARS, and Neural Network." width="672" /></p>
</div>
<div id="data-types" class="section level3">
<h3>Data types</h3>
<p>When running models, it is very important to make sure that the datatype of the variables in the model are according what the model-algorithm <em>expects</em>. For example, many models require the outcome variable to be a factor, neural networks expect all the data to be tensors, and for logistic regression we need to convert categorical variables to dummy encoding. This makes it of importance to check the datatype and set or correct the datatype accordingly.</p>
<p>let’s make a graph of the datatypes of all the variables in the <code>mutagen</code> data. We first get all the datatypes of the 1580 variables in the data, and store this in a dataframe. From this we create a graph.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="part-2-machine-learning-with-r.html#cb217-1" aria-hidden="true" tabindex="-1"></a>var_data_classes <span class="ot">&lt;-</span> <span class="fu">map_chr</span>(</span>
<span id="cb217-2"><a href="part-2-machine-learning-with-r.html#cb217-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> mutagen_tbl,</span>
<span id="cb217-3"><a href="part-2-machine-learning-with-r.html#cb217-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> class</span>
<span id="cb217-4"><a href="part-2-machine-learning-with-r.html#cb217-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb217-5"><a href="part-2-machine-learning-with-r.html#cb217-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-6"><a href="part-2-machine-learning-with-r.html#cb217-6" aria-hidden="true" tabindex="-1"></a>var_data_types <span class="ot">&lt;-</span> <span class="fu">map_df</span>(</span>
<span id="cb217-7"><a href="part-2-machine-learning-with-r.html#cb217-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> mutagen_tbl,</span>
<span id="cb217-8"><a href="part-2-machine-learning-with-r.html#cb217-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> typeof</span>
<span id="cb217-9"><a href="part-2-machine-learning-with-r.html#cb217-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb217-10"><a href="part-2-machine-learning-with-r.html#cb217-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb217-11"><a href="part-2-machine-learning-with-r.html#cb217-11" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(mutagen_tbl), </span>
<span id="cb217-12"><a href="part-2-machine-learning-with-r.html#cb217-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;var_name&quot;</span>,</span>
<span id="cb217-13"><a href="part-2-machine-learning-with-r.html#cb217-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;typeof&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb217-14"><a href="part-2-machine-learning-with-r.html#cb217-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var_position =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(mutagen_tbl),</span>
<span id="cb217-15"><a href="part-2-machine-learning-with-r.html#cb217-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">var_class =</span> var_data_classes)</span>
<span id="cb217-16"><a href="part-2-machine-learning-with-r.html#cb217-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-17"><a href="part-2-machine-learning-with-r.html#cb217-17" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb217-18"><a href="part-2-machine-learning-with-r.html#cb217-18" aria-hidden="true" tabindex="-1"></a>var_data_types <span class="sc">|&gt;</span></span>
<span id="cb217-19"><a href="part-2-machine-learning-with-r.html#cb217-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb217-20"><a href="part-2-machine-learning-with-r.html#cb217-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(<span class="fu">as_factor</span>(var_name), var_position),</span>
<span id="cb217-21"><a href="part-2-machine-learning-with-r.html#cb217-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> typeof)) <span class="sc">+</span></span>
<span id="cb217-22"><a href="part-2-machine-learning-with-r.html#cb217-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(</span>
<span id="cb217-23"><a href="part-2-machine-learning-with-r.html#cb217-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb217-24"><a href="part-2-machine-learning-with-r.html#cb217-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> var_class,</span>
<span id="cb217-25"><a href="part-2-machine-learning-with-r.html#cb217-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">shape =</span> var_class), </span>
<span id="cb217-26"><a href="part-2-machine-learning-with-r.html#cb217-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">position =</span> <span class="st">&quot;jitter&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb217-27"><a href="part-2-machine-learning-with-r.html#cb217-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb217-28"><a href="part-2-machine-learning-with-r.html#cb217-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(), <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb217-29"><a href="part-2-machine-learning-with-r.html#cb217-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">limits =</span> <span class="fu">unique</span>(var_data_types<span class="sc">$</span>var_name))</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/data_types_mutagen-1.png" width="672" /></p>
<p>This supports our assumption that all variables in the <code>mutagen</code> dataset are <code>numeric</code>: either <code>integer</code> or <code>double</code>. Because <code>factor</code> is a special integer with class <code>factor</code>, we see only 1 red dot. if you look carefully, you will see it to the far left of the plot. This is the only factor. Which variable do you think this is? We do not need to change the datatype of any of our variables for our first model (or any that will follow for that matter). <strong>Usually, wild data like this is not so clean, so please always perform this check, before moving on.</strong></p>
</div>
<div id="subsetting-the-data-for-run-time" class="section level3">
<h3>Subsetting the data for run-time</h3>
<p>The mutagen data contains 1580 columns. This is a lot of features. Because the example here is for educational purposes, I decided to reduce the dataset to 100 randomly selected predictors. In real life, you would perform a more regorous and substantiated feature selection procedure. For example, you could use Ridge Regression or LASSO to select features. Or use a permutation approach in combination with a tree based algorithm. A good example on how to do this is described in <a href="https://juliasilge.com/blog/lasso-the-office/">this blog by Julia Silge</a> or in <a href="https://youtu.be/1AKug0tgux8">this video by Adrew Couch</a>.</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="part-2-machine-learning-with-r.html#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb218-2"><a href="part-2-machine-learning-with-r.html#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming your data frame is named &quot;df&quot;</span></span>
<span id="cb218-3"><a href="part-2-machine-learning-with-r.html#cb218-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-4"><a href="part-2-machine-learning-with-r.html#cb218-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the first 2 columns</span></span>
<span id="cb218-5"><a href="part-2-machine-learning-with-r.html#cb218-5" aria-hidden="true" tabindex="-1"></a>selected_columns <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb218-6"><a href="part-2-machine-learning-with-r.html#cb218-6" aria-hidden="true" tabindex="-1"></a>no_predictors <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb218-7"><a href="part-2-machine-learning-with-r.html#cb218-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-8"><a href="part-2-machine-learning-with-r.html#cb218-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate random indices for the remaining 99 columns</span></span>
<span id="cb218-9"><a href="part-2-machine-learning-with-r.html#cb218-9" aria-hidden="true" tabindex="-1"></a>remaining_columns <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(mutagen_tbl), no_predictors)</span>
<span id="cb218-10"><a href="part-2-machine-learning-with-r.html#cb218-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-11"><a href="part-2-machine-learning-with-r.html#cb218-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the selected columns</span></span>
<span id="cb218-12"><a href="part-2-machine-learning-with-r.html#cb218-12" aria-hidden="true" tabindex="-1"></a>selected_columns <span class="ot">&lt;-</span> <span class="fu">c</span>(selected_columns, remaining_columns)</span>
<span id="cb218-13"><a href="part-2-machine-learning-with-r.html#cb218-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-14"><a href="part-2-machine-learning-with-r.html#cb218-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset the data frame with the selected columns</span></span>
<span id="cb218-15"><a href="part-2-machine-learning-with-r.html#cb218-15" aria-hidden="true" tabindex="-1"></a>mutagen_tbl_selected <span class="ot">&lt;-</span> mutagen_tbl[, selected_columns]</span></code></pre></div>
</div>
<div id="tidymodels-workflow-illustration-on-the-mutagen-data" class="section level3">
<h3>Tidymodels workflow illustration on the <code>mutagen</code> data</h3>
<p>Let’s put all the pieces of the complete tidymodels workflow together and run a logistic model on a single split (1-fold cross validation) of the <code>mutagen</code> data.</p>
<p>The code below was adapted from: <a href="https://github.com/simonpcouch/mutagen/blob/main/source/fit.R" class="uri">https://github.com/simonpcouch/mutagen/blob/main/source/fit.R</a></p>
<p>To set the stage for modelling, which can be resource intensive, we create a cluster on the local cores of the computer. We leave one core available for the system.</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="part-2-machine-learning-with-r.html#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="do">## multicore running</span></span>
<span id="cb219-2"><a href="part-2-machine-learning-with-r.html#cb219-2" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoMC</span>(<span class="at">cores =</span> <span class="fu">max</span>(<span class="dv">1</span>, parallelly<span class="sc">::</span><span class="fu">availableCores</span>() <span class="sc">-</span> <span class="dv">1</span>))</span></code></pre></div>
</div>
<div id="split-data" class="section level3">
<h3>Split data</h3>
<p>First step is to divide the data into a training and a test set. The <code>set.seed()</code> function can be used for reproducibility of the computations that are dependent on random numbers.</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="part-2-machine-learning-with-r.html#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb220-2"><a href="part-2-machine-learning-with-r.html#cb220-2" aria-hidden="true" tabindex="-1"></a>mutagen_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(<span class="at">data =</span> mutagen_tbl_selected)</span>
<span id="cb220-3"><a href="part-2-machine-learning-with-r.html#cb220-3" aria-hidden="true" tabindex="-1"></a>mutagen_train <span class="ot">&lt;-</span> <span class="fu">training</span>(mutagen_split)</span>
<span id="cb220-4"><a href="part-2-machine-learning-with-r.html#cb220-4" aria-hidden="true" tabindex="-1"></a>mutagen_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(mutagen_split)</span></code></pre></div>
</div>
<div id="define-model-specification" class="section level3">
<h3>Define model (specification)</h3>
<p>With specific model functions (here: <code>logistic_reg()</code>), we choose the model type. A full list of tidymodels model implementation can be found [here]((<a href="https://www.tidymodels.org/find/parsnip/" class="uri">https://www.tidymodels.org/find/parsnip/</a>).</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="part-2-machine-learning-with-r.html#cb221-1" aria-hidden="true" tabindex="-1"></a>spec_lr <span class="ot">&lt;-</span></span>
<span id="cb221-2"><a href="part-2-machine-learning-with-r.html#cb221-2" aria-hidden="true" tabindex="-1"></a><span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb221-3"><a href="part-2-machine-learning-with-r.html#cb221-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb221-4"><a href="part-2-machine-learning-with-r.html#cb221-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)</span></code></pre></div>
</div>
<div id="define-recipe" class="section level3">
<h3>Define recipe</h3>
<p>The <a href="https://recipes.tidymodels.org/reference/recipe.html"><code>recipe()</code> function</a> as we used it here has two arguments:</p>
<ul>
<li><p>A <strong>formula</strong>. Any variable on the left-hand side of the tilde (<code>~</code>) is considered the model outcome (here, <code>outcome</code>). On the right-hand side of the tilde are the predictors. Variables may be listed by name, or you can use the dot (<code>.</code>) to indicate all other variables as predictors.</p></li>
<li><p>The <strong>data</strong>. A recipe is associated with the data set used to create the model. This will typically be the <em>training</em> set, so <code>data = mutagen_train</code> here.</p></li>
</ul>
<p>A recipe contains the specification for which dataset we will use for modelling and all the preprocessing steps we need to perform, before the data is ready for modelling. When we look at <a href="https://www.tmwr.org/pre-proc-table.html">this table</a>, we can see that for ‘logistic regression’ (the first model we will try), a few pre-processing steps seem mandatory:</p>
<p>1.dummy (<code>step_dummy()</code>)<br />
1.zv (<code>step_nzv()</code>)<br />
1. impute (<code>step_impute()</code>)<br />
1. decorrelate (<code>step_corr()</code>)</p>
<p>Technically, we would need to do all the pre-processing of the data, before moving on. Here we can skip a few steps though: There are no categorical variables in the data, so we do not need to convert any to dummy variables. Secondly, there are no missing values in the data (did we check that? - How would you do a quick check, whether that is true?).
Thirdly, removing zero variance (zv) variables is what we will do in our first recipe. Let’s first see how that recipe works for this data and model. We can revisit or improve the recipe later and add a step, using the <code>add_step</code>.</p>
<p>We can also add a role for a specific variable. For instance an id variable. Here we will create an additional column called <code>sample_id</code>, and assign it an <code>id</code> role. This step of adding roles to a recipe is optional; the purpose of using it here is that those two variables can be retained in the data but not included in the model. This can be convenient when, after the model is fit, we want to investigate some poorly predicted value. These ID columns will be available and can be used to try to understand what went wrong.</p>
<p>Let’s put the recipe together.</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="part-2-machine-learning-with-r.html#cb222-1" aria-hidden="true" tabindex="-1"></a>recipe_lr <span class="ot">&lt;-</span></span>
<span id="cb222-2"><a href="part-2-machine-learning-with-r.html#cb222-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., mutagen_train) <span class="sc">%&gt;%</span></span>
<span id="cb222-3"><a href="part-2-machine-learning-with-r.html#cb222-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_role</span>(sample_id, <span class="at">new_role =</span> <span class="st">&quot;id&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb222-4"><a href="part-2-machine-learning-with-r.html#cb222-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb222-5"><a href="part-2-machine-learning-with-r.html#cb222-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_predictors</span>())</span></code></pre></div>
</div>
<div id="model-performance-metrics" class="section level3">
<h3>Model performance metrics</h3>
<p>Next, we need to specify what we would like to see for determining the performance of the model. Different modelling algorithms have different types of metrics. For more info see e.g <a href="https://towardsdatascience.com/metrics-to-evaluate-your-machine-learning-algorithm-f10ba6e38234">this blog</a>. Because we have a binary classification problem (mutagen vs. non-mutagen classification), we will chose the AUC - ROC evaluation metric here. The classification accuracy; indicating which proportion was classified correctly and which was not, can also be selected here.</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="part-2-machine-learning-with-r.html#cb223-1" aria-hidden="true" tabindex="-1"></a>mutagen_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(roc_auc, accuracy)</span></code></pre></div>
</div>
<div id="combine-model-specification-and-recipe-a-workflow" class="section level3">
<h3>Combine model specification and recipe a workflow</h3>
<p>We will want to use our recipe across several steps as we train and test our model. We will:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Process the recipe using the training set</strong>: This involves any estimation or calculations based on the training set. For our recipe, the training set will be used to determine which predictors should be converted to dummy variables and which predictors will have zero-variance in the training set, and should be slated for removal.</p></li>
<li><p><strong>Apply the recipe to the training set</strong>: We create the final predictor set on the training set.</p></li>
<li><p><strong>Apply the recipe to the test set</strong>: We create the final predictor set on the test set. Nothing is recomputed and no information from the test set is used here; the dummy variable and zero-variance results from the training set are applied to the test set.</p></li>
</ol>
<p>To simplify this process, we can use a <em>model workflow</em>, which pairs a model and recipe together. This is a straightforward approach because different recipes are often needed for different models, so when a model and recipe are bundled, it becomes easier to train and test <em>workflows</em>. We’ll use the <a href="https://workflows.tidymodels.org/">workflows package</a> from tidymodels to bundle our parsnip model (<code>lr_mod</code>) with our recipe (<code>flights_rec</code>).</p>
<p>Now we are ready to setup our complete modelling workflow. This <code>workflow</code> contains the model <code>specification</code> and the <code>recipe</code>.</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="part-2-machine-learning-with-r.html#cb224-1" aria-hidden="true" tabindex="-1"></a>wf_mutagen <span class="ot">&lt;-</span></span>
<span id="cb224-2"><a href="part-2-machine-learning-with-r.html#cb224-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>(</span>
<span id="cb224-3"><a href="part-2-machine-learning-with-r.html#cb224-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">spec =</span> spec_lr,</span>
<span id="cb224-4"><a href="part-2-machine-learning-with-r.html#cb224-4" aria-hidden="true" tabindex="-1"></a>    recipe_lr</span>
<span id="cb224-5"><a href="part-2-machine-learning-with-r.html#cb224-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb224-6"><a href="part-2-machine-learning-with-r.html#cb224-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-7"><a href="part-2-machine-learning-with-r.html#cb224-7" aria-hidden="true" tabindex="-1"></a>wf_mutagen</span></code></pre></div>
<pre><code>## ══ Workflow ════════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: logistic_reg()
## 
## ── Preprocessor ────────────────────────────────────────────────────────────────
## 2 Recipe Steps
## 
## • step_zv()
## • step_corr()
## 
## ── Model ───────────────────────────────────────────────────────────────────────
## Logistic Regression Model Specification (classification)
## 
## Computational engine: glm</code></pre>
</div>
<div id="fitting-the-logistic-regression-model" class="section level3">
<h3>Fitting the logistic regression model</h3>
<p>Now we use the workflow, we created to fit the model on our training data.
This steps takes a while. We use the training partition of the data, that we created previously.</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="part-2-machine-learning-with-r.html#cb226-1" aria-hidden="true" tabindex="-1"></a>fit_lr <span class="ot">&lt;-</span> wf_mutagen  <span class="sc">%&gt;%</span> </span>
<span id="cb226-2"><a href="part-2-machine-learning-with-r.html#cb226-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> mutagen_train)</span></code></pre></div>
<pre><code>## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="part-2-machine-learning-with-r.html#cb228-1" aria-hidden="true" tabindex="-1"></a>fit_lr</span></code></pre></div>
<pre><code>## ══ Workflow [trained] ══════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: logistic_reg()
## 
## ── Preprocessor ────────────────────────────────────────────────────────────────
## 2 Recipe Steps
## 
## • step_zv()
## • step_corr()
## 
## ── Model ───────────────────────────────────────────────────────────────────────
## 
## Call:  stats::glm(formula = ..y ~ ., family = stats::binomial, data = data)
## 
## Coefficients:
## (Intercept)    sample_id     e_eig14r        srw07       be_hp3       mor10v  
##   4.620e+00    4.080e-05    2.347e-01   -3.266e-03    7.359e-01   -1.334e-01  
##        n_ct          r5m          r2v          l3m         n_sh          rci  
##   2.847e-01    1.466e+00    1.718e+00    5.856e-01    1.803e-01    5.222e-01  
##      g_f_br       mor19p           de       mor25v       gats3v      n_ar_cn  
##   1.247e+00   -1.240e+00    3.444e+00    4.764e-01   -4.084e-01    3.911e-01  
##     rdf035p      n_h_don       mor04v         jgi6     e_eig02x      rdf055p  
##   3.138e-02   -1.165e-01   -5.016e-01    3.280e-01    2.843e-01   -2.259e-01  
##      hat_sm         ggi5       be_lm7       mor09m       mor09v          l1v  
##  -1.898e-02    6.057e-01   -6.161e-01    1.442e-01    2.012e-01   -5.686e-02  
##      mor27m       mor28v       mats4m       hats1m          x2a        r3p_2  
##  -7.579e-01   -2.367e+00    4.285e-01   -1.285e-01    2.394e+00   -2.212e+00  
##        vrz2        t_o_p      rdf130p       t_p_br        ats5e        c_036  
##  -5.631e+00    1.652e-02    7.063e-02   -2.685e-01   -3.040e-01   -6.362e-01  
##       n_r07       jhet_z       mats3v        r8u_2       hats2u      rdf155m  
##   8.411e-01   -2.347e-01    5.684e-02   -1.038e+01   -6.782e-01   -1.692e-02  
##     rdf020m     e_spm11d          g1e       hats5v      rdf045m          r3u  
##  -2.628e-01    9.261e-02    3.135e-02   -3.748e+00    3.951e-02    4.140e-01  
##        n_br       be_le1            w      rdf060m     e_eig08r       n_r_cp  
##   1.244e+00   -2.234e+00    3.587e-06    8.505e-03   -8.979e-02    1.622e-01  
##      r_te_2           dm       mor32m       mor14p       mor23e  n_pyrazines  
##   1.111e+00   -1.356e+00   -1.255e+00    2.054e+00   -1.365e-01   -3.661e-01  
##         r8p        qz_zm       d_dr03          h6u       hats4v          e1s  
##   1.369e+00    7.284e-04   -3.855e-02    4.782e-01    7.051e-01   -9.214e-01  
##      be_hm5       mor22p           ke          g2p           am       hats4e  
##   2.964e-02   -3.404e-01   -4.962e-01    6.331e-01   -2.683e-03   -5.515e-01  
## 
## Degrees of Freedom: 3250 Total (i.e. Null);  3173 Residual
## Null Deviance:       4471 
## Residual Deviance: 3308  AIC: 3464</code></pre>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="part-2-machine-learning-with-r.html#cb230-1" aria-hidden="true" tabindex="-1"></a>rf_training_pred <span class="ot">&lt;-</span> </span>
<span id="cb230-2"><a href="part-2-machine-learning-with-r.html#cb230-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(fit_lr, mutagen_train) <span class="sc">%&gt;%</span> </span>
<span id="cb230-3"><a href="part-2-machine-learning-with-r.html#cb230-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(fit_lr, mutagen_train, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb230-4"><a href="part-2-machine-learning-with-r.html#cb230-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the true outcome data back in</span></span>
<span id="cb230-5"><a href="part-2-machine-learning-with-r.html#cb230-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(mutagen_train <span class="sc">%&gt;%</span> </span>
<span id="cb230-6"><a href="part-2-machine-learning-with-r.html#cb230-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(outcome))</span>
<span id="cb230-7"><a href="part-2-machine-learning-with-r.html#cb230-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-8"><a href="part-2-machine-learning-with-r.html#cb230-8" aria-hidden="true" tabindex="-1"></a>rf_training_pred <span class="sc">%&gt;%</span>                <span class="co"># training set predictions</span></span>
<span id="cb230-9"><a href="part-2-machine-learning-with-r.html#cb230-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(<span class="at">truth =</span> outcome, .pred_class) <span class="ot">-&gt;</span> acc_train</span>
<span id="cb230-10"><a href="part-2-machine-learning-with-r.html#cb230-10" aria-hidden="true" tabindex="-1"></a>acc_train</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.747</code></pre>
<p>The accuracy of the model on the training data is 0.7471547 which is above 0.5 (mere chance). This basically means that the model was able to learn predictive patterns from the training data. To see if the model is able to <em>generalise</em> what it learned when exposed to new data, we evaluate the model on our hold-out (or so-called <code>test</code> data). We created a test dataset when splitting the data at the start of the modelling.</p>
</div>
<div id="evaluating-the-model-on-the-test-data" class="section level3">
<h3>Evaluating the model on the test data</h3>
<p>The resulting accuracy is less then the accuracy on the training data, but not too bad for a first go and a relatively simple classification model.</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="part-2-machine-learning-with-r.html#cb232-1" aria-hidden="true" tabindex="-1"></a>lr_testing_pred <span class="ot">&lt;-</span> </span>
<span id="cb232-2"><a href="part-2-machine-learning-with-r.html#cb232-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(fit_lr, mutagen_test) <span class="sc">%&gt;%</span> </span>
<span id="cb232-3"><a href="part-2-machine-learning-with-r.html#cb232-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(fit_lr, mutagen_test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb232-4"><a href="part-2-machine-learning-with-r.html#cb232-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(mutagen_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(outcome))</span>
<span id="cb232-5"><a href="part-2-machine-learning-with-r.html#cb232-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-6"><a href="part-2-machine-learning-with-r.html#cb232-6" aria-hidden="true" tabindex="-1"></a>lr_testing_pred <span class="sc">%&gt;%</span>                   <span class="co"># test set predictions</span></span>
<span id="cb232-7"><a href="part-2-machine-learning-with-r.html#cb232-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(outcome, .pred_class)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.719</code></pre>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="part-2-machine-learning-with-r.html#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Let&#39;s plot the AUC-ROC </span></span>
<span id="cb234-2"><a href="part-2-machine-learning-with-r.html#cb234-2" aria-hidden="true" tabindex="-1"></a>lr_testing_pred <span class="sc">%&gt;%</span> </span>
<span id="cb234-3"><a href="part-2-machine-learning-with-r.html#cb234-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> outcome, .pred_mutagen) <span class="sc">%&gt;%</span> </span>
<span id="cb234-4"><a href="part-2-machine-learning-with-r.html#cb234-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">&quot;Logistic Regression&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb234-5"><a href="part-2-machine-learning-with-r.html#cb234-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/mutagen_validate_logistic_regression-1.png" width="672" /></p>
<p>Next, we will explore our improvement options: using a different model type, hyperparameter tuning and multiple fold cross-validation, to see if we can crank up the model performance.</p>
</div>
</div>
<div id="running-a-different-model-type-random-forest" class="section level2">
<h2>Running a different model type, Random Forest</h2>
<p>We will try a Random Forest model (RF), that is able to construct a model from a selection of so-called <code>predictors</code> or <code>parameters</code>. While building the new RF model, we will also demo how to tune the hyperparameters for such a model, using a grid-search. The code used in the following fragment was adapted from <a href="https://juliasilge.com/blog/sf-trees-random-tuning/">this blog by Julia Silge, who works for Posit</a></p>
<div id="finding-the-best-random-forest-model-with-hyperparameter-tuning" class="section level3">
<h3>Finding the best Random Forest model with hyperparameter tuning</h3>
<p>First we define a new model specification. You can find all the models available <a href="https://www.tidymodels.org/find/parsnip/">here</a>. Let define a new models specification that will define what model and model-engine to use and which hyperparameters we will be <code>tuning</code>. The “ranger” engine takes three hyperparameters that we need to set before running the model. We set the <code>trees</code> parameter to a fixed value and we will set the <code>mtry</code> and <code>min_n</code> to value <code>tune()</code>, which means that we will be optimizing the performance of the model by tuning these two hyperparameters. We could have chosen to also tune the <code>trees</code> parameter. It would just mean replacing the value <code>100</code> for <code>tune()</code> and including values for this parameter in the tuning grid. It would also mean a significant increase of computation time. For now, we leave it up to you to experiment with this.</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="part-2-machine-learning-with-r.html#cb235-1" aria-hidden="true" tabindex="-1"></a>rf_tune_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(</span>
<span id="cb235-2"><a href="part-2-machine-learning-with-r.html#cb235-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb235-3"><a href="part-2-machine-learning-with-r.html#cb235-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="dv">100</span>,</span>
<span id="cb235-4"><a href="part-2-machine-learning-with-r.html#cb235-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb235-5"><a href="part-2-machine-learning-with-r.html#cb235-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb235-6"><a href="part-2-machine-learning-with-r.html#cb235-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;ranger&quot;</span>)</span></code></pre></div>
</div>
<div id="a-new-recipe-for-rf-modelling" class="section level3">
<h3>A new recipe for RF modelling</h3>
<p>When looking at the table for preprocessing steps for Random Forest, we see that the only step recommended is imputation. Here we have a dataset that does not include missing values, so we can skip that step. See <a href="https://juliasilge.com/blog/captive-africans-voyages/">this blog</a> for more info on imputation with tidymodels. Let’s start with the most simple recipe we can make: just the data, the specification of the outcome variable and all other columns in the dataset as predictors.</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="part-2-machine-learning-with-r.html#cb236-1" aria-hidden="true" tabindex="-1"></a>rf_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> mutagen_train) </span></code></pre></div>
</div>
<div id="defining-a-new-modelling-workflow" class="section level3">
<h3>Defining a new modelling workflow</h3>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="part-2-machine-learning-with-r.html#cb237-1" aria-hidden="true" tabindex="-1"></a>rf_tune_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb237-2"><a href="part-2-machine-learning-with-r.html#cb237-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rf_rec) <span class="sc">%&gt;%</span></span>
<span id="cb237-3"><a href="part-2-machine-learning-with-r.html#cb237-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_tune_spec)</span>
<span id="cb237-4"><a href="part-2-machine-learning-with-r.html#cb237-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-5"><a href="part-2-machine-learning-with-r.html#cb237-5" aria-hidden="true" tabindex="-1"></a>rf_tune_wf</span></code></pre></div>
<pre><code>## ══ Workflow ════════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: rand_forest()
## 
## ── Preprocessor ────────────────────────────────────────────────────────────────
## 0 Recipe Steps
## 
## ── Model ───────────────────────────────────────────────────────────────────────
## Random Forest Model Specification (classification)
## 
## Main Arguments:
##   mtry = tune()
##   trees = 100
##   min_n = tune()
## 
## Computational engine: ranger</code></pre>
</div>
<div id="defining-a-grid-for-grid-search-hyperparameter-tuning." class="section level3">
<h3>Defining a grid for <code>grid search</code> hyperparameter tuning.</h3>
<p>In order to define a number of possible values for the hyperparameters that we will tune, we will define a grid. Because we are tuning two hyperparameters here, we will define a grid that holds varying values for combinations of both parameters, to find the best combination. We will train the models, based on a number of cross-validation resamples. This means that we create different sets of training and test data. Default, the function <code>vfold_cv()</code> will create 10 so-called folds, containing roughly the same amount of training and validation samples from the data. Each fold is different, because the samples for the training and validation set are randomly sampled from the input data.</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="part-2-machine-learning-with-r.html#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234</span>)</span>
<span id="cb239-2"><a href="part-2-machine-learning-with-r.html#cb239-2" aria-hidden="true" tabindex="-1"></a>mutagen_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(mutagen_train)</span>
<span id="cb239-3"><a href="part-2-machine-learning-with-r.html#cb239-3" aria-hidden="true" tabindex="-1"></a>mutagen_folds</span></code></pre></div>
<pre><code>## #  10-fold cross-validation 
## # A tibble: 10 × 2
##    splits             id    
##    &lt;list&gt;             &lt;chr&gt; 
##  1 &lt;split [2925/326]&gt; Fold01
##  2 &lt;split [2926/325]&gt; Fold02
##  3 &lt;split [2926/325]&gt; Fold03
##  4 &lt;split [2926/325]&gt; Fold04
##  5 &lt;split [2926/325]&gt; Fold05
##  6 &lt;split [2926/325]&gt; Fold06
##  7 &lt;split [2926/325]&gt; Fold07
##  8 &lt;split [2926/325]&gt; Fold08
##  9 &lt;split [2926/325]&gt; Fold09
## 10 &lt;split [2926/325]&gt; Fold10</code></pre>
</div>
<div id="running-the-initial-tuning" class="section level3">
<h3>Running the initial tuning</h3>
<p>Initially we will use a grid tuning where we are just setting the dimensions of the grid (<code>grid = 20</code>). The <code>workflow</code> and cross validation <code>folds</code> are the input for this grid tuning. This step takes a bit longer.</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="part-2-machine-learning-with-r.html#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoMC</span>(<span class="at">cores =</span> <span class="fu">max</span>(<span class="dv">1</span>, parallelly<span class="sc">::</span><span class="fu">availableCores</span>() <span class="sc">-</span> <span class="dv">1</span>))  </span>
<span id="cb241-2"><a href="part-2-machine-learning-with-r.html#cb241-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-3"><a href="part-2-machine-learning-with-r.html#cb241-3" aria-hidden="true" tabindex="-1"></a> tictoc<span class="sc">::</span><span class="fu">tic</span>()</span>
<span id="cb241-4"><a href="part-2-machine-learning-with-r.html#cb241-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">345</span>)</span>
<span id="cb241-5"><a href="part-2-machine-learning-with-r.html#cb241-5" aria-hidden="true" tabindex="-1"></a>  tune_res <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb241-6"><a href="part-2-machine-learning-with-r.html#cb241-6" aria-hidden="true" tabindex="-1"></a>  rf_tune_wf,</span>
<span id="cb241-7"><a href="part-2-machine-learning-with-r.html#cb241-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> mutagen_folds,</span>
<span id="cb241-8"><a href="part-2-machine-learning-with-r.html#cb241-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> <span class="dv">4</span></span>
<span id="cb241-9"><a href="part-2-machine-learning-with-r.html#cb241-9" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## i Creating pre-processing data to finalize unknown parameter: mtry</code></pre>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="part-2-machine-learning-with-r.html#cb243-1" aria-hidden="true" tabindex="-1"></a>  tictoc<span class="sc">::</span><span class="fu">toc</span>(<span class="at">log =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## 16.174 sec elapsed</code></pre>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="part-2-machine-learning-with-r.html#cb245-1" aria-hidden="true" tabindex="-1"></a>tune_res</span></code></pre></div>
<pre><code>## # Tuning results
## # 10-fold cross-validation 
## # A tibble: 10 × 4
##    splits             id     .metrics         .notes          
##    &lt;list&gt;             &lt;chr&gt;  &lt;list&gt;           &lt;list&gt;          
##  1 &lt;split [2925/326]&gt; Fold01 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  2 &lt;split [2926/325]&gt; Fold02 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  3 &lt;split [2926/325]&gt; Fold03 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  4 &lt;split [2926/325]&gt; Fold04 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  5 &lt;split [2926/325]&gt; Fold05 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  6 &lt;split [2926/325]&gt; Fold06 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  7 &lt;split [2926/325]&gt; Fold07 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  8 &lt;split [2926/325]&gt; Fold08 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  9 &lt;split [2926/325]&gt; Fold09 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 3]&gt;
## 10 &lt;split [2926/325]&gt; Fold10 &lt;tibble [8 × 6]&gt; &lt;tibble [0 × 3]&gt;</code></pre>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="part-2-machine-learning-with-r.html#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="do">## get timings</span></span>
<span id="cb247-2"><a href="part-2-machine-learning-with-r.html#cb247-2" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">tic.log</span>(<span class="at">format =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## [[1]]
## [1] &quot;16.174 sec elapsed&quot;</code></pre>
</div>
<div id="visualize-tuning" class="section level3">
<h3>Visualize tuning</h3>
<p>We chose a small grid of only 4 points for each tuning parameter and a low number of trees to keep the run time down. Note that if you increase these numbers, run time will become slower up to the point that you either need to wait for several hours or run things on a larger machine. If you would like to time runtime, you could use <a href="https://www.jumpingrivers.com/blog/timing-in-r/">the <code>{tictoc}</code> package</a>. The output can be retrieved by printing <code>toc.log(format = TRUE)</code> to the console to get the elapsed time, since tic().</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="part-2-machine-learning-with-r.html#cb249-1" aria-hidden="true" tabindex="-1"></a>tune_res <span class="sc">%&gt;%</span></span>
<span id="cb249-2"><a href="part-2-machine-learning-with-r.html#cb249-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb249-3"><a href="part-2-machine-learning-with-r.html#cb249-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">&quot;roc_auc&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb249-4"><a href="part-2-machine-learning-with-r.html#cb249-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mean, min_n, mtry) <span class="sc">%&gt;%</span></span>
<span id="cb249-5"><a href="part-2-machine-learning-with-r.html#cb249-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(min_n<span class="sc">:</span>mtry,</span>
<span id="cb249-6"><a href="part-2-machine-learning-with-r.html#cb249-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb249-7"><a href="part-2-machine-learning-with-r.html#cb249-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;parameter&quot;</span></span>
<span id="cb249-8"><a href="part-2-machine-learning-with-r.html#cb249-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb249-9"><a href="part-2-machine-learning-with-r.html#cb249-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(value, mean, <span class="at">color =</span> parameter)) <span class="sc">+</span></span>
<span id="cb249-10"><a href="part-2-machine-learning-with-r.html#cb249-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb249-11"><a href="part-2-machine-learning-with-r.html#cb249-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>parameter, <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="sc">+</span></span>
<span id="cb249-12"><a href="part-2-machine-learning-with-r.html#cb249-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;AUC&quot;</span>)</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/visualize_inital_tune-1.png" width="672" /></p>
</div>
<div id="using-a-more-fine-grained-grid" class="section level3">
<h3>Using a more fine grained grid</h3>
<p>Based on initial (rough) tuning we can define a more fine-grained grid</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="part-2-machine-learning-with-r.html#cb250-1" aria-hidden="true" tabindex="-1"></a>rf_grid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(</span>
<span id="cb250-2"><a href="part-2-machine-learning-with-r.html#cb250-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtry</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>)),</span>
<span id="cb250-3"><a href="part-2-machine-learning-with-r.html#cb250-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">min_n</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">25</span>)),</span>
<span id="cb250-4"><a href="part-2-machine-learning-with-r.html#cb250-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> <span class="dv">5</span></span>
<span id="cb250-5"><a href="part-2-machine-learning-with-r.html#cb250-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb250-6"><a href="part-2-machine-learning-with-r.html#cb250-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-7"><a href="part-2-machine-learning-with-r.html#cb250-7" aria-hidden="true" tabindex="-1"></a>rf_grid</span></code></pre></div>
<pre><code>## # A tibble: 25 × 2
##     mtry min_n
##    &lt;int&gt; &lt;int&gt;
##  1    20    10
##  2    27    10
##  3    35    10
##  4    42    10
##  5    50    10
##  6    20    13
##  7    27    13
##  8    35    13
##  9    42    13
## 10    50    13
## # ℹ 15 more rows</code></pre>
</div>
<div id="running-another-tuning" class="section level3">
<h3>Running another tuning</h3>
<p>This step takes a longer time. I ran this on a 30 core machine with &gt;400 Gb RAM, which took about 8 hours to complete. In stead of running we load the resulting R-object from disk. I commented the code out, so that it cannot be run accidentally.</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="part-2-machine-learning-with-r.html#cb252-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">registerDoMC</span>(<span class="at">cores =</span> <span class="fu">max</span>(<span class="dv">1</span>, parallelly<span class="sc">::</span><span class="fu">availableCores</span>() <span class="sc">-</span> <span class="dv">1</span>))  </span>
<span id="cb252-2"><a href="part-2-machine-learning-with-r.html#cb252-2" aria-hidden="true" tabindex="-1"></a> tictoc<span class="sc">::</span><span class="fu">tic</span>()</span>
<span id="cb252-3"><a href="part-2-machine-learning-with-r.html#cb252-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">set.seed</span>(<span class="dv">456</span>)</span>
<span id="cb252-4"><a href="part-2-machine-learning-with-r.html#cb252-4" aria-hidden="true" tabindex="-1"></a> regular_res <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb252-5"><a href="part-2-machine-learning-with-r.html#cb252-5" aria-hidden="true" tabindex="-1"></a>   rf_tune_wf,</span>
<span id="cb252-6"><a href="part-2-machine-learning-with-r.html#cb252-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">resamples =</span> mutagen_folds,</span>
<span id="cb252-7"><a href="part-2-machine-learning-with-r.html#cb252-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">grid =</span> rf_grid</span>
<span id="cb252-8"><a href="part-2-machine-learning-with-r.html#cb252-8" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb252-9"><a href="part-2-machine-learning-with-r.html#cb252-9" aria-hidden="true" tabindex="-1"></a> tictoc<span class="sc">::</span><span class="fu">toc</span>()</span></code></pre></div>
<pre><code>## 74.111 sec elapsed</code></pre>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="part-2-machine-learning-with-r.html#cb254-1" aria-hidden="true" tabindex="-1"></a> regular_res</span></code></pre></div>
<pre><code>## # Tuning results
## # 10-fold cross-validation 
## # A tibble: 10 × 4
##    splits             id     .metrics          .notes          
##    &lt;list&gt;             &lt;chr&gt;  &lt;list&gt;            &lt;list&gt;          
##  1 &lt;split [2925/326]&gt; Fold01 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  2 &lt;split [2926/325]&gt; Fold02 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  3 &lt;split [2926/325]&gt; Fold03 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  4 &lt;split [2926/325]&gt; Fold04 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  5 &lt;split [2926/325]&gt; Fold05 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  6 &lt;split [2926/325]&gt; Fold06 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  7 &lt;split [2926/325]&gt; Fold07 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  8 &lt;split [2926/325]&gt; Fold08 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  9 &lt;split [2926/325]&gt; Fold09 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
## 10 &lt;split [2926/325]&gt; Fold10 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;</code></pre>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="part-2-machine-learning-with-r.html#cb256-1" aria-hidden="true" tabindex="-1"></a> <span class="do">## get timings</span></span>
<span id="cb256-2"><a href="part-2-machine-learning-with-r.html#cb256-2" aria-hidden="true" tabindex="-1"></a> tictoc<span class="sc">::</span><span class="fu">tic.log</span>(<span class="at">format =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## [[1]]
## [1] &quot;16.174 sec elapsed&quot;</code></pre>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="part-2-machine-learning-with-r.html#cb258-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">write_rds</span>(regular_res, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;regular_res.rds&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="part-2-machine-learning-with-r.html#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="do">## read regular_res from disk</span></span>
<span id="cb259-2"><a href="part-2-machine-learning-with-r.html#cb259-2" aria-hidden="true" tabindex="-1"></a>regular_res <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_rds</span>(</span>
<span id="cb259-3"><a href="part-2-machine-learning-with-r.html#cb259-3" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb259-4"><a href="part-2-machine-learning-with-r.html#cb259-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb259-5"><a href="part-2-machine-learning-with-r.html#cb259-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;regular_res.rds&quot;</span></span>
<span id="cb259-6"><a href="part-2-machine-learning-with-r.html#cb259-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb259-7"><a href="part-2-machine-learning-with-r.html#cb259-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb259-8"><a href="part-2-machine-learning-with-r.html#cb259-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-9"><a href="part-2-machine-learning-with-r.html#cb259-9" aria-hidden="true" tabindex="-1"></a>regular_res</span></code></pre></div>
<pre><code>## # Tuning results
## # 10-fold cross-validation 
## # A tibble: 10 × 4
##    splits             id     .metrics          .notes          
##    &lt;list&gt;             &lt;chr&gt;  &lt;list&gt;            &lt;list&gt;          
##  1 &lt;split [2925/326]&gt; Fold01 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  2 &lt;split [2926/325]&gt; Fold02 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  3 &lt;split [2926/325]&gt; Fold03 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  4 &lt;split [2926/325]&gt; Fold04 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  5 &lt;split [2926/325]&gt; Fold05 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  6 &lt;split [2926/325]&gt; Fold06 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  7 &lt;split [2926/325]&gt; Fold07 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  8 &lt;split [2926/325]&gt; Fold08 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
##  9 &lt;split [2926/325]&gt; Fold09 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;
## 10 &lt;split [2926/325]&gt; Fold10 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt;</code></pre>
</div>
<div id="view-results-for-fine-grained-tuning" class="section level3">
<h3>View results for fine-grained tuning</h3>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="part-2-machine-learning-with-r.html#cb261-1" aria-hidden="true" tabindex="-1"></a>regular_res <span class="sc">%&gt;%</span></span>
<span id="cb261-2"><a href="part-2-machine-learning-with-r.html#cb261-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb261-3"><a href="part-2-machine-learning-with-r.html#cb261-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">&quot;roc_auc&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb261-4"><a href="part-2-machine-learning-with-r.html#cb261-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">min_n =</span> <span class="fu">factor</span>(min_n)) <span class="sc">%&gt;%</span></span>
<span id="cb261-5"><a href="part-2-machine-learning-with-r.html#cb261-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(mtry, mean, <span class="at">color =</span> min_n)) <span class="sc">+</span></span>
<span id="cb261-6"><a href="part-2-machine-learning-with-r.html#cb261-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb261-7"><a href="part-2-machine-learning-with-r.html#cb261-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb261-8"><a href="part-2-machine-learning-with-r.html#cb261-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;AUC&quot;</span>)</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/final_tuned_plot-1.png" width="672" /></p>
</div>
<div id="fit-final-model-with-optimized-hyperparameters" class="section level3">
<h3>Fit final model with optimized hyperparameters</h3>
<p>We could rerun all step above, to also optimize the number of <code>trees</code> hyperperparamter.</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="part-2-machine-learning-with-r.html#cb262-1" aria-hidden="true" tabindex="-1"></a>best_auc <span class="ot">&lt;-</span> <span class="fu">select_best</span>(regular_res, <span class="st">&quot;roc_auc&quot;</span>)</span>
<span id="cb262-2"><a href="part-2-machine-learning-with-r.html#cb262-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-3"><a href="part-2-machine-learning-with-r.html#cb262-3" aria-hidden="true" tabindex="-1"></a>final_rf <span class="ot">&lt;-</span> <span class="fu">finalize_model</span>(</span>
<span id="cb262-4"><a href="part-2-machine-learning-with-r.html#cb262-4" aria-hidden="true" tabindex="-1"></a>  rf_tune_spec,</span>
<span id="cb262-5"><a href="part-2-machine-learning-with-r.html#cb262-5" aria-hidden="true" tabindex="-1"></a>  best_auc</span>
<span id="cb262-6"><a href="part-2-machine-learning-with-r.html#cb262-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb262-7"><a href="part-2-machine-learning-with-r.html#cb262-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-8"><a href="part-2-machine-learning-with-r.html#cb262-8" aria-hidden="true" tabindex="-1"></a>final_rf</span></code></pre></div>
<pre><code>## Random Forest Model Specification (classification)
## 
## Main Arguments:
##   mtry = 50
##   trees = 100
##   min_n = 10
## 
## Computational engine: ranger</code></pre>
</div>
<div id="explore-final-model" class="section level3">
<h3>Explore final model</h3>
<p>Because of the many features, we can look at their importance using the <code>{vip}</code> package.</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="part-2-machine-learning-with-r.html#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;vip&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:utils&#39;:
## 
##     vi</code></pre>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="part-2-machine-learning-with-r.html#cb267-1" aria-hidden="true" tabindex="-1"></a>rf_mutagen_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(rf_rec)</span>
<span id="cb267-2"><a href="part-2-machine-learning-with-r.html#cb267-2" aria-hidden="true" tabindex="-1"></a>mutagen_juiced <span class="ot">&lt;-</span> <span class="fu">juice</span>(rf_mutagen_prep)</span>
<span id="cb267-3"><a href="part-2-machine-learning-with-r.html#cb267-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-4"><a href="part-2-machine-learning-with-r.html#cb267-4" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoMC</span>(<span class="at">cores =</span> <span class="fu">max</span>(<span class="dv">1</span>, parallelly<span class="sc">::</span><span class="fu">availableCores</span>() <span class="sc">-</span> <span class="dv">1</span>))  </span>
<span id="cb267-5"><a href="part-2-machine-learning-with-r.html#cb267-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-6"><a href="part-2-machine-learning-with-r.html#cb267-6" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">tic</span>()</span>
<span id="cb267-7"><a href="part-2-machine-learning-with-r.html#cb267-7" aria-hidden="true" tabindex="-1"></a>final_rf <span class="sc">%&gt;%</span></span>
<span id="cb267-8"><a href="part-2-machine-learning-with-r.html#cb267-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;ranger&quot;</span>, <span class="at">importance =</span> <span class="st">&quot;permutation&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb267-9"><a href="part-2-machine-learning-with-r.html#cb267-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(outcome <span class="sc">~</span> .,</span>
<span id="cb267-10"><a href="part-2-machine-learning-with-r.html#cb267-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> mutagen_juiced) <span class="ot">-&gt;</span> rf_mutagen_final_fit</span>
<span id="cb267-11"><a href="part-2-machine-learning-with-r.html#cb267-11" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">toc</span>(<span class="at">log =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## 2.513 sec elapsed</code></pre>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="part-2-machine-learning-with-r.html#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="do">## write to disk</span></span>
<span id="cb269-2"><a href="part-2-machine-learning-with-r.html#cb269-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(</span>
<span id="cb269-3"><a href="part-2-machine-learning-with-r.html#cb269-3" aria-hidden="true" tabindex="-1"></a>  rf_mutagen_final_fit,</span>
<span id="cb269-4"><a href="part-2-machine-learning-with-r.html#cb269-4" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb269-5"><a href="part-2-machine-learning-with-r.html#cb269-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data&quot;</span>,</span>
<span id="cb269-6"><a href="part-2-machine-learning-with-r.html#cb269-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;rf_mutagen_final_fit.rds&quot;</span></span>
<span id="cb269-7"><a href="part-2-machine-learning-with-r.html#cb269-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb269-8"><a href="part-2-machine-learning-with-r.html#cb269-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb269-9"><a href="part-2-machine-learning-with-r.html#cb269-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-10"><a href="part-2-machine-learning-with-r.html#cb269-10" aria-hidden="true" tabindex="-1"></a><span class="do">## read from disk</span></span>
<span id="cb269-11"><a href="part-2-machine-learning-with-r.html#cb269-11" aria-hidden="true" tabindex="-1"></a>rf_mutagen_final_fit <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(</span>
<span id="cb269-12"><a href="part-2-machine-learning-with-r.html#cb269-12" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb269-13"><a href="part-2-machine-learning-with-r.html#cb269-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;data&quot;</span>,</span>
<span id="cb269-14"><a href="part-2-machine-learning-with-r.html#cb269-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;rf_mutagen_final_fit.rds&quot;</span>)</span>
<span id="cb269-15"><a href="part-2-machine-learning-with-r.html#cb269-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb269-16"><a href="part-2-machine-learning-with-r.html#cb269-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-17"><a href="part-2-machine-learning-with-r.html#cb269-17" aria-hidden="true" tabindex="-1"></a>rf_mutagen_final_fit <span class="sc">%&gt;%</span></span>
<span id="cb269-18"><a href="part-2-machine-learning-with-r.html#cb269-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vip</span>(<span class="at">geom =</span> <span class="st">&quot;point&quot;</span>)</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/feature_importance-1.png" width="672" /></p>
</div>
</div>
<div id="final-fit" class="section level2">
<h2>Final fit</h2>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="part-2-machine-learning-with-r.html#cb270-1" aria-hidden="true" tabindex="-1"></a>rf_final_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb270-2"><a href="part-2-machine-learning-with-r.html#cb270-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rf_rec) <span class="sc">%&gt;%</span></span>
<span id="cb270-3"><a href="part-2-machine-learning-with-r.html#cb270-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(final_rf)</span>
<span id="cb270-4"><a href="part-2-machine-learning-with-r.html#cb270-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-5"><a href="part-2-machine-learning-with-r.html#cb270-5" aria-hidden="true" tabindex="-1"></a> rf_final_res <span class="ot">&lt;-</span> rf_final_wf <span class="sc">%&gt;%</span></span>
<span id="cb270-6"><a href="part-2-machine-learning-with-r.html#cb270-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(mutagen_split)</span>
<span id="cb270-7"><a href="part-2-machine-learning-with-r.html#cb270-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-8"><a href="part-2-machine-learning-with-r.html#cb270-8" aria-hidden="true" tabindex="-1"></a> rf_final_res <span class="sc">%&gt;%</span></span>
<span id="cb270-9"><a href="part-2-machine-learning-with-r.html#cb270-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 × 4
##   .metric  .estimator .estimate .config             
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
## 1 accuracy binary         0.803 Preprocessor1_Model1
## 2 roc_auc  binary         0.878 Preprocessor1_Model1</code></pre>
<div id="compare-auc-roc-curves" class="section level3">
<h3>Compare AUC-ROC curves</h3>
<p>To compare performance of the logistic regression and the Random Forest model, we plot both ROC curves in the same graph. When we compare the ROC curve for the logistic regression model (<code>blue</code>) with the curve for the Random Forest model (<code>Red</code>), we see that indeed the overall performance of the Random Forest model is better.</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="part-2-machine-learning-with-r.html#cb272-1" aria-hidden="true" tabindex="-1"></a>rf_auc <span class="ot">&lt;-</span> </span>
<span id="cb272-2"><a href="part-2-machine-learning-with-r.html#cb272-2" aria-hidden="true" tabindex="-1"></a>  rf_final_res <span class="sc">%&gt;%</span> </span>
<span id="cb272-3"><a href="part-2-machine-learning-with-r.html#cb272-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb272-4"><a href="part-2-machine-learning-with-r.html#cb272-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(outcome, .pred_mutagen) <span class="sc">%&gt;%</span> </span>
<span id="cb272-5"><a href="part-2-machine-learning-with-r.html#cb272-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">&quot;Random Forest&quot;</span>)</span>
<span id="cb272-6"><a href="part-2-machine-learning-with-r.html#cb272-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-7"><a href="part-2-machine-learning-with-r.html#cb272-7" aria-hidden="true" tabindex="-1"></a>lr_auc <span class="ot">&lt;-</span> lr_testing_pred <span class="sc">%&gt;%</span> </span>
<span id="cb272-8"><a href="part-2-machine-learning-with-r.html#cb272-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> outcome, .pred_mutagen) <span class="sc">%&gt;%</span> </span>
<span id="cb272-9"><a href="part-2-machine-learning-with-r.html#cb272-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">&quot;Logistic Regression&quot;</span>)</span>
<span id="cb272-10"><a href="part-2-machine-learning-with-r.html#cb272-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-11"><a href="part-2-machine-learning-with-r.html#cb272-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-12"><a href="part-2-machine-learning-with-r.html#cb272-12" aria-hidden="true" tabindex="-1"></a><span class="do">## compare logistic regression and RF</span></span>
<span id="cb272-13"><a href="part-2-machine-learning-with-r.html#cb272-13" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(rf_auc, lr_auc) <span class="sc">%&gt;%</span> </span>
<span id="cb272-14"><a href="part-2-machine-learning-with-r.html#cb272-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span> <span class="sc">-</span> specificity, <span class="at">y =</span> sensitivity, <span class="at">col =</span> model)) <span class="sc">+</span> </span>
<span id="cb272-15"><a href="part-2-machine-learning-with-r.html#cb272-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">lwd =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb272-16"><a href="part-2-machine-learning-with-r.html#cb272-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">lty =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb272-17"><a href="part-2-machine-learning-with-r.html#cb272-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span> </span>
<span id="cb272-18"><a href="part-2-machine-learning-with-r.html#cb272-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>, <span class="at">end =</span> .<span class="dv">6</span>)</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/compare_roc_curves-1.png" width="672" /></p>
</div>
<div id="confusion-matrix" class="section level3">
<h3>Confusion matrix</h3>
<p>As a final check for performance, you can take a look a the so-called <code>confusion matrix</code>. This matrix show the raw frequencies for the true classifications, versus the estimated (predicted) classes. You can see that the model is able to make accurate predictions, but makes mistakes, especially when predicting non-mutagens, where the actual class is mutagen. This is called a <code>false negative</code>. The model also missclassifies a number of mutagens, where the actual class is non-mutagen. This is called a <code>false postive</code>.</p>
<p>Sensitivity and Specificity and overall Accuracy, can be directly derived from the confusion matrix as:</p>
<p><span class="math inline">\(Sensitivity=[a/(a+c)]×100\)</span></p>
<p><span class="math inline">\(Specificity=[d/(b+d)]×100\)</span></p>
<p><span class="math inline">\(Accuracy=[(a+d)/(a+d+b+c)]\)</span></p>
<p>where a, b, c and d are explained in the image below:</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="part-2-machine-learning-with-r.html#cb273-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(</span>
<span id="cb273-2"><a href="part-2-machine-learning-with-r.html#cb273-2" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb273-3"><a href="part-2-machine-learning-with-r.html#cb273-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;images&quot;</span>,</span>
<span id="cb273-4"><a href="part-2-machine-learning-with-r.html#cb273-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;conf_mat_spec_sele.png&quot;</span></span>
<span id="cb273-5"><a href="part-2-machine-learning-with-r.html#cb273-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb273-6"><a href="part-2-machine-learning-with-r.html#cb273-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="images/conf_mat_spec_sele.png" width="543" /></p>
<p>To get the confusion matrix from our final Random Forest fit</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="part-2-machine-learning-with-r.html#cb274-1" aria-hidden="true" tabindex="-1"></a> rf_final_res <span class="sc">%&gt;%</span> </span>
<span id="cb274-2"><a href="part-2-machine-learning-with-r.html#cb274-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="ot">-&gt;</span> predictions_tbl</span>
<span id="cb274-3"><a href="part-2-machine-learning-with-r.html#cb274-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-4"><a href="part-2-machine-learning-with-r.html#cb274-4" aria-hidden="true" tabindex="-1"></a><span class="fu">conf_mat</span>(predictions_tbl, <span class="at">truth =</span> outcome, <span class="at">estimate =</span> .pred_class)</span></code></pre></div>
<pre><code>##             Truth
## Prediction   mutagen nonmutagen
##   mutagen        510        121
##   nonmutagen      93        360</code></pre>
</div>
<div id="conclusion" class="section level3">
<h3>Conclusion</h3>
<p>The final model is not too bad, and better then logistic regression. We could rerun all the steps above for different modelling algorithms. Also, remember that for this educational exercise we kept only 100 arbitrary (randomly selected) columns in the data. One could imagine rerunning the model training with all the features. This could well result in better model performance.</p>
<div id="exercise-getting-started-with-the-tame-dataset-2" class="section level5 unnumbered question">
<h5>Exercise; Getting started with the TAME dataset 2</h5>
<p>The TAME learning module contains an example dataset from the EPA containing molecular descriptors of PFAS and statins. The data was already downloaded above and should be visible in your Global env. as <code>data_tame</code>. If not, look up the code chunk above an rerun it.</p>
<p>In this exercise, we are going to build a predictive model to try and answer the following question:</p>
<p>“Can we differentiate between the <code>PFAS</code> and <code>statin</code> chemical classes, when considering just the raw physicochemical property variables.</p>
<p>The assignment is to build a predictive model, using the Tidymodel framework that was demonstrated in the previous section. In order to achieve this you need at least to consider the following steps</p>
<ol style="list-style-type: decimal">
<li>Inpect the data, using the tools/functions you learned during the previous section of this lesson and the course</li>
<li>Check the datatypes of the variables</li>
<li>Create some exploratory graphs</li>
<li>Identify the type of modelling approach (engine?) you would like to use</li>
<li>Identify the roles for each variable in the dataset</li>
<li>Are there any variables that need to be ‘<code>feature engineered</code>’?</li>
<li>Build a <code>tame_mod</code> R object that contains the model definition (formula)</li>
<li>Split the data in to a <code>data_tame_train</code> and a <code>data_tame_test</code> fold</li>
<li>Define a recipe (<code>tame_rec</code>) that includes all the steps you would like to perform as pre-processing. Think about the ‘zero-variance’ variables here</li>
<li>Build a workflow that combines the model (<code>tame_mod</code>) and recipe (<code>tame_rec</code>)</li>
<li>Fit the model using the workflow and the training data</li>
<li>Check the model performance using the fitted model and the test data</li>
<li>Visualize model performance.</li>
</ol>
<p><strong>TIPS</strong></p>
<ol style="list-style-type: decimal">
<li>Think about what type of classification problem we are dealing with here: regression, logistic regression, binary classification, is the outcome numeric or a factor?</li>
<li>Check if there are any missing values, as part of your exploratory analysis</li>
<li>Also check the distributions of the variables, do we perhaps need to scale and/or center the variables, before fitting the model? If so why, or if not - why not?</li>
<li>Remember <code>janitor::clean_names()</code> to tidy the variable names, this makes the variables complient to R convention</li>
<li>Maybe rename the <code>List</code> variable to something more meaningful?</li>
</ol>
</div>
<details>
<summary>
Click for the answer
</summary>
<p>Exercise Answer:</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="part-2-machine-learning-with-r.html#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Inspect the data</span></span>
<span id="cb276-2"><a href="part-2-machine-learning-with-r.html#cb276-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(data_tame)</span></code></pre></div>
<pre><code>## [1] 144  14</code></pre>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="part-2-machine-learning-with-r.html#cb278-1" aria-hidden="true" tabindex="-1"></a>data_tame[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## # A tibble: 4 × 5
##   List  `Substance Name`                         CASRN DTXSID `Molecular Weight`
##   &lt;chr&gt; &lt;chr&gt;                                    &lt;chr&gt; &lt;chr&gt;               &lt;dbl&gt;
## 1 PFAS  Perfluoro-2-(trifluoromethyl)propanesul… 9376… DTXSI…               300.
## 2 PFAS  Potassium perfluoroheptanesulfonate      6027… DTXSI…               488.
## 3 PFAS  Bis(2-hydroxyethyl)ammonium perfluorohe… 7022… DTXSI…               555.
## 4 PFAS  Potassium perfluoro-p-ethylcyclohexanes… 335-… DTXSI…               500.</code></pre>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="part-2-machine-learning-with-r.html#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb280-2"><a href="part-2-machine-learning-with-r.html#cb280-2" aria-hidden="true" tabindex="-1"></a>data_tame</span></code></pre></div>
<pre><code>## # A tibble: 144 × 14
##    List  `Substance Name` CASRN DTXSID `Molecular Weight` `OPERA, Boiling Point`
##    &lt;chr&gt; &lt;chr&gt;            &lt;chr&gt; &lt;chr&gt;               &lt;dbl&gt;                  &lt;dbl&gt;
##  1 PFAS  Perfluoro-2-(tr… 9376… DTXSI…               300.                   213.
##  2 PFAS  Potassium perfl… 6027… DTXSI…               488.                   223.
##  3 PFAS  Bis(2-hydroxyet… 7022… DTXSI…               555.                   223.
##  4 PFAS  Potassium perfl… 335-… DTXSI…               500.                   221.
##  5 PFAS  1,1,2,2,3,3,4,4… 647-… DTXSI…               484.                   207.
##  6 PFAS  Perfluorononane… 6825… DTXSI…               550.                   224.
##  7 PFAS  Ammonium perflu… 6825… DTXSI…               367.                   225.
##  8 PFAS  Ammonium perflu… 6825… DTXSI…               467.                   223.
##  9 PFAS  Sodium nonafluo… 6045… DTXSI…               322.                   211.
## 10 PFAS  2H-Perfluoropro… 357-… DTXSI…               232.                   202.
## # ℹ 134 more rows
## # ℹ 8 more variables: `OPERA, Henry&#39;s Law Constant` &lt;dbl&gt;,
## #   `OPERA, Melting Point` &lt;dbl&gt;,
## #   `OPERA, Negative Log of Acid Dissociation Constant` &lt;dbl&gt;,
## #   `OPERA, Octanol-Air Partition Coefficient` &lt;dbl&gt;,
## #   `OPERA, Octanol-Water Distribution Coefficient` &lt;dbl&gt;,
## #   `OPERA, Octanol-Water Partition Coefficient` &lt;dbl&gt;, …</code></pre>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="part-2-machine-learning-with-r.html#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(data_tame<span class="sc">$</span>List)</span></code></pre></div>
<pre><code>## [1] &quot;PFAS&quot;    &quot;Statins&quot;</code></pre>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb284-1"><a href="part-2-machine-learning-with-r.html#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_tame)</span></code></pre></div>
<pre><code>##  [1] &quot;List&quot;                                             
##  [2] &quot;Substance Name&quot;                                   
##  [3] &quot;CASRN&quot;                                            
##  [4] &quot;DTXSID&quot;                                           
##  [5] &quot;Molecular Weight&quot;                                 
##  [6] &quot;OPERA, Boiling Point&quot;                             
##  [7] &quot;OPERA, Henry&#39;s Law Constant&quot;                      
##  [8] &quot;OPERA, Melting Point&quot;                             
##  [9] &quot;OPERA, Negative Log of Acid Dissociation Constant&quot;
## [10] &quot;OPERA, Octanol-Air Partition Coefficient&quot;         
## [11] &quot;OPERA, Octanol-Water Distribution Coefficient&quot;    
## [12] &quot;OPERA, Octanol-Water Partition Coefficient&quot;       
## [13] &quot;OPERA, Vapor Pressure&quot;                            
## [14] &quot;OPERA, Water Solubility&quot;</code></pre>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="part-2-machine-learning-with-r.html#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="do">## exploratory graphs</span></span>
<span id="cb286-2"><a href="part-2-machine-learning-with-r.html#cb286-2" aria-hidden="true" tabindex="-1"></a>data_tame_tidy <span class="ot">&lt;-</span> data_tame <span class="sc">|&gt;</span></span>
<span id="cb286-3"><a href="part-2-machine-learning-with-r.html#cb286-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">class =</span> List) <span class="sc">|&gt;</span></span>
<span id="cb286-4"><a href="part-2-machine-learning-with-r.html#cb286-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">as_factor</span>(class)) <span class="sc">|&gt;</span></span>
<span id="cb286-5"><a href="part-2-machine-learning-with-r.html#cb286-5" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb286-6"><a href="part-2-machine-learning-with-r.html#cb286-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data_tame_tidy)</span></code></pre></div>
<pre><code>##  [1] &quot;class&quot;                                           
##  [2] &quot;substance_name&quot;                                  
##  [3] &quot;casrn&quot;                                           
##  [4] &quot;dtxsid&quot;                                          
##  [5] &quot;molecular_weight&quot;                                
##  [6] &quot;opera_boiling_point&quot;                             
##  [7] &quot;opera_henrys_law_constant&quot;                       
##  [8] &quot;opera_melting_point&quot;                             
##  [9] &quot;opera_negative_log_of_acid_dissociation_constant&quot;
## [10] &quot;opera_octanol_air_partition_coefficient&quot;         
## [11] &quot;opera_octanol_water_distribution_coefficient&quot;    
## [12] &quot;opera_octanol_water_partition_coefficient&quot;       
## [13] &quot;opera_vapor_pressure&quot;                            
## [14] &quot;opera_water_solubility&quot;</code></pre>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="part-2-machine-learning-with-r.html#cb288-1" aria-hidden="true" tabindex="-1"></a>data_tame_tidy <span class="sc">|&gt;</span></span>
<span id="cb288-2"><a href="part-2-machine-learning-with-r.html#cb288-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> molecular_weight, <span class="at">y =</span> opera_octanol_water_distribution_coefficient)) <span class="sc">+</span></span>
<span id="cb288-3"><a href="part-2-machine-learning-with-r.html#cb288-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> class))</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb289-1"><a href="part-2-machine-learning-with-r.html#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="do">## let&#39;s do another</span></span>
<span id="cb289-2"><a href="part-2-machine-learning-with-r.html#cb289-2" aria-hidden="true" tabindex="-1"></a>data_tame_tidy <span class="sc">|&gt;</span></span>
<span id="cb289-3"><a href="part-2-machine-learning-with-r.html#cb289-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> opera_water_solubility , <span class="at">y =</span> opera_negative_log_of_acid_dissociation_constant)) <span class="sc">+</span></span>
<span id="cb289-4"><a href="part-2-machine-learning-with-r.html#cb289-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> class))</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/unnamed-chunk-5-2.png" width="672" /></p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="part-2-machine-learning-with-r.html#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="do">## What can you conclude from these two example graphs?</span></span>
<span id="cb290-2"><a href="part-2-machine-learning-with-r.html#cb290-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-3"><a href="part-2-machine-learning-with-r.html#cb290-3" aria-hidden="true" tabindex="-1"></a><span class="do">## missing values</span></span>
<span id="cb290-4"><a href="part-2-machine-learning-with-r.html#cb290-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_tame_tidy))</span></code></pre></div>
<pre><code>## [1] 47</code></pre>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="part-2-machine-learning-with-r.html#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span>
<span id="cb292-2"><a href="part-2-machine-learning-with-r.html#cb292-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vis_miss</span>(data_tame_tidy)</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/unnamed-chunk-5-3.png" width="672" /></p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="part-2-machine-learning-with-r.html#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="do">## missingnes seems to be in the dtxsid colum</span></span>
<span id="cb293-2"><a href="part-2-machine-learning-with-r.html#cb293-2" aria-hidden="true" tabindex="-1"></a><span class="do">## check</span></span>
<span id="cb293-3"><a href="part-2-machine-learning-with-r.html#cb293-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_tame_tidy<span class="sc">$</span>dtxsid))</span></code></pre></div>
<pre><code>## [1] 47</code></pre>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="part-2-machine-learning-with-r.html#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt; 47, so not a problem, this variable is an ID, not a predictor. For random forest, we cannot have missing values in predictor variables</span></span></code></pre></div>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="part-2-machine-learning-with-r.html#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define the engine and model type</span></span>
<span id="cb296-2"><a href="part-2-machine-learning-with-r.html#cb296-2" aria-hidden="true" tabindex="-1"></a><span class="do">## this problem seems fit for a regression tree approach, e.g. random forest. See: https://parsnip.tidymodels.org/reference/rand_forest.html</span></span>
<span id="cb296-3"><a href="part-2-machine-learning-with-r.html#cb296-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-4"><a href="part-2-machine-learning-with-r.html#cb296-4" aria-hidden="true" tabindex="-1"></a>tame_mod <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>() <span class="sc">|&gt;</span></span>
<span id="cb296-5"><a href="part-2-machine-learning-with-r.html#cb296-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;ranger&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb296-6"><a href="part-2-machine-learning-with-r.html#cb296-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)<span class="co"># default engine</span></span>
<span id="cb296-7"><a href="part-2-machine-learning-with-r.html#cb296-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-8"><a href="part-2-machine-learning-with-r.html#cb296-8" aria-hidden="true" tabindex="-1"></a>tame_mod</span></code></pre></div>
<pre><code>## Random Forest Model Specification (classification)
## 
## Computational engine: ranger</code></pre>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="part-2-machine-learning-with-r.html#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="do">## data split</span></span>
<span id="cb298-2"><a href="part-2-machine-learning-with-r.html#cb298-2" aria-hidden="true" tabindex="-1"></a>data_tame_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_tame_tidy, <span class="at">prop =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb298-3"><a href="part-2-machine-learning-with-r.html#cb298-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-4"><a href="part-2-machine-learning-with-r.html#cb298-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frames for the two sets:</span></span>
<span id="cb298-5"><a href="part-2-machine-learning-with-r.html#cb298-5" aria-hidden="true" tabindex="-1"></a>data_tame_train <span class="ot">&lt;-</span> <span class="fu">training</span>(data_tame_split)</span>
<span id="cb298-6"><a href="part-2-machine-learning-with-r.html#cb298-6" aria-hidden="true" tabindex="-1"></a>data_tame_test  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_tame_split)</span></code></pre></div>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="part-2-machine-learning-with-r.html#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data_tame_tidy)</span></code></pre></div>
<pre><code>##  [1] &quot;class&quot;                                           
##  [2] &quot;substance_name&quot;                                  
##  [3] &quot;casrn&quot;                                           
##  [4] &quot;dtxsid&quot;                                          
##  [5] &quot;molecular_weight&quot;                                
##  [6] &quot;opera_boiling_point&quot;                             
##  [7] &quot;opera_henrys_law_constant&quot;                       
##  [8] &quot;opera_melting_point&quot;                             
##  [9] &quot;opera_negative_log_of_acid_dissociation_constant&quot;
## [10] &quot;opera_octanol_air_partition_coefficient&quot;         
## [11] &quot;opera_octanol_water_distribution_coefficient&quot;    
## [12] &quot;opera_octanol_water_partition_coefficient&quot;       
## [13] &quot;opera_vapor_pressure&quot;                            
## [14] &quot;opera_water_solubility&quot;</code></pre>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="part-2-machine-learning-with-r.html#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define the recipe</span></span>
<span id="cb301-2"><a href="part-2-machine-learning-with-r.html#cb301-2" aria-hidden="true" tabindex="-1"></a>tame_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(class <span class="sc">~</span> ., <span class="at">data =</span> data_tame_train) <span class="sc">|&gt;</span> </span>
<span id="cb301-3"><a href="part-2-machine-learning-with-r.html#cb301-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(substance_name, casrn, dtxsid, <span class="at">new_role =</span> <span class="st">&quot;ID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb301-4"><a href="part-2-machine-learning-with-r.html#cb301-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb301-5"><a href="part-2-machine-learning-with-r.html#cb301-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb301-6"><a href="part-2-machine-learning-with-r.html#cb301-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb301-7"><a href="part-2-machine-learning-with-r.html#cb301-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-8"><a href="part-2-machine-learning-with-r.html#cb301-8" aria-hidden="true" tabindex="-1"></a><span class="do">## let&#39;s look at the distribution of values accross the predictors</span></span>
<span id="cb301-9"><a href="part-2-machine-learning-with-r.html#cb301-9" aria-hidden="true" tabindex="-1"></a><span class="fu">map_lgl</span>(</span>
<span id="cb301-10"><a href="part-2-machine-learning-with-r.html#cb301-10" aria-hidden="true" tabindex="-1"></a>  data_tame_tidy,</span>
<span id="cb301-11"><a href="part-2-machine-learning-with-r.html#cb301-11" aria-hidden="true" tabindex="-1"></a>  is.numeric</span>
<span id="cb301-12"><a href="part-2-machine-learning-with-r.html#cb301-12" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> ind</span>
<span id="cb301-13"><a href="part-2-machine-learning-with-r.html#cb301-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-14"><a href="part-2-machine-learning-with-r.html#cb301-14" aria-hidden="true" tabindex="-1"></a><span class="fu">map_df</span>(</span>
<span id="cb301-15"><a href="part-2-machine-learning-with-r.html#cb301-15" aria-hidden="true" tabindex="-1"></a>  data_tame_tidy[,ind],</span>
<span id="cb301-16"><a href="part-2-machine-learning-with-r.html#cb301-16" aria-hidden="true" tabindex="-1"></a>  min</span>
<span id="cb301-17"><a href="part-2-machine-learning-with-r.html#cb301-17" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> mins</span>
<span id="cb301-18"><a href="part-2-machine-learning-with-r.html#cb301-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-19"><a href="part-2-machine-learning-with-r.html#cb301-19" aria-hidden="true" tabindex="-1"></a>mins<span class="sc">$</span>type <span class="ot">=</span> <span class="st">&quot;min&quot;</span></span>
<span id="cb301-20"><a href="part-2-machine-learning-with-r.html#cb301-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-21"><a href="part-2-machine-learning-with-r.html#cb301-21" aria-hidden="true" tabindex="-1"></a><span class="fu">map_df</span>(</span>
<span id="cb301-22"><a href="part-2-machine-learning-with-r.html#cb301-22" aria-hidden="true" tabindex="-1"></a>  data_tame_tidy[,ind],</span>
<span id="cb301-23"><a href="part-2-machine-learning-with-r.html#cb301-23" aria-hidden="true" tabindex="-1"></a>  max</span>
<span id="cb301-24"><a href="part-2-machine-learning-with-r.html#cb301-24" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> maxes</span>
<span id="cb301-25"><a href="part-2-machine-learning-with-r.html#cb301-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-26"><a href="part-2-machine-learning-with-r.html#cb301-26" aria-hidden="true" tabindex="-1"></a>maxes<span class="sc">$</span>type <span class="ot">=</span> <span class="st">&quot;max&quot;</span></span>
<span id="cb301-27"><a href="part-2-machine-learning-with-r.html#cb301-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-28"><a href="part-2-machine-learning-with-r.html#cb301-28" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(mins, maxes) <span class="sc">|&gt;</span></span>
<span id="cb301-29"><a href="part-2-machine-learning-with-r.html#cb301-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">names_to =</span> <span class="st">&quot;vars&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;values&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb301-30"><a href="part-2-machine-learning-with-r.html#cb301-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb301-31"><a href="part-2-machine-learning-with-r.html#cb301-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">reorder</span>(<span class="fu">as_factor</span>(vars), values), </span>
<span id="cb301-32"><a href="part-2-machine-learning-with-r.html#cb301-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> values)) <span class="sc">+</span></span>
<span id="cb301-33"><a href="part-2-machine-learning-with-r.html#cb301-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> type), <span class="at">position =</span> <span class="st">&quot;jitter&quot;</span>) <span class="sc">+</span></span>
<span id="cb301-34"><a href="part-2-machine-learning-with-r.html#cb301-34" aria-hidden="true" tabindex="-1"></a>  toolboxr<span class="sc">::</span><span class="fu">rotate_axis_labels</span>(<span class="st">&quot;x&quot;</span>, <span class="dv">90</span>)</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="part-2-machine-learning-with-r.html#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="do">## now we do the same for the normalized and centered data, we will use the function `preProcess()` from the {caret} package, which was developed by Max Kuhn (co/lead-developer for {tidymodels})</span></span>
<span id="cb302-2"><a href="part-2-machine-learning-with-r.html#cb302-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span></code></pre></div>
<pre><code>## Loading required package: lattice</code></pre>
<pre><code>## 
## Attaching package: &#39;caret&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:yardstick&#39;:
## 
##     precision, recall, sensitivity, specificity</code></pre>
<pre><code>## The following object is masked from &#39;package:purrr&#39;:
## 
##     lift</code></pre>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="part-2-machine-learning-with-r.html#cb307-1" aria-hidden="true" tabindex="-1"></a>preProcValues <span class="ot">&lt;-</span> <span class="fu">preProcess</span>(data_tame, <span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;scale&quot;</span>))</span>
<span id="cb307-2"><a href="part-2-machine-learning-with-r.html#cb307-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-3"><a href="part-2-machine-learning-with-r.html#cb307-3" aria-hidden="true" tabindex="-1"></a>data_tame_transformed <span class="ot">&lt;-</span> <span class="fu">predict</span>(preProcValues, data_tame)</span>
<span id="cb307-4"><a href="part-2-machine-learning-with-r.html#cb307-4" aria-hidden="true" tabindex="-1"></a>data_tame_transformed</span></code></pre></div>
<pre><code>## # A tibble: 144 × 14
##    List  `Substance Name` CASRN DTXSID `Molecular Weight` `OPERA, Boiling Point`
##    &lt;chr&gt; &lt;chr&gt;            &lt;chr&gt; &lt;chr&gt;               &lt;dbl&gt;                  &lt;dbl&gt;
##  1 PFAS  Perfluoro-2-(tr… 9376… DTXSI…            -1.03                   -0.626
##  2 PFAS  Potassium perfl… 6027… DTXSI…             0.118                  -0.515
##  3 PFAS  Bis(2-hydroxyet… 7022… DTXSI…             0.526                  -0.515
##  4 PFAS  Potassium perfl… 335-… DTXSI…             0.191                  -0.543
##  5 PFAS  1,1,2,2,3,3,4,4… 647-… DTXSI…             0.0931                 -0.694
##  6 PFAS  Perfluorononane… 6825… DTXSI…             0.495                  -0.504
##  7 PFAS  Ammonium perflu… 6825… DTXSI…            -0.619                  -0.494
##  8 PFAS  Ammonium perflu… 6825… DTXSI…            -0.0103                 -0.515
##  9 PFAS  Sodium nonafluo… 6045… DTXSI…            -0.893                  -0.650
## 10 PFAS  2H-Perfluoropro… 357-… DTXSI…            -1.44                   -0.752
## # ℹ 134 more rows
## # ℹ 8 more variables: `OPERA, Henry&#39;s Law Constant` &lt;dbl&gt;,
## #   `OPERA, Melting Point` &lt;dbl&gt;,
## #   `OPERA, Negative Log of Acid Dissociation Constant` &lt;dbl&gt;,
## #   `OPERA, Octanol-Air Partition Coefficient` &lt;dbl&gt;,
## #   `OPERA, Octanol-Water Distribution Coefficient` &lt;dbl&gt;,
## #   `OPERA, Octanol-Water Partition Coefficient` &lt;dbl&gt;, …</code></pre>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="part-2-machine-learning-with-r.html#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="do">## let&#39;s put the code above in a function that we can recycle for later use</span></span>
<span id="cb309-2"><a href="part-2-machine-learning-with-r.html#cb309-2" aria-hidden="true" tabindex="-1"></a>plot_min_max <span class="ot">&lt;-</span> <span class="cf">function</span>(df, ...) { <span class="do">## ... ellipsis, additional arguments to pivot_longer(), column index or tidy-eval column names (unquoted)</span></span>
<span id="cb309-3"><a href="part-2-machine-learning-with-r.html#cb309-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_lgl</span>(df,</span>
<span id="cb309-4"><a href="part-2-machine-learning-with-r.html#cb309-4" aria-hidden="true" tabindex="-1"></a>          is.numeric) <span class="ot">-&gt;</span> ind</span>
<span id="cb309-5"><a href="part-2-machine-learning-with-r.html#cb309-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb309-6"><a href="part-2-machine-learning-with-r.html#cb309-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(df[, ind],</span>
<span id="cb309-7"><a href="part-2-machine-learning-with-r.html#cb309-7" aria-hidden="true" tabindex="-1"></a>         min) <span class="ot">-&gt;</span> mins</span>
<span id="cb309-8"><a href="part-2-machine-learning-with-r.html#cb309-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb309-9"><a href="part-2-machine-learning-with-r.html#cb309-9" aria-hidden="true" tabindex="-1"></a>  mins<span class="sc">$</span>type <span class="ot">=</span> <span class="st">&quot;min&quot;</span></span>
<span id="cb309-10"><a href="part-2-machine-learning-with-r.html#cb309-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb309-11"><a href="part-2-machine-learning-with-r.html#cb309-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(df[, ind],</span>
<span id="cb309-12"><a href="part-2-machine-learning-with-r.html#cb309-12" aria-hidden="true" tabindex="-1"></a>         max) <span class="ot">-&gt;</span> maxes</span>
<span id="cb309-13"><a href="part-2-machine-learning-with-r.html#cb309-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb309-14"><a href="part-2-machine-learning-with-r.html#cb309-14" aria-hidden="true" tabindex="-1"></a>  maxes<span class="sc">$</span>type <span class="ot">=</span> <span class="st">&quot;max&quot;</span></span>
<span id="cb309-15"><a href="part-2-machine-learning-with-r.html#cb309-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb309-16"><a href="part-2-machine-learning-with-r.html#cb309-16" aria-hidden="true" tabindex="-1"></a>  title <span class="ot">&lt;-</span> <span class="fu">deparse</span>(<span class="fu">substitute</span>(df)) </span>
<span id="cb309-17"><a href="part-2-machine-learning-with-r.html#cb309-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb309-18"><a href="part-2-machine-learning-with-r.html#cb309-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(mins, maxes) <span class="sc">|&gt;</span></span>
<span id="cb309-19"><a href="part-2-machine-learning-with-r.html#cb309-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(..., <span class="at">names_to =</span> <span class="st">&quot;vars&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;values&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb309-20"><a href="part-2-machine-learning-with-r.html#cb309-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(<span class="fu">as_factor</span>(vars), values),</span>
<span id="cb309-21"><a href="part-2-machine-learning-with-r.html#cb309-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">y =</span> values)) <span class="sc">+</span></span>
<span id="cb309-22"><a href="part-2-machine-learning-with-r.html#cb309-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> type), <span class="at">position =</span> <span class="st">&quot;jitter&quot;</span>) <span class="sc">+</span></span>
<span id="cb309-23"><a href="part-2-machine-learning-with-r.html#cb309-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(title) <span class="sc">+</span></span>
<span id="cb309-24"><a href="part-2-machine-learning-with-r.html#cb309-24" aria-hidden="true" tabindex="-1"></a>    toolboxr<span class="sc">::</span><span class="fu">rotate_axis_labels</span>(<span class="st">&quot;x&quot;</span>, <span class="dv">90</span>) <span class="ot">-&gt;</span> p</span>
<span id="cb309-25"><a href="part-2-machine-learning-with-r.html#cb309-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb309-26"><a href="part-2-machine-learning-with-r.html#cb309-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb309-27"><a href="part-2-machine-learning-with-r.html#cb309-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-28"><a href="part-2-machine-learning-with-r.html#cb309-28" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_min_max</span>(<span class="at">df =</span> data_tame_transformed, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="ot">-&gt;</span> tame_plot_transformed </span>
<span id="cb309-29"><a href="part-2-machine-learning-with-r.html#cb309-29" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_min_max</span>(<span class="at">df =</span> data_tame, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="ot">-&gt;</span> tame_plot</span>
<span id="cb309-30"><a href="part-2-machine-learning-with-r.html#cb309-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-31"><a href="part-2-machine-learning-with-r.html#cb309-31" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb309-32"><a href="part-2-machine-learning-with-r.html#cb309-32" aria-hidden="true" tabindex="-1"></a>  tame_plot,</span>
<span id="cb309-33"><a href="part-2-machine-learning-with-r.html#cb309-33" aria-hidden="true" tabindex="-1"></a>  tame_plot_transformed</span>
<span id="cb309-34"><a href="part-2-machine-learning-with-r.html#cb309-34" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/unnamed-chunk-8-2.png" width="672" /></p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="part-2-machine-learning-with-r.html#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="do">## In terms of feature engineering, there seems to be no need to do this upfront. We could get the SMILES for each compound from a database, and calculate fingerprints. In a later part of this lesson we will revisit this option.</span></span></code></pre></div>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="part-2-machine-learning-with-r.html#cb311-1" aria-hidden="true" tabindex="-1"></a>tame_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb311-2"><a href="part-2-machine-learning-with-r.html#cb311-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tame_mod) <span class="sc">|&gt;</span></span>
<span id="cb311-3"><a href="part-2-machine-learning-with-r.html#cb311-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(tame_rec)</span></code></pre></div>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="part-2-machine-learning-with-r.html#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="do">## fitting the model</span></span>
<span id="cb312-2"><a href="part-2-machine-learning-with-r.html#cb312-2" aria-hidden="true" tabindex="-1"></a>tame_fit <span class="ot">&lt;-</span> tame_workflow <span class="sc">|&gt;</span></span>
<span id="cb312-3"><a href="part-2-machine-learning-with-r.html#cb312-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> data_tame_train)</span>
<span id="cb312-4"><a href="part-2-machine-learning-with-r.html#cb312-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-5"><a href="part-2-machine-learning-with-r.html#cb312-5" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(tame_fit, data_tame_test)</span></code></pre></div>
<pre><code>## # A tibble: 36 × 1
##    .pred_class
##    &lt;fct&gt;      
##  1 PFAS       
##  2 PFAS       
##  3 PFAS       
##  4 PFAS       
##  5 PFAS       
##  6 PFAS       
##  7 PFAS       
##  8 PFAS       
##  9 PFAS       
## 10 PFAS       
## # ℹ 26 more rows</code></pre>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="part-2-machine-learning-with-r.html#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(tame_fit, data_tame_test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 36 × 2
##    .pred_PFAS .pred_Statins
##         &lt;dbl&gt;         &lt;dbl&gt;
##  1      0.998       0.002  
##  2      1           0      
##  3      0.981       0.0187 
##  4      0.997       0.00326
##  5      0.994       0.00630
##  6      1           0      
##  7      0.997       0.0026 
##  8      1           0      
##  9      0.996       0.00411
## 10      0.998       0.0024 
## # ℹ 26 more rows</code></pre>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="part-2-machine-learning-with-r.html#cb316-1" aria-hidden="true" tabindex="-1"></a><span class="do">## augment</span></span>
<span id="cb316-2"><a href="part-2-machine-learning-with-r.html#cb316-2" aria-hidden="true" tabindex="-1"></a>tame_aug <span class="ot">&lt;-</span> </span>
<span id="cb316-3"><a href="part-2-machine-learning-with-r.html#cb316-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>(tame_fit, data_tame_test, .pred_PFAS, .pred_Statins)</span>
<span id="cb316-4"><a href="part-2-machine-learning-with-r.html#cb316-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-5"><a href="part-2-machine-learning-with-r.html#cb316-5" aria-hidden="true" tabindex="-1"></a><span class="do">## The data look like: </span></span>
<span id="cb316-6"><a href="part-2-machine-learning-with-r.html#cb316-6" aria-hidden="true" tabindex="-1"></a>tame_aug <span class="sc">%&gt;%</span></span>
<span id="cb316-7"><a href="part-2-machine-learning-with-r.html#cb316-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(class, .pred_class, .pred_PFAS, .pred_Statins)</span></code></pre></div>
<pre><code>## # A tibble: 36 × 4
##    class .pred_class .pred_PFAS .pred_Statins
##    &lt;fct&gt; &lt;fct&gt;            &lt;dbl&gt;         &lt;dbl&gt;
##  1 PFAS  PFAS             0.998       0.002  
##  2 PFAS  PFAS             1           0      
##  3 PFAS  PFAS             0.981       0.0187 
##  4 PFAS  PFAS             0.997       0.00326
##  5 PFAS  PFAS             0.994       0.00630
##  6 PFAS  PFAS             1           0      
##  7 PFAS  PFAS             0.997       0.0026 
##  8 PFAS  PFAS             1           0      
##  9 PFAS  PFAS             0.996       0.00411
## 10 PFAS  PFAS             0.998       0.0024 
## # ℹ 26 more rows</code></pre>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="part-2-machine-learning-with-r.html#cb318-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Confusion table</span></span>
<span id="cb318-2"><a href="part-2-machine-learning-with-r.html#cb318-2" aria-hidden="true" tabindex="-1"></a> tame_aug <span class="sc">%&gt;%</span></span>
<span id="cb318-3"><a href="part-2-machine-learning-with-r.html#cb318-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> class, <span class="at">estimate =</span> .pred_class)</span></code></pre></div>
<pre><code>##           Truth
## Prediction PFAS Statins
##    PFAS      25       0
##    Statins    0      11</code></pre>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="part-2-machine-learning-with-r.html#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Accuracy</span></span>
<span id="cb320-2"><a href="part-2-machine-learning-with-r.html#cb320-2" aria-hidden="true" tabindex="-1"></a> <span class="co"># Model preformace metrics</span></span>
<span id="cb320-3"><a href="part-2-machine-learning-with-r.html#cb320-3" aria-hidden="true" tabindex="-1"></a>class_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(accuracy)</span>
<span id="cb320-4"><a href="part-2-machine-learning-with-r.html#cb320-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-5"><a href="part-2-machine-learning-with-r.html#cb320-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Get preformance metrics</span></span>
<span id="cb320-6"><a href="part-2-machine-learning-with-r.html#cb320-6" aria-hidden="true" tabindex="-1"></a>tame_aug <span class="sc">%&gt;%</span></span>
<span id="cb320-7"><a href="part-2-machine-learning-with-r.html#cb320-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">class_metrics</span>(<span class="at">truth =</span> class, <span class="at">estimate =</span> .pred_class)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary             1</code></pre>
</details>
</div>
</div>
<div id="feature-importance" class="section level2">
<h2>Feature importance</h2>
<p>When we use a tree based approach we can also get an idea on which features are most important in the determining the class to which an observation belongs. We will need a different model “deand engine”rpart” to get to the feature importance and the derived decision tree.</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="part-2-machine-learning-with-r.html#cb322-1" aria-hidden="true" tabindex="-1"></a>tame_importance_mod <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>() <span class="sc">|&gt;</span></span>
<span id="cb322-2"><a href="part-2-machine-learning-with-r.html#cb322-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;rpart&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb322-3"><a href="part-2-machine-learning-with-r.html#cb322-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)<span class="co"># default engine</span></span>
<span id="cb322-4"><a href="part-2-machine-learning-with-r.html#cb322-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb322-5"><a href="part-2-machine-learning-with-r.html#cb322-5" aria-hidden="true" tabindex="-1"></a>tame_rpart_wf <span class="ot">&lt;-</span> tame_workflow <span class="sc">|&gt;</span></span>
<span id="cb322-6"><a href="part-2-machine-learning-with-r.html#cb322-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(tame_importance_mod)</span>
<span id="cb322-7"><a href="part-2-machine-learning-with-r.html#cb322-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb322-8"><a href="part-2-machine-learning-with-r.html#cb322-8" aria-hidden="true" tabindex="-1"></a><span class="do">## new fit using the updated workflow</span></span>
<span id="cb322-9"><a href="part-2-machine-learning-with-r.html#cb322-9" aria-hidden="true" tabindex="-1"></a>tame_importance_fit <span class="ot">&lt;-</span> tame_rpart_wf <span class="sc">|&gt;</span></span>
<span id="cb322-10"><a href="part-2-machine-learning-with-r.html#cb322-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> data_tame_train)</span>
<span id="cb322-11"><a href="part-2-machine-learning-with-r.html#cb322-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb322-12"><a href="part-2-machine-learning-with-r.html#cb322-12" aria-hidden="true" tabindex="-1"></a><span class="do">## decision tree</span></span>
<span id="cb322-13"><a href="part-2-machine-learning-with-r.html#cb322-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span></code></pre></div>
<pre><code>## Loading required package: rpart</code></pre>
<pre><code>## 
## Attaching package: &#39;rpart&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dials&#39;:
## 
##     prune</code></pre>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="part-2-machine-learning-with-r.html#cb326-1" aria-hidden="true" tabindex="-1"></a>tame_importance_fit <span class="sc">%&gt;%</span></span>
<span id="cb326-2"><a href="part-2-machine-learning-with-r.html#cb326-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>() <span class="sc">%&gt;%</span></span>
<span id="cb326-3"><a href="part-2-machine-learning-with-r.html#cb326-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart.plot</span>(<span class="at">roundint =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
</div>
<div id="case-study-qsar-data" class="section level2">
<h2>Case study; QSAR data</h2>
<p>To look at a more realistic case example, that is not so clear cut as the previous (educational) exercise. Let’s look at a dataset containing data suitable for Quantitative Structure Activity Relationships (QSAR).
We downloaded the data in a code chunk above as “qsar_oral_toxicity.csv”. The data should be available in a temporary directory on your machine. To see the contents of this directory type</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="part-2-machine-learning-with-r.html#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">&quot;data&quot;</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">pattern =</span> <span class="st">&quot;.csv&quot;</span>)</span></code></pre></div>
<pre><code>## character(0)</code></pre>
<div id="exercise-2" class="section level5 unnumbered question">
<h5>Exercise 2</h5>
<ol style="list-style-type: decimal">
<li>Inspect the file <code>qsar_oral_toxicity.csv</code>, using the <code>head</code> command in the terminal, or on Windows: open the file with Notepad. Are there headers in this file?</li>
<li>Read the file into R, using the <code>read_csv()</code> funtion</li>
<li>Rename the columns with a string from “f1” to “f1025”</li>
<li>Reorder the classification column (“f1025”) to be the first column, and rename this column to <code>class</code></li>
<li>Look at the dataset</li>
<li>Tally the classification column, how many observations of each class do we have? Does this correspond with the meta data on UCL? Do you see a potential problem?</li>
<li>Isolate the classification column in a new R object</li>
<li>Remove the row with classifications (“f1025”) from the data and store the resulting new dataframe as a matrix, using the <code>as.matrix()</code> function.</li>
</ol>
</div>
<details>
<summary>
Click for the answer
</summary>
<p>Reading the data into R. This file has no headers. The last column in the data contains the labels. We will move that column to the first position.</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="part-2-machine-learning-with-r.html#cb329-1" aria-hidden="true" tabindex="-1"></a>data_qsar <span class="ot">&lt;-</span> <span class="fu">read_csv2</span>(</span>
<span id="cb329-2"><a href="part-2-machine-learning-with-r.html#cb329-2" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb329-3"><a href="part-2-machine-learning-with-r.html#cb329-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data-raw&quot;</span>,</span>
<span id="cb329-4"><a href="part-2-machine-learning-with-r.html#cb329-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;qsar_oral_toxicity.csv&quot;</span>),</span>
<span id="cb329-5"><a href="part-2-machine-learning-with-r.html#cb329-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb329-6"><a href="part-2-machine-learning-with-r.html#cb329-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>()</span></code></pre></div>
<pre><code>## ℹ Using &quot;&#39;,&#39;&quot; as decimal and &quot;&#39;.&#39;&quot; as grouping mark. Use `read_delim()` for more control.</code></pre>
<pre><code>## Rows: 8992 Columns: 1025
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;;&quot;
## chr    (1): X1025
## dbl (1024): X1, X2, X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15...
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="part-2-machine-learning-with-r.html#cb332-1" aria-hidden="true" tabindex="-1"></a><span class="co"># answer</span></span>
<span id="cb332-2"><a href="part-2-machine-learning-with-r.html#cb332-2" aria-hidden="true" tabindex="-1"></a>names_new <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;f&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">1025</span>)</span>
<span id="cb332-3"><a href="part-2-machine-learning-with-r.html#cb332-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data_qsar) <span class="ot">&lt;-</span> names_new</span>
<span id="cb332-4"><a href="part-2-machine-learning-with-r.html#cb332-4" aria-hidden="true" tabindex="-1"></a>data_qsar <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb332-5"><a href="part-2-machine-learning-with-r.html#cb332-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(f1025, <span class="at">.before =</span> f1) <span class="sc">|&gt;</span></span>
<span id="cb332-6"><a href="part-2-machine-learning-with-r.html#cb332-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">class =</span> f1025)</span>
<span id="cb332-7"><a href="part-2-machine-learning-with-r.html#cb332-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-8"><a href="part-2-machine-learning-with-r.html#cb332-8" aria-hidden="true" tabindex="-1"></a>data_qsar <span class="sc">|&gt;</span> </span>
<span id="cb332-9"><a href="part-2-machine-learning-with-r.html#cb332-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(class) <span class="sc">|&gt;</span></span>
<span id="cb332-10"><a href="part-2-machine-learning-with-r.html#cb332-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   class        n
##   &lt;chr&gt;    &lt;int&gt;
## 1 negative  8251
## 2 positive   741</code></pre>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="part-2-machine-learning-with-r.html#cb334-1" aria-hidden="true" tabindex="-1"></a>classes <span class="ot">&lt;-</span> data_qsar<span class="sc">$</span>class</span>
<span id="cb334-2"><a href="part-2-machine-learning-with-r.html#cb334-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-3"><a href="part-2-machine-learning-with-r.html#cb334-3" aria-hidden="true" tabindex="-1"></a><span class="co">#data_qsar_all_numm &lt;- data_qsar |&gt;</span></span>
<span id="cb334-4"><a href="part-2-machine-learning-with-r.html#cb334-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  select(-class)</span></span>
<span id="cb334-5"><a href="part-2-machine-learning-with-r.html#cb334-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-6"><a href="part-2-machine-learning-with-r.html#cb334-6" aria-hidden="true" tabindex="-1"></a><span class="do">## look at the data</span></span>
<span id="cb334-7"><a href="part-2-machine-learning-with-r.html#cb334-7" aria-hidden="true" tabindex="-1"></a>data_qsar</span></code></pre></div>
<pre><code>## # A tibble: 8,992 × 1,025
##    class    f1    f2    f3    f4    f5    f6    f7    f8    f9   f10   f11   f12
##    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 nega…     0     0     0     0     0     0     0     0     0     0     1     0
##  2 nega…     0     0     1     0     0     0     0     0     0     0     1     0
##  3 nega…     0     0     0     0     0     0     0     0     0     0     1     0
##  4 nega…     0     0     0     0     0     0     0     1     0     0     1     0
##  5 nega…     0     0     0     0     0     0     0     0     0     0     0     0
##  6 nega…     1     0     0     0     0     0     1     0     0     0     0     0
##  7 nega…     0     0     0     0     0     0     0     0     0     0     1     0
##  8 posi…     0     0     1     0     0     0     0     0     0     0     0     0
##  9 nega…     0     0     0     0     0     0     0     0     0     0     0     0
## 10 nega…     0     0     0     0     0     0     0     0     0     0     0     0
## # ℹ 8,982 more rows
## # ℹ 1,012 more variables: f13 &lt;dbl&gt;, f14 &lt;dbl&gt;, f15 &lt;dbl&gt;, f16 &lt;dbl&gt;,
## #   f17 &lt;dbl&gt;, f18 &lt;dbl&gt;, f19 &lt;dbl&gt;, f20 &lt;dbl&gt;, f21 &lt;dbl&gt;, f22 &lt;dbl&gt;,
## #   f23 &lt;dbl&gt;, f24 &lt;dbl&gt;, f25 &lt;dbl&gt;, f26 &lt;dbl&gt;, f27 &lt;dbl&gt;, f28 &lt;dbl&gt;,
## #   f29 &lt;dbl&gt;, f30 &lt;dbl&gt;, f31 &lt;dbl&gt;, f32 &lt;dbl&gt;, f33 &lt;dbl&gt;, f34 &lt;dbl&gt;,
## #   f35 &lt;dbl&gt;, f36 &lt;dbl&gt;, f37 &lt;dbl&gt;, f38 &lt;dbl&gt;, f39 &lt;dbl&gt;, f40 &lt;dbl&gt;,
## #   f41 &lt;dbl&gt;, f42 &lt;dbl&gt;, f43 &lt;dbl&gt;, f44 &lt;dbl&gt;, f45 &lt;dbl&gt;, f46 &lt;dbl&gt;, …</code></pre>
</details>
<div class="question">
<div id="exercise-exploratory-data-analysis-2" class="section level5 unnumbered">
<h5>Exercise Exploratory Data Analysis 2</h5>
<ul>
<li>Use visualizations and transformations to explore your data in a systematic way</li>
<li>A task that statisticians call exploratory data analysis, or EDA for short.</li>
</ul>
</div>
<div id="eda-is-an-iterative-cycle-you" class="section level2">
<h2>EDA is an iterative cycle; you:</h2>
<ol style="list-style-type: decimal">
<li>Generate questions about your data.</li>
<li>Search for answers by visualising, transforming, and modelling your data.</li>
<li>Use what you learn to refine your questions and/or generate new questions.</li>
</ol>
<p><strong>You do not need to know statistics for EDA, but it helps if you do!</strong></p>
</div>
<div id="eda-is-not-a-formal-process-with-a-strict-set-of-rules" class="section level2">
<h2>EDA is not a formal process with a strict set of rules</h2>
<ul>
<li>EDA is a state of mind.</li>
<li>Should feel free to investigate every idea that occurs to you.</li>
<li>Some of these ideas will pan out, and some will be dead ends.</li>
<li>As your exploration continues, you will zoom in on a few particularly productive areas that you’ll eventually write up and communicate to others.</li>
</ul>
</div>
<div id="eda-steps" class="section level2">
<h2>EDA Steps</h2>
<p>To do data analysis, you’ll need to deploy all the tools of EDA: visualisation, transformation, and modelling.</p>
<p>When perfoming EDA consider</p>
<ol style="list-style-type: decimal">
<li>What question(s) are you trying to solve (or prove wrong)?</li>
<li>Which information do you need and can you come up with a plan to answer the question(s)</li>
<li>What kind of data do you have and how do you treat different types?</li>
<li>What’s missing from the data and how do you deal with it?</li>
<li>Where are the outliers and why should you care about them?</li>
<li>How can you add, change or remove features to get more out of your data?</li>
<li>Do you need additional data from other sources to relate to the dataset under scrutany?</li>
<li>Are underlying statitical assumptions met / how is data distribution looking?</li>
<li>What (exploratory) models apply or fit well to the data?</li>
<li>What is the undelying (experimental) design?</li>
<li>Is there multi-colinearity?</li>
</ol>
</div>
<div id="definitions" class="section level2">
<h2>Definitions</h2>
<ul>
<li>A <strong>variable</strong> is a quantity, quality, or property that you can measure.</li>
<li>A <strong>value</strong> is the state of a variable when you measure it. The value of a variable may change from measurement to measurement.</li>
<li>An <strong>observation</strong> is a set of measurements made under similar conditions. An observation will contain several values, each associated with a different variable. I’ll sometimes refer to an observation as a data point.</li>
<li>Tables: <strong>Tabular data</strong> is a set of values, each associated with a variable and an observation.</li>
<li>Tabular data is <em>tidy</em> if each value is placed in its own “cell”, each variable in its own column, and each observation in its own row.</li>
<li>In real-life, most data isn’t tidy, as we’ve seen in <strong>tidy data</strong>.</li>
</ul>
</div>
<div id="variation" class="section level2">
<h2>Variation</h2>
<p><strong>Variation</strong> is the tendency of the values of a variable to change from measurement to measurement.</p>
<ul>
<li><p>Categorical variables can also vary if you measure across different subjects (e.g. the eye colors of different people), or different times (e.g. the energy levels of an electron at different moments).</p></li>
<li><p>Every variable has its own pattern of variation, which can reveal interesting information. The best way to understand that pattern is to visualise the distribution of the variable’s values.</p></li>
</ul>
<div id="categorical-variables" class="section level3">
<h3>Categorical variables</h3>
<ul>
<li>A variable is <strong>categorical</strong> if it can only take one of a small set of values.<br />
</li>
<li>In R, categorical variables are usually saved as factors or character vectors.</li>
<li>To examine the distribution of a categorical variable, use a bar chart:</li>
</ul>
</div>
</div>
<div id="missing-values-1" class="section level2">
<h2>Missing values</h2>
<p>In a dataset such as this, I do not expect to encouter any missing values. The fingerprints are calculated from molecules, so it would not make sense to have missing values somewhere. But just to be sure, we can get the sum of missing values like this:</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="part-2-machine-learning-with-r.html#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_qsar))</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>One less thing to worry about.</p>
</div>
<div id="distributions" class="section level2">
<h2>Distributions</h2>
<p>Here we have a distribution of either value <code>0</code> or <code>1</code> in the data. Let’s check if on average the amount of <code>1</code>s is the same for positive and negative compounds. We will convert the dataframe to a long format to do more easy calculations and plotting with <code>{ggplot2}</code></p>
<p>Calculate first how many times a certain feature is present in the data.</p>
<details>
<summary>
Click for the answer
</summary>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="part-2-machine-learning-with-r.html#cb338-1" aria-hidden="true" tabindex="-1"></a>data_qsar_mtx <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb338-2"><a href="part-2-machine-learning-with-r.html#cb338-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb338-3"><a href="part-2-machine-learning-with-r.html#cb338-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb338-4"><a href="part-2-machine-learning-with-r.html#cb338-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-5"><a href="part-2-machine-learning-with-r.html#cb338-5" aria-hidden="true" tabindex="-1"></a>features <span class="ot">&lt;-</span> <span class="fu">colSums</span>(data_qsar_mtx) <span class="sc">|&gt;</span> </span>
<span id="cb338-6"><a href="part-2-machine-learning-with-r.html#cb338-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>()</span>
<span id="cb338-7"><a href="part-2-machine-learning-with-r.html#cb338-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-8"><a href="part-2-machine-learning-with-r.html#cb338-8" aria-hidden="true" tabindex="-1"></a>features <span class="sc">|&gt;</span></span>
<span id="cb338-9"><a href="part-2-machine-learning-with-r.html#cb338-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb338-10"><a href="part-2-machine-learning-with-r.html#cb338-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="002_tidymodels_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>So there are many featurs that are represented in the data at low frequencies and very few features that are respresented in the data very often.</p>
</details>
How do these distributions look if we split for negative and positive compounds
<details>
<summary>
Click for the answer
</summary>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb340-1"><a href="part-2-machine-learning-with-r.html#cb340-1" aria-hidden="true" tabindex="-1"></a>features_negative <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb340-2"><a href="part-2-machine-learning-with-r.html#cb340-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(class <span class="sc">==</span> <span class="st">&quot;negative&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb340-3"><a href="part-2-machine-learning-with-r.html#cb340-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb340-4"><a href="part-2-machine-learning-with-r.html#cb340-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span></span>
<span id="cb340-5"><a href="part-2-machine-learning-with-r.html#cb340-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colSums</span>() <span class="sc">|&gt;</span></span>
<span id="cb340-6"><a href="part-2-machine-learning-with-r.html#cb340-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb340-7"><a href="part-2-machine-learning-with-r.html#cb340-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">distro =</span> <span class="st">&quot;negative&quot;</span>)</span>
<span id="cb340-8"><a href="part-2-machine-learning-with-r.html#cb340-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-9"><a href="part-2-machine-learning-with-r.html#cb340-9" aria-hidden="true" tabindex="-1"></a>features_positive <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb340-10"><a href="part-2-machine-learning-with-r.html#cb340-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(class <span class="sc">==</span> <span class="st">&quot;positive&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb340-11"><a href="part-2-machine-learning-with-r.html#cb340-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb340-12"><a href="part-2-machine-learning-with-r.html#cb340-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span></span>
<span id="cb340-13"><a href="part-2-machine-learning-with-r.html#cb340-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colSums</span>() <span class="sc">|&gt;</span></span>
<span id="cb340-14"><a href="part-2-machine-learning-with-r.html#cb340-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb340-15"><a href="part-2-machine-learning-with-r.html#cb340-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">distro =</span> <span class="st">&quot;positive&quot;</span>)</span>
<span id="cb340-16"><a href="part-2-machine-learning-with-r.html#cb340-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-17"><a href="part-2-machine-learning-with-r.html#cb340-17" aria-hidden="true" tabindex="-1"></a>features_neg_pos <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb340-18"><a href="part-2-machine-learning-with-r.html#cb340-18" aria-hidden="true" tabindex="-1"></a>  features_negative,</span>
<span id="cb340-19"><a href="part-2-machine-learning-with-r.html#cb340-19" aria-hidden="true" tabindex="-1"></a>  features_positive</span>
<span id="cb340-20"><a href="part-2-machine-learning-with-r.html#cb340-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb340-21"><a href="part-2-machine-learning-with-r.html#cb340-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-22"><a href="part-2-machine-learning-with-r.html#cb340-22" aria-hidden="true" tabindex="-1"></a>features_neg_pos <span class="sc">|&gt;</span></span>
<span id="cb340-23"><a href="part-2-machine-learning-with-r.html#cb340-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb340-24"><a href="part-2-machine-learning-with-r.html#cb340-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_freqpoly</span>(<span class="fu">aes</span>(<span class="at">colour =</span> distro), <span class="at">alpha =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<img src="002_tidymodels_files/figure-html/unnamed-chunk-18-1.png" width="672" />
</details>
</div>
</div>
<div id="exercise-2-1" class="section level5 unnumbered question">
<h5>Exercise 2</h5>
<p>Are there differences in total amount of features between positive and negative compounds?</p>
<p>Be aware, that we have more negtives then positives in our data. Can you think of a way to normalize for this?</p>
<p><strong>TIPS</strong></p>
<ul>
<li>Create a frequency distribution of all features and group by compound class (negatives/positives)</li>
<li>Remember that <code>{ggplot2}</code> works best with long dataframe format</li>
<li>The <code>{ggplot2}</code> geom for frequency distribution is <code>geom_freqpoly()</code></li>
</ul>
</div>
<details>
<summary>
Click for the answer
</summary>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb342-1"><a href="part-2-machine-learning-with-r.html#cb342-1" aria-hidden="true" tabindex="-1"></a>data_qsar <span class="sc">|&gt;</span></span>
<span id="cb342-2"><a href="part-2-machine-learning-with-r.html#cb342-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(class) <span class="sc">|&gt;</span></span>
<span id="cb342-3"><a href="part-2-machine-learning-with-r.html#cb342-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>() <span class="ot">-&gt;</span> tally_compounds</span>
<span id="cb342-4"><a href="part-2-machine-learning-with-r.html#cb342-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb342-5"><a href="part-2-machine-learning-with-r.html#cb342-5" aria-hidden="true" tabindex="-1"></a>features_row_neg <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb342-6"><a href="part-2-machine-learning-with-r.html#cb342-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(class <span class="sc">==</span> <span class="st">&quot;negative&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb342-7"><a href="part-2-machine-learning-with-r.html#cb342-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb342-8"><a href="part-2-machine-learning-with-r.html#cb342-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span></span>
<span id="cb342-9"><a href="part-2-machine-learning-with-r.html#cb342-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowSums</span>() <span class="sc">|&gt;</span></span>
<span id="cb342-10"><a href="part-2-machine-learning-with-r.html#cb342-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb342-11"><a href="part-2-machine-learning-with-r.html#cb342-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">distro =</span> <span class="st">&quot;negative&quot;</span>)</span>
<span id="cb342-12"><a href="part-2-machine-learning-with-r.html#cb342-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb342-13"><a href="part-2-machine-learning-with-r.html#cb342-13" aria-hidden="true" tabindex="-1"></a>features_row_pos <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb342-14"><a href="part-2-machine-learning-with-r.html#cb342-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(class <span class="sc">==</span> <span class="st">&quot;positive&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb342-15"><a href="part-2-machine-learning-with-r.html#cb342-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb342-16"><a href="part-2-machine-learning-with-r.html#cb342-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span></span>
<span id="cb342-17"><a href="part-2-machine-learning-with-r.html#cb342-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowSums</span>() <span class="sc">|&gt;</span></span>
<span id="cb342-18"><a href="part-2-machine-learning-with-r.html#cb342-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb342-19"><a href="part-2-machine-learning-with-r.html#cb342-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">distro =</span> <span class="st">&quot;positive&quot;</span>)</span>
<span id="cb342-20"><a href="part-2-machine-learning-with-r.html#cb342-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb342-21"><a href="part-2-machine-learning-with-r.html#cb342-21" aria-hidden="true" tabindex="-1"></a>features_row_neg_pos <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb342-22"><a href="part-2-machine-learning-with-r.html#cb342-22" aria-hidden="true" tabindex="-1"></a>  features_row_neg,</span>
<span id="cb342-23"><a href="part-2-machine-learning-with-r.html#cb342-23" aria-hidden="true" tabindex="-1"></a>  features_row_pos</span>
<span id="cb342-24"><a href="part-2-machine-learning-with-r.html#cb342-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb342-25"><a href="part-2-machine-learning-with-r.html#cb342-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb342-26"><a href="part-2-machine-learning-with-r.html#cb342-26" aria-hidden="true" tabindex="-1"></a>features_row_neg_pos <span class="sc">|&gt;</span></span>
<span id="cb342-27"><a href="part-2-machine-learning-with-r.html#cb342-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb342-28"><a href="part-2-machine-learning-with-r.html#cb342-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_freqpoly</span>(<span class="fu">aes</span>(<span class="at">colour =</span> distro), <span class="at">alpha =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="002_tidymodels_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb344-1"><a href="part-2-machine-learning-with-r.html#cb344-1" aria-hidden="true" tabindex="-1"></a>features_row_neg_pos <span class="sc">|&gt;</span></span>
<span id="cb344-2"><a href="part-2-machine-learning-with-r.html#cb344-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(distro) <span class="sc">|&gt;</span></span>
<span id="cb344-3"><a href="part-2-machine-learning-with-r.html#cb344-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_feat =</span> <span class="fu">mean</span>(value))</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   distro   mean_feat
##   &lt;chr&gt;        &lt;dbl&gt;
## 1 negative      95.6
## 2 positive      91.4</code></pre>
<p>On average, there is not much difference in number of features per compound, if we compare negatives and positives</p>
</details>
</div>
<div id="sparsity" class="section level2">
<h2>Sparsity</h2>
<p>As we saw upon first inspection of the data, the fingerprints contain only 2 values: a <code>1</code> and a <code>0</code>. One of the disadvantages of describing molecules on the basis of fingerprints is that the resulting matrix is <em>sparse</em>. This means that there is a relatively low amount of information content (many zeros and a few ones) in the data. Let’s calculate how sparse the matrix is. We will write a function that we can recycle.</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="part-2-machine-learning-with-r.html#cb346-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> data_qsar</span>
<span id="cb346-2"><a href="part-2-machine-learning-with-r.html#cb346-2" aria-hidden="true" tabindex="-1"></a>only_numeric <span class="ot">&lt;-</span> <span class="fu">select_if</span>(df, is.numeric)</span>
<span id="cb346-3"><a href="part-2-machine-learning-with-r.html#cb346-3" aria-hidden="true" tabindex="-1"></a>number_numeric_cells <span class="ot">&lt;-</span> (<span class="fu">nrow</span>(df) <span class="sc">*</span> <span class="fu">ncol</span>(df))</span>
<span id="cb346-4"><a href="part-2-machine-learning-with-r.html#cb346-4" aria-hidden="true" tabindex="-1"></a>number_zeros <span class="ot">&lt;-</span> <span class="fu">sum</span>(df <span class="sc">==</span> <span class="dv">0</span>) </span>
<span id="cb346-5"><a href="part-2-machine-learning-with-r.html#cb346-5" aria-hidden="true" tabindex="-1"></a>number_ones <span class="ot">&lt;-</span> <span class="fu">sum</span>(df <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb346-6"><a href="part-2-machine-learning-with-r.html#cb346-6" aria-hidden="true" tabindex="-1"></a>sparsity <span class="ot">=</span> (number_ones <span class="sc">/</span> number_zeros)<span class="sc">*</span><span class="dv">100</span></span>
<span id="cb346-7"><a href="part-2-machine-learning-with-r.html#cb346-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-8"><a href="part-2-machine-learning-with-r.html#cb346-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Let&#39;s put this together in a function, we write a test to check for input</span></span>
<span id="cb346-9"><a href="part-2-machine-learning-with-r.html#cb346-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-10"><a href="part-2-machine-learning-with-r.html#cb346-10" aria-hidden="true" tabindex="-1"></a>get_sparsity_perc <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb346-11"><a href="part-2-machine-learning-with-r.html#cb346-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb346-12"><a href="part-2-machine-learning-with-r.html#cb346-12" aria-hidden="true" tabindex="-1"></a>  only_numeric <span class="ot">&lt;-</span> <span class="fu">select_if</span>(df, is.numeric)</span>
<span id="cb346-13"><a href="part-2-machine-learning-with-r.html#cb346-13" aria-hidden="true" tabindex="-1"></a>  only_numeric_mtx <span class="ot">&lt;-</span> only_numeric <span class="sc">|&gt;</span> <span class="fu">as.matrix</span>()</span>
<span id="cb346-14"><a href="part-2-machine-learning-with-r.html#cb346-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb346-15"><a href="part-2-machine-learning-with-r.html#cb346-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">## check if values of matrix are either 0 or 1</span></span>
<span id="cb346-16"><a href="part-2-machine-learning-with-r.html#cb346-16" aria-hidden="true" tabindex="-1"></a>  <span class="do">## %in% is functional for `match`</span></span>
<span id="cb346-17"><a href="part-2-machine-learning-with-r.html#cb346-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb346-18"><a href="part-2-machine-learning-with-r.html#cb346-18" aria-hidden="true" tabindex="-1"></a>      only_numeric_mtx <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb346-19"><a href="part-2-machine-learning-with-r.html#cb346-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all</span>() <span class="sc">==</span> <span class="cn">FALSE</span>){</span>
<span id="cb346-20"><a href="part-2-machine-learning-with-r.html#cb346-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Please check if input values are either ones               and/or zeros&quot;</span>)</span>
<span id="cb346-21"><a href="part-2-machine-learning-with-r.html#cb346-21" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb346-22"><a href="part-2-machine-learning-with-r.html#cb346-22" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb346-23"><a href="part-2-machine-learning-with-r.html#cb346-23" aria-hidden="true" tabindex="-1"></a>  number_numeric_cells <span class="ot">&lt;-</span> (<span class="fu">nrow</span>(df) <span class="sc">*</span> <span class="fu">ncol</span>(df))</span>
<span id="cb346-24"><a href="part-2-machine-learning-with-r.html#cb346-24" aria-hidden="true" tabindex="-1"></a>  number_zeros <span class="ot">&lt;-</span> <span class="fu">sum</span>(df <span class="sc">==</span> <span class="dv">0</span>) </span>
<span id="cb346-25"><a href="part-2-machine-learning-with-r.html#cb346-25" aria-hidden="true" tabindex="-1"></a>  number_ones <span class="ot">&lt;-</span> <span class="fu">sum</span>(df <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb346-26"><a href="part-2-machine-learning-with-r.html#cb346-26" aria-hidden="true" tabindex="-1"></a>  sparsity <span class="ot">=</span> (number_ones <span class="sc">/</span> number_zeros)<span class="sc">*</span><span class="dv">100</span></span>
<span id="cb346-27"><a href="part-2-machine-learning-with-r.html#cb346-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sparsity)</span>
<span id="cb346-28"><a href="part-2-machine-learning-with-r.html#cb346-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-29"><a href="part-2-machine-learning-with-r.html#cb346-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb346-30"><a href="part-2-machine-learning-with-r.html#cb346-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb346-31"><a href="part-2-machine-learning-with-r.html#cb346-31" aria-hidden="true" tabindex="-1"></a><span class="do">## test function</span></span>
<span id="cb346-32"><a href="part-2-machine-learning-with-r.html#cb346-32" aria-hidden="true" tabindex="-1"></a><span class="fu">get_sparsity_perc</span>(<span class="at">df =</span> data_qsar)</span>
<span id="cb346-33"><a href="part-2-machine-learning-with-r.html#cb346-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-34"><a href="part-2-machine-learning-with-r.html#cb346-34" aria-hidden="true" tabindex="-1"></a><span class="do">## check our test</span></span>
<span id="cb346-35"><a href="part-2-machine-learning-with-r.html#cb346-35" aria-hidden="true" tabindex="-1"></a>data_qsar_with_mutation <span class="ot">&lt;-</span> data_qsar</span>
<span id="cb346-36"><a href="part-2-machine-learning-with-r.html#cb346-36" aria-hidden="true" tabindex="-1"></a>data_qsar_with_mutation[<span class="dv">333</span>,<span class="dv">445</span>] <span class="ot">&lt;-</span> <span class="fl">9.887</span></span>
<span id="cb346-37"><a href="part-2-machine-learning-with-r.html#cb346-37" aria-hidden="true" tabindex="-1"></a><span class="fu">get_sparsity_perc</span>(data_qsar_with_mutation)</span>
<span id="cb346-38"><a href="part-2-machine-learning-with-r.html#cb346-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-39"><a href="part-2-machine-learning-with-r.html#cb346-39" aria-hidden="true" tabindex="-1"></a><span class="do">## getting unique values</span></span>
<span id="cb346-40"><a href="part-2-machine-learning-with-r.html#cb346-40" aria-hidden="true" tabindex="-1"></a><span class="fu">select_if</span>(data_qsar, is.numeric) <span class="sc">|&gt;</span></span>
<span id="cb346-41"><a href="part-2-machine-learning-with-r.html#cb346-41" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(unique) <span class="sc">|&gt;</span></span>
<span id="cb346-42"><a href="part-2-machine-learning-with-r.html#cb346-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span> </span>
<span id="cb346-43"><a href="part-2-machine-learning-with-r.html#cb346-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flatten</span>() <span class="sc">|&gt;</span> </span>
<span id="cb346-44"><a href="part-2-machine-learning-with-r.html#cb346-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb346-45"><a href="part-2-machine-learning-with-r.html#cb346-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-46"><a href="part-2-machine-learning-with-r.html#cb346-46" aria-hidden="true" tabindex="-1"></a><span class="fu">select_if</span>(data_qsar_with_mutation, is.numeric) <span class="sc">|&gt;</span></span>
<span id="cb346-47"><a href="part-2-machine-learning-with-r.html#cb346-47" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(unique) <span class="sc">|&gt;</span>  <span class="fu">unique</span>() <span class="sc">|&gt;</span> </span>
<span id="cb346-48"><a href="part-2-machine-learning-with-r.html#cb346-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flatten</span>() <span class="sc">|&gt;</span> </span>
<span id="cb346-49"><a href="part-2-machine-learning-with-r.html#cb346-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span></code></pre></div>
<div id="heatmap" class="section level3">
<h3>Heatmap</h3>
<p>Let’s look at the fingerprints and see how they differ between negatives and positives. Maybe we can learn something there. Because we have many features and observations, we will take a random sample, to reduce computation time.</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb347-1"><a href="part-2-machine-learning-with-r.html#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb347-2"><a href="part-2-machine-learning-with-r.html#cb347-2" aria-hidden="true" tabindex="-1"></a>data_qsar_sample <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb347-3"><a href="part-2-machine-learning-with-r.html#cb347-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data_qsar)) <span class="sc">|&gt;</span></span>
<span id="cb347-4"><a href="part-2-machine-learning-with-r.html#cb347-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_frac</span>(<span class="fl">0.005</span>)</span>
<span id="cb347-5"><a href="part-2-machine-learning-with-r.html#cb347-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-6"><a href="part-2-machine-learning-with-r.html#cb347-6" aria-hidden="true" tabindex="-1"></a>data_qsar_mtx_sample <span class="ot">&lt;-</span> data_qsar_sample <span class="sc">|&gt;</span></span>
<span id="cb347-7"><a href="part-2-machine-learning-with-r.html#cb347-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class) <span class="sc">|&gt;</span></span>
<span id="cb347-8"><a href="part-2-machine-learning-with-r.html#cb347-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() </span>
<span id="cb347-9"><a href="part-2-machine-learning-with-r.html#cb347-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-10"><a href="part-2-machine-learning-with-r.html#cb347-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_qsar_mtx_sample) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb347-11"><a href="part-2-machine-learning-with-r.html#cb347-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;c&quot;</span>, </span>
<span id="cb347-12"><a href="part-2-machine-learning-with-r.html#cb347-12" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(data_qsar_mtx_sample)</span>
<span id="cb347-13"><a href="part-2-machine-learning-with-r.html#cb347-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb347-14"><a href="part-2-machine-learning-with-r.html#cb347-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-15"><a href="part-2-machine-learning-with-r.html#cb347-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-16"><a href="part-2-machine-learning-with-r.html#cb347-16" aria-hidden="true" tabindex="-1"></a>data_qsar_sample <span class="sc">|&gt;</span> </span>
<span id="cb347-17"><a href="part-2-machine-learning-with-r.html#cb347-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> f1<span class="sc">:</span>f1024, <span class="at">values_to =</span> <span class="st">&quot;score&quot;</span>, <span class="at">names_to =</span> <span class="st">&quot;feature&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb347-18"><a href="part-2-machine-learning-with-r.html#cb347-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb347-19"><a href="part-2-machine-learning-with-r.html#cb347-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">reorder</span>(<span class="fu">as_factor</span>(feature), score), </span>
<span id="cb347-20"><a href="part-2-machine-learning-with-r.html#cb347-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">as_factor</span>(score))) <span class="sc">+</span></span>
<span id="cb347-21"><a href="part-2-machine-learning-with-r.html#cb347-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">as_factor</span>(score))) <span class="sc">+</span> <span class="fu">facet_wrap</span>(class<span class="sc">~</span>row_id) <span class="sc">+</span></span>
<span id="cb347-22"><a href="part-2-machine-learning-with-r.html#cb347-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb347-23"><a href="part-2-machine-learning-with-r.html#cb347-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb347-24"><a href="part-2-machine-learning-with-r.html#cb347-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb347-25"><a href="part-2-machine-learning-with-r.html#cb347-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb347-26"><a href="part-2-machine-learning-with-r.html#cb347-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb347-27"><a href="part-2-machine-learning-with-r.html#cb347-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">4</span>))</span>
<span id="cb347-28"><a href="part-2-machine-learning-with-r.html#cb347-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb347-29"><a href="part-2-machine-learning-with-r.html#cb347-29" aria-hidden="true" tabindex="-1"></a><span class="do">## to save the graph in a readible size and format</span></span>
<span id="cb347-30"><a href="part-2-machine-learning-with-r.html#cb347-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave(&quot;test.png&quot;, height = 20, width = 20, units = &quot;cm&quot;, dpi = 300)</span></span>
<span id="cb347-31"><a href="part-2-machine-learning-with-r.html#cb347-31" aria-hidden="true" tabindex="-1"></a><span class="do">## or if you want to have a vectorgraph</span></span>
<span id="cb347-32"><a href="part-2-machine-learning-with-r.html#cb347-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave(&quot;test.png&quot;, height = 20, width = 20, units = &quot;cm&quot;, dpi = 300)</span></span></code></pre></div>
</div>
</div>
<div id="unsupervised-machine-learning" class="section level2">
<h2>Unsupervised machine learning</h2>
<p>Before we plan to do any kind of classification task on our data, it is good to consider doing an exploratory data analysis to learn more about our data.
Here we use a principal component analysis and a k-means clustering to learn some patterns.</p>
</div>
<div id="principal-component-analysis" class="section level2">
<h2>Principal Component Analysis</h2>
<p>For code see: <a href="https://cmdlinetips.com/2020/06/pca-with-tidymodels-in-r/" class="uri">https://cmdlinetips.com/2020/06/pca-with-tidymodels-in-r/</a></p>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="part-2-machine-learning-with-r.html#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb348-2"><a href="part-2-machine-learning-with-r.html#cb348-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb348-3"><a href="part-2-machine-learning-with-r.html#cb348-3" aria-hidden="true" tabindex="-1"></a><span class="co">#library(gapminder)</span></span>
<span id="cb348-4"><a href="part-2-machine-learning-with-r.html#cb348-4" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>(<span class="dv">16</span>))</span></code></pre></div>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb349-1"><a href="part-2-machine-learning-with-r.html#cb349-1" aria-hidden="true" tabindex="-1"></a>pca_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_qsar)</span>
<span id="cb349-2"><a href="part-2-machine-learning-with-r.html#cb349-2" aria-hidden="true" tabindex="-1"></a>pca_trans <span class="ot">&lt;-</span> pca_recipe <span class="sc">%&gt;%</span></span>
<span id="cb349-3"><a href="part-2-machine-learning-with-r.html#cb349-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># center the data</span></span>
<span id="cb349-4"><a href="part-2-machine-learning-with-r.html#cb349-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb349-5"><a href="part-2-machine-learning-with-r.html#cb349-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># center the data</span></span>
<span id="cb349-6"><a href="part-2-machine-learning-with-r.html#cb349-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb349-7"><a href="part-2-machine-learning-with-r.html#cb349-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pca on all numeric variables</span></span>
<span id="cb349-8"><a href="part-2-machine-learning-with-r.html#cb349-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">all_numeric</span>())</span>
<span id="cb349-9"><a href="part-2-machine-learning-with-r.html#cb349-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-10"><a href="part-2-machine-learning-with-r.html#cb349-10" aria-hidden="true" tabindex="-1"></a>pca_estimates <span class="ot">&lt;-</span> <span class="fu">prep</span>(pca_trans) <span class="do">## this step takes a bit longer to calculate</span></span>
<span id="cb349-11"><a href="part-2-machine-learning-with-r.html#cb349-11" aria-hidden="true" tabindex="-1"></a>pca_estimates<span class="sc">$</span>var_info</span>
<span id="cb349-12"><a href="part-2-machine-learning-with-r.html#cb349-12" aria-hidden="true" tabindex="-1"></a>sdev <span class="ot">&lt;-</span> pca_estimates<span class="sc">$</span>steps[[<span class="dv">3</span>]]<span class="sc">$</span>res<span class="sc">$</span>sdev</span>
<span id="cb349-13"><a href="part-2-machine-learning-with-r.html#cb349-13" aria-hidden="true" tabindex="-1"></a>percent_variation <span class="ot">&lt;-</span> sdev<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="fu">sum</span>(sdev<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb349-14"><a href="part-2-machine-learning-with-r.html#cb349-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-15"><a href="part-2-machine-learning-with-r.html#cb349-15" aria-hidden="true" tabindex="-1"></a>var_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">PC=</span><span class="fu">paste0</span>(<span class="st">&quot;PC&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sdev)),</span>
<span id="cb349-16"><a href="part-2-machine-learning-with-r.html#cb349-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">var_explained=</span>percent_variation,</span>
<span id="cb349-17"><a href="part-2-machine-learning-with-r.html#cb349-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb349-18"><a href="part-2-machine-learning-with-r.html#cb349-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-19"><a href="part-2-machine-learning-with-r.html#cb349-19" aria-hidden="true" tabindex="-1"></a>var_df <span class="sc">%&gt;%</span></span>
<span id="cb349-20"><a href="part-2-machine-learning-with-r.html#cb349-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PC =</span> <span class="fu">fct_inorder</span>(PC)) <span class="sc">%&gt;%</span></span>
<span id="cb349-21"><a href="part-2-machine-learning-with-r.html#cb349-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>PC,<span class="at">y=</span>var_explained))<span class="sc">+</span><span class="fu">geom_col</span>()</span>
<span id="cb349-22"><a href="part-2-machine-learning-with-r.html#cb349-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-23"><a href="part-2-machine-learning-with-r.html#cb349-23" aria-hidden="true" tabindex="-1"></a><span class="fu">juice</span>(pca_estimates) </span>
<span id="cb349-24"><a href="part-2-machine-learning-with-r.html#cb349-24" aria-hidden="true" tabindex="-1"></a><span class="fu">juice</span>(pca_estimates) <span class="sc">%&gt;%</span></span>
<span id="cb349-25"><a href="part-2-machine-learning-with-r.html#cb349-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(PC1, PC2)) <span class="sc">+</span></span>
<span id="cb349-26"><a href="part-2-machine-learning-with-r.html#cb349-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> class), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb349-27"><a href="part-2-machine-learning-with-r.html#cb349-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;PCA from tidymodels&quot;</span>)</span></code></pre></div>
</div>
<div id="t-sne" class="section level2">
<h2>t-SNE</h2>
<p>T-SNE or <a href="https://en.wikipedia.org/wiki/T-distributed_stochastic_neighbor_embedding">t-distributed stochastic neighbor embedding</a> is way to visualize high dimensional data. It is especially used in many of the omics areas. For illustrative puposes, we here show how to run such a model on our QSAR data.</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb350-1"><a href="part-2-machine-learning-with-r.html#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&quot;embed&quot;)</span></span>
<span id="cb350-2"><a href="part-2-machine-learning-with-r.html#cb350-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(embed)</span>
<span id="cb350-3"><a href="part-2-machine-learning-with-r.html#cb350-3" aria-hidden="true" tabindex="-1"></a>pca_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_qsar)</span>
<span id="cb350-4"><a href="part-2-machine-learning-with-r.html#cb350-4" aria-hidden="true" tabindex="-1"></a>pca_trans <span class="ot">&lt;-</span> pca_recipe <span class="sc">%&gt;%</span></span>
<span id="cb350-5"><a href="part-2-machine-learning-with-r.html#cb350-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># center the data</span></span>
<span id="cb350-6"><a href="part-2-machine-learning-with-r.html#cb350-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb350-7"><a href="part-2-machine-learning-with-r.html#cb350-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># center the data</span></span>
<span id="cb350-8"><a href="part-2-machine-learning-with-r.html#cb350-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb350-9"><a href="part-2-machine-learning-with-r.html#cb350-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pca on all numeric variables</span></span>
<span id="cb350-10"><a href="part-2-machine-learning-with-r.html#cb350-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_umap</span>(<span class="fu">all_numeric</span>())</span>
<span id="cb350-11"><a href="part-2-machine-learning-with-r.html#cb350-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-12"><a href="part-2-machine-learning-with-r.html#cb350-12" aria-hidden="true" tabindex="-1"></a>pca_estimates <span class="ot">&lt;-</span> <span class="fu">prep</span>(pca_trans) <span class="do">## this step takes a bit longer to calculate</span></span>
<span id="cb350-13"><a href="part-2-machine-learning-with-r.html#cb350-13" aria-hidden="true" tabindex="-1"></a>pca_estimates<span class="sc">$</span>var_info</span></code></pre></div>
<pre><code>## # A tibble: 1,025 × 4
##    variable type      role      source  
##    &lt;chr&gt;    &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
##  1 class    &lt;chr [3]&gt; predictor original
##  2 f1       &lt;chr [2]&gt; predictor original
##  3 f2       &lt;chr [2]&gt; predictor original
##  4 f3       &lt;chr [2]&gt; predictor original
##  5 f4       &lt;chr [2]&gt; predictor original
##  6 f5       &lt;chr [2]&gt; predictor original
##  7 f6       &lt;chr [2]&gt; predictor original
##  8 f7       &lt;chr [2]&gt; predictor original
##  9 f8       &lt;chr [2]&gt; predictor original
## 10 f9       &lt;chr [2]&gt; predictor original
## # ℹ 1,015 more rows</code></pre>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb352-1"><a href="part-2-machine-learning-with-r.html#cb352-1" aria-hidden="true" tabindex="-1"></a><span class="fu">juice</span>(pca_estimates) </span></code></pre></div>
<pre><code>## # A tibble: 8,992 × 3
##    class     UMAP1 UMAP2
##    &lt;fct&gt;     &lt;dbl&gt; &lt;dbl&gt;
##  1 negative -0.848 -3.64
##  2 negative -0.806 -3.49
##  3 negative -0.851 -3.49
##  4 negative -0.901 -3.37
##  5 negative  1.05  -2.19
##  6 negative -0.633 -3.04
##  7 negative  1.21  -3.84
##  8 positive -3.90   4.54
##  9 negative -3.77   4.46
## 10 negative -2.93   6.20
## # ℹ 8,982 more rows</code></pre>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb354-1"><a href="part-2-machine-learning-with-r.html#cb354-1" aria-hidden="true" tabindex="-1"></a><span class="fu">juice</span>(pca_estimates) <span class="sc">%&gt;%</span></span>
<span id="cb354-2"><a href="part-2-machine-learning-with-r.html#cb354-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(UMAP1, UMAP2)) <span class="sc">+</span></span>
<span id="cb354-3"><a href="part-2-machine-learning-with-r.html#cb354-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> class), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb354-4"><a href="part-2-machine-learning-with-r.html#cb354-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;UMAP (t-SNE) from tidymodels&quot;</span>)</span></code></pre></div>
<p><img src="002_tidymodels_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
</div>
<div id="k-means-clustering" class="section level2">
<h2>K-means clustering</h2>
<p>To show you that we do not need to stick to the Tidymodels framework (but I would recommend it), here we use a dedicated workflow for K-means clustering. An equivalent Tidymodels approach can be found <a href="https://www.tidymodels.org/learn/statistics/k-means/">here</a></p>
<p><a href="https://uc-r.github.io/kmeans_clustering" class="uri">https://uc-r.github.io/kmeans_clustering</a></p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="part-2-machine-learning-with-r.html#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)  <span class="co"># data manipulation</span></span>
<span id="cb355-2"><a href="part-2-machine-learning-with-r.html#cb355-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cluster)    <span class="co"># clustering algorithms</span></span>
<span id="cb355-3"><a href="part-2-machine-learning-with-r.html#cb355-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span>
<span id="cb355-4"><a href="part-2-machine-learning-with-r.html#cb355-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-5"><a href="part-2-machine-learning-with-r.html#cb355-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb355-6"><a href="part-2-machine-learning-with-r.html#cb355-6" aria-hidden="true" tabindex="-1"></a>data_qsar_k <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb355-7"><a href="part-2-machine-learning-with-r.html#cb355-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_frac</span>(<span class="fl">0.1</span>) <span class="sc">|&gt;</span></span>
<span id="cb355-8"><a href="part-2-machine-learning-with-r.html#cb355-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb355-9"><a href="part-2-machine-learning-with-r.html#cb355-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-10"><a href="part-2-machine-learning-with-r.html#cb355-10" aria-hidden="true" tabindex="-1"></a>row_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data_qsar_k)), data_qsar_k<span class="sc">$</span>class, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb355-11"><a href="part-2-machine-learning-with-r.html#cb355-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-12"><a href="part-2-machine-learning-with-r.html#cb355-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(data_qsar_k) <span class="ot">&lt;-</span> row_names</span>
<span id="cb355-13"><a href="part-2-machine-learning-with-r.html#cb355-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-14"><a href="part-2-machine-learning-with-r.html#cb355-14" aria-hidden="true" tabindex="-1"></a>data_qsar_k <span class="ot">&lt;-</span> data_qsar_k <span class="sc">|&gt;</span></span>
<span id="cb355-15"><a href="part-2-machine-learning-with-r.html#cb355-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>class)</span>
<span id="cb355-16"><a href="part-2-machine-learning-with-r.html#cb355-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-17"><a href="part-2-machine-learning-with-r.html#cb355-17" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">scale</span>(data_qsar_k) </span>
<span id="cb355-18"><a href="part-2-machine-learning-with-r.html#cb355-18" aria-hidden="true" tabindex="-1"></a>df</span>
<span id="cb355-19"><a href="part-2-machine-learning-with-r.html#cb355-19" aria-hidden="true" tabindex="-1"></a>distance <span class="ot">&lt;-</span> <span class="fu">get_dist</span>(df)</span>
<span id="cb355-20"><a href="part-2-machine-learning-with-r.html#cb355-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-21"><a href="part-2-machine-learning-with-r.html#cb355-21" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(df))</span>
<span id="cb355-22"><a href="part-2-machine-learning-with-r.html#cb355-22" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(data_qsar_sample))</span>
<span id="cb355-23"><a href="part-2-machine-learning-with-r.html#cb355-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-24"><a href="part-2-machine-learning-with-r.html#cb355-24" aria-hidden="true" tabindex="-1"></a><span class="do">## takes a long time to compute</span></span>
<span id="cb355-25"><a href="part-2-machine-learning-with-r.html#cb355-25" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_dist</span>(</span>
<span id="cb355-26"><a href="part-2-machine-learning-with-r.html#cb355-26" aria-hidden="true" tabindex="-1"></a>  distance, </span>
<span id="cb355-27"><a href="part-2-machine-learning-with-r.html#cb355-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">gradient =</span> <span class="fu">list</span>(</span>
<span id="cb355-28"><a href="part-2-machine-learning-with-r.html#cb355-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">&quot;#00AFBB&quot;</span>, </span>
<span id="cb355-29"><a href="part-2-machine-learning-with-r.html#cb355-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">mid =</span> <span class="st">&quot;white&quot;</span>, </span>
<span id="cb355-30"><a href="part-2-machine-learning-with-r.html#cb355-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">high =</span> <span class="st">&quot;#FC4E07&quot;</span></span>
<span id="cb355-31"><a href="part-2-machine-learning-with-r.html#cb355-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb355-32"><a href="part-2-machine-learning-with-r.html#cb355-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb355-33"><a href="part-2-machine-learning-with-r.html#cb355-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-34"><a href="part-2-machine-learning-with-r.html#cb355-34" aria-hidden="true" tabindex="-1"></a>k2 <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(df, <span class="at">centers =</span> <span class="dv">2</span>)</span>
<span id="cb355-35"><a href="part-2-machine-learning-with-r.html#cb355-35" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_cluster</span>(k2, <span class="at">data =</span> df)</span>
<span id="cb355-36"><a href="part-2-machine-learning-with-r.html#cb355-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-37"><a href="part-2-machine-learning-with-r.html#cb355-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-38"><a href="part-2-machine-learning-with-r.html#cb355-38" aria-hidden="true" tabindex="-1"></a><span class="do">## Multiple clusters</span></span>
<span id="cb355-39"><a href="part-2-machine-learning-with-r.html#cb355-39" aria-hidden="true" tabindex="-1"></a>k3 <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(df, <span class="at">centers =</span> <span class="dv">3</span>, <span class="at">nstart =</span> <span class="dv">25</span>)</span>
<span id="cb355-40"><a href="part-2-machine-learning-with-r.html#cb355-40" aria-hidden="true" tabindex="-1"></a>k4 <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(df, <span class="at">centers =</span> <span class="dv">4</span>, <span class="at">nstart =</span> <span class="dv">25</span>)</span>
<span id="cb355-41"><a href="part-2-machine-learning-with-r.html#cb355-41" aria-hidden="true" tabindex="-1"></a>k5 <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(df, <span class="at">centers =</span> <span class="dv">5</span>, <span class="at">nstart =</span> <span class="dv">25</span>)</span>
<span id="cb355-42"><a href="part-2-machine-learning-with-r.html#cb355-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-43"><a href="part-2-machine-learning-with-r.html#cb355-43" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">fviz_cluster</span>(k2, <span class="at">geom =</span> <span class="st">&quot;point&quot;</span>, <span class="at">data =</span> df) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;k = 2&quot;</span>)</span>
<span id="cb355-44"><a href="part-2-machine-learning-with-r.html#cb355-44" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">fviz_cluster</span>(k3, <span class="at">geom =</span> <span class="st">&quot;point&quot;</span>,  <span class="at">data =</span> df) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;k = 3&quot;</span>)</span>
<span id="cb355-45"><a href="part-2-machine-learning-with-r.html#cb355-45" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">fviz_cluster</span>(k4, <span class="at">geom =</span> <span class="st">&quot;point&quot;</span>,  <span class="at">data =</span> df) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;k = 4&quot;</span>)</span>
<span id="cb355-46"><a href="part-2-machine-learning-with-r.html#cb355-46" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">fviz_cluster</span>(k5, <span class="at">geom =</span> <span class="st">&quot;point&quot;</span>,  <span class="at">data =</span> df) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;k = 5&quot;</span>)</span>
<span id="cb355-47"><a href="part-2-machine-learning-with-r.html#cb355-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-48"><a href="part-2-machine-learning-with-r.html#cb355-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb355-49"><a href="part-2-machine-learning-with-r.html#cb355-49" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, p3, p4, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb355-50"><a href="part-2-machine-learning-with-r.html#cb355-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-51"><a href="part-2-machine-learning-with-r.html#cb355-51" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb355-52"><a href="part-2-machine-learning-with-r.html#cb355-52" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_nbclust</span>(df, kmeans, <span class="at">method =</span> <span class="st">&quot;wss&quot;</span>)</span>
<span id="cb355-53"><a href="part-2-machine-learning-with-r.html#cb355-53" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_nbclust</span>(df, kmeans, <span class="at">method =</span> <span class="st">&quot;silhouette&quot;</span>)</span>
<span id="cb355-54"><a href="part-2-machine-learning-with-r.html#cb355-54" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span></code></pre></div>
<div id="exercise-building-an-xgboost-model-on-the-qsar-data-2" class="section level5 unnumbered question">
<h5>Exercise Building an XGBoost model on the QSAR data 2</h5>
<p>A much used machine learning algorithm is a regression tree as we saw before. A variant that is often used to boost accuracy is the <a href="https://parsnip.tidymodels.org/reference/details_boost_tree_xgboost.html">XGBoost model</a>. In this Exercise we invite you to build such a model and run some predictions and diagnostics on your model. You can follow the steps from the previous demo, where we used the TAME <code>PFAS/Statins</code> dataset to build a Random Forest model.</p>
<p>These are the steps you need to take</p>
<ol style="list-style-type: decimal">
<li>Build the appropriate model - <a href="https://parsnip.tidymodels.org/reference/details_boost_tree_xgboost.html">XGBoost</a></li>
<li>Choose the right mode and engine</li>
<li>Build a suitable recipe</li>
<li>Generate a random split of the data for a train and a test portion - maybe think about stratification here</li>
<li>Build a workflow, including the model and the recipe</li>
<li>Fit our model on the training data</li>
<li>Test our model on the test dataset</li>
<li>Evaluate the model by assessing some performance metrics (accuracy, confusion table)</li>
</ol>
</div>
<details>
<summary>
Click for the answer
</summary>
<p>Beause we have class imbalance (more negatives then positives) we use a stratification approach</p>
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb356-1"><a href="part-2-machine-learning-with-r.html#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="do">## prepare data splits</span></span>
<span id="cb356-2"><a href="part-2-machine-learning-with-r.html#cb356-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb356-3"><a href="part-2-machine-learning-with-r.html#cb356-3" aria-hidden="true" tabindex="-1"></a>qsar_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(<span class="at">data =</span> data_qsar, </span>
<span id="cb356-4"><a href="part-2-machine-learning-with-r.html#cb356-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">prop =</span> <span class="fl">0.80</span>, </span>
<span id="cb356-5"><a href="part-2-machine-learning-with-r.html#cb356-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">strata =</span> class)</span>
<span id="cb356-6"><a href="part-2-machine-learning-with-r.html#cb356-6" aria-hidden="true" tabindex="-1"></a>qsar_train <span class="ot">&lt;-</span> <span class="fu">training</span>(qsar_split)</span>
<span id="cb356-7"><a href="part-2-machine-learning-with-r.html#cb356-7" aria-hidden="true" tabindex="-1"></a>qsar_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(qsar_split)</span></code></pre></div>
<p>Let’s look at the tally
<a href="https://r4ds.github.io/bookclub-tmwr/class-imbalance.html" class="uri">https://r4ds.github.io/bookclub-tmwr/class-imbalance.html</a></p>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="part-2-machine-learning-with-r.html#cb357-1" aria-hidden="true" tabindex="-1"></a>qsar_test <span class="sc">|&gt;</span></span>
<span id="cb357-2"><a href="part-2-machine-learning-with-r.html#cb357-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(class) <span class="sc">|&gt;</span></span>
<span id="cb357-3"><a href="part-2-machine-learning-with-r.html#cb357-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   class        n
##   &lt;chr&gt;    &lt;int&gt;
## 1 negative  1665
## 2 positive   134</code></pre>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="part-2-machine-learning-with-r.html#cb359-1" aria-hidden="true" tabindex="-1"></a>qsar_train <span class="sc">|&gt;</span></span>
<span id="cb359-2"><a href="part-2-machine-learning-with-r.html#cb359-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(class) <span class="sc">|&gt;</span></span>
<span id="cb359-3"><a href="part-2-machine-learning-with-r.html#cb359-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   class        n
##   &lt;chr&gt;    &lt;int&gt;
## 1 negative  6586
## 2 positive   607</code></pre>
</div>
<div id="xgboost" class="section level2">
<h2>XGBoost</h2>
<p>See: <a href="https://parsnip.tidymodels.org/reference/details_boost_tree_xgboost.html" class="uri">https://parsnip.tidymodels.org/reference/details_boost_tree_xgboost.html</a></p>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="part-2-machine-learning-with-r.html#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="do">## prepare model recipe</span></span>
<span id="cb361-2"><a href="part-2-machine-learning-with-r.html#cb361-2" aria-hidden="true" tabindex="-1"></a>xgb_mod <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">mtry =</span> <span class="dv">50</span>, <span class="at">trees =</span> <span class="dv">500</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb361-3"><a href="part-2-machine-learning-with-r.html#cb361-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb361-4"><a href="part-2-machine-learning-with-r.html#cb361-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)</span>
<span id="cb361-5"><a href="part-2-machine-learning-with-r.html#cb361-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-6"><a href="part-2-machine-learning-with-r.html#cb361-6" aria-hidden="true" tabindex="-1"></a>xgb_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(class <span class="sc">~</span> ., <span class="at">data =</span> qsar_train) <span class="sc">|&gt;</span></span>
<span id="cb361-7"><a href="part-2-machine-learning-with-r.html#cb361-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb361-8"><a href="part-2-machine-learning-with-r.html#cb361-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb361-9"><a href="part-2-machine-learning-with-r.html#cb361-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb361-10"><a href="part-2-machine-learning-with-r.html#cb361-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-11"><a href="part-2-machine-learning-with-r.html#cb361-11" aria-hidden="true" tabindex="-1"></a>xgb_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb361-12"><a href="part-2-machine-learning-with-r.html#cb361-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(xgb_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb361-13"><a href="part-2-machine-learning-with-r.html#cb361-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(xgb_rec)</span>
<span id="cb361-14"><a href="part-2-machine-learning-with-r.html#cb361-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-15"><a href="part-2-machine-learning-with-r.html#cb361-15" aria-hidden="true" tabindex="-1"></a><span class="co">#prep &lt;- prep(rf_rec)</span></span>
<span id="cb361-16"><a href="part-2-machine-learning-with-r.html#cb361-16" aria-hidden="true" tabindex="-1"></a><span class="co">#juiced &lt;- juice(prep)</span></span>
<span id="cb361-17"><a href="part-2-machine-learning-with-r.html#cb361-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-18"><a href="part-2-machine-learning-with-r.html#cb361-18" aria-hidden="true" tabindex="-1"></a>data_qsar <span class="ot">&lt;-</span> data_qsar <span class="sc">|&gt;</span></span>
<span id="cb361-19"><a href="part-2-machine-learning-with-r.html#cb361-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">as_factor</span>(class))</span>
<span id="cb361-20"><a href="part-2-machine-learning-with-r.html#cb361-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-21"><a href="part-2-machine-learning-with-r.html#cb361-21" aria-hidden="true" tabindex="-1"></a>qsar_test <span class="ot">&lt;-</span> qsar_test <span class="sc">|&gt;</span></span>
<span id="cb361-22"><a href="part-2-machine-learning-with-r.html#cb361-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">as_factor</span>(class))</span>
<span id="cb361-23"><a href="part-2-machine-learning-with-r.html#cb361-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-24"><a href="part-2-machine-learning-with-r.html#cb361-24" aria-hidden="true" tabindex="-1"></a>qsar_train <span class="ot">&lt;-</span> qsar_train <span class="sc">|&gt;</span></span>
<span id="cb361-25"><a href="part-2-machine-learning-with-r.html#cb361-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">as_factor</span>(class))</span>
<span id="cb361-26"><a href="part-2-machine-learning-with-r.html#cb361-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-27"><a href="part-2-machine-learning-with-r.html#cb361-27" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb361-28"><a href="part-2-machine-learning-with-r.html#cb361-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-29"><a href="part-2-machine-learning-with-r.html#cb361-29" aria-hidden="true" tabindex="-1"></a><span class="do">## fit model</span></span>
<span id="cb361-30"><a href="part-2-machine-learning-with-r.html#cb361-30" aria-hidden="true" tabindex="-1"></a>xgb_fit <span class="ot">&lt;-</span> xgb_wf <span class="sc">%&gt;%</span> </span>
<span id="cb361-31"><a href="part-2-machine-learning-with-r.html#cb361-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> qsar_train)</span>
<span id="cb361-32"><a href="part-2-machine-learning-with-r.html#cb361-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-33"><a href="part-2-machine-learning-with-r.html#cb361-33" aria-hidden="true" tabindex="-1"></a><span class="do">## see model metrics</span></span>
<span id="cb361-34"><a href="part-2-machine-learning-with-r.html#cb361-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-35"><a href="part-2-machine-learning-with-r.html#cb361-35" aria-hidden="true" tabindex="-1"></a>xgb_fit <span class="sc">%&gt;%</span> <span class="fu">extract_fit_parsnip</span>()</span></code></pre></div>
<pre><code>## parsnip model object
## 
## ##### xgb.Booster
## raw: 863.8 Kb 
## call:
##   xgboost::xgb.train(params = list(eta = 0.3, max_depth = 6, gamma = 0, 
##     colsample_bytree = 1, colsample_bynode = 0.048828125, min_child_weight = 1, 
##     subsample = 1), data = x$data, nrounds = 500, watchlist = x$watchlist, 
##     verbose = 0, nthread = 1, objective = &quot;binary:logistic&quot;)
## params (as set within xgb.train):
##   eta = &quot;0.3&quot;, max_depth = &quot;6&quot;, gamma = &quot;0&quot;, colsample_bytree = &quot;1&quot;, colsample_bynode = &quot;0.048828125&quot;, min_child_weight = &quot;1&quot;, subsample = &quot;1&quot;, nthread = &quot;1&quot;, objective = &quot;binary:logistic&quot;, validate_parameters = &quot;TRUE&quot;
## xgb.attributes:
##   niter
## callbacks:
##   cb.evaluation.log()
## # of features: 1024 
## niter: 500
## nfeatures : 1024 
## evaluation_log:
##     iter training_logloss
##        1       0.50282655
##        2       0.39467603
## ---                      
##      499       0.02022062
##      500       0.02018738</code></pre>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="part-2-machine-learning-with-r.html#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(xgb_fit, qsar_test)</span></code></pre></div>
<pre><code>## # A tibble: 1,799 × 1
##    .pred_class
##    &lt;fct&gt;      
##  1 negative   
##  2 negative   
##  3 negative   
##  4 negative   
##  5 negative   
##  6 positive   
##  7 negative   
##  8 negative   
##  9 negative   
## 10 negative   
## # ℹ 1,789 more rows</code></pre>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb365-1"><a href="part-2-machine-learning-with-r.html#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model eval</span></span>
<span id="cb365-2"><a href="part-2-machine-learning-with-r.html#cb365-2" aria-hidden="true" tabindex="-1"></a>xgb_fit <span class="sc">%&gt;%</span> </span>
<span id="cb365-3"><a href="part-2-machine-learning-with-r.html#cb365-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>( <span class="at">new_data =</span> qsar_test) <span class="sc">%&gt;%</span> </span>
<span id="cb365-4"><a href="part-2-machine-learning-with-r.html#cb365-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(qsar_test[<span class="st">&quot;class&quot;</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb365-5"><a href="part-2-machine-learning-with-r.html#cb365-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(<span class="at">truth=</span> class, .pred_class) </span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.957</code></pre>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb367-1"><a href="part-2-machine-learning-with-r.html#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="do">## confusion matrix</span></span>
<span id="cb367-2"><a href="part-2-machine-learning-with-r.html#cb367-2" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">confusionMatrix</span>(</span>
<span id="cb367-3"><a href="part-2-machine-learning-with-r.html#cb367-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.factor</span>(qsar_test<span class="sc">$</span>class), </span>
<span id="cb367-4"><a href="part-2-machine-learning-with-r.html#cb367-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(xgb_fit, <span class="at">new_data =</span> qsar_test)<span class="sc">$</span>.pred_class)</span></code></pre></div>
<pre><code>## Confusion Matrix and Statistics
## 
##           Reference
## Prediction negative positive
##   negative     1646       19
##   positive       59       75
##                                           
##                Accuracy : 0.9566          
##                  95% CI : (0.9462, 0.9656)
##     No Information Rate : 0.9477          
##     P-Value [Acc &gt; NIR] : 0.04729         
##                                           
##                   Kappa : 0.6355          
##                                           
##  Mcnemar&#39;s Test P-Value : 1.006e-05       
##                                           
##             Sensitivity : 0.9654          
##             Specificity : 0.7979          
##          Pos Pred Value : 0.9886          
##          Neg Pred Value : 0.5597          
##              Prevalence : 0.9477          
##          Detection Rate : 0.9150          
##    Detection Prevalence : 0.9255          
##       Balanced Accuracy : 0.8816          
##                                           
##        &#39;Positive&#39; Class : negative        
## </code></pre>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb369-1"><a href="part-2-machine-learning-with-r.html#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(</span>
<span id="cb369-2"><a href="part-2-machine-learning-with-r.html#cb369-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(xgb_fit, qsar_test),</span>
<span id="cb369-3"><a href="part-2-machine-learning-with-r.html#cb369-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(xgb_fit, qsar_test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>),</span>
<span id="cb369-4"><a href="part-2-machine-learning-with-r.html#cb369-4" aria-hidden="true" tabindex="-1"></a>    qsar_test[,<span class="dv">1</span>]</span>
<span id="cb369-5"><a href="part-2-machine-learning-with-r.html#cb369-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> predictions</span>
<span id="cb369-6"><a href="part-2-machine-learning-with-r.html#cb369-6" aria-hidden="true" tabindex="-1"></a>predictions</span></code></pre></div>
<pre><code>## # A tibble: 1,799 × 4
##    .pred_class .pred_negative .pred_positive class   
##    &lt;fct&gt;                &lt;dbl&gt;          &lt;dbl&gt; &lt;fct&gt;   
##  1 negative             0.999      0.00131   negative
##  2 negative             1.00       0.000378  negative
##  3 negative             0.976      0.0241    negative
##  4 negative             0.983      0.0173    negative
##  5 negative             0.999      0.000697  negative
##  6 positive             0.489      0.511     positive
##  7 negative             0.999      0.00142   negative
##  8 negative             0.622      0.378     negative
##  9 negative             0.937      0.0634    negative
## 10 negative             1.00       0.0000561 negative
## # ℹ 1,789 more rows</code></pre>
</details>
</div>
<div id="tuning-our-model" class="section level2">
<h2>Tuning our model</h2>
<p>Above we arbitrarily chose trees = 200 and mtry = 50. These arguments is called hyperparameters. We can more structurally tune our model when we do a grid search for the optimal hyperparameters that yield the best accuracy of our model.</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb371-1"><a href="part-2-machine-learning-with-r.html#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)  <span class="co"># for the tune package, along with the rest of tidymodels</span></span>
<span id="cb371-2"><a href="part-2-machine-learning-with-r.html#cb371-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-3"><a href="part-2-machine-learning-with-r.html#cb371-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper packages</span></span>
<span id="cb371-4"><a href="part-2-machine-learning-with-r.html#cb371-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)  <span class="co"># for visualizing a decision tree</span></span>
<span id="cb371-5"><a href="part-2-machine-learning-with-r.html#cb371-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)         <span class="co"># for variable importance plots</span></span></code></pre></div>
</details>
</div>
<div id="model-tuning" class="section level2">
<h2>Model tuning</h2>
<p>Model tuning, means that we will try to find the optimal value for the so-called hyperparameters of the model. These parameters are the paramters that define some setting of the model. For the Random Forest model we saw earlier, we chose an arbitrary value for instance for the <code>mtry</code> and <code>trees</code> hyperparameters. During the model tuning process, we run muliple models with varying values for the hyperparameters. Each time we evaluate the model to check the performance. The result from this tuning will hopefully yield the best setting for our hyperparameters. Finally, we can run the model one last time with these optimized setting to get the maximum performance. Because model tuning is expensive in terms of computing power, I have run the computation on a Virtual Machine in the Cloud. A machine with 30 cores and 472 Gb RAM memory. A big computer, much bigger than your laptop. The results of these expensive calculations were saved to disk. They can be found online <a href="**ADD%20LINK**">here</a>.
To tune the hyperparameters of our XGBoost model we can update (create a new) model using a grid search. This is structural way of defining different values for our hyperparameters. We stick to the <a href="https://www.tidymodels.org/start/tuning/">Tidymodels tuning workflow here</a>.</p>
<p>In stead of defining a value for the hyperparameters, we use the <code>tune()</code> function to act as a placeholder for the actual values from the tune grid:</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="part-2-machine-learning-with-r.html#cb372-1" aria-hidden="true" tabindex="-1"></a>xgb_mod_tune <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb372-2"><a href="part-2-machine-learning-with-r.html#cb372-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>(), </span>
<span id="cb372-3"><a href="part-2-machine-learning-with-r.html#cb372-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb372-4"><a href="part-2-machine-learning-with-r.html#cb372-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb372-5"><a href="part-2-machine-learning-with-r.html#cb372-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb372-6"><a href="part-2-machine-learning-with-r.html#cb372-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;classification&quot;</span>)</span></code></pre></div>
<p>In order to get a structured collection of possible combinations of our hyperperparameters, we can use the <code>grid_regular()</code> function.</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb373-1"><a href="part-2-machine-learning-with-r.html#cb373-1" aria-hidden="true" tabindex="-1"></a>tree_grid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(</span>
<span id="cb373-2"><a href="part-2-machine-learning-with-r.html#cb373-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trees</span>(),</span>
<span id="cb373-3"><a href="part-2-machine-learning-with-r.html#cb373-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tree_depth</span>(),</span>
<span id="cb373-4"><a href="part-2-machine-learning-with-r.html#cb373-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(<span class="fu">mtry</span>(), <span class="fu">select</span>(data_qsar , <span class="sc">-</span>class)),</span>
<span id="cb373-5"><a href="part-2-machine-learning-with-r.html#cb373-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> <span class="dv">3</span>)</span>
<span id="cb373-6"><a href="part-2-machine-learning-with-r.html#cb373-6" aria-hidden="true" tabindex="-1"></a>tree_grid</span></code></pre></div>
<pre><code>## # A tibble: 27 × 3
##    trees tree_depth  mtry
##    &lt;int&gt;      &lt;int&gt; &lt;int&gt;
##  1     1          1     1
##  2  1000          1     1
##  3  2000          1     1
##  4     1          8     1
##  5  1000          8     1
##  6  2000          8     1
##  7     1         15     1
##  8  1000         15     1
##  9  2000         15     1
## 10     1          1   512
## # ℹ 17 more rows</code></pre>
<p>Armed with this grid we need to create multiple folds of our data to run the models.</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb375-1"><a href="part-2-machine-learning-with-r.html#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234</span>)</span>
<span id="cb375-2"><a href="part-2-machine-learning-with-r.html#cb375-2" aria-hidden="true" tabindex="-1"></a>cell_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(qsar_train, <span class="at">v =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>We tune our parameters according the grid, over the data-folds we created. This step takes a long time to compute. I ran this on 30 core VM, with 472 Gb RAM. A very large machine, in comparison to a standards laptop, almost 4x more compute power. On that machine it took about 2 hours for the code below to finish. That is why I stored the results on disk, so that you do not need to run this. For safety reasons, I out-commented the code, so that you do not accidentally run it.</p>
<div class="sourceCode" id="cb376"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb376-1"><a href="part-2-machine-learning-with-r.html#cb376-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(345)</span></span>
<span id="cb376-2"><a href="part-2-machine-learning-with-r.html#cb376-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-3"><a href="part-2-machine-learning-with-r.html#cb376-3" aria-hidden="true" tabindex="-1"></a><span class="co"># tree_grid &lt;- grid_regular(</span></span>
<span id="cb376-4"><a href="part-2-machine-learning-with-r.html#cb376-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   trees(),</span></span>
<span id="cb376-5"><a href="part-2-machine-learning-with-r.html#cb376-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   tree_depth(),</span></span>
<span id="cb376-6"><a href="part-2-machine-learning-with-r.html#cb376-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   finalize(mtry(), select(data_qsar , -class)),</span></span>
<span id="cb376-7"><a href="part-2-machine-learning-with-r.html#cb376-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   levels = 3)</span></span>
<span id="cb376-8"><a href="part-2-machine-learning-with-r.html#cb376-8" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb376-9"><a href="part-2-machine-learning-with-r.html#cb376-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb376-10"><a href="part-2-machine-learning-with-r.html#cb376-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(234)</span></span>
<span id="cb376-11"><a href="part-2-machine-learning-with-r.html#cb376-11" aria-hidden="true" tabindex="-1"></a><span class="co"># cell_folds &lt;- vfold_cv(qsar_train, v = 3)</span></span>
<span id="cb376-12"><a href="part-2-machine-learning-with-r.html#cb376-12" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb376-13"><a href="part-2-machine-learning-with-r.html#cb376-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-14"><a href="part-2-machine-learning-with-r.html#cb376-14" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_wf_tune &lt;- workflow() %&gt;%</span></span>
<span id="cb376-15"><a href="part-2-machine-learning-with-r.html#cb376-15" aria-hidden="true" tabindex="-1"></a><span class="co">#  add_model(xgb_mod_tune) %&gt;%</span></span>
<span id="cb376-16"><a href="part-2-machine-learning-with-r.html#cb376-16" aria-hidden="true" tabindex="-1"></a><span class="co">#  add_formula(class ~ .)</span></span>
<span id="cb376-17"><a href="part-2-machine-learning-with-r.html#cb376-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-18"><a href="part-2-machine-learning-with-r.html#cb376-18" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_res &lt;- </span></span>
<span id="cb376-19"><a href="part-2-machine-learning-with-r.html#cb376-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  xgb_wf_tune %&gt;% </span></span>
<span id="cb376-20"><a href="part-2-machine-learning-with-r.html#cb376-20" aria-hidden="true" tabindex="-1"></a><span class="co">#  tune_grid(</span></span>
<span id="cb376-21"><a href="part-2-machine-learning-with-r.html#cb376-21" aria-hidden="true" tabindex="-1"></a><span class="co">#    resamples = cell_folds,</span></span>
<span id="cb376-22"><a href="part-2-machine-learning-with-r.html#cb376-22" aria-hidden="true" tabindex="-1"></a><span class="co">#    grid = tree_grid, control = control_grid(verbose = TRUE))</span></span>
<span id="cb376-23"><a href="part-2-machine-learning-with-r.html#cb376-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb376-24"><a href="part-2-machine-learning-with-r.html#cb376-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-25"><a href="part-2-machine-learning-with-r.html#cb376-25" aria-hidden="true" tabindex="-1"></a><span class="co">#xgb_res</span></span>
<span id="cb376-26"><a href="part-2-machine-learning-with-r.html#cb376-26" aria-hidden="true" tabindex="-1"></a><span class="co">#write_rds(xgb_res, here::here(base_folder, &quot;data&quot;, &quot;xgb_res.rds&quot;))</span></span></code></pre></div>
</div>
<div id="read-results-from-disk" class="section level2">
<h2>Read results from disk</h2>
<div class="sourceCode" id="cb377"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb377-1"><a href="part-2-machine-learning-with-r.html#cb377-1" aria-hidden="true" tabindex="-1"></a>xgb_res <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_rds</span>(here<span class="sc">::</span><span class="fu">here</span>(base_folder, <span class="st">&quot;data&quot;</span>, <span class="st">&quot;xgb_res.rds&quot;</span>))</span>
<span id="cb377-2"><a href="part-2-machine-learning-with-r.html#cb377-2" aria-hidden="true" tabindex="-1"></a>xgb_res</span>
<span id="cb377-3"><a href="part-2-machine-learning-with-r.html#cb377-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-4"><a href="part-2-machine-learning-with-r.html#cb377-4" aria-hidden="true" tabindex="-1"></a>hyper_p <span class="ot">&lt;-</span> xgb_res <span class="sc">|&gt;</span></span>
<span id="cb377-5"><a href="part-2-machine-learning-with-r.html#cb377-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span>
<span id="cb377-6"><a href="part-2-machine-learning-with-r.html#cb377-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-7"><a href="part-2-machine-learning-with-r.html#cb377-7" aria-hidden="true" tabindex="-1"></a>xgb_res <span class="sc">%&gt;%</span></span>
<span id="cb377-8"><a href="part-2-machine-learning-with-r.html#cb377-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb377-9"><a href="part-2-machine-learning-with-r.html#cb377-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="fu">factor</span>(tree_depth)) <span class="sc">%&gt;%</span></span>
<span id="cb377-10"><a href="part-2-machine-learning-with-r.html#cb377-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(trees, mean, <span class="at">color =</span> tree_depth)) <span class="sc">+</span></span>
<span id="cb377-11"><a href="part-2-machine-learning-with-r.html#cb377-11" aria-hidden="true" tabindex="-1"></a><span class="co">#  geom_line(size = 1.5, alpha = 0.6) +</span></span>
<span id="cb377-12"><a href="part-2-machine-learning-with-r.html#cb377-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb377-13"><a href="part-2-machine-learning-with-r.html#cb377-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb377-14"><a href="part-2-machine-learning-with-r.html#cb377-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>()) <span class="sc">+</span></span>
<span id="cb377-15"><a href="part-2-machine-learning-with-r.html#cb377-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>, <span class="at">begin =</span> .<span class="dv">9</span>, <span class="at">end =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb377-16"><a href="part-2-machine-learning-with-r.html#cb377-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>mtry)</span>
<span id="cb377-17"><a href="part-2-machine-learning-with-r.html#cb377-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-18"><a href="part-2-machine-learning-with-r.html#cb377-18" aria-hidden="true" tabindex="-1"></a>xgb_res <span class="sc">%&gt;%</span></span>
<span id="cb377-19"><a href="part-2-machine-learning-with-r.html#cb377-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_best</span>(<span class="st">&quot;accuracy&quot;</span>)</span>
<span id="cb377-20"><a href="part-2-machine-learning-with-r.html#cb377-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-21"><a href="part-2-machine-learning-with-r.html#cb377-21" aria-hidden="true" tabindex="-1"></a>best_boost <span class="ot">&lt;-</span> xgb_res <span class="sc">%&gt;%</span></span>
<span id="cb377-22"><a href="part-2-machine-learning-with-r.html#cb377-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_best</span>(<span class="st">&quot;accuracy&quot;</span>)</span>
<span id="cb377-23"><a href="part-2-machine-learning-with-r.html#cb377-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-24"><a href="part-2-machine-learning-with-r.html#cb377-24" aria-hidden="true" tabindex="-1"></a>final_wf <span class="ot">&lt;-</span> </span>
<span id="cb377-25"><a href="part-2-machine-learning-with-r.html#cb377-25" aria-hidden="true" tabindex="-1"></a>  xgb_wf <span class="sc">%&gt;%</span> </span>
<span id="cb377-26"><a href="part-2-machine-learning-with-r.html#cb377-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_boost)</span>
<span id="cb377-27"><a href="part-2-machine-learning-with-r.html#cb377-27" aria-hidden="true" tabindex="-1"></a>final_wf</span>
<span id="cb377-28"><a href="part-2-machine-learning-with-r.html#cb377-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-29"><a href="part-2-machine-learning-with-r.html#cb377-29" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> </span>
<span id="cb377-30"><a href="part-2-machine-learning-with-r.html#cb377-30" aria-hidden="true" tabindex="-1"></a>  final_wf <span class="sc">%&gt;%</span></span>
<span id="cb377-31"><a href="part-2-machine-learning-with-r.html#cb377-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(qsar_split) </span>
<span id="cb377-32"><a href="part-2-machine-learning-with-r.html#cb377-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-33"><a href="part-2-machine-learning-with-r.html#cb377-33" aria-hidden="true" tabindex="-1"></a>final_fit<span class="sc">$</span>.metrics</span>
<span id="cb377-34"><a href="part-2-machine-learning-with-r.html#cb377-34" aria-hidden="true" tabindex="-1"></a>final_fit<span class="sc">$</span>.predictions</span>
<span id="cb377-35"><a href="part-2-machine-learning-with-r.html#cb377-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-36"><a href="part-2-machine-learning-with-r.html#cb377-36" aria-hidden="true" tabindex="-1"></a>final_fit<span class="sc">$</span>.predictions[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb377-37"><a href="part-2-machine-learning-with-r.html#cb377-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(<span class="at">truth=</span> <span class="fu">as.factor</span>(class), .pred_class) </span>
<span id="cb377-38"><a href="part-2-machine-learning-with-r.html#cb377-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-39"><a href="part-2-machine-learning-with-r.html#cb377-39" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">confusionMatrix</span>(</span>
<span id="cb377-40"><a href="part-2-machine-learning-with-r.html#cb377-40" aria-hidden="true" tabindex="-1"></a>  final_fit<span class="sc">$</span>.predictions[[<span class="dv">1</span>]]<span class="sc">$</span>.pred_class, final_fit<span class="sc">$</span>.predictions[[<span class="dv">1</span>]]<span class="sc">$</span>class )</span></code></pre></div>
</div>
<div id="bigger-grid" class="section level2">
<h2>Bigger grid</h2>
<p><a href="https://cran.r-project.org/web/packages/doFuture/vignettes/doFuture.html" class="uri">https://cran.r-project.org/web/packages/doFuture/vignettes/doFuture.html</a></p>
<div class="sourceCode" id="cb378"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb378-1"><a href="part-2-machine-learning-with-r.html#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # ## we can optimize the big grid tuning using a different engine</span></span>
<span id="cb378-2"><a href="part-2-machine-learning-with-r.html#cb378-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  xgb_l_tune &lt;- boost_tree(</span></span>
<span id="cb378-3"><a href="part-2-machine-learning-with-r.html#cb378-3" aria-hidden="true" tabindex="-1"></a><span class="co">#    trees = tune(),</span></span>
<span id="cb378-4"><a href="part-2-machine-learning-with-r.html#cb378-4" aria-hidden="true" tabindex="-1"></a><span class="co">#    mtry = tune(),</span></span>
<span id="cb378-5"><a href="part-2-machine-learning-with-r.html#cb378-5" aria-hidden="true" tabindex="-1"></a><span class="co">#    tree_depth = tune()) %&gt;% </span></span>
<span id="cb378-6"><a href="part-2-machine-learning-with-r.html#cb378-6" aria-hidden="true" tabindex="-1"></a><span class="co">#    set_engine(&quot;xgboost&quot;) |&gt;</span></span>
<span id="cb378-7"><a href="part-2-machine-learning-with-r.html#cb378-7" aria-hidden="true" tabindex="-1"></a><span class="co">#    set_mode(&quot;classification&quot;)</span></span>
<span id="cb378-8"><a href="part-2-machine-learning-with-r.html#cb378-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # </span></span>
<span id="cb378-9"><a href="part-2-machine-learning-with-r.html#cb378-9" aria-hidden="true" tabindex="-1"></a><span class="co"># # tree_grid &lt;- grid_regular(</span></span>
<span id="cb378-10"><a href="part-2-machine-learning-with-r.html#cb378-10" aria-hidden="true" tabindex="-1"></a><span class="co"># #   trees(),</span></span>
<span id="cb378-11"><a href="part-2-machine-learning-with-r.html#cb378-11" aria-hidden="true" tabindex="-1"></a><span class="co"># #   tree_depth(),</span></span>
<span id="cb378-12"><a href="part-2-machine-learning-with-r.html#cb378-12" aria-hidden="true" tabindex="-1"></a><span class="co"># #   finalize(mtry(), select(data_qsar , -class)),</span></span>
<span id="cb378-13"><a href="part-2-machine-learning-with-r.html#cb378-13" aria-hidden="true" tabindex="-1"></a><span class="co"># #   levels = 10)</span></span>
<span id="cb378-14"><a href="part-2-machine-learning-with-r.html#cb378-14" aria-hidden="true" tabindex="-1"></a><span class="co"># # </span></span>
<span id="cb378-15"><a href="part-2-machine-learning-with-r.html#cb378-15" aria-hidden="true" tabindex="-1"></a><span class="co"># # </span></span>
<span id="cb378-16"><a href="part-2-machine-learning-with-r.html#cb378-16" aria-hidden="true" tabindex="-1"></a><span class="co"># # set.seed(234)</span></span>
<span id="cb378-17"><a href="part-2-machine-learning-with-r.html#cb378-17" aria-hidden="true" tabindex="-1"></a><span class="co"># # cell_folds &lt;- vfold_cv(qsar_train, v = 10)</span></span>
<span id="cb378-18"><a href="part-2-machine-learning-with-r.html#cb378-18" aria-hidden="true" tabindex="-1"></a><span class="co"># # </span></span>
<span id="cb378-19"><a href="part-2-machine-learning-with-r.html#cb378-19" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-20"><a href="part-2-machine-learning-with-r.html#cb378-20" aria-hidden="true" tabindex="-1"></a><span class="co"># # </span></span>
<span id="cb378-21"><a href="part-2-machine-learning-with-r.html#cb378-21" aria-hidden="true" tabindex="-1"></a><span class="co"># # set.seed(345)</span></span>
<span id="cb378-22"><a href="part-2-machine-learning-with-r.html#cb378-22" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-23"><a href="part-2-machine-learning-with-r.html#cb378-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ## read results from disk</span></span>
<span id="cb378-24"><a href="part-2-machine-learning-with-r.html#cb378-24" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_l_res &lt;- readr::read_rds(&quot;xgb_l_res.rds&quot;)</span></span>
<span id="cb378-25"><a href="part-2-machine-learning-with-r.html#cb378-25" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-26"><a href="part-2-machine-learning-with-r.html#cb378-26" aria-hidden="true" tabindex="-1"></a><span class="co">#  xgb_wf_l_tune &lt;- workflow() %&gt;%</span></span>
<span id="cb378-27"><a href="part-2-machine-learning-with-r.html#cb378-27" aria-hidden="true" tabindex="-1"></a><span class="co">#    add_model(xgb_l_tune) %&gt;%</span></span>
<span id="cb378-28"><a href="part-2-machine-learning-with-r.html#cb378-28" aria-hidden="true" tabindex="-1"></a><span class="co">#    add_formula(class ~ .)</span></span>
<span id="cb378-29"><a href="part-2-machine-learning-with-r.html#cb378-29" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-30"><a href="part-2-machine-learning-with-r.html#cb378-30" aria-hidden="true" tabindex="-1"></a><span class="co"># #xgb_l_res &lt;- </span></span>
<span id="cb378-31"><a href="part-2-machine-learning-with-r.html#cb378-31" aria-hidden="true" tabindex="-1"></a><span class="co"># #  xgb_wf_l_tune %&gt;% </span></span>
<span id="cb378-32"><a href="part-2-machine-learning-with-r.html#cb378-32" aria-hidden="true" tabindex="-1"></a><span class="co"># #  tune_grid(</span></span>
<span id="cb378-33"><a href="part-2-machine-learning-with-r.html#cb378-33" aria-hidden="true" tabindex="-1"></a><span class="co"># #    resamples = cell_folds,</span></span>
<span id="cb378-34"><a href="part-2-machine-learning-with-r.html#cb378-34" aria-hidden="true" tabindex="-1"></a><span class="co"># #    grid = tree_grid, control = control_grid(verbose = TRUE))</span></span>
<span id="cb378-35"><a href="part-2-machine-learning-with-r.html#cb378-35" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb378-36"><a href="part-2-machine-learning-with-r.html#cb378-36" aria-hidden="true" tabindex="-1"></a><span class="co"># #xgb_l_res</span></span>
<span id="cb378-37"><a href="part-2-machine-learning-with-r.html#cb378-37" aria-hidden="true" tabindex="-1"></a><span class="co"># #readr::write_rds(xgb_l_res, &quot;xgb_l_res.rds&quot;)</span></span>
<span id="cb378-38"><a href="part-2-machine-learning-with-r.html#cb378-38" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-39"><a href="part-2-machine-learning-with-r.html#cb378-39" aria-hidden="true" tabindex="-1"></a><span class="co"># hyper_p &lt;- xgb_l_res |&gt;</span></span>
<span id="cb378-40"><a href="part-2-machine-learning-with-r.html#cb378-40" aria-hidden="true" tabindex="-1"></a><span class="co">#   collect_metrics()</span></span>
<span id="cb378-41"><a href="part-2-machine-learning-with-r.html#cb378-41" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-42"><a href="part-2-machine-learning-with-r.html#cb378-42" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_l_res %&gt;%</span></span>
<span id="cb378-43"><a href="part-2-machine-learning-with-r.html#cb378-43" aria-hidden="true" tabindex="-1"></a><span class="co">#   collect_metrics() %&gt;%</span></span>
<span id="cb378-44"><a href="part-2-machine-learning-with-r.html#cb378-44" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(tree_depth = factor(tree_depth)) %&gt;%</span></span>
<span id="cb378-45"><a href="part-2-machine-learning-with-r.html#cb378-45" aria-hidden="true" tabindex="-1"></a><span class="co">#   ggplot(aes(trees, mean, color = tree_depth)) +</span></span>
<span id="cb378-46"><a href="part-2-machine-learning-with-r.html#cb378-46" aria-hidden="true" tabindex="-1"></a><span class="co"># #  geom_line(size = 1.5, alpha = 0.6) +</span></span>
<span id="cb378-47"><a href="part-2-machine-learning-with-r.html#cb378-47" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_point(size = 2) +</span></span>
<span id="cb378-48"><a href="part-2-machine-learning-with-r.html#cb378-48" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap(~ .metric, scales = &quot;free&quot;, nrow = 2) +</span></span>
<span id="cb378-49"><a href="part-2-machine-learning-with-r.html#cb378-49" aria-hidden="true" tabindex="-1"></a><span class="co">#   scale_x_log10(labels = scales::label_number()) +</span></span>
<span id="cb378-50"><a href="part-2-machine-learning-with-r.html#cb378-50" aria-hidden="true" tabindex="-1"></a><span class="co">#   scale_color_viridis_d(option = &quot;plasma&quot;, begin = .9, end = 0) +</span></span>
<span id="cb378-51"><a href="part-2-machine-learning-with-r.html#cb378-51" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap(~mtry)</span></span>
<span id="cb378-52"><a href="part-2-machine-learning-with-r.html#cb378-52" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-53"><a href="part-2-machine-learning-with-r.html#cb378-53" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_l_res %&gt;%</span></span>
<span id="cb378-54"><a href="part-2-machine-learning-with-r.html#cb378-54" aria-hidden="true" tabindex="-1"></a><span class="co">#   show_best(&quot;accuracy&quot;)</span></span>
<span id="cb378-55"><a href="part-2-machine-learning-with-r.html#cb378-55" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-56"><a href="part-2-machine-learning-with-r.html#cb378-56" aria-hidden="true" tabindex="-1"></a><span class="co"># best_boost &lt;- xgb_l_res %&gt;%</span></span>
<span id="cb378-57"><a href="part-2-machine-learning-with-r.html#cb378-57" aria-hidden="true" tabindex="-1"></a><span class="co">#   select_best(&quot;accuracy&quot;)</span></span>
<span id="cb378-58"><a href="part-2-machine-learning-with-r.html#cb378-58" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-59"><a href="part-2-machine-learning-with-r.html#cb378-59" aria-hidden="true" tabindex="-1"></a><span class="co"># final_wf &lt;- </span></span>
<span id="cb378-60"><a href="part-2-machine-learning-with-r.html#cb378-60" aria-hidden="true" tabindex="-1"></a><span class="co">#   xgb_wf %&gt;% </span></span>
<span id="cb378-61"><a href="part-2-machine-learning-with-r.html#cb378-61" aria-hidden="true" tabindex="-1"></a><span class="co">#   finalize_workflow(best_boost)</span></span>
<span id="cb378-62"><a href="part-2-machine-learning-with-r.html#cb378-62" aria-hidden="true" tabindex="-1"></a><span class="co"># final_wf</span></span>
<span id="cb378-63"><a href="part-2-machine-learning-with-r.html#cb378-63" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-64"><a href="part-2-machine-learning-with-r.html#cb378-64" aria-hidden="true" tabindex="-1"></a><span class="co"># final_fit &lt;- </span></span>
<span id="cb378-65"><a href="part-2-machine-learning-with-r.html#cb378-65" aria-hidden="true" tabindex="-1"></a><span class="co">#   final_wf %&gt;%</span></span>
<span id="cb378-66"><a href="part-2-machine-learning-with-r.html#cb378-66" aria-hidden="true" tabindex="-1"></a><span class="co">#   last_fit(qsar_split) </span></span>
<span id="cb378-67"><a href="part-2-machine-learning-with-r.html#cb378-67" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-68"><a href="part-2-machine-learning-with-r.html#cb378-68" aria-hidden="true" tabindex="-1"></a><span class="co"># final_fit$.metrics</span></span>
<span id="cb378-69"><a href="part-2-machine-learning-with-r.html#cb378-69" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-70"><a href="part-2-machine-learning-with-r.html#cb378-70" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_fit %&gt;% extract_fit_parsnip()</span></span>
<span id="cb378-71"><a href="part-2-machine-learning-with-r.html#cb378-71" aria-hidden="true" tabindex="-1"></a><span class="co"># #predict(final_fit, qsar_test)</span></span>
<span id="cb378-72"><a href="part-2-machine-learning-with-r.html#cb378-72" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-73"><a href="part-2-machine-learning-with-r.html#cb378-73" aria-hidden="true" tabindex="-1"></a><span class="co"># final_fit$.predictions</span></span>
<span id="cb378-74"><a href="part-2-machine-learning-with-r.html#cb378-74" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-75"><a href="part-2-machine-learning-with-r.html#cb378-75" aria-hidden="true" tabindex="-1"></a><span class="co"># final_fit$.predictions[[1]] %&gt;% </span></span>
<span id="cb378-76"><a href="part-2-machine-learning-with-r.html#cb378-76" aria-hidden="true" tabindex="-1"></a><span class="co">#   accuracy(truth= as.factor(class), .pred_class) </span></span>
<span id="cb378-77"><a href="part-2-machine-learning-with-r.html#cb378-77" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb378-78"><a href="part-2-machine-learning-with-r.html#cb378-78" aria-hidden="true" tabindex="-1"></a><span class="co"># caret::confusionMatrix(</span></span>
<span id="cb378-79"><a href="part-2-machine-learning-with-r.html#cb378-79" aria-hidden="true" tabindex="-1"></a><span class="co">#   final_fit$.predictions[[1]]$.pred_class, final_fit$.predictions[[1]]$class )</span></span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="part-1-introduction-to-r-and-rstudio.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
